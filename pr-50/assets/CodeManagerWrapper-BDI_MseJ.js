import{e as H,j as e,f as W,n as X,U as O,r as u,bl as c,b2 as V,a4 as J,a5 as Q,a6 as ee,a7 as te,k as _,K as L,M as D,aT as se,aU as ne,aV as ae,aW as P,a8 as oe,l as U,bm as R,a2 as ie,a3 as re,T as A,bn as de,ay as z,aq as le,a1 as ce,bo as ue,bp as xe,aj as pe,aX as G,aY as B,am as F,aZ as q,o as me}from"./index-ChgWv7eL.js";import{I as he,V as je,a as ge,A as Z}from"./VisibilityOff-FoAp3sdq.js";import{D as Ce}from"./Delete-DDdDSm0o.js";import{E as fe}from"./Edit-BMzbppnc.js";const ye=H(e.jsx("path",{d:"m19 8-4 4h3c0 3.31-2.69 6-6 6-1.01 0-1.97-.25-2.8-.7l-1.46 1.46C8.97 19.54 10.43 20 12 20c4.42 0 8-3.58 8-8h3zM6 12c0-3.31 2.69-6 6-6 1.01 0 1.97.25 2.8.7l1.46-1.46C15.03 4.46 13.57 4 12 4c-4.42 0-8 3.58-8 8H1l4 4 4-4z"})),be=H(e.jsx("path",{d:"M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8m0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4z"})),ve=t=>{const i=new Uint32Array(1);return crypto.getRandomValues(i),i[0]%t},K=()=>{const t="0123456789AB";let i="";for(let r=0;r<6;r++)i+=t.charAt(ve(t.length));return i},Ie=t=>t?t.toUpperCase().replace(/[^0-9AB]/g,""):"",_e=({open:t,onClose:i,onSave:r,editingCode:o})=>{const{t:s}=W(["codes","common"]),{activeDevice:n}=X(),x=!!n?.configuration_key,f=n?.role===O.Owner||n?.role===O.Admin,[d,j]=u.useState(c.MASTER),[y,m]=u.useState(""),[S,b]=u.useState(""),[v,g]=u.useState(0),[k,E]=u.useState(1),[p,M]=u.useState(!0);u.useEffect(()=>{if(t){const a=setTimeout(()=>{o?(j(o.type),m(o.code),b(o.name||o.description||""),g(o.index||0),E(o.uses||1)):(j(c.MASTER),m(K()),b(""),g(0),E(1)),M(!0)},0);return()=>clearTimeout(a)}},[o,t]),u.useEffect(()=>{t&&n?.id&&d===c.MASTER&&V.loadCodes(n.id).then(a=>{const w=a.filter(l=>l.type===c.MASTER&&l.status!=="pending_delete").map(l=>l.index).filter(l=>l!==void 0),I=Math.max(...w,-1)+1;g(I)})},[t,n?.id,d]);const T=()=>{j(c.MASTER),m(""),b(""),g(0),E(1),i()},N=async()=>{const a=Ie(y);if(m(a),d===c.MASTER&&n?.id){const I=(await V.loadCodes(n.id)).find(l=>l.type===c.MASTER&&l.index===v&&l.status!=="pending_delete"&&(!o||l.id!==o.id));if(I){r({type:d,code:a,name:S,index:v,maxUses:k},I.id),T();return}}r({type:d,code:a,name:S,index:v,maxUses:k},o?o.id:null),T()};return e.jsx(e.Fragment,{children:e.jsxs(J,{open:t,onClose:T,maxWidth:"sm",fullWidth:!0,children:[e.jsx(Q,{children:s(o?"edit_code":"add_new")}),e.jsxs(ee,{children:[!n?.configuration_key&&e.jsx(te,{severity:"warning",sx:{mb:2},children:s("config_key_missing")}),e.jsxs(_,{sx:{display:"flex",flexDirection:"column",gap:2,mt:1},children:[e.jsxs(_,{sx:{display:"flex",gap:1},children:[e.jsx(L,{label:s("pin_label"),value:y,onChange:a=>m(a.currentTarget.value.trim().toUpperCase()),fullWidth:!0,type:p?"text":"password",inputProps:{maxLength:6,"data-testid":"code-pin-input"},InputProps:{endAdornment:e.jsx(he,{position:"end",children:e.jsx(D,{"aria-label":"toggle code visibility",onClick:()=>M(!p),edge:"end",size:"small",children:p?e.jsx(je,{}):e.jsx(ge,{})})})}}),e.jsx(D,{onClick:()=>m(K()),"aria-label":s("generate"),"data-testid":"generate-code-button",children:e.jsx(ye,{})})]}),e.jsx(L,{label:s("description_label"),value:S,onChange:a=>b(a.currentTarget.value),placeholder:s("description_placeholder"),inputProps:{"data-testid":"code-name-input"},fullWidth:!0,required:!0}),e.jsxs(se,{fullWidth:!0,children:[e.jsx(ne,{children:s("type_label")}),e.jsxs(ae,{value:d,onChange:a=>j(a.target.value),label:s("type_label"),"data-testid":"code-type-select",children:[(!f||f&&x)&&e.jsx(P,{value:c.MASTER,children:s("master_code")}),e.jsx(P,{value:c.SINGLE,children:s("single_use_code")}),e.jsx(P,{value:c.MULTI,children:s("multi_use_code")})]})]}),d===c.MASTER&&e.jsx(L,{label:`${s("index_label")}: ${v}`,type:"number",value:v,onChange:a=>g(parseInt(a.currentTarget.value)||0),fullWidth:!0,disabled:!f,inputProps:{min:0,max:255,"data-testid":"code-index-input"}}),d===c.MULTI&&e.jsx(L,{label:s("uses_label"),type:"number",value:k,onChange:a=>E(parseInt(a.currentTarget.value)||1),fullWidth:!0,inputProps:{min:1,max:3,"data-testid":"code-uses-input"}})]})]}),e.jsxs(oe,{children:[e.jsx(U,{onClick:T,children:s("cancel")}),e.jsx(U,{onClick:N,variant:"contained","data-testid":"save-code-button",startIcon:e.jsx(Z,{}),disabled:!y||y.length!==6||S.trim()==="",children:s(o?"save":"generate")})]})]})})},Se=({code:t,metadata:i,onCopy:r,onEdit:o,onDelete:s})=>{const{t:n}=W("codes"),x=t.status===R.PENDING_DELETE,f=i.used,d=x||f;return e.jsxs(ie,{divider:!0,"data-testid":`code-item-${t.code}`,"data-status":t.status,sx:{opacity:d?.6:1,backgroundColor:d?"action.selected":"inherit",textDecoration:d?"line-through":"none",borderLeft:"4px solid",borderLeftColor:t.status===R.ON_DEVICE?"primary.main":t.status===R.PENDING_ADD?"warning.main":t.status===R.PENDING_DELETE?"error.main":"default.main",pl:1},children:[e.jsx(re,{primary:e.jsxs(_,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap"},children:[e.jsx(A,{variant:"body1",sx:{fontWeight:"bold"},children:t.name||t.description||n("unnamed")}),e.jsxs(A,{variant:"caption",sx:{ml:1},children:[n("pin_label"),": ",t.code]})]}),secondary:null,slotProps:{primary:{component:"div"},secondary:{component:"div"}}}),e.jsxs(de,{children:[e.jsx(z,{title:n("copy_code"),children:e.jsx(D,{edge:"end","aria-label":"copy",onClick:()=>r(t.code),children:e.jsx(le,{})})}),e.jsx(z,{title:n("edit_description"),children:e.jsx(D,{edge:"end","aria-label":"edit",onClick:()=>o(t),"data-testid":`edit-code-${t.code}`,children:e.jsx(fe,{})})}),e.jsx(D,{edge:"end","aria-label":"delete",onClick:()=>s(t.id),"data-testid":`delete-code-${t.code}`,children:e.jsx(Ce,{})})]})]})},Y=({codes:t,deriveCodeMetadata:i,hasIndexConflict:r,onCopy:o,onEdit:s,onDelete:n})=>e.jsx(ce,{children:t.map(x=>e.jsx(Se,{code:x,metadata:i(x),hasIndexConflict:r?r(x.index,x.id):!1,onCopy:o,onEdit:s,onDelete:n},x.id))}),Ee=({showAddForm:t,setShowAddForm:i,showNotification:r,hideNotification:o})=>{const{t:s}=W(["codes","common"]),{activeDevice:n}=X(),{tasks:x,syncTasks:f}=ue(),[d,j]=u.useState(!1),[y,m]=u.useState(new Set(["permanent","temporary"])),[S,b]=u.useState(null),v=n?.auto_sync??!1,g=x.filter(C=>C.status==="pending"&&C.deviceId===n?.id).length,{masterCodes:k,temporaryCodes:E,codeCount:p,refreshCodeCount:M,hasIndexConflict:T,handleAddCode:N,handleDeleteCode:a,deriveCodeMetadata:w,getFilteredCodes:I,handleCopyCode:l}=xe(r),$=u.useCallback(C=>{b(C),j(!0)},[]);return e.jsxs(_,{sx:{width:"100%"},children:[e.jsxs(_,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2},children:[e.jsxs(A,{variant:"h5",children:[s("title")," ",p&&`(Total: ${p.total})`]}),e.jsxs(_,{sx:{display:"flex",gap:1},children:[!v&&g>0&&e.jsx(U,{variant:"contained",color:"warning",startIcon:e.jsx(be,{}),onClick:f,size:"small",sx:{mr:1},children:s("sync_pending",{count:g})}),e.jsx(U,{variant:"outlined",startIcon:e.jsx(pe,{}),onClick:M,size:"small",children:s("refresh")}),e.jsx(D,{color:"primary",onClick:()=>j(!0),"aria-label":s("add_new"),"data-testid":"add-code-button",size:"small",children:e.jsx(Z,{})})]})]}),n&&e.jsx(A,{variant:"subtitle1",color:"textSecondary",sx:{mb:2},children:n.friendly_name||n.ble_name}),e.jsx(_e,{open:d||t||!1,onClose:()=>{j(!1),i&&i(!1),b(null)},onSave:N,editingCode:S}),e.jsxs(G,{expanded:y.has("permanent"),onChange:()=>{m(C=>{const h=new Set(C);return h.has("permanent")?h.delete("permanent"):h.add("permanent"),h})},elevation:0,sx:{backgroundColor:"transparent",width:"100%"},disableGutters:!0,children:[e.jsx(B,{expandIcon:e.jsx(F,{}),children:e.jsxs(A,{children:[s("permanent_codes")," (",k.length,p&&` / ${p.master} ${s("codes:on_device_count")}`,")"]})}),e.jsx(q,{sx:{padding:"0 0 0 0 !important"},children:e.jsx(Y,{codes:I("master"),deriveCodeMetadata:w,hasIndexConflict:T,onCopy:l,onEdit:$,onDelete:a})})]}),e.jsxs(G,{expanded:y.has("temporary"),onChange:()=>{m(C=>{const h=new Set(C);return h.has("temporary")?h.delete("temporary"):h.add("temporary"),h})},elevation:0,sx:{backgroundColor:"transparent",width:"100%"},disableGutters:!0,children:[e.jsx(B,{expandIcon:e.jsx(F,{}),children:e.jsxs(A,{children:[s("temporary_codes")," (",E.length,p&&` / ${p.single} ${s("codes:on_device_count")}`,")"]})}),e.jsx(q,{sx:{padding:"0 0 0 0 !important"},children:e.jsx(Y,{codes:I("temporary"),deriveCodeMetadata:w,onCopy:l,onEdit:$,onDelete:a})})]})]})},we=()=>{const t=me();if(!t)return null;const{showNotification:i,hideNotification:r}=t;return e.jsx(_,{sx:{p:2},children:e.jsx(Ee,{showNotification:i,hideNotification:r})})};export{we as CodeManagerWrapper};
