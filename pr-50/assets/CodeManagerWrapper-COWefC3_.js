import{e as se,j as e,f as W,n as ne,U as G,r as c,bl as u,b2 as F,a4 as re,a5 as de,a6 as le,a7 as ce,k as I,K as L,M as k,aT as ue,aU as xe,aV as pe,aW as N,a8 as me,l as P,bm as R,a2 as he,a3 as fe,T as w,bn as je,ay as q,aq as ye,a1 as ge,bo as Ce,i as be,bp as Ie,aX as K,aY as Y,am as H,aZ as X,aj as Z,o as ve}from"./index-BGP71L2G.js";import{I as Se,V as _e,a as Ee,A as ae}from"./VisibilityOff-Dht5nI_G.js";import{D as Te}from"./Delete-BrMWeND4.js";import{E as Ae}from"./Edit-CMZrKP1X.js";const De=se(e.jsx("path",{d:"m19 8-4 4h3c0 3.31-2.69 6-6 6-1.01 0-1.97-.25-2.8-.7l-1.46 1.46C8.97 19.54 10.43 20 12 20c4.42 0 8-3.58 8-8h3zM6 12c0-3.31 2.69-6 6-6 1.01 0 1.97.25 2.8.7l1.46-1.46C15.03 4.46 13.57 4 12 4c-4.42 0-8 3.58-8 8H1l4 4 4-4z"})),J=se(e.jsx("path",{d:"M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8m0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4z"})),we=t=>{const i=new Uint32Array(1);return crypto.getRandomValues(i),i[0]%t},Q=()=>{const t="0123456789AB";let i="";for(let r=0;r<6;r++)i+=t.charAt(we(t.length));return i},ke=t=>t?t.toUpperCase().replace(/[^0-9AB]/g,""):"",Me=({open:t,onClose:i,onSave:r,editingCode:o})=>{const{t:s}=W(["codes","common"]),{activeDevice:a}=ne(),x=!!a?.configuration_key,C=a?.role===G.Owner||a?.role===G.Admin,[d,v]=c.useState(u.MASTER),[j,m]=c.useState(""),[b,S]=c.useState(""),[y,g]=c.useState(0),[_,E]=c.useState(1),[T,h]=c.useState(!0);c.useEffect(()=>{if(t){const n=setTimeout(()=>{o?(v(o.type),m(o.code),S(o.name||o.description||""),g(o.index||0),E(o.uses||1)):(v(u.MASTER),m(Q()),S(""),g(0),E(1)),h(!0)},0);return()=>clearTimeout(n)}},[o,t]),c.useEffect(()=>{t&&a?.id&&d===u.MASTER&&F.loadCodes(a.id).then(n=>{const M=n.filter(l=>l.type===u.MASTER&&l.status!=="pending_delete").map(l=>l.index).filter(l=>l!==void 0),D=Math.max(...M,-1)+1;g(D)})},[t,a?.id,d]);const A=()=>{v(u.MASTER),m(""),S(""),g(0),E(1),i()},U=async()=>{const n=ke(j);if(m(n),d===u.MASTER&&a?.id){const D=(await F.loadCodes(a.id)).find(l=>l.type===u.MASTER&&l.index===y&&l.status!=="pending_delete"&&(!o||l.id!==o.id));if(D){r({type:d,code:n,name:b,index:y,maxUses:_},D.id),A();return}}r({type:d,code:n,name:b,index:y,maxUses:_},o?o.id:null),A()};return e.jsx(e.Fragment,{children:e.jsxs(re,{open:t,onClose:A,maxWidth:"sm",fullWidth:!0,children:[e.jsx(de,{children:s(o?"edit_code":"add_new")}),e.jsxs(le,{children:[!a?.configuration_key&&e.jsx(ce,{severity:"warning",sx:{mb:2},children:s("config_key_missing")}),e.jsxs(I,{sx:{display:"flex",flexDirection:"column",gap:2,mt:1},children:[e.jsxs(I,{sx:{display:"flex",gap:1},children:[e.jsx(L,{label:s("pin_label"),value:j,onChange:n=>m(n.currentTarget.value.trim().toUpperCase()),fullWidth:!0,type:T?"text":"password",inputProps:{maxLength:6,"data-testid":"code-pin-input"},InputProps:{endAdornment:e.jsx(Se,{position:"end",children:e.jsx(k,{"aria-label":"toggle code visibility",onClick:()=>h(!T),edge:"end",size:"small",children:T?e.jsx(_e,{}):e.jsx(Ee,{})})})}}),e.jsx(k,{onClick:()=>m(Q()),"aria-label":s("generate"),"data-testid":"generate-code-button",children:e.jsx(De,{})})]}),e.jsx(L,{label:s("description_label"),value:b,onChange:n=>S(n.currentTarget.value),placeholder:s("description_placeholder"),inputProps:{"data-testid":"code-name-input"},fullWidth:!0,required:!0}),e.jsxs(ue,{fullWidth:!0,children:[e.jsx(xe,{children:s("type_label")}),e.jsxs(pe,{value:d,onChange:n=>v(n.target.value),label:s("type_label"),"data-testid":"code-type-select",children:[(!C||C&&x)&&e.jsx(N,{value:u.MASTER,children:s("master_code")}),e.jsx(N,{value:u.SINGLE,children:s("single_use_code")}),e.jsx(N,{value:u.MULTI,children:s("multi_use_code")})]})]}),d===u.MASTER&&e.jsx(L,{label:`${s("index_label")}: ${y}`,type:"number",value:y,onChange:n=>g(parseInt(n.currentTarget.value)||0),fullWidth:!0,disabled:!C,inputProps:{min:0,max:255,"data-testid":"code-index-input"}}),d===u.MULTI&&e.jsx(L,{label:s("uses_label"),type:"number",value:_,onChange:n=>E(parseInt(n.currentTarget.value)||1),fullWidth:!0,inputProps:{min:1,max:3,"data-testid":"code-uses-input"}})]})]}),e.jsxs(me,{children:[e.jsx(P,{onClick:A,children:s("cancel")}),e.jsx(P,{onClick:U,variant:"contained","data-testid":"save-code-button",startIcon:e.jsx(ae,{}),disabled:!j||j.length!==6||b.trim()==="",children:s(o?"save":"generate")})]})]})})},Le=({code:t,metadata:i,onCopy:r,onEdit:o,onDelete:s})=>{const{t:a}=W("codes"),x=t.status===R.PENDING_DELETE,C=i.used,d=x||C;return e.jsxs(he,{divider:!0,"data-testid":`code-item-${t.code}`,"data-status":t.status,sx:{opacity:d?.6:1,backgroundColor:d?"action.selected":"inherit",textDecoration:d?"line-through":"none",borderLeft:"4px solid",borderLeftColor:t.status===R.ON_DEVICE?"primary.main":t.status===R.PENDING_ADD?"warning.main":t.status===R.PENDING_DELETE?"error.main":"default.main",pl:1},children:[e.jsx(fe,{primary:e.jsxs(I,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap"},children:[e.jsx(w,{variant:"body1",sx:{fontWeight:"bold"},children:t.name||t.description||a("unnamed")}),e.jsxs(w,{variant:"caption",sx:{ml:1},children:[a("pin_label"),": ",t.code]})]}),secondary:null,slotProps:{primary:{component:"div"},secondary:{component:"div"}}}),e.jsxs(je,{children:[e.jsx(q,{title:a("copy_code"),children:e.jsx(k,{edge:"end","aria-label":"copy",onClick:()=>r(t.code),children:e.jsx(ye,{})})}),e.jsx(q,{title:a("edit_description"),children:e.jsx(k,{edge:"end","aria-label":"edit",onClick:()=>o(t),"data-testid":`edit-code-${t.code}`,children:e.jsx(Ae,{})})}),e.jsx(k,{edge:"end","aria-label":"delete",onClick:()=>s(t.id),"data-testid":`delete-code-${t.code}`,children:e.jsx(Te,{})})]})]})},ee=({codes:t,deriveCodeMetadata:i,hasIndexConflict:r,onCopy:o,onEdit:s,onDelete:a})=>e.jsx(ge,{children:t.map(x=>e.jsx(Le,{code:x,metadata:i(x),hasIndexConflict:r?r(x.index,x.id):!1,onCopy:o,onEdit:s,onDelete:a},x.id))}),te={animation:"spin 1s linear infinite","@keyframes spin":{"0%":{transform:"rotate(0deg)"},"100%":{transform:"rotate(360deg)"}}},Re=({showAddForm:t,setShowAddForm:i,showNotification:r,hideNotification:o})=>{const{t:s}=W(["codes","common"]),{activeDevice:a}=ne(),{tasks:x,syncTasks:C}=Ce(),{isConnected:d}=be(),[v,j]=c.useState(!1),[m,b]=c.useState(new Set(["permanent","temporary"])),[S,y]=c.useState(null),[g,_]=c.useState(!1),E=a?.auto_sync??!1,T=x.filter(p=>p.status==="pending"&&p.deviceId===a?.id).length,h=!E&&T>0,{masterCodes:A,temporaryCodes:U,codeCount:n,refreshCodeCount:M,hasIndexConflict:D,handleAddCode:l,handleDeleteCode:$,deriveCodeMetadata:O,getFilteredCodes:B,handleCopyCode:V}=Ie(r),z=c.useCallback(p=>{y(p),j(!0)},[]),oe=async()=>{_(!0);try{h&&await C(),await M()}catch(p){console.error("Failed to refresh/sync:",p)}finally{_(!1)}},ie=()=>g?h?e.jsx(J,{sx:te}):e.jsx(Z,{sx:te}):h?e.jsx(J,{}):e.jsx(Z,{});return e.jsxs(I,{sx:{width:"100%"},children:[e.jsxs(I,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2},children:[e.jsxs(w,{variant:"h5",children:[s("title")," ",n&&`(Total: ${n.total})`]}),e.jsxs(I,{sx:{display:"flex",gap:1},children:[e.jsx(P,{variant:h?"contained":"outlined",color:h?"warning":"primary",startIcon:ie(),onClick:oe,disabled:!d||g,size:"small",children:h?s("sync_pending",{count:T}):s("refresh")}),e.jsx(k,{color:"primary",onClick:()=>j(!0),"aria-label":s("add_new"),"data-testid":"add-code-button",size:"small",children:e.jsx(ae,{})})]})]}),a&&e.jsx(w,{variant:"subtitle1",color:"textSecondary",sx:{mb:2},children:a.friendly_name||a.ble_name}),e.jsx(Me,{open:v||t||!1,onClose:()=>{j(!1),i&&i(!1),y(null)},onSave:l,editingCode:S}),e.jsxs(K,{expanded:m.has("permanent"),onChange:()=>{b(p=>{const f=new Set(p);return f.has("permanent")?f.delete("permanent"):f.add("permanent"),f})},elevation:0,sx:{backgroundColor:"transparent",width:"100%"},disableGutters:!0,children:[e.jsx(Y,{expandIcon:e.jsx(H,{}),children:e.jsxs(w,{children:[s("permanent_codes")," (",A.length,n&&` / ${n.master} ${s("codes:on_device_count")}`,")"]})}),e.jsx(X,{sx:{padding:"0 0 0 0 !important"},children:e.jsx(ee,{codes:B("master"),deriveCodeMetadata:O,hasIndexConflict:D,onCopy:V,onEdit:z,onDelete:$})})]}),e.jsxs(K,{expanded:m.has("temporary"),onChange:()=>{b(p=>{const f=new Set(p);return f.has("temporary")?f.delete("temporary"):f.add("temporary"),f})},elevation:0,sx:{backgroundColor:"transparent",width:"100%"},disableGutters:!0,children:[e.jsx(Y,{expandIcon:e.jsx(H,{}),children:e.jsxs(w,{children:[s("temporary_codes")," (",U.length,n&&` / ${n.single} ${s("codes:on_device_count")}`,")"]})}),e.jsx(X,{sx:{padding:"0 0 0 0 !important"},children:e.jsx(ee,{codes:B("temporary"),deriveCodeMetadata:O,onCopy:V,onEdit:z,onDelete:$})})]})]})},$e=()=>{const t=ve();if(!t)return null;const{showNotification:i,hideNotification:r}=t;return e.jsx(I,{sx:{p:2},children:e.jsx(Re,{showNotification:i,hideNotification:r})})};export{$e as CodeManagerWrapper};
