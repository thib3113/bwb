import{e as J,j as e,f as W,n as Q,U as B,r as c,bl as u,b2 as G,a4 as se,a5 as ne,a6 as ae,a7 as oe,k as _,K as R,M as w,aT as re,aU as ie,aV as de,aW as N,a8 as le,l as P,bm as U,a2 as ce,a3 as ue,T as D,bn as xe,ay as F,aq as pe,a1 as he,bo as me,bp as je,aj as fe,aX as q,aY as K,am as Y,aZ as H,o as ye}from"./index--t3H4OzX.js";import{I as ge,V as Ce,a as be,A as ee}from"./VisibilityOff-DmiSCgnK.js";import{D as ve}from"./Delete-BtavUVd5.js";import{E as Ie}from"./Edit-f553venk.js";const Se=J(e.jsx("path",{d:"m19 8-4 4h3c0 3.31-2.69 6-6 6-1.01 0-1.97-.25-2.8-.7l-1.46 1.46C8.97 19.54 10.43 20 12 20c4.42 0 8-3.58 8-8h3zM6 12c0-3.31 2.69-6 6-6 1.01 0 1.97.25 2.8.7l1.46-1.46C15.03 4.46 13.57 4 12 4c-4.42 0-8 3.58-8 8H1l4 4 4-4z"})),_e=J(e.jsx("path",{d:"M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8m0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4z"})),Ee=t=>{const r=new Uint32Array(1);return crypto.getRandomValues(r),r[0]%t},X=()=>{const t="0123456789AB";let r="";for(let i=0;i<6;i++)r+=t.charAt(Ee(t.length));return r},Te=t=>t?t.toUpperCase().replace(/[^0-9AB]/g,""):"",Ae=({open:t,onClose:r,onSave:i,editingCode:a})=>{const{t:s}=W(["codes","common"]),{activeDevice:n}=Q(),x=!!n?.configuration_key,C=n?.role===B.Owner||n?.role===B.Admin,[d,f]=c.useState(u.MASTER),[b,h]=c.useState(""),[E,v]=c.useState(""),[I,y]=c.useState(0),[k,S]=c.useState(1),[m,M]=c.useState(!0);c.useEffect(()=>{if(t){const o=setTimeout(()=>{a?(f(a.type),h(a.code),v(a.name||a.description||""),y(a.index||0),S(a.uses||1)):(f(u.MASTER),h(X()),v(""),y(0),S(1)),M(!0)},0);return()=>clearTimeout(o)}},[a,t]),c.useEffect(()=>{t&&n?.id&&d===u.MASTER&&G.loadCodes(n.id).then(o=>{const L=o.filter(l=>l.type===u.MASTER&&l.status!=="pending_delete").map(l=>l.index).filter(l=>l!==void 0),A=Math.max(...L,-1)+1;y(A)})},[t,n?.id,d]);const T=()=>{f(u.MASTER),h(""),v(""),y(0),S(1),r()},g=async()=>{const o=Te(b);if(h(o),d===u.MASTER&&n?.id){const A=(await G.loadCodes(n.id)).find(l=>l.type===u.MASTER&&l.index===I&&l.status!=="pending_delete"&&(!a||l.id!==a.id));if(A){i({type:d,code:o,name:E,index:I,maxUses:k},A.id),T();return}}i({type:d,code:o,name:E,index:I,maxUses:k},a?a.id:null),T()};return e.jsx(e.Fragment,{children:e.jsxs(se,{open:t,onClose:T,maxWidth:"sm",fullWidth:!0,children:[e.jsx(ne,{children:s(a?"edit_code":"add_new")}),e.jsxs(ae,{children:[!n?.configuration_key&&e.jsx(oe,{severity:"warning",sx:{mb:2},children:s("config_key_missing")}),e.jsxs(_,{sx:{display:"flex",flexDirection:"column",gap:2,mt:1},children:[e.jsxs(_,{sx:{display:"flex",gap:1},children:[e.jsx(R,{label:s("pin_label"),value:b,onChange:o=>h(o.currentTarget.value.trim().toUpperCase()),fullWidth:!0,type:m?"text":"password",inputProps:{maxLength:6,"data-testid":"code-pin-input"},InputProps:{endAdornment:e.jsx(ge,{position:"end",children:e.jsx(w,{"aria-label":"toggle code visibility",onClick:()=>M(!m),edge:"end",size:"small",children:m?e.jsx(Ce,{}):e.jsx(be,{})})})}}),e.jsx(w,{onClick:()=>h(X()),"aria-label":s("generate"),"data-testid":"generate-code-button",children:e.jsx(Se,{})})]}),e.jsx(R,{label:s("description_label"),value:E,onChange:o=>v(o.currentTarget.value),placeholder:s("description_placeholder"),inputProps:{"data-testid":"code-name-input"},fullWidth:!0,required:!0}),e.jsxs(re,{fullWidth:!0,children:[e.jsx(ie,{children:s("type_label")}),e.jsxs(de,{value:d,onChange:o=>f(o.target.value),label:s("type_label"),"data-testid":"code-type-select",children:[(!C||C&&x)&&e.jsx(N,{value:u.MASTER,children:s("master_code")}),e.jsx(N,{value:u.SINGLE,children:s("single_use_code")}),e.jsx(N,{value:u.MULTI,children:s("multi_use_code")})]})]}),d===u.MASTER&&e.jsx(R,{label:`${s("index_label")}: ${I}`,type:"number",value:I,onChange:o=>y(parseInt(o.currentTarget.value)||0),fullWidth:!0,disabled:!C,inputProps:{min:0,max:255,"data-testid":"code-index-input"}}),d===u.MULTI&&e.jsx(R,{label:s("uses_label"),type:"number",value:k,onChange:o=>S(parseInt(o.currentTarget.value)||1),fullWidth:!0,inputProps:{min:1,max:3,"data-testid":"code-uses-input"}})]})]}),e.jsxs(le,{children:[e.jsx(P,{onClick:T,children:s("cancel")}),e.jsx(P,{onClick:g,variant:"contained","data-testid":"save-code-button",startIcon:e.jsx(ee,{}),disabled:!b||b.length!==6||E.trim()==="",children:s(a?"save":"generate")})]})]})})},De=({code:t,metadata:r,onCopy:i,onEdit:a,onDelete:s})=>{const{t:n}=W("codes"),x=t.status===U.PENDING_DELETE,C=r.used,d=x||C;return e.jsxs(ce,{divider:!0,"data-testid":`code-item-${t.code}`,"data-status":t.status,sx:{opacity:d?.6:1,backgroundColor:d?"action.selected":"inherit",textDecoration:d?"line-through":"none",borderLeft:"4px solid",borderLeftColor:t.status===U.ON_DEVICE?"primary.main":t.status===U.PENDING_ADD?"warning.main":t.status===U.PENDING_DELETE?"error.main":"default.main",pl:1},children:[e.jsx(ue,{primary:e.jsxs(_,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap"},children:[e.jsx(D,{variant:"body1",sx:{fontWeight:"bold"},children:t.name||t.description||n("unnamed")}),e.jsxs(D,{variant:"caption",sx:{ml:1},children:[n("pin_label"),": ",t.code]})]}),secondary:null,slotProps:{primary:{component:"div"},secondary:{component:"div"}}}),e.jsxs(xe,{children:[e.jsx(F,{title:n("copy_code"),children:e.jsx(w,{edge:"end","aria-label":"copy",onClick:()=>i(t.code),children:e.jsx(pe,{})})}),e.jsx(F,{title:n("edit_description"),children:e.jsx(w,{edge:"end","aria-label":"edit",onClick:()=>a(t),"data-testid":`edit-code-${t.code}`,children:e.jsx(Ie,{})})}),e.jsx(w,{edge:"end","aria-label":"delete",onClick:()=>s(t.id),"data-testid":`delete-code-${t.code}`,children:e.jsx(ve,{})})]})]})},Z=({codes:t,deriveCodeMetadata:r,hasIndexConflict:i,onCopy:a,onEdit:s,onDelete:n})=>e.jsx(he,{children:t.map(x=>e.jsx(De,{code:x,metadata:r(x),hasIndexConflict:i?i(x.index,x.id):!1,onCopy:a,onEdit:s,onDelete:n},x.id))}),we=({showAddForm:t,setShowAddForm:r,showNotification:i,hideNotification:a})=>{const{t:s}=W(["codes","common"]),{activeDevice:n}=Q(),{tasks:x,syncTasks:C}=me(),[d,f]=c.useState(!1),[b,h]=c.useState(new Set(["permanent","temporary"])),[E,v]=c.useState(null),[I,y]=c.useState(!1),k=n?.auto_sync??!1,S=x.filter(p=>p.status==="pending"&&p.deviceId===n?.id).length,m=!k&&S>0,{masterCodes:M,temporaryCodes:T,codeCount:g,refreshCodeCount:o,hasIndexConflict:L,handleAddCode:A,handleDeleteCode:l,deriveCodeMetadata:$,getFilteredCodes:O,handleCopyCode:V}=je(i),z=c.useCallback(p=>{v(p),f(!0)},[]),te=async()=>{y(!0);try{m&&await C(),await o()}catch(p){console.error("Failed to refresh/sync:",p)}finally{y(!1)}};return e.jsxs(_,{sx:{width:"100%"},children:[e.jsxs(_,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2},children:[e.jsxs(D,{variant:"h5",children:[s("title")," ",g&&`(Total: ${g.total})`]}),e.jsxs(_,{sx:{display:"flex",gap:1},children:[e.jsx(P,{variant:m?"contained":"outlined",color:m?"warning":"primary",startIcon:m?e.jsx(_e,{}):e.jsx(fe,{}),onClick:te,disabled:I,size:"small",children:m?s("sync_pending",{count:S}):s("refresh")}),e.jsx(w,{color:"primary",onClick:()=>f(!0),"aria-label":s("add_new"),"data-testid":"add-code-button",size:"small",children:e.jsx(ee,{})})]})]}),n&&e.jsx(D,{variant:"subtitle1",color:"textSecondary",sx:{mb:2},children:n.friendly_name||n.ble_name}),e.jsx(Ae,{open:d||t||!1,onClose:()=>{f(!1),r&&r(!1),v(null)},onSave:A,editingCode:E}),e.jsxs(q,{expanded:b.has("permanent"),onChange:()=>{h(p=>{const j=new Set(p);return j.has("permanent")?j.delete("permanent"):j.add("permanent"),j})},elevation:0,sx:{backgroundColor:"transparent",width:"100%"},disableGutters:!0,children:[e.jsx(K,{expandIcon:e.jsx(Y,{}),children:e.jsxs(D,{children:[s("permanent_codes")," (",M.length,g&&` / ${g.master} ${s("codes:on_device_count")}`,")"]})}),e.jsx(H,{sx:{padding:"0 0 0 0 !important"},children:e.jsx(Z,{codes:O("master"),deriveCodeMetadata:$,hasIndexConflict:L,onCopy:V,onEdit:z,onDelete:l})})]}),e.jsxs(q,{expanded:b.has("temporary"),onChange:()=>{h(p=>{const j=new Set(p);return j.has("temporary")?j.delete("temporary"):j.add("temporary"),j})},elevation:0,sx:{backgroundColor:"transparent",width:"100%"},disableGutters:!0,children:[e.jsx(K,{expandIcon:e.jsx(Y,{}),children:e.jsxs(D,{children:[s("temporary_codes")," (",T.length,g&&` / ${g.single} ${s("codes:on_device_count")}`,")"]})}),e.jsx(H,{sx:{padding:"0 0 0 0 !important"},children:e.jsx(Z,{codes:O("temporary"),deriveCodeMetadata:$,onCopy:V,onEdit:z,onDelete:l})})]})]})},Ue=()=>{const t=ye();if(!t)return null;const{showNotification:r,hideNotification:i}=t;return e.jsx(_,{sx:{p:2},children:e.jsx(we,{showNotification:r,hideNotification:i})})};export{Ue as CodeManagerWrapper};
