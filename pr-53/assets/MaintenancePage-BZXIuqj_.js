import{g as R,a as P,r as m,u as b,j as s,c as O,b as k,s as A,e as E,f as w,T as h,n as I,z as T,A as D,a7 as M,k as U,P as L,a1 as B,a2 as N,a3 as z,l as j,aC as K,Y as S,aD as Y,aE as q}from"./index-CYtC7eEa.js";import{C as $}from"./Container-BvhT8KSO.js";import{L as F}from"./LinearProgress-cqVjclwp.js";function H(t){return R("MuiCardActions",t)}P("MuiCardActions",["root","spacing"]);const W=t=>{const{classes:e,disableSpacing:n}=t;return k({root:["root",!n&&"spacing"]},H,e)},G=A("div",{name:"MuiCardActions",slot:"Root",overridesResolver:(t,e)=>{const{ownerState:n}=t;return[e.root,!n.disableSpacing&&e.spacing]}})({display:"flex",alignItems:"center",padding:8,variants:[{props:{disableSpacing:!1},style:{"& > :not(style) ~ :not(style)":{marginLeft:8}}}]}),J=m.forwardRef(function(e,n){const a=b({props:e,name:"MuiCardActions"}),{disableSpacing:i=!1,className:c,...o}=a,l={...a,disableSpacing:i},r=W(l);return s.jsx(G,{className:O(r.root,c),ownerState:l,ref:n,...o})}),Q=E(s.jsx("path",{d:"M8 5v14l11-7z"})),V=E(s.jsx("path",{d:"M6 6h12v12H6z"})),X=({script:t})=>{const{t:e}=w("maintenance"),[n,a]=m.useState(!1),[i,c]=m.useState(0),[o,l]=m.useState([]),[r,p]=m.useState(null),{activeDevice:_}=I(),d=m.useRef(!1),u=async()=>{const x=Y.getInstance();if(x.getState()!=="connected"){p(e("status.not_connected"));return}const y=_?.configuration_key;if(!y){p(e("status.missing_config_key"));return}a(!0),c(0),l([]),p(null),d.current=!1;const C=g=>l(f=>[...f.slice(-4),g]);try{await t.run({setProgress:c,log:C,checkStop:()=>{if(d.current)throw new Error("STOPPED_BY_USER")},t:e},{bleService:x,configKey:y}),C(e("status.finished")),c(100)}catch(g){console.error(g);const f=g instanceof Error?g.message:String(g);f==="STOPPED_BY_USER"?C(e("status.stopped_user")):(p(e("status.error",{message:f})),C(e("status.error",{message:f})))}finally{a(!1)}};return s.jsxs(T,{sx:{mb:2},children:[s.jsxs(D,{children:[s.jsx(h,{variant:"h6",component:"div",children:e(t.titleKey)}),s.jsx(h,{sx:{mb:1.5},color:"text.secondary",children:e(t.descriptionKey)}),r&&s.jsx(M,{severity:"error",sx:{mb:2},children:r}),(n||o.length>0)&&s.jsxs(U,{sx:{width:"100%",mb:2},children:[s.jsx(F,{variant:"determinate",value:i}),s.jsx(h,{variant:"body2",color:"text.secondary",align:"right",children:e("progress",{percent:Math.round(i)})})]}),o.length>0&&s.jsx(L,{variant:"outlined",sx:{p:1,bgcolor:"background.default",maxHeight:100,overflow:"auto"},children:s.jsx(B,{dense:!0,disablePadding:!0,children:o.map((x,y)=>s.jsx(N,{disablePadding:!0,children:s.jsx(z,{primary:x,primaryTypographyProps:{variant:"caption",fontFamily:"monospace"}})},y))})})]}),s.jsx(J,{children:n?s.jsx(j,{size:"small",variant:"contained",color:"error",startIcon:s.jsx(V,{}),onClick:()=>{d.current=!0},children:e("stop")}):s.jsx(j,{size:"small",variant:"contained",startIcon:s.jsx(Q,{}),onClick:u,children:e("run")})})]})},v=async t=>{const e=new q,n=await t.sendRequest(e,{expectResponse:!0});if(n.opcode!==S.NOTIFY_CODES_COUNT)throw new Error(`Unexpected response opcode: 0x${n.opcode.toString(16)}`);if(n.payload.length<2)throw new Error("Invalid payload length for CODES_COUNT");return n.payload[0]<<8|n.payload[1]},Z={id:"clean_master_codes",titleKey:"scripts.clean_master_codes.title",descriptionKey:"scripts.clean_master_codes.description",run:async({setProgress:t,log:e,checkStop:n,t:a},{bleService:i,configKey:c})=>{e(a("status.fetching_count"));let o=await v(i);if(e(a("status.initial_count",{count:o})),o===0){e(a("status.no_codes"));return}const l=256;for(let r=0;r<l;r++){n();const p=r/l*100;for(t(p);;){n(),e(a("status.deleting_index",{index:r,count:o}));const _=new K(c,r);let d=!1;try{const u=await i.sendRequest(_,{expectResponse:!0},c);u.opcode===S.CODE_OPERATION_SUCCESS?(e(a("status.success_index",{index:r})),d=!0):u.opcode===S.CODE_OPERATION_ERROR&&(e(a("status.error_index",{index:r})),d=!1)}catch(u){const x=u instanceof Error?u.message:String(u);e(a("status.error",{message:`Index ${r}: ${x}`})),d=!1}if(!d)break}if(o=await v(i),o===0){e(a("status.stopping_early"));break}}}},ne=()=>{const{t}=w("maintenance");return s.jsxs($,{maxWidth:"sm",sx:{mt:2,pb:10},children:[s.jsx(h,{variant:"h4",gutterBottom:!0,children:t("title")}),s.jsx(h,{variant:"body2",color:"text.secondary",paragraph:!0,children:t("description")}),s.jsx(X,{script:Z})]})};export{ne as MaintenancePage};
