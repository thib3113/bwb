import{e as te,j as e,f as W,n as se,U as F,r as c,br as p,b6 as K,a6 as ie,a7 as de,a8 as le,a1 as ce,k as C,K as P,M as T,aU as xe,aV as ue,aW as pe,aX as Y,a9 as he,l as U,bs as R,a4 as me,a5 as fe,T as y,bt as je,a2 as q,as as ge,a3 as ye,bu as Ce,bv as be,bw as ve,i as Ie,bx as Se,aY as H,aZ as X,ao as Z,a_ as J,C as _e,al as Ee,o as De}from"./index-DWkX-YrG.js";import{I as Ae,V as Te,a as we,A as ne}from"./VisibilityOff-zaC4KvHW.js";import{L as ke}from"./Lock-BqVowUll.js";import{D as Le}from"./Delete-CEUKn-dA.js";import{E as Me}from"./Edit-DUvx8DuA.js";const Ne=te(e.jsx("path",{d:"m19 8-4 4h3c0 3.31-2.69 6-6 6-1.01 0-1.97-.25-2.8-.7l-1.46 1.46C8.97 19.54 10.43 20 12 20c4.42 0 8-3.58 8-8h3zM6 12c0-3.31 2.69-6 6-6 1.01 0 1.97.25 2.8.7l1.46-1.46C15.03 4.46 13.57 4 12 4c-4.42 0-8 3.58-8 8H1l4 4 4-4z"})),Re=te(e.jsx("path",{d:"M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8m0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4z"})),Pe=t=>{const r=new Uint32Array(1);return crypto.getRandomValues(r),r[0]%t},Q=()=>{const t="0123456789AB";let r="";for(let i=0;i<6;i++)r+=t.charAt(Pe(t.length));return r},Ue=t=>t?t.toUpperCase().replace(/[^0-9AB]/g,""):"",We=({open:t,onClose:r,onSave:i,editingCode:a})=>{const{t:s}=W(["codes","common"]),{activeDevice:n}=se(),x=!!n?.configuration_key,b=n?.role===F.Owner||n?.role===F.Admin,[l,v]=c.useState(p.SINGLE),[I,f]=c.useState(""),[S,_]=c.useState(""),[h,j]=c.useState(0),[w,k]=c.useState(1),[E,M]=c.useState(!0);c.useEffect(()=>{if(t){const o=setTimeout(()=>{a?(v(a.type),f(a.code),_(a.name||a.description||""),j(a.index||0),k(a.uses||1)):(v(p.SINGLE),f(Q()),_(""),j(0),k(1)),M(!0)},0);return()=>clearTimeout(o)}},[a,t]),c.useEffect(()=>{t&&n?.id&&l===p.MASTER&&K.loadCodes(n.id).then(o=>{const N=o.filter(d=>d.type===p.MASTER&&d.status!=="pending_delete").map(d=>d.index).filter(d=>d!==void 0),A=Math.max(...N,-1)+1;j(A)})},[t,n?.id,l]);const D=()=>{v(p.SINGLE),f(""),_(""),j(0),k(1),r()},g=async()=>{const o=Ue(I);if(f(o),l===p.MASTER&&n?.id){const A=(await K.loadCodes(n.id)).find(d=>d.type===p.MASTER&&d.index===h&&d.status!=="pending_delete"&&(!a||d.id!==a.id));if(A){i({type:l,code:o,name:S,index:h,maxUses:w},A.id),D();return}}i({type:l,code:o,name:S,index:h,maxUses:w},a?a.id:null),D()};return e.jsx(e.Fragment,{children:e.jsxs(ie,{open:t,onClose:D,maxWidth:"sm",fullWidth:!0,children:[e.jsx(de,{children:s(a?"edit_code":"add_new")}),e.jsxs(le,{children:[!n?.configuration_key&&e.jsx(ce,{severity:"warning",sx:{mb:2},children:s("config_key_missing")}),e.jsxs(C,{sx:{display:"flex",flexDirection:"column",gap:2,mt:1},children:[e.jsxs(C,{sx:{display:"flex",gap:1},children:[e.jsx(P,{label:s("pin_label"),value:I,onChange:o=>f(o.currentTarget.value.trim().toUpperCase()),fullWidth:!0,type:E?"text":"password",inputProps:{maxLength:6,"data-testid":"code-pin-input"},InputProps:{endAdornment:e.jsx(Ae,{position:"end",children:e.jsx(T,{"aria-label":"toggle code visibility",onClick:()=>M(!E),edge:"end",size:"small",children:E?e.jsx(Te,{}):e.jsx(we,{})})})}}),e.jsx(T,{onClick:()=>f(Q()),"aria-label":s("generate"),"data-testid":"generate-code-button",children:e.jsx(Ne,{})})]}),e.jsx(P,{label:s("description_label"),value:S,onChange:o=>_(o.currentTarget.value),placeholder:s("description_placeholder"),inputProps:{"data-testid":"code-name-input"},fullWidth:!0,required:!0}),e.jsxs(xe,{fullWidth:!0,children:[e.jsx(ue,{children:s("type_label")}),e.jsxs(pe,{value:l,onChange:o=>v(o.target.value),label:s("type_label"),"data-testid":"code-type-select",children:[(!b||b&&x)&&e.jsx(Y,{value:p.MASTER,"data-testid":"option-master",children:s("master_code")}),e.jsx(Y,{value:p.SINGLE,"data-testid":"option-single",children:s("single_use_code")})]})]}),l===p.MASTER&&e.jsx(P,{label:`${s("index_label")}: ${h}`,type:"number",value:h,onChange:o=>j(parseInt(o.currentTarget.value)||0),fullWidth:!0,disabled:!b,inputProps:{min:0,max:255,"data-testid":"code-index-input"}})]})]}),e.jsxs(he,{children:[e.jsx(U,{onClick:D,children:s("cancel")}),e.jsx(U,{onClick:g,variant:"contained","data-testid":"save-code-button",startIcon:e.jsx(ne,{}),disabled:!I||I.length!==6||S.trim()==="",children:s(a?"save":"generate")})]})]})})},Be=({code:t,metadata:r,onCopy:i,onEdit:a,onDelete:s})=>{const{t:n}=W("codes"),x=t.status===R.PENDING_DELETE,b=r.used,l=x||b;return e.jsxs(me,{divider:!0,"data-testid":`code-item-${t.code}`,"data-status":t.status,sx:{opacity:l?.6:1,backgroundColor:l?"action.selected":"inherit",textDecoration:l?"line-through":"none",borderLeft:"4px solid",borderLeftColor:t.status===R.ON_DEVICE?"primary.main":t.status===R.PENDING_ADD?"warning.main":t.status===R.PENDING_DELETE?"error.main":"default.main",pl:1},children:[e.jsx(fe,{primary:e.jsxs(C,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap"},children:[e.jsx(y,{variant:"body1",sx:{fontWeight:"bold"},children:t.name||t.description||n("unnamed")}),e.jsxs(y,{variant:"caption",sx:{ml:1},children:[n("pin_label"),": ",t.code]})]}),secondary:null,slotProps:{primary:{component:"div"},secondary:{component:"div"}}}),e.jsxs(je,{children:[e.jsx(q,{title:n("copy_code"),children:e.jsx(T,{edge:"end","aria-label":"copy",onClick:()=>i(t.code),children:e.jsx(ge,{})})}),e.jsx(q,{title:n("edit_description"),children:e.jsx(T,{edge:"end","aria-label":"edit",onClick:()=>a(t),"data-testid":`edit-code-${t.code}`,children:e.jsx(Me,{})})}),e.jsx(T,{edge:"end","aria-label":"delete",onClick:()=>s(t.id),"data-testid":`delete-code-${t.code}`,children:e.jsx(Le,{})})]})]})},ee=({codes:t,deriveCodeMetadata:r,hasIndexConflict:i,onCopy:a,onEdit:s,onDelete:n})=>e.jsx(ye,{children:t.map(x=>e.jsx(Be,{code:x,metadata:r(x),hasIndexConflict:i?i(x.index,x.id):!1,onCopy:a,onEdit:s,onDelete:n},x.id))}),$e=({showAddForm:t,setShowAddForm:r,showNotification:i,hideNotification:a})=>{const{t:s}=W(["codes","common"]),{activeDevice:n,isSyncingCodes:x}=se(),{isRestricted:b}=Ce(),{tasks:l,syncTasks:v,isProcessing:I}=be(),{isSyncingLogs:f}=ve(),{isConnected:S}=Ie(),[_,h]=c.useState(!1),[j,w]=c.useState(new Set(["permanent","temporary"])),[k,E]=c.useState(null),{masterCodes:M,temporaryCodes:D,codeCount:g,refreshCodeCount:o,hasIndexConflict:N,handleAddCode:A,handleDeleteCode:d,deriveCodeMetadata:B,getFilteredCodes:$,handleCopyCode:G}=Se(i),ae=n?.auto_sync??!1,O=l.filter(u=>u.status==="pending"&&u.deviceId===n?.id).length,L=!ae&&O>0,V=I||f||x,z=c.useCallback(u=>{E(u),h(!0)},[]),oe=async()=>{try{L&&await v(),await o()}catch(u){console.error("Failed to refresh/sync:",u)}},re=()=>V?e.jsx(_e,{size:20,color:"inherit"}):L?e.jsx(Re,{}):e.jsx(Ee,{});return b?e.jsxs(C,{"data-testid":"feature-blocked-screen",sx:{width:"100%",p:4,textAlign:"center",display:"flex",flexDirection:"column",alignItems:"center"},children:[e.jsx(ke,{sx:{fontSize:60,color:"text.secondary",mb:2}}),e.jsx(y,{variant:"h5",gutterBottom:!0,color:"text.secondary",children:s("common:feature_disabled")}),e.jsx(y,{variant:"body1",color:"text.secondary",sx:{maxWidth:400},children:s("common:errors.version.feature_restricted_message",{feature:s("codes:title")})})]}):e.jsxs(C,{sx:{width:"100%"},children:[e.jsxs(C,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2},children:[e.jsxs(y,{variant:"h5","data-testid":"code-stats",children:[s("title")," ",g&&`(Total: ${g.total})`]}),e.jsxs(C,{sx:{display:"flex",gap:1},children:[e.jsx(U,{variant:L?"contained":"outlined",color:L?"warning":"primary",startIcon:re(),onClick:oe,disabled:!S||V,size:"small",children:L?s("sync_pending",{count:O}):s("refresh")}),e.jsx(T,{color:"primary",onClick:()=>h(!0),"aria-label":s("add_new"),"data-testid":"add-code-button",size:"small",children:e.jsx(ne,{})})]})]}),n&&e.jsx(y,{variant:"subtitle1",color:"textSecondary",sx:{mb:2},children:n.friendly_name||n.ble_name}),e.jsx(We,{open:_||t||!1,onClose:()=>{h(!1),r&&r(!1),E(null)},onSave:A,editingCode:k}),e.jsxs(H,{expanded:j.has("permanent"),onChange:()=>{w(u=>{const m=new Set(u);return m.has("permanent")?m.delete("permanent"):m.add("permanent"),m})},elevation:0,sx:{backgroundColor:"transparent",width:"100%"},disableGutters:!0,children:[e.jsx(X,{expandIcon:e.jsx(Z,{}),children:e.jsxs(y,{children:[s("permanent_codes")," (",M.length,g&&` / ${g.master} ${s("codes:on_device_count")}`,")"]})}),e.jsx(J,{sx:{padding:"0 0 0 0 !important"},children:e.jsx(ee,{codes:$("master"),deriveCodeMetadata:B,hasIndexConflict:N,onCopy:G,onEdit:z,onDelete:d})})]}),e.jsxs(H,{expanded:j.has("temporary"),onChange:()=>{w(u=>{const m=new Set(u);return m.has("temporary")?m.delete("temporary"):m.add("temporary"),m})},elevation:0,sx:{backgroundColor:"transparent",width:"100%"},disableGutters:!0,children:[e.jsx(X,{expandIcon:e.jsx(Z,{}),children:e.jsxs(y,{children:[s("temporary_codes")," (",D.length,g&&` / ${g.single} ${s("codes:on_device_count")}`,")"]})}),e.jsx(J,{sx:{padding:"0 0 0 0 !important"},children:e.jsx(ee,{codes:$("temporary"),deriveCodeMetadata:B,onCopy:G,onEdit:z,onDelete:d})})]})]})},Ke=()=>{const t=De();if(!t)return null;const{showNotification:r,hideNotification:i}=t;return e.jsx(C,{sx:{p:2},children:e.jsx($e,{showNotification:r,hideNotification:i})})};export{Ke as CodeManagerWrapper};
