import{h as $,b as e,g as J,a as ee,D as te,u as ne,f as M,c as ae,l as w,Q as O,d as se,s as G,e as me,R as he,U as fe,i as q,q as K,t as E,V as pe,T as b,I as _e,H as ve,F as ye,o as v,W as P,X as be,Y as H,Z as Ie,$ as Re,C as re,n as k,a0 as Ce,a1 as Te,a2 as Se,a3 as N,a4 as L,a5 as we,a6 as x,a7 as Ee,a8 as V,a9 as Ae,aa as xe,ab as ie,ac as oe,ad as le,ae as W,af as ke,ag as De,ah as Ne,ai as U,aj as Fe,k as Le,r as Oe,v as Ue}from"./index-CTlfncBf.js";import{I as j,V as Q,a as Z,A as Pe}from"./VisibilityOff-DvfjrdKX.js";import{D as Ge}from"./Delete-C6AoKJAI.js";import{T as Me,a as z}from"./Tabs-CJs_rNSo.js";const Ve=$(e("path",{d:"M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"}));function ze(t){return J("MuiAvatar",t)}ee("MuiAvatar",["root","colorDefault","circular","rounded","square","img","fallback"]);const Be=t=>{const{classes:a,variant:n,colorDefault:s}=t;return se({root:["root",n,s&&"colorDefault"],img:["img"],fallback:["fallback"]},ze,a)},Ye=G("div",{name:"MuiAvatar",slot:"Root",overridesResolver:(t,a)=>{const{ownerState:n}=t;return[a.root,a[n.variant],n.colorDefault&&a.colorDefault]}})(me(({theme:t})=>({position:"relative",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0,width:40,height:40,fontFamily:t.typography.fontFamily,fontSize:t.typography.pxToRem(20),lineHeight:1,borderRadius:"50%",overflow:"hidden",userSelect:"none",variants:[{props:{variant:"rounded"},style:{borderRadius:(t.vars||t).shape.borderRadius}},{props:{variant:"square"},style:{borderRadius:0}},{props:{colorDefault:!0},style:{color:(t.vars||t).palette.background.default,...t.vars?{backgroundColor:t.vars.palette.Avatar.defaultBg}:{backgroundColor:t.palette.grey[400],...t.applyStyles("dark",{backgroundColor:t.palette.grey[600]})}}}]}))),He=G("img",{name:"MuiAvatar",slot:"Img"})({width:"100%",height:"100%",textAlign:"center",objectFit:"cover",color:"transparent",textIndent:1e4}),Xe=G(Ve,{name:"MuiAvatar",slot:"Fallback"})({width:"75%",height:"75%"});function $e({crossOrigin:t,referrerPolicy:a,src:n,srcSet:s}){const[o,d]=w(!1);return O(()=>{if(!n&&!s)return;d(!1);let u=!0;const l=new Image;return l.onload=()=>{u&&d("loaded")},l.onerror=()=>{u&&d("error")},l.crossOrigin=t,l.referrerPolicy=a,l.src=n,s&&(l.srcset=s),()=>{u=!1}},[t,a,n,s]),o}const qe=te(function(a,n){const s=ne({props:a,name:"MuiAvatar"}),{alt:o,children:d,className:u,component:l="div",slots:i={},slotProps:_={},imgProps:p,sizes:y,src:I,srcSet:T,variant:S="circular",...c}=s;let g=null;const h={...s,component:l,variant:S},f=$e({...p,...typeof _.img=="function"?_.img(h):_.img,src:I,srcSet:T}),R=I||T,A=R&&f!=="error";h.colorDefault=!A,delete h.ownerState;const D=Be(h),[r,C]=M("root",{ref:n,className:ae(D.root,u),elementType:Ye,externalForwardedProps:{slots:i,slotProps:_,component:l,...c},ownerState:h}),[F,de]=M("img",{className:D.img,elementType:He,externalForwardedProps:{slots:i,slotProps:{img:{...p,..._.img}}},additionalProps:{alt:o,src:I,srcSet:T,sizes:y},ownerState:h}),[ue,ge]=M("fallback",{className:D.fallback,elementType:Xe,externalForwardedProps:{slots:i,slotProps:_},shouldForwardComponentProp:!0,ownerState:h});return A?g=e(F,{...de}):d||d===0?g=d:R&&o?g=o[0]:g=e(ue,{...ge}),e(r,{...C,children:g})});function Ke(t){return J("MuiListItemAvatar",t)}ee("MuiListItemAvatar",["root","alignItemsFlexStart"]);const We=t=>{const{alignItems:a,classes:n}=t;return se({root:["root",a==="flex-start"&&"alignItemsFlexStart"]},Ke,n)},je=G("div",{name:"MuiListItemAvatar",slot:"Root",overridesResolver:(t,a)=>{const{ownerState:n}=t;return[a.root,n.alignItems==="flex-start"&&a.alignItemsFlexStart]}})({minWidth:56,flexShrink:0,variants:[{props:{alignItems:"flex-start"},style:{marginTop:8}}]}),Qe=te(function(a,n){const s=ne({props:a,name:"MuiListItemAvatar"}),{className:o,...d}=s,u=he(fe),l={...s,alignItems:u.alignItems},i=We(l);return e(je,{className:ae(i.root,o),ownerState:l,ref:n,...d})}),Ze=$(e("path",{d:"M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20z"})),Je=$(e("path",{d:"M20 2H4c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2m0 18H4V4h16zM18 6h-5c-1.1 0-2 .9-2 2v2.28c-.6.35-1 .98-1 1.72 0 1.1.9 2 2 2s2-.9 2-2c0-.74-.4-1.38-1-1.72V8h3v8H8V8h2V6H6v12h12z"})),X=(t,a)=>{if(!t||!a)return 0;const n=t.replace(/[^0-9.]/g,""),s=a.replace(/[^0-9.]/g,""),o=n.split(".").map(Number),d=s.split(".").map(Number);for(let u=0;u<Math.max(o.length,d.length);u++){const l=o[u]||0,i=d[u]||0;if(l>i)return 1;if(l<i)return-1}return 0},et=({deviceId:t})=>{const{t:a}=q(["common","settings"]),{activeDevice:n,updateDeviceDetails:s,removeDevice:o,toggleLaPoste:d}=K(),[u,l]=E(w(!1),"isTogglingLaPoste"),[i,_]=E(w({key:!n?.configuration_key,pin:!n?.door_pin_code}),"visibleFields"),[p,y]=E(w(n?.friendly_name||""),"deviceName"),[I,T]=E(w(n?.configuration_key||""),"configurationKey"),[S,c]=E(w(n?.door_pin_code||""),"doorPinCode");pe.useEffect(()=>{n&&(y(n.friendly_name||""),T(n.configuration_key||""),c(n.door_pin_code||""))},[n]);const g=r=>{_(C=>({...C,[r]:!C[r]}))},h=async()=>{if(n)try{await s(t,{friendly_name:p,configuration_key:I,door_pin_code:S})}catch(r){console.error("Failed to update device details:",r)}},f=async r=>{l(!0);try{await d(r.target.checked)}catch(C){console.error("Failed to toggle La Poste:",C)}finally{l(!1)}},R=async()=>{if(n)try{await o(t)}catch(r){console.error("Failed to remove device:",r)}},A=r=>{const F=r.trim().toUpperCase().replace(/[^0-9A-F]/g,"").slice(-8);T(F)},D=r=>{const C=r.trim().toUpperCase();c(C)};return n?e(v,{sx:{my:2},children:[e(b,{variant:"subtitle1",gutterBottom:!0,children:a("devices.title")}),e(_e,{sx:{mb:2}}),e(ve,{children:e(ye,{children:e(v,{sx:{display:"flex",flexDirection:"column",gap:2},children:[e(P,{label:a("devices.device_name"),value:p,onChange:r=>y(r.currentTarget.value),fullWidth:!0,size:"small"}),n.role===be.Admin&&e(P,{label:a("settings:configuration_key.label"),value:I,onChange:r=>A(r.currentTarget.value),fullWidth:!0,size:"small",type:i.key?"text":"password",helperText:a("settings:configuration_key.helper"),slotProps:{input:{endAdornment:e(j,{position:"end",children:e(H,{"aria-label":a("settings:toggle_key_visibility"),onClick:()=>g("key"),edge:"end",size:"small",children:i.key?e(Q,{}):e(Z,{})})})}}}),e(P,{label:a("settings:door_pin_code"),value:S,onChange:r=>D(r.currentTarget.value),fullWidth:!0,size:"small",type:i.pin?"text":"password",slotProps:{input:{endAdornment:e(j,{position:"end",children:e(H,{"aria-label":a("settings:toggle_pin_visibility"),onClick:()=>g("pin"),edge:"end",size:"small",children:i.pin?e(Q,{}):e(Z,{})})})}}}),n.hardware_version==="4.0"&&n.software_revision&&X(n.software_revision,"4.2.0")>=0&&e(v,{sx:{display:"flex",alignItems:"center"},children:[e(Ie,{control:e(Re,{"data-testid":"la-poste-switch",checked:n.la_poste_activated||!1,onChange:f,disabled:u}),label:a("settings:activate_la_poste")}),u&&e(re,{size:20,sx:{ml:1}})]}),e(v,{sx:{display:"flex",justifyContent:"space-between",mt:2},children:[e(k,{size:"small",color:"error",variant:"outlined",onClick:R,children:a("devices.forget")}),e(k,{size:"small",variant:"contained",onClick:h,children:a("save")})]})]})})})]}):null};var ce=(t=>(t[t.LA_POSTE=1]="LA_POSTE",t[t.VIGIK_TERTIARY=2]="VIGIK_TERTIARY",t[t.USER_BADGE=3]="USER_BADGE",t))(ce||{}),m=(t=>(t.IDLE="idle",t.SCANNING="scanning",t.FOUND="found",t.TIMEOUT="timeout",t.ERROR_EXISTS="error_exists",t.ERROR="error",t))(m||{});const tt=()=>{const{activeDevice:t}=K(),{sendRequest:a}=Ce(),{addListener:n,removeListener:s}=Te(),[o,d]=E(w(m.IDLE),"scanStatus"),[u,l]=E(w(null),"scannedUid"),i=t?.id,_=Se(()=>i?N.nfc_tags.where("device_id").equals(i).toArray():[],[i]),p=L(async()=>{if(!i)throw new Error("No active device");const c=await N.device_secrets.get(i);if(!c?.configuration_key)throw new Error("Configuration Key required");return c.configuration_key},[i]),y=L(async()=>{try{const c=await p();d(m.SCANNING),l(null),await a(new we(c))}catch(c){console.error("Failed to start scan",c),d(m.ERROR)}},[p,a]);O(()=>{const c=g=>{if(!(o!==m.SCANNING&&o!==m.IDLE)&&[x.NOTIFY_NFC_TAG_REGISTER_SCAN_RESULT,x.NOTIFY_NFC_TAG_REGISTER_SCAN_ERROR_EXISTS,x.NOTIFY_NFC_TAG_REGISTER_SCAN_TIMEOUT].includes(g.opcode)){const h=new Ee(g.opcode);switch(h.parse(g.payload),h.status){case V.TIMEOUT:d(m.TIMEOUT);break;case V.ALREADY_EXISTS:d(m.ERROR_EXISTS),h.uid&&l(h.uid);break;case V.FOUND:d(m.FOUND),h.uid&&l(h.uid);break;default:d(m.ERROR)}}};return n(x.NOTIFY_NFC_TAG_REGISTER_SCAN_RESULT,c),n(x.NOTIFY_NFC_TAG_REGISTER_SCAN_ERROR_EXISTS,c),n(x.NOTIFY_NFC_TAG_REGISTER_SCAN_TIMEOUT,c),()=>{s(x.NOTIFY_NFC_TAG_REGISTER_SCAN_RESULT,c),s(x.NOTIFY_NFC_TAG_REGISTER_SCAN_ERROR_EXISTS,c),s(x.NOTIFY_NFC_TAG_REGISTER_SCAN_TIMEOUT,c)}},[n,s,o]);const I=L(async c=>{if(!(!u||!i))try{const g=await p(),h=new Uint8Array(u.split(":").map(R=>parseInt(R,16)));if(o===m.FOUND){const R=new Ae(g,h);await a(R)}const f=await N.nfc_tags.where({device_id:i,uid:u}).first();f?await N.nfc_tags.update(f.id,{name:c,updated_at:Date.now()}):await N.nfc_tags.add({id:crypto.randomUUID(),device_id:i,uid:u,name:c,type:ce.USER_BADGE,created_at:Date.now(),sync_status:"created"}),d(m.IDLE),l(null)}catch(g){throw console.error("Failed to register tag",g),g}},[u,i,p,a,o]),T=L(async c=>{if(i)try{const g=await p(),h=new Uint8Array(c.uid.split(":").map(R=>parseInt(R,16))),f=new xe(g,h);await a(f),await N.nfc_tags.delete(c.id)}catch(g){throw console.error("Failed to unregister tag",g),g}},[i,p,a]),S=L(()=>{d(m.IDLE),l(null)},[]);return{tags:_,scanStatus:o,scannedUid:u,startScan:y,registerTag:I,unregisterTag:T,resetScan:S}},nt=()=>{const{t}=q(["common","settings"]),a=t,{tags:n,scanStatus:s,scannedUid:o,startScan:d,registerTag:u,unregisterTag:l,resetScan:i}=tt(),[_,p]=E(w(!1),"openAddDialog"),[y,I]=E(w(""),"tagName"),T=()=>{i(),I(""),p(!0)},S=()=>{p(!1),i()},c=()=>{d()},g=async()=>{if(y.trim())try{await u(y.trim()),S()}catch(f){console.error(f)}},h=async f=>{if(confirm(a("common:confirm_delete")))try{await l(f)}catch(R){console.error(R),alert(t("settings:nfc.error_delete_failed"))}};return O(()=>{o&&!y&&I(`Badge ${o.substring(0,5)}`)},[o,y]),e(v,{sx:{p:2},children:[e(v,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2},children:[e(b,{variant:"h6",children:t("settings:nfc.title")}),e(k,{variant:"contained",startIcon:e(Pe,{}),onClick:T,children:t("settings:nfc.add_tag")})]}),n&&n.length>0?e(ie,{children:n.map(f=>e(oe,{secondaryAction:e(H,{edge:"end","aria-label":"delete",onClick:()=>h(f),children:e(Ge,{})}),children:[e(Qe,{children:e(qe,{children:e(Je,{})})}),e(le,{primary:f.name,secondary:e(W,{children:[e(b,{component:"span",variant:"body2",color:"textPrimary",children:f.uid}),e("br",{}),f.last_seen_at?t("settings:nfc.last_seen",{date:new Date(f.last_seen_at).toLocaleString()}):t("settings:nfc.never_seen")]})})]},f.id))}):e(b,{variant:"body1",color:"textSecondary",align:"center",sx:{mt:4},children:t("settings:nfc.no_tags")}),e(ke,{open:_,onClose:S,fullWidth:!0,maxWidth:"sm",children:[e(De,{children:t("settings:nfc.dialog_title")}),e(Ne,{children:e(v,{sx:{display:"flex",flexDirection:"column",alignItems:"center",gap:2,py:2},children:[s===m.IDLE&&e(b,{children:t("settings:nfc.instructions_idle")}),s===m.SCANNING&&e(W,{children:[e(re,{}),e(b,{children:t("settings:nfc.instructions_scanning")})]}),s===m.TIMEOUT&&e(U,{severity:"warning",children:t("settings:nfc.error_timeout")}),s===m.ERROR&&e(U,{severity:"error",children:t("settings:nfc.error_generic")}),s===m.ERROR_EXISTS&&e(U,{severity:"info",children:[t("settings:nfc.error_exists"),o&&e(v,{sx:{mt:1},children:[e(b,{variant:"caption",children:["UID: ",o]}),e(b,{children:t("settings:nfc.instructions_exists_local")})]})]}),(s===m.FOUND||s===m.ERROR_EXISTS)&&o&&e(v,{sx:{width:"100%",mt:2},children:[e(U,{severity:"success",sx:{mb:2},children:t("settings:nfc.tag_found",{uid:o})}),e(P,{autoFocus:!0,margin:"dense",label:t("settings:nfc.input_label"),fullWidth:!0,value:y,onChange:f=>I(f.target.value)})]})]})}),e(Fe,{children:[e(k,{onClick:S,children:t("common:cancel")}),s===m.IDLE||s===m.TIMEOUT||s===m.ERROR?e(k,{onClick:c,variant:"contained",children:t("settings:nfc.button_start_scan")}):null,(s===m.FOUND||s===m.ERROR_EXISTS)&&e(k,{onClick:g,variant:"contained",disabled:!y,children:t("settings:nfc.add_tag")})]})]})]})};function B(t){const{children:a,value:n,index:s,...o}=t;return e("div",{role:"tabpanel",hidden:n!==s,id:`my-boks-tabpanel-${s}`,"aria-labelledby":`my-boks-tab-${s}`,...o,children:n===s&&e(v,{sx:{p:3},children:a})})}function Y(t){return{id:`my-boks-tab-${t}`,"aria-controls":`my-boks-tabpanel-${t}`}}const ot=()=>{const{t}=q(["common","codes","logs","settings"]),{activeDevice:a,knownDevices:n,setActiveDevice:s}=K(),{isConnected:o}=Le(),{showNotification:d}=Oe(),u=Ue(),[l,i]=E(w(0),"value"),[_,p]=E(w(null),"selectedDeviceId");O(()=>{const C=new URLSearchParams(u.search).get("tab"),F=setTimeout(()=>{switch(C){case"settings":i(0);break;case"users":i(1);break;default:i(0);break}},0);return()=>clearTimeout(F)},[u.search]),O(()=>{(!a||!n.some(r=>r.id===a.id))&&_!==null&&setTimeout(()=>p(null),0)},[a,n,_]);const y=r=>a?.software_revision?X(a.software_revision,r)>=0:!1,I=r=>a?.hardware_version?X(a.hardware_version,r)>=0:!1,T=y("4.3.3"),S=I("4.0"),c=T&&S,g=(r,C)=>{if(C===2){if(!S){d("Version Hardware 4.0 required","warning");return}if(!T){d("Version Firmware 4.3.3 required","warning");return}}i(C)},h=r=>{p(r),s(r)},f=()=>{p(null),s(null)},R=n.length>1&&!_&&!a;let A=t("common:my_boks");return a&&n.length===1||a&&n.length>1?A=a.friendly_name||a.ble_name:!a&&n.length===1&&(A=n[0].friendly_name||n[0].ble_name),R?e(v,{sx:{p:3},children:[e(b,{variant:"h5",gutterBottom:!0,children:t("common:my_boks")}),e(ie,{children:n.map(r=>e(oe,{onClick:()=>h(r.id),sx:{cursor:"pointer"},children:e(le,{primary:r.friendly_name||r.ble_name,secondary:r.ble_name})},r.id))})]}):a||n.find(r=>r.id===_)||(n.length===1?n[0]:null)?e(v,{sx:{width:"100%"},children:[e(v,{sx:{p:3,borderBottom:1,borderColor:"divider"},children:[n.length>1&&e(k,{startIcon:e(Ze,{}),onClick:f,sx:{mb:1},children:t("common:back_to_list")}),e(b,{variant:"h4",component:"h1",gutterBottom:!0,children:A}),e(b,{variant:"subtitle1",color:"textSecondary",children:t(o?"common:connected":"common:disconnected")})]}),e(v,{sx:{borderBottom:1,borderColor:"divider"},children:e(Me,{value:l,onChange:g,"aria-label":"my boks tabs",children:[e(z,{"data-testid":"tab-settings",label:t("settings:title"),...Y(0)}),e(z,{"data-testid":"tab-users",label:t("common:users.title"),...Y(1)}),e(z,{"data-testid":"tab-nfc",label:"Tags NFC",...Y(2),sx:{opacity:c?1:.5}})]})}),e(B,{value:l,index:0,children:e(et,{deviceId:a?.id||""})}),e(B,{value:l,index:1,children:e(v,{sx:{p:3},children:[e(b,{variant:"h6",children:t("common:users.title")}),e(b,{variant:"body1",color:"textSecondary",children:t("common:coming_soon")})]})}),e(B,{value:l,index:2,children:c?e(nt,{}):e(v,{sx:{p:3},children:"Feature Unavailable"})})]}):e(v,{sx:{p:3},children:[e(b,{variant:"h5",children:t("common:my_boks")}),e(b,{variant:"body1",color:"textSecondary",children:t("common:no_active_device")})]})};export{ot as MyBoksPage};
