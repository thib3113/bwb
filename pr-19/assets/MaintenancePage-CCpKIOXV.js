import{g as A,a as E,D as P,u as R,b as s,c as O,d as I,s as k,h as M,i as w,T as h,t as f,l as x,q as T,F as D,ai as L,o as U,P as N,ab as B,ac as K,ad as $,n as q,H as F,aQ as z,a6 as b,aR as H,aS as Q}from"./index-B9yXfOt9.js";import{C as W}from"./Container-noAwZzR4.js";import{L as Y}from"./LinearProgress-DsRvM1RN.js";function j(n){return A("MuiCardActions",n)}E("MuiCardActions",["root","spacing"]);const G=n=>{const{classes:e,disableSpacing:t}=n;return I({root:["root",!t&&"spacing"]},j,e)},J=k("div",{name:"MuiCardActions",slot:"Root",overridesResolver:(n,e)=>{const{ownerState:t}=n;return[e.root,!t.disableSpacing&&e.spacing]}})({display:"flex",alignItems:"center",padding:8,variants:[{props:{disableSpacing:!1},style:{"& > :not(style) ~ :not(style)":{marginLeft:8}}}]}),V=P(function(e,t){const c=R({props:e,name:"MuiCardActions"}),{disableSpacing:l=!1,className:d,...a}=c,r={...c,disableSpacing:l},u=G(r);return s(J,{className:O(u.root,d),ownerState:r,ref:t,...a})}),X=M(s("path",{d:"M8 5v14l11-7z"})),Z=({script:n})=>{const{t:e}=w(["maintenance"]),t=e,[c,l]=f(x(!1),"running"),[d,a]=f(x(0),"progress"),[r,u]=f(x([]),"logs"),[o,p]=f(x(null),"error"),{activeDevice:_}=T(),g=async()=>{const i=H.getInstance();if(i.getState()!=="connected"){p(t("status.not_connected"));return}const m=_?.configuration_key;if(!m){p(t("status.missing_config_key"));return}l(!0),a(0),u([]),p(null);const v=y=>u(C=>[...C.slice(-4),y]);try{await n.run({setProgress:a,log:v,checkStop:()=>{},t:e},{bleService:i,configKey:m}),v(t("status.finished")),a(100)}catch(y){console.error(y);const C=y instanceof Error?y.message:String(y);p(t("status.error",{message:C})),v(t("status.error",{message:C}))}finally{l(!1)}};return s(F,{sx:{mb:2},children:[s(D,{children:[s(h,{variant:"h6",component:"div",children:t(n.titleKey)}),s(h,{sx:{mb:1.5},color:"text.secondary",children:t(n.descriptionKey)}),o&&s(L,{severity:"error",sx:{mb:2},children:o}),(c||r.length>0)&&s(U,{sx:{width:"100%",mb:2},children:[s(Y,{variant:"determinate",value:d}),s(h,{variant:"body2",color:"text.secondary",align:"right",children:t("progress",{percent:Math.round(d)})})]}),r.length>0&&s(N,{variant:"outlined",sx:{p:1,bgcolor:"background.default",maxHeight:100,overflow:"auto"},children:s(B,{dense:!0,disablePadding:!0,children:r.map((i,m)=>s(K,{disablePadding:!0,children:s($,{primary:i,primaryTypographyProps:{variant:"caption",fontFamily:"monospace"}})},m))})})]}),s(V,{children:s(q,{size:"small",variant:"contained",startIcon:s(X,{}),onClick:g,disabled:c,children:t("run")})})]})},S=async n=>{const e=new Q,t=await n.sendRequest(e,{expectResponse:!0});if(t.opcode!==b.NOTIFY_CODES_COUNT)throw new Error(`Unexpected response opcode: 0x${t.opcode.toString(16)}`);if(t.payload.length<2)throw new Error("Invalid payload length for CODES_COUNT");return t.payload[0]<<8|t.payload[1]},tt={id:"clean_master_codes",titleKey:"scripts.clean_master_codes.title",descriptionKey:"scripts.clean_master_codes.description",run:async({setProgress:n,log:e,checkStop:t,t:c},{bleService:l,configKey:d})=>{const a=c;e(a("status.fetching_count"));let r=await S(l);if(e(a("status.initial_count",{count:r})),r===0){e(a("status.no_codes"));return}const u=256;for(let o=0;o<u;o++){t();const p=o/u*100;for(n(p);;){t(),e(a("status.deleting_index",{index:o,count:r}));const _=new z(d,o);let g=!1;try{const i=await l.sendRequest(_,{expectResponse:!0},d);i.opcode===b.CODE_OPERATION_SUCCESS?(e(a("status.success_index",{index:o})),g=!0):i.opcode===b.CODE_OPERATION_ERROR&&(e(a("status.error_index",{index:o})),g=!1)}catch(i){const m=i instanceof Error?i.message:String(i);e(a("status.error",{message:`Index ${o}: ${m}`})),g=!1}if(!g)break}if(r=await S(l),r===0){e(a("status.stopping_early"));break}}}},at=()=>{const{t:n}=w(["maintenance"]),e=n;return s(W,{maxWidth:"sm",sx:{mt:2,pb:10},children:[s(h,{variant:"h4",gutterBottom:!0,children:e("title")}),s(h,{variant:"body2",color:"text.secondary",paragraph:!0,children:e("description")}),s(Z,{script:tt})]})};export{at as MaintenancePage};
