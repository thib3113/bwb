import{h as z,b as e,i as C,t as g,l as _,a3 as D,aT as $,aU as H,aV as j,aW as F,o as c,a2 as q,T as h,ac as G,aX as ee,aY as te,az as re,aZ as se,ab as ne,W as U,ai as k,n as x,Y as A,a0 as K,P as Z,aO as ae,an as B,a_ as R,a$ as le,Q as P,a6 as ie,F as E,I as oe,aw as ce,H as I,w as de,b0 as he,Z as ue,$ as pe,b1 as W}from"./index-CDpomVQy.js";import{S as ge}from"./Stack-HtVcW2Pk.js";import{E as me}from"./Edit-mxVUlspl.js";import{D as J}from"./Delete-F_5hM6D5.js";import{T as ve,a as be,b as L,c as S,d as fe}from"./TableRow-CZl7I3MP.js";import{C as _e}from"./Chip-vHmxL9Em.js";import{T as ye,a as N}from"./Tabs-BvtMdo1V.js";import{C as xe}from"./Container-BN4eQsnr.js";const we=z(e("path",{d:"M12 2C6.47 2 2 6.47 2 12s4.47 10 10 10 10-4.47 10-10S17.53 2 12 2m5 13.59L15.59 17 12 13.41 8.41 17 7 15.59 10.59 12 7 8.41 8.41 7 12 10.59 15.59 7 17 8.41 13.41 12z"})),Se=z(e("path",{d:"M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6zm2.46-7.12 1.41-1.41L12 12.59l2.12-2.12 1.41 1.41L13.41 14l2.12 2.12-1.41 1.41L12 15.41l-2.12 2.12-1.41-1.41L10.59 14zM15.5 4l-1-1h-5l-1 1H5v2h14V4z"})),ke=z(e("path",{d:"M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3m3-10H5V5h10z"})),Ce=z(e("path",{d:"m12 16.5 4-4h-3v-9h-2v9H8zm9-13h-6v1.99h6v14.03H3V5.49h6V3.5H3c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2v-14c0-1.1-.9-2-2-2"})),De=({tableName:t,item:n,primaryKey:l})=>{const[a,i]=g(_(!1),"isEditing"),[r,d]=g(_(JSON.stringify(n,null,2)),"editValue"),[b,v]=g(_(null),"error"),o=async()=>{try{const y=JSON.parse(r);await D.table(t).put(y),i(!1),v(null)}catch(y){v(y instanceof Error?y.message:"Invalid JSON")}},p=async()=>{confirm("Are you sure you want to delete this record?")&&await D.table(t).delete(l)};return a?e(c,{sx:{p:1},children:[e(U,{fullWidth:!0,multiline:!0,minRows:3,value:r,onChange:y=>d(y.target.value),variant:"outlined",size:"small",sx:{fontFamily:"monospace",mb:1}}),b&&e(k,{severity:"error",sx:{mb:1},children:b}),e(ge,{direction:"row",spacing:1,justifyContent:"flex-end",children:[e(x,{startIcon:e(we,{}),onClick:()=>{i(!1),d(JSON.stringify(n,null,2)),v(null)},size:"small",children:"Cancel"}),e(x,{startIcon:e(ke,{}),onClick:o,variant:"contained",size:"small",children:"Save"})]})]}):e(c,{children:[e(c,{sx:{display:"flex",justifyContent:"flex-end",mb:1},children:[e(A,{size:"small",onClick:()=>i(!0),children:e(me,{fontSize:"small"})}),e(A,{size:"small",onClick:p,color:"error",children:e(J,{fontSize:"small"})})]}),e(c,{component:"pre",sx:{overflowX:"auto",fontSize:"0.75rem",m:0,p:1,bgcolor:"action.hover",borderRadius:1},children:JSON.stringify(n,null,2)})]})},Te=({tableName:t})=>{const{t:n}=C(["settings"]),l=q(()=>D.table(t).toArray(),[t]),i=D.table(t).schema.primKey.name;return l?l.length===0?e(h,{children:n("settings:developer.no_records")}):e(ne,{children:l.map((r,d)=>{const b=r[i];return e(G,{disablePadding:!0,children:e(ee,{sx:{width:"100%"},children:[e(te,{expandIcon:e(re,{}),children:e(h,{noWrap:!0,children:r.id||r.name||r.key||`Record ${d}`})}),e(se,{children:e(De,{tableName:t,item:r,primaryKey:b})})]})},b||d)})}):e(h,{children:n("settings:developer.loading")})},Oe=()=>{const{t}=C(["settings"]),[n,l]=g(_(""),"selectedTable"),a=D.tables.map(r=>r.name),i=r=>{l(r.target.value)};return e(c,{sx:{mt:2},children:[e($,{fullWidth:!0,size:"small",sx:{mb:2},children:[e(H,{children:t("settings:developer.select_table")}),e(j,{value:n,label:t("settings:developer.select_table"),onChange:i,children:a.map(r=>e(F,{value:r,children:r},r))})]}),n&&e(Te,{tableName:n})]})},Ee=()=>{const{t}=C(["settings"]),{debugLogs:n,clearDebugLogs:l}=K(),a=n.filter(r=>r.type==="packet").sort((r,d)=>new Date(d.timestamp).getTime()-new Date(r.timestamp).getTime()),i=r=>r===void 0?"UNKNOWN":ae[r]||`OP_${r.toString(16).toUpperCase()}`;return e(c,{sx:{mt:4},children:[e(c,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2},children:[e(h,{variant:"h6",children:t("settings:developer.packet_logger_title")}),e(x,{variant:"outlined",color:"error",startIcon:e(J,{}),onClick:l,size:"small",children:t("settings:developer.clear_logs")})]}),e(Z,{variant:"outlined",sx:{width:"100%",overflow:"hidden"},children:e(c,{sx:{maxHeight:400,overflowY:"auto"},children:e(ve,{stickyHeader:!0,size:"small",children:[e(be,{children:e(L,{children:[e(S,{children:"Time"}),e(S,{children:"Dir"}),e(S,{children:"Opcode"}),e(S,{children:"Payload (Hex)"})]})}),e(fe,{children:a.length>0?a.map(r=>e(L,{hover:!0,children:[e(S,{sx:{whiteSpace:"nowrap",fontSize:"0.75rem"},children:new Date(r.timestamp).toLocaleTimeString([],{hour12:!1,hour:"2-digit",minute:"2-digit",second:"2-digit",fractionalSecondDigits:3})}),e(S,{children:e(_e,{label:r.direction,color:r.direction==="TX"?"primary":"success",size:"small",sx:{fontSize:"0.7rem",height:20}})}),e(S,{sx:{fontSize:"0.75rem",fontWeight:"bold"},children:i(r.opcode)}),e(S,{sx:{fontFamily:"monospace",fontSize:"0.75rem",wordBreak:"break-all"},children:r.payload||"-"})]},r.id)):e(L,{children:e(S,{colSpan:4,align:"center",children:e(h,{variant:"body2",color:"text.secondary",sx:{py:2},children:t("settings:developer.no_records")})})})})]})})})]})},Ie=t=>ie[t]||`UNKNOWN_OPCODE_${t}`,V={},ze=()=>{const{t}=C(["settings"]),{sendPacket:n,isConnected:l}=K(),[a,i]=g(_(""),"selectedOpcode"),[r,d]=g(_({}),"formData"),[b,v]=g(_(null),"validationError"),[o,p]=g(_(null),"successMessage"),y=g(B(()=>Array.from(R.getRegisteredTXPackets().entries()).sort((s,m)=>s[0]-m[0]),[]),"registeredPackets"),u=g(B(()=>a===""?null:R.getRegisteredTXPackets().get(a),[a]),"SelectedPacketClass"),f=g(B(()=>!u||!u.schema?null:u.schema instanceof le?u.schema.shape:null,[u]),"schemaShape");P(()=>{if(!f){d({});return}const s={};Object.keys(f).forEach(m=>{s[m]=V[m]||""}),d(s)},[f]);const X=s=>{i(s.target.value),v(null),p(null)},Y=(s,m)=>{d(w=>({...w,[s]:m})),V[s]=m,v(null),p(null)},Q=async()=>{if(u){v(null),p(null);try{let s={};if(u.schema){const w=u.schema.safeParse(r);if(!w.success){const T=w.error.errors.map(O=>`${O.path.join(".")}: ${O.message}`).join(", ");v(T);return}s=w.data}const m=new u;Object.assign(m,s),await n(m),console.log("Packet sent successfully",m),p(t("settings:developer.packet_sent_success"))}catch(s){console.error("Failed to send packet",s),v(s.message||t("settings:developer.packet_send_error"))}}};return e(c,{sx:{display:"flex",flexDirection:"column",gap:3},children:[e(k,{severity:l?"success":"warning",children:t(l?"settings:developer.enabled_success":"settings:developer.not_connected_warning")}),e($,{fullWidth:!0,children:[e(H,{children:t("settings:developer.packet_type_label")}),e(j,{value:a,label:t("settings:developer.packet_type_label"),onChange:X,children:y.map(([s])=>e(F,{value:s,children:[Ie(s)," (",s,")"]},s))})]}),u&&e(Z,{variant:"outlined",sx:{p:2},children:[e(h,{variant:"h6",gutterBottom:!0,children:t("settings:developer.packet_parameters_title")}),e(c,{sx:{display:"flex",flexDirection:"column",gap:2},children:[f?Object.keys(f).length>0?Object.keys(f).map(s=>{const m=f[s];let w=!1;const T=m._def.typeName;return(T==="ZodNumber"||T==="ZodEffects"&&m._def.schema?._def.typeName==="ZodNumber")&&(w=!0),e(U,{label:s,variant:"outlined",fullWidth:!0,type:w?"number":"text",value:r[s]||"",onChange:O=>Y(s,O.target.value),helperText:w?"Number":"String"},s)}):e(h,{color:"text.secondary",children:t("settings:developer.no_parameters")}):e(h,{color:"text.secondary",children:t("settings:developer.no_schema")}),b&&e(k,{severity:"error",children:b}),o&&e(k,{severity:"success",children:o}),e(x,{variant:"contained",onClick:Q,disabled:!l&&!window.BOKS_SIMULATOR_ENABLED,children:t("settings:developer.send_packet")})]})]}),e(Ee,{})]})},Be=()=>{const{t}=C(["settings"]),[n,l]=g(_([]),"registrations"),[a,i]=g(_(null),"message"),r=async()=>{if("serviceWorker"in navigator){const o=await navigator.serviceWorker.getRegistrations();l([...o])}};P(()=>{r()},[]);const d=async o=>{try{await o.update(),i(t("settings:developer.sw_update_requested")),r()}catch(p){i(t("settings:developer.sw_update_failed",{error:String(p)}))}},b=async o=>{try{const p=await o.unregister();i(t(p?"settings:developer.sw_unregister_success":"settings:developer.sw_unregister_failed")),r()}catch(p){i(t("settings:developer.sw_unregister_error",{error:String(p)}))}},v=()=>{window.location.reload()};return"serviceWorker"in navigator?e(I,{sx:{mt:2},children:e(E,{children:[e(h,{variant:"h6",gutterBottom:!0,children:t("settings:developer.sw_title")}),e(oe,{sx:{mb:2}}),a&&e(k,{severity:"info",sx:{mb:2},onClose:()=>i(null),children:a}),n.length===0?e(h,{variant:"body2",color:"text.secondary",children:t("settings:developer.sw_no_active")}):n.map((o,p)=>e(c,{sx:{mb:2,p:1,border:"1px solid #ddd",borderRadius:1},children:[e(h,{variant:"subtitle2",children:t("settings:developer.sw_scope",{scope:o.scope})}),e(h,{variant:"body2",color:"text.secondary",gutterBottom:!0,children:t("settings:developer.sw_status",{status:o.installing?t("settings:developer.sw_installing"):o.waiting?t("settings:developer.sw_waiting"):o.active?t("settings:developer.sw_active"):t("settings:developer.sw_unknown")})}),e(c,{sx:{display:"flex",gap:1,flexWrap:"wrap",mt:1},children:[e(x,{size:"small",variant:"outlined",startIcon:e(Ce,{}),onClick:()=>d(o),children:t("settings:developer.sw_check_update")}),e(x,{size:"small",variant:"outlined",color:"error",startIcon:e(Se,{}),onClick:()=>b(o),children:t("settings:developer.sw_unregister")})]})]},p)),e(c,{sx:{mt:2},children:e(x,{fullWidth:!0,variant:"contained",color:"primary",startIcon:e(ce,{}),onClick:v,children:t("settings:developer.sw_reload")})})]})}):e(k,{severity:"warning",children:t("settings:developer.sw_not_supported")})};function M(t){const{children:n,value:l,index:a,...i}=t;return e("div",{role:"tabpanel",hidden:l!==a,id:`simple-tabpanel-${a}`,"aria-labelledby":`simple-tab-${a}`,...i,children:l===a&&e(c,{sx:{p:2},children:n})})}const $e=()=>{const{t}=C(["settings"]),n=de(),{isDeveloperMode:l,disableDeveloperMode:a}=he(),[i,r]=g(_(!1),"simulatorEnabled"),[d,b]=g(_(0),"tabValue");P(()=>{l||n("/");const u=localStorage.getItem("BOKS_SIMULATOR_ENABLED")==="true";r(u)},[l,n]);const v=()=>{a(),n("/")},o=u=>{const f=u.target.checked;r(f),f?localStorage.setItem("BOKS_SIMULATOR_ENABLED","true"):localStorage.removeItem("BOKS_SIMULATOR_ENABLED"),window.location.reload()},p=async()=>{try{confirm(t("settings:developer.mock_data_confirm"))&&(await W.mockData(),alert(t("settings:developer.mock_data_success")))}catch(u){console.error(u),alert(t("settings:developer.mock_data_failed"))}},y=(u,f)=>{b(f)};return e(xe,{maxWidth:"md",sx:{py:2},children:[e(c,{sx:{mb:3,display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e(h,{variant:"h4",children:t("settings:developer.page_title")}),e(x,{variant:"outlined",color:"error",onClick:v,children:t("settings:developer.disable_mode")})]}),e(c,{sx:{borderBottom:1,borderColor:"divider"},children:e(ye,{value:d,onChange:y,"aria-label":"developer tabs",children:[e(N,{label:t("settings:developer.tabs.general")}),e(N,{label:t("settings:developer.tabs.database")}),e(N,{label:t("settings:developer.tabs.bluetooth")})]})}),e(M,{value:d,index:0,children:[e(I,{sx:{mb:3},children:e(E,{children:e(c,{sx:{display:"flex",flexDirection:"column",gap:2},children:[e(h,{variant:"h6",children:t("settings:developer.simulators_tools")}),e(ue,{control:e(pe,{checked:i,onChange:o}),label:t("settings:developer.enable_simulator")})]})})}),e(Be,{})]}),e(M,{value:d,index:1,children:e(I,{children:e(E,{children:[e(c,{sx:{mb:4},children:[e(c,{sx:{display:"flex",gap:2},children:[e(x,{variant:"contained",onClick:p,children:t("settings:developer.load_mock_data")}),e(x,{variant:"outlined",color:"error",onClick:()=>{confirm(t("settings:developer.clear_db_confirm"))&&W.clearAllData()},children:t("settings:developer.clear_db")})]}),e(h,{variant:"caption",display:"block",color:"text.secondary",sx:{mt:1},children:t("settings:developer.mock_data_helper")})]}),e(h,{variant:"h6",gutterBottom:!0,children:t("settings:developer.db_editor")}),e(h,{variant:"body2",color:"text.secondary",paragraph:!0,children:t("settings:developer.db_editor_helper")}),e(Oe,{})]})})}),e(M,{value:d,index:2,children:e(I,{children:e(E,{children:[e(h,{variant:"h6",gutterBottom:!0,children:"Bluetooth Debugger"}),e(ze,{})]})})})]})};export{$e as DeveloperPage};
