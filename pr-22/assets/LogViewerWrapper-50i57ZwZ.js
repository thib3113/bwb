import{R as B,bv as A,i as D,t as _,l as I,b as e,Y as O,az as Y,aA as R,o as m,ae as $,q as k,k as M,aL as V,a2 as j,a3 as z,an as L,bw as P,bx as W,a4 as q,by as F,T as w,n as Q,C as H,aw as J,ai as K,r as G}from"./index-0Y0MItfz.js";import{b as p,c,T as C,d as T,a as N}from"./TableRow-Bao-jNhp.js";const U=()=>{const n=B(A);if(n===void 0)throw new Error("useLogCount must be used within a DeviceProvider");return{logCount:n.logCount}};function X(n,t){const a=new Date(n),l=new Date,r=new Date;return r.setFullYear(l.getFullYear()-1),a<r?a.toLocaleDateString(t,{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit",hour12:!1}):a.toLocaleDateString(t,{day:"2-digit",month:"2-digit",hour:"2-digit",minute:"2-digit",hour12:!1})}function Z(n,t){return{code_index:t("code_index"),code_value:t("code_value"),code:t("code_value"),method:t("method"),result:t("result"),reason:t("reason"),error_code:t("error_code"),weight:t("weight"),battery_level:t("battery_level"),tagId:t("tag_id"),initiatedBy:t("initiated_by"),bootReason:t("boot_reason"),payload:t("payload")}[n]||n}const ee=({log:n})=>{const{t,i18n:a}=D("logs"),[l,r]=_(I(!1),"isExpanded"),d=()=>{r(!l)};return e($,{children:[e(p,{children:[e(c,{title:n.fullDate,children:X(n.timestamp,a.language)}),e(c,{children:n.event}),e(c,{children:(()=>{const s={...n.details};return delete s.age,delete s.timestamp,Object.keys(s).length>0?e(O,{"aria-label":"expand row",size:"small",onClick:d,children:e(Y,{style:{transform:l?"rotate(180deg)":"rotate(0deg)"}})}):null})()})]}),e(p,{children:e(c,{style:{paddingBottom:0,paddingTop:0},colSpan:3,children:e(R,{in:l,timeout:"auto",unmountOnExit:!0,children:e(m,{sx:{margin:1},children:e(C,{size:"small","aria-label":"details",children:e(T,{children:(()=>{const s={...n.details};return delete s.age,delete s.timestamp,Object.entries(s).map(([u,h])=>e(p,{children:[e(c,{component:"th",scope:"row",sx:{fontWeight:"bold"},children:Z(u,t)}),e(c,{children:typeof h=="object"?JSON.stringify(h):String(h)})]},u))})()})})})})})})]})},te=({showNotification:n,hideNotification:t})=>{const{t:a,i18n:l}=D(["logs","common"]),r=a,{activeDevice:d}=k(),{isConnected:s}=M(),{isSyncingLogs:u,requestLogs:h}=V(),{logCount:f}=U(),v=j(()=>{const o=d?.id;return o?(console.log(`[LogViewer] Querying logs for device_id: ${o}`),z.logs.orderBy("timestamp").reverse().filter(i=>i.device_id===o).limit(50).toArray()):[]},[d?.id]),g=_(L(()=>{const o=v??P;return console.log(`[LogViewer] raw logs count: ${o.length}`,o),o},[v]),"logs"),x=_(L(()=>{if(g.length===0)return[];try{console.log(`[LogViewer] Starting parseLogs with ${g.length} logs`);const o=W(g).map(i=>{const y=new Date(i.timestamp).toLocaleString(l.language);return{...i,fullDate:y,event:r(i.description)}});return console.log(`[LogViewer] Parsing finished. parsedLogs: ${o.length}`,o),o}catch(o){const i=o instanceof Error?o.message:String(o);return console.error(r("parse_error"),i),[]}},[g,l.language,a]),"parsedLogs"),S=q(async()=>{if(!s){n&&n(r("not_connected"),"error");return}await F(h,{showNotification:n,hideNotification:t,loadingMsg:r("refresh_started"),successMsg:r("refresh_success"),errorMsg:r("refresh_failed")})},[s,h,n,t,a]);return e(m,{sx:{p:2,mb:2,width:"100%"},children:[e(m,{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2,children:[e(w,{variant:"h5",component:"h2",children:[r("title")," ",f!==null&&f>0&&`(${f})`]}),e(Q,{variant:"outlined",startIcon:u?e(H,{size:20}):e(J,{}),onClick:S,disabled:!s||u,children:r("refresh")})]}),!s&&!d&&g.length===0&&e(K,{severity:"info",sx:{mb:2},children:r("connect_to_view")}),e(m,{sx:{height:"100%",width:"100%",overflowY:"auto",borderRadius:1,p:2,backgroundColor:"background.paper",fontFamily:"Courier New, monospace"},children:x.length>0?e(C,{children:[e(N,{children:e(p,{children:[e(c,{children:r("timestamp")}),e(c,{children:r("event_label")}),e(c,{})]})}),e(T,{children:x.map((o,i)=>e(ee,{log:o},i))})]}):g.length>0?e(m,{children:g.map((o,i)=>{const b=new Date(o.timestamp),y=b.toLocaleDateString(l.language,{day:"2-digit",month:"2-digit",hour:"2-digit",minute:"2-digit"}),E=b.toLocaleString(l.language);return e(m,{sx:{py:1,borderBottom:"1px solid",borderColor:"divider"},children:[e(w,{component:"span",fontWeight:"bold",title:E,children:y}),": ",o.event]},i)})}):e(w,{align:"center",sx:{fontStyle:"italic",py:2},component:"p",children:r(s||d?"no_logs_when_connected":"no_logs_when_disconnected")})})]})},re=()=>{const n=G();if(!n)return null;const{showNotification:t,hideNotification:a}=n;return e(te,{showNotification:t,hideNotification:a})};export{re as LogViewerWrapper};
