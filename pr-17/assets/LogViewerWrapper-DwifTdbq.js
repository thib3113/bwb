import{R as E,bv as B,i as L,t as w,l as I,b as e,Y as O,az as Y,aA as A,o as m,ae as R,q as $,k,aL as M,a2 as V,a3 as j,an as x,bw as z,bx as P,a4 as W,by as q,T as y,n as F,C as Q,aw as H,ai as J,r as K}from"./index-DIJNTHdl.js";import{b as p,c,T as D,d as C,a as G}from"./TableRow-BCSVvXpU.js";const N=()=>{const o=E(B);if(o===void 0)throw new Error("useLogCount must be used within a DeviceProvider");return{logCount:o.logCount}};function U(o,n){const t=new Date(o),a=new Date,l=new Date;return l.setFullYear(a.getFullYear()-1),t<l?t.toLocaleDateString(n,{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit",hour12:!1}):t.toLocaleDateString(n,{day:"2-digit",month:"2-digit",hour:"2-digit",minute:"2-digit",hour12:!1})}function X(o,n){return{code_index:n("code_index"),code_value:n("code_value"),code:n("code_value"),method:n("method"),result:n("result"),reason:n("reason"),error_code:n("error_code"),weight:n("weight"),battery_level:n("battery_level"),tagId:n("tag_id"),initiatedBy:n("initiated_by"),bootReason:n("boot_reason"),payload:n("payload")}[o]||o}const Z=({log:o})=>{const{t:n,i18n:t}=L("logs"),[a,l]=w(I(!1),"isExpanded"),d=()=>{l(!a)};return e(R,{children:[e(p,{children:[e(c,{title:o.fullDate,children:U(o.timestamp,t.language)}),e(c,{children:o.event}),e(c,{children:(()=>{const i={...o.details};return delete i.age,delete i.timestamp,Object.keys(i).length>0?e(O,{"aria-label":"expand row",size:"small",onClick:d,children:e(Y,{style:{transform:a?"rotate(180deg)":"rotate(0deg)"}})}):null})()})]}),e(p,{children:e(c,{style:{paddingBottom:0,paddingTop:0},colSpan:3,children:e(A,{in:a,timeout:"auto",unmountOnExit:!0,children:e(m,{sx:{margin:1},children:e(D,{size:"small","aria-label":"details",children:e(C,{children:(()=>{const i={...o.details};return delete i.age,delete i.timestamp,Object.entries(i).map(([h,g])=>e(p,{children:[e(c,{component:"th",scope:"row",sx:{fontWeight:"bold"},children:X(h,n)}),e(c,{children:typeof g=="object"?JSON.stringify(g):String(g)})]},h))})()})})})})})})]})},ee=({showNotification:o,hideNotification:n})=>{const{t,i18n:a}=L(["logs","common"]),{activeDevice:l}=$(),{isConnected:d}=k(),{isSyncingLogs:i,requestLogs:h}=M(),{logCount:g}=N(),_=V(()=>{const r=l?.id;return r?(console.log(`[LogViewer] Querying logs for device_id: ${r}`),j.logs.orderBy("timestamp").reverse().filter(s=>s.device_id===r).limit(50).toArray()):[]},[l?.id]),u=w(x(()=>{const r=_??z;return console.log(`[LogViewer] raw logs count: ${r.length}`,r),r},[_]),"logs"),v=w(x(()=>{if(u.length===0)return[];try{console.log(`[LogViewer] Starting parseLogs with ${u.length} logs`);const r=P(u).map(s=>{const b=new Date(s.timestamp).toLocaleString(a.language);return{...s,fullDate:b,event:t(s.description)}});return console.log(`[LogViewer] Parsing finished. parsedLogs: ${r.length}`,r),r}catch(r){const s=r instanceof Error?r.message:String(r);return console.error(t("parse_error"),s),[]}},[u,a.language,t]),"parsedLogs"),T=W(async()=>{if(!d){o&&o(t("not_connected"),"error");return}await q(h,{showNotification:o,hideNotification:n,loadingMsg:t("refresh_started"),successMsg:t("refresh_success"),errorMsg:t("refresh_failed")})},[d,h,o,n,t]);return e(m,{sx:{p:2,mb:2,width:"100%"},children:[e(m,{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2,children:[e(y,{variant:"h5",component:"h2",children:[t("title")," ",g!==null&&g>0&&`(${g})`]}),e(F,{variant:"outlined",startIcon:i?e(Q,{size:20}):e(H,{}),onClick:T,disabled:!d||i,children:t("refresh")})]}),!d&&!l&&u.length===0&&e(J,{severity:"info",sx:{mb:2},children:t("connect_to_view")}),e(m,{sx:{height:"100%",width:"100%",overflowY:"auto",borderRadius:1,p:2,backgroundColor:"background.paper",fontFamily:"Courier New, monospace"},children:v.length>0?e(D,{children:[e(G,{children:e(p,{children:[e(c,{children:t("timestamp")}),e(c,{children:t("event_label")}),e(c,{})]})}),e(C,{children:v.map((r,s)=>e(Z,{log:r},s))})]}):u.length>0?e(m,{children:u.map((r,s)=>{const f=new Date(r.timestamp),b=f.toLocaleDateString(a.language,{day:"2-digit",month:"2-digit",hour:"2-digit",minute:"2-digit"}),S=f.toLocaleString(a.language);return e(m,{sx:{py:1,borderBottom:"1px solid",borderColor:"divider"},children:[e(y,{component:"span",fontWeight:"bold",title:S,children:b}),": ",r.event]},s)})}):e(y,{align:"center",sx:{fontStyle:"italic",py:2},component:"p",children:t(d||l?"no_logs_when_connected":"no_logs_when_disconnected")})})]})},oe=()=>{const o=K();if(!o)return null;const{showNotification:n,hideNotification:t}=o;return e(ee,{showNotification:n,hideNotification:t})};export{oe as LogViewerWrapper};
