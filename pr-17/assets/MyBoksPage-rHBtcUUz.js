import{h as Y,b as e,g as j,a as Q,D as Z,u as J,f as P,c as ee,l as E,Q as N,d as te,s as O,e as me,R as ge,U as he,i as X,q as $,t as A,V as fe,T as v,I as _e,H as pe,F as ve,o as p,W as L,X as ye,Y as B,Z as be,$ as Ie,n as x,a0 as Re,a1 as Se,a2 as Te,a3 as k,a4 as D,a5 as Ce,a6 as w,a7 as Ee,a8 as G,a9 as Ae,aa as we,ab as ne,ac as ae,ad as se,ae as H,af as xe,ag as ke,ah as De,C as Ne,ai as F,aj as Fe,k as Le,v as Oe}from"./index-DgAkrOf0.js";import{I as K,V as W,a as q,A as Ue}from"./VisibilityOff-CjjPVPha.js";import{D as Pe}from"./Delete-DfZEz8mr.js";import{T as Ge,a as M}from"./Tabs-CgyoFqpS.js";const Me=Y(e("path",{d:"M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"}));function Ve(t){return j("MuiAvatar",t)}Q("MuiAvatar",["root","colorDefault","circular","rounded","square","img","fallback"]);const ze=t=>{const{classes:a,variant:n,colorDefault:o}=t;return te({root:["root",n,o&&"colorDefault"],img:["img"],fallback:["fallback"]},Ve,a)},Be=O("div",{name:"MuiAvatar",slot:"Root",overridesResolver:(t,a)=>{const{ownerState:n}=t;return[a.root,a[n.variant],n.colorDefault&&a.colorDefault]}})(me(({theme:t})=>({position:"relative",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0,width:40,height:40,fontFamily:t.typography.fontFamily,fontSize:t.typography.pxToRem(20),lineHeight:1,borderRadius:"50%",overflow:"hidden",userSelect:"none",variants:[{props:{variant:"rounded"},style:{borderRadius:(t.vars||t).shape.borderRadius}},{props:{variant:"square"},style:{borderRadius:0}},{props:{colorDefault:!0},style:{color:(t.vars||t).palette.background.default,...t.vars?{backgroundColor:t.vars.palette.Avatar.defaultBg}:{backgroundColor:t.palette.grey[400],...t.applyStyles("dark",{backgroundColor:t.palette.grey[600]})}}}]}))),Ye=O("img",{name:"MuiAvatar",slot:"Img"})({width:"100%",height:"100%",textAlign:"center",objectFit:"cover",color:"transparent",textIndent:1e4}),Xe=O(Me,{name:"MuiAvatar",slot:"Fallback"})({width:"75%",height:"75%"});function $e({crossOrigin:t,referrerPolicy:a,src:n,srcSet:o}){const[h,d]=E(!1);return N(()=>{if(!n&&!o)return;d(!1);let r=!0;const i=new Image;return i.onload=()=>{r&&d("loaded")},i.onerror=()=>{r&&d("error")},i.crossOrigin=t,i.referrerPolicy=a,i.src=n,o&&(i.srcset=o),()=>{r=!1}},[t,a,n,o]),h}const He=Z(function(a,n){const o=J({props:a,name:"MuiAvatar"}),{alt:h,children:d,className:r,component:i="div",slots:c={},slotProps:_={},imgProps:f,sizes:I,src:R,srcSet:y,variant:S="circular",...l}=o;let u=null;const s={...o,component:i,variant:S},b=$e({...f,...typeof _.img=="function"?_.img(s):_.img,src:R,srcSet:y}),T=R||y,m=T&&b!=="error";s.colorDefault=!m,delete s.ownerState;const C=ze(s),[U,ie]=P("root",{ref:n,className:ee(C.root,r),elementType:Be,externalForwardedProps:{slots:c,slotProps:_,component:i,...l},ownerState:s}),[ce,le]=P("img",{className:C.img,elementType:Ye,externalForwardedProps:{slots:c,slotProps:{img:{...f,..._.img}}},additionalProps:{alt:h,src:R,srcSet:y,sizes:I},ownerState:s}),[de,ue]=P("fallback",{className:C.fallback,elementType:Xe,externalForwardedProps:{slots:c,slotProps:_},shouldForwardComponentProp:!0,ownerState:s});return m?u=e(ce,{...le}):d||d===0?u=d:T&&h?u=h[0]:u=e(de,{...ue}),e(U,{...ie,children:u})});function Ke(t){return j("MuiListItemAvatar",t)}Q("MuiListItemAvatar",["root","alignItemsFlexStart"]);const We=t=>{const{alignItems:a,classes:n}=t;return te({root:["root",a==="flex-start"&&"alignItemsFlexStart"]},Ke,n)},qe=O("div",{name:"MuiListItemAvatar",slot:"Root",overridesResolver:(t,a)=>{const{ownerState:n}=t;return[a.root,n.alignItems==="flex-start"&&a.alignItemsFlexStart]}})({minWidth:56,flexShrink:0,variants:[{props:{alignItems:"flex-start"},style:{marginTop:8}}]}),je=Z(function(a,n){const o=J({props:a,name:"MuiListItemAvatar"}),{className:h,...d}=o,r=ge(he),i={...o,alignItems:r.alignItems},c=We(i);return e(qe,{className:ee(c.root,h),ownerState:i,ref:n,...d})}),Qe=Y(e("path",{d:"M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20z"})),Ze=Y(e("path",{d:"M20 2H4c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2m0 18H4V4h16zM18 6h-5c-1.1 0-2 .9-2 2v2.28c-.6.35-1 .98-1 1.72 0 1.1.9 2 2 2s2-.9 2-2c0-.74-.4-1.38-1-1.72V8h3v8H8V8h2V6H6v12h12z"})),oe=(t,a)=>{if(!t||!a)return 0;const n=t.replace(/[^0-9.]/g,""),o=a.replace(/[^0-9.]/g,""),h=n.split(".").map(Number),d=o.split(".").map(Number);for(let r=0;r<Math.max(h.length,d.length);r++){const i=h[r]||0,c=d[r]||0;if(i>c)return 1;if(i<c)return-1}return 0},Je=({deviceId:t})=>{const{t:a}=X(["common","settings"]),{activeDevice:n,updateDeviceDetails:o,removeDevice:h,toggleLaPoste:d}=$(),[r,i]=A(E({key:!n?.configuration_key,pin:!n?.door_pin_code}),"visibleFields"),[c,_]=A(E(n?.friendly_name||""),"deviceName"),[f,I]=A(E(n?.configuration_key||""),"configurationKey"),[R,y]=A(E(n?.door_pin_code||""),"doorPinCode");fe.useEffect(()=>{n&&(_(n.friendly_name||""),I(n.configuration_key||""),y(n.door_pin_code||""))},[n]);const S=m=>{i(C=>({...C,[m]:!C[m]}))},l=async()=>{if(n)try{await o(t,{friendly_name:c,configuration_key:f,door_pin_code:R})}catch(m){console.error("Failed to update device details:",m)}},u=async m=>{try{await d(m.target.checked)}catch(C){console.error("Failed to toggle La Poste:",C)}},s=async()=>{if(n)try{await h(t)}catch(m){console.error("Failed to remove device:",m)}},b=m=>{const U=m.trim().toUpperCase().replace(/[^0-9A-F]/g,"").slice(-8);I(U)},T=m=>{const C=m.trim().toUpperCase();y(C)};return n?e(p,{sx:{my:2},children:[e(v,{variant:"subtitle1",gutterBottom:!0,children:a("devices.title")}),e(_e,{sx:{mb:2}}),e(pe,{children:e(ve,{children:e(p,{sx:{display:"flex",flexDirection:"column",gap:2},children:[e(L,{label:a("devices.device_name"),value:c,onChange:m=>_(m.currentTarget.value),fullWidth:!0,size:"small"}),n.role===ye.Admin&&e(L,{label:a("settings:configuration_key.label"),value:f,onChange:m=>b(m.currentTarget.value),fullWidth:!0,size:"small",type:r.key?"text":"password",helperText:a("settings:configuration_key.helper"),slotProps:{input:{endAdornment:e(K,{position:"end",children:e(B,{"aria-label":a("settings:toggle_key_visibility"),onClick:()=>S("key"),edge:"end",size:"small",children:r.key?e(W,{}):e(q,{})})})}}}),e(L,{label:a("settings:door_pin_code"),value:R,onChange:m=>T(m.currentTarget.value),fullWidth:!0,size:"small",type:r.pin?"text":"password",slotProps:{input:{endAdornment:e(K,{position:"end",children:e(B,{"aria-label":a("settings:toggle_pin_visibility"),onClick:()=>S("pin"),edge:"end",size:"small",children:r.pin?e(W,{}):e(q,{})})})}}}),n.hardware_version==="4.0"&&n.software_revision&&oe(n.software_revision,"4.2.0")>=0&&e(p,{children:e(be,{control:e(Ie,{checked:n.la_poste_activated||!1,onChange:u}),label:a("settings:activate_la_poste")})}),e(p,{sx:{display:"flex",justifyContent:"space-between",mt:2},children:[e(x,{size:"small",color:"error",variant:"outlined",onClick:s,children:a("devices.forget")}),e(x,{size:"small",variant:"contained",onClick:l,children:a("save")})]})]})})})]}):null};var re=(t=>(t[t.LA_POSTE=1]="LA_POSTE",t[t.VIGIK_TERTIARY=2]="VIGIK_TERTIARY",t[t.USER_BADGE=3]="USER_BADGE",t))(re||{}),g=(t=>(t.IDLE="idle",t.SCANNING="scanning",t.FOUND="found",t.TIMEOUT="timeout",t.ERROR_EXISTS="error_exists",t.ERROR="error",t))(g||{});const et=()=>{const{activeDevice:t}=$(),{sendRequest:a}=Re(),{addListener:n,removeListener:o}=Se(),[h,d]=A(E(g.IDLE),"scanStatus"),[r,i]=A(E(null),"scannedUid"),c=t?.id,_=Te(()=>c?k.nfc_tags.where("device_id").equals(c).toArray():[],[c]),f=D(async()=>{if(!c)throw new Error("No active device");const l=await k.device_secrets.get(c);if(!l?.configuration_key)throw new Error("Configuration Key required");return l.configuration_key},[c]),I=D(async()=>{try{const l=await f();d(g.SCANNING),i(null),await a(new Ce(l))}catch(l){console.error("Failed to start scan",l),d(g.ERROR)}},[f,a]);N(()=>{const l=u=>{if([w.NOTIFY_NFC_TAG_REGISTER_SCAN_RESULT,w.NOTIFY_NFC_TAG_REGISTER_SCAN_ERROR_EXISTS,w.NOTIFY_NFC_TAG_REGISTER_SCAN_TIMEOUT].includes(u.opcode)){const s=new Ee(u.opcode);switch(s.parse(u.payload),s.status){case G.TIMEOUT:d(g.TIMEOUT);break;case G.ALREADY_EXISTS:d(g.ERROR_EXISTS),s.uid&&i(s.uid);break;case G.FOUND:d(g.FOUND),s.uid&&i(s.uid);break;default:d(g.ERROR)}}};return n(w.NOTIFY_NFC_TAG_REGISTER_SCAN_RESULT,l),n(w.NOTIFY_NFC_TAG_REGISTER_SCAN_ERROR_EXISTS,l),n(w.NOTIFY_NFC_TAG_REGISTER_SCAN_TIMEOUT,l),()=>{o(w.NOTIFY_NFC_TAG_REGISTER_SCAN_RESULT,l),o(w.NOTIFY_NFC_TAG_REGISTER_SCAN_ERROR_EXISTS,l),o(w.NOTIFY_NFC_TAG_REGISTER_SCAN_TIMEOUT,l)}},[n,o]);const R=D(async l=>{if(!(!r||!c))try{const u=await f(),s=new Uint8Array(r.split(":").map(m=>parseInt(m,16))),b=new Ae(u,s);await a(b);const T=await k.nfc_tags.where({device_id:c,uid:r}).first();T?await k.nfc_tags.update(T.id,{name:l,updated_at:Date.now()}):await k.nfc_tags.add({id:crypto.randomUUID(),device_id:c,uid:r,name:l,type:re.USER_BADGE,created_at:Date.now(),sync_status:"created"}),d(g.IDLE),i(null)}catch(u){throw console.error("Failed to register tag",u),u}},[r,c,f,a]),y=D(async l=>{if(c)try{const u=await f(),s=new Uint8Array(l.uid.split(":").map(T=>parseInt(T,16))),b=new we(u,s);await a(b),await k.nfc_tags.delete(l.id)}catch(u){throw console.error("Failed to unregister tag",u),u}},[c,f,a]),S=D(()=>{d(g.IDLE),i(null)},[]);return{tags:_,scanStatus:h,scannedUid:r,startScan:I,registerTag:R,unregisterTag:y,resetScan:S}},tt=()=>{const{t}=X(["common","settings"]),{tags:a,scanStatus:n,scannedUid:o,startScan:h,registerTag:d,unregisterTag:r,resetScan:i}=et(),[c,_]=A(E(!1),"openAddDialog"),[f,I]=A(E(""),"tagName"),R=()=>{i(),I(""),_(!0)},y=()=>{_(!1),i()},S=()=>{h()},l=async()=>{if(f.trim())try{await d(f.trim()),y()}catch(s){console.error(s)}},u=async s=>{if(confirm(t("common:confirm_delete")))try{await r(s)}catch(b){console.error(b),alert(t("settings:nfc.error_delete_failed"))}};return N(()=>{o&&!f&&I(`Badge ${o.substring(0,5)}`)},[o,f]),e(p,{sx:{p:2},children:[e(p,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2},children:[e(v,{variant:"h6",children:t("settings:nfc.title")}),e(x,{variant:"contained",startIcon:e(Ue,{}),onClick:R,children:t("settings:nfc.add_tag")})]}),a&&a.length>0?e(ne,{children:a.map(s=>e(ae,{secondaryAction:e(B,{edge:"end","aria-label":"delete",onClick:()=>u(s),children:e(Pe,{})}),children:[e(je,{children:e(He,{children:e(Ze,{})})}),e(se,{primary:s.name,secondary:e(H,{children:[e(v,{component:"span",variant:"body2",color:"textPrimary",children:s.uid}),e("br",{}),s.last_seen_at?t("settings:nfc.last_seen",{date:new Date(s.last_seen_at).toLocaleString()}):t("settings:nfc.never_seen")]})})]},s.id))}):e(v,{variant:"body1",color:"textSecondary",align:"center",sx:{mt:4},children:t("settings:nfc.no_tags")}),e(xe,{open:c,onClose:y,fullWidth:!0,maxWidth:"sm",children:[e(ke,{children:t("settings:nfc.dialog_title")}),e(De,{children:e(p,{sx:{display:"flex",flexDirection:"column",alignItems:"center",gap:2,py:2},children:[n===g.IDLE&&e(v,{children:t("settings:nfc.instructions_idle")}),n===g.SCANNING&&e(H,{children:[e(Ne,{}),e(v,{children:t("settings:nfc.instructions_scanning")})]}),n===g.TIMEOUT&&e(F,{severity:"warning",children:t("settings:nfc.error_timeout")}),n===g.ERROR&&e(F,{severity:"error",children:t("settings:nfc.error_generic")}),n===g.ERROR_EXISTS&&e(F,{severity:"info",children:[t("settings:nfc.error_exists"),o&&e(p,{sx:{mt:1},children:[e(v,{variant:"caption",children:["UID: ",o]}),e(v,{children:t("settings:nfc.instructions_exists_local")})]})]}),(n===g.FOUND||n===g.ERROR_EXISTS)&&o&&e(p,{sx:{width:"100%",mt:2},children:[e(F,{severity:"success",sx:{mb:2},children:t("settings:nfc.tag_found",{uid:o})}),e(L,{autoFocus:!0,margin:"dense",label:t("settings:nfc.input_label"),fullWidth:!0,value:f,onChange:s=>I(s.target.value)})]})]})}),e(Fe,{children:[e(x,{onClick:y,children:t("common:cancel")}),n===g.IDLE||n===g.TIMEOUT||n===g.ERROR?e(x,{onClick:S,variant:"contained",children:t("settings:nfc.button_start_scan")}):null,(n===g.FOUND||n===g.ERROR_EXISTS)&&e(x,{onClick:l,variant:"contained",disabled:!f,children:t("settings:nfc.add_tag")})]})]})]})};function V(t){const{children:a,value:n,index:o,...h}=t;return e("div",{role:"tabpanel",hidden:n!==o,id:`my-boks-tabpanel-${o}`,"aria-labelledby":`my-boks-tab-${o}`,...h,children:n===o&&e(p,{sx:{p:3},children:a})})}function z(t){return{id:`my-boks-tab-${t}`,"aria-controls":`my-boks-tabpanel-${t}`}}const rt=()=>{const{t}=X(["common","codes","logs","settings"]),{activeDevice:a,knownDevices:n,setActiveDevice:o}=$(),{isConnected:h}=Le(),d=Oe(),[r,i]=A(E(0),"value"),[c,_]=A(E(null),"selectedDeviceId");N(()=>{const b=new URLSearchParams(d.search).get("tab"),T=setTimeout(()=>{switch(b){case"settings":i(0);break;case"users":i(1);break;default:i(0);break}},0);return()=>clearTimeout(T)},[d.search]),N(()=>{(!a||!n.some(s=>s.id===a.id))&&c!==null&&setTimeout(()=>_(null),0)},[a,n,c]);const f=(s,b)=>{i(b)},I=s=>{_(s),o(s)},R=()=>{_(null),o(null)},y=n.length>1&&!c&&!a,S=a&&a.hardware_version==="4.0"&&a.software_revision&&oe(a.software_revision,"4.3.3")>=0;let l=t("common:my_boks");return a&&n.length===1||a&&n.length>1?l=a.friendly_name||a.ble_name:!a&&n.length===1&&(l=n[0].friendly_name||n[0].ble_name),y?e(p,{sx:{p:3},children:[e(v,{variant:"h5",gutterBottom:!0,children:t("common:my_boks")}),e(ne,{children:n.map(s=>e(ae,{onClick:()=>I(s.id),sx:{cursor:"pointer"},children:e(se,{primary:s.friendly_name||s.ble_name,secondary:s.ble_name})},s.id))})]}):a||n.find(s=>s.id===c)||(n.length===1?n[0]:null)?e(p,{sx:{width:"100%"},children:[e(p,{sx:{p:3,borderBottom:1,borderColor:"divider"},children:[n.length>1&&e(x,{startIcon:e(Qe,{}),onClick:R,sx:{mb:1},children:t("common:back_to_list")}),e(v,{variant:"h4",component:"h1",gutterBottom:!0,children:l}),e(v,{variant:"subtitle1",color:"textSecondary",children:t(h?"common:connected":"common:disconnected")})]}),e(p,{sx:{borderBottom:1,borderColor:"divider"},children:e(Ge,{value:r,onChange:f,"aria-label":"my boks tabs",children:[e(M,{label:t("settings:title"),...z(0)}),e(M,{label:t("common:users.title"),...z(1)}),S&&e(M,{label:"Tags NFC",...z(2)})]})}),e(V,{value:r,index:0,children:e(Je,{deviceId:a?.id||""})}),e(V,{value:r,index:1,children:e(p,{sx:{p:3},children:[e(v,{variant:"h6",children:t("common:users.title")}),e(v,{variant:"body1",color:"textSecondary",children:t("common:coming_soon")})]})}),S&&e(V,{value:r,index:2,children:e(tt,{})})]}):e(p,{sx:{p:3},children:[e(v,{variant:"h5",children:t("common:my_boks")}),e(v,{variant:"body1",color:"textSecondary",children:t("common:no_active_device")})]})};export{rt as MyBoksPage};
