import{h as K,b as e,i as O,q as X,X as P,t as g,l as f,bp as c,Q as $,b1 as z,af as Q,ag as Z,ah as J,ai as ee,o as v,W as R,Y as w,aT as ne,aU as te,aV as ae,aW as W,aj as oe,n as N,ae as se,bq as U,ad as re,T as S,br as ie,aM as G,aD as le,ac as de,ab as ce,bs as pe,a4 as he,aw as ue,aX as V,aY as B,az as q,aZ as Y,r as me}from"./index-6vKSTphI.js";import{I as xe,V as Ce,a as ge,A as H}from"./VisibilityOff-CijtAe2N.js";import{D as fe}from"./Delete-C_4Yn-NY.js";import{E as ye}from"./Edit-KpIrq-Wo.js";const be=K(e("path",{d:"m19 8-4 4h3c0 3.31-2.69 6-6 6-1.01 0-1.97-.25-2.8-.7l-1.46 1.46C8.97 19.54 10.43 20 12 20c4.42 0 8-3.58 8-8h3zM6 12c0-3.31 2.69-6 6-6 1.01 0 1.97.25 2.8.7l1.46-1.46C15.03 4.46 13.57 4 12 4c-4.42 0-8 3.58-8 8H1l4 4 4-4z"})),Ie=n=>{const r=new Uint32Array(1);return crypto.getRandomValues(r),r[0]%n},j=()=>{const n="0123456789AB";let r="";for(let p=0;p<6;p++)r+=n.charAt(Ie(n.length));return r},ve=n=>n?n.toUpperCase().replace(/[^0-9AB]/g,""):"",_e=({open:n,onClose:r,onSave:p,editingCode:a})=>{const{t}=O(["codes","common"]),{activeDevice:s}=X(),l=!!s?.configuration_key,x=s?.role===P.Owner||s?.role===P.Admin,[i,u]=g(f(c.MASTER),"type"),[_,C]=g(f(""),"code"),[A,E]=g(f(""),"name"),[h,b]=g(f(0),"index"),[M,T]=g(f(1),"uses"),[D,k]=g(f(!0),"showCode");$(()=>{if(n){const o=setTimeout(()=>{a?(u(a.type),C(a.code),E(a.name||a.description||""),b(a.index||0),T(a.uses||1)):(u(c.MASTER),C(j()),E(""),b(0),T(1))},0);return()=>clearTimeout(o)}},[a,n]),$(()=>{n&&s?.id&&i===c.MASTER&&z.loadCodes(s.id).then(o=>{const y=o.filter(m=>m.type===c.MASTER&&m.status!=="pending_delete").map(m=>m.index).filter(m=>m!==void 0),d=Math.max(...y,-1)+1;b(d)})},[n,s?.id,i]);const I=()=>{u(c.MASTER),C(""),E(""),b(0),T(1),k(!1),r()},L=async()=>{const o=ve(_);if(C(o),i===c.MASTER&&s?.id){const d=(await z.loadCodes(s.id)).find(m=>m.type===c.MASTER&&m.index===h&&m.status!=="pending_delete"&&(!a||m.id!==a.id));if(d){p({type:i,code:o,name:A,index:h,maxUses:M},d.id),I();return}}p({type:i,code:o,name:A,index:h,maxUses:M},a?a.id:null),I()};return e(se,{children:e(Q,{open:n,onClose:I,maxWidth:"sm",fullWidth:!0,children:[e(Z,{children:t(a?"edit_code":"add_new")}),e(J,{children:[!s?.configuration_key&&e(ee,{severity:"warning",sx:{mb:2},children:t("config_key_missing")}),e(v,{sx:{display:"flex",flexDirection:"column",gap:2,mt:1},children:[e(v,{sx:{display:"flex",gap:1},children:[e(R,{label:t("pin_label"),value:_,onChange:o=>C(o.currentTarget.value.trim().toUpperCase()),fullWidth:!0,type:D?"text":"password",slotProps:{htmlInput:{maxLength:6},input:{endAdornment:e(xe,{position:"end",children:e(w,{"aria-label":"toggle code visibility",onClick:()=>k(!D),edge:"end",size:"small",children:D?e(Ce,{}):e(ge,{})})})}}}),e(w,{onClick:()=>C(j()),"aria-label":t("generate"),children:e(be,{})})]}),e(R,{label:t("description_label"),value:A,onChange:o=>E(o.currentTarget.value),placeholder:t("description_placeholder"),fullWidth:!0}),e(ne,{fullWidth:!0,children:[e(te,{children:t("type_label")}),e(ae,{value:i,onChange:o=>u(o.target.value),label:t("type_label"),children:[(!x||x&&l)&&e(W,{value:c.MASTER,children:t("master_code")}),e(W,{value:c.SINGLE,children:t("single_use_code")}),e(W,{value:c.MULTI,children:t("multi_use_code")})]})]}),i===c.MASTER&&e(R,{label:`${t("index_label")}: ${h}`,type:"number",value:h,onChange:o=>b(parseInt(o.currentTarget.value)||0),fullWidth:!0,disabled:!x,slotProps:{htmlInput:{min:0,max:255}}}),i===c.MULTI&&e(R,{label:t("uses_label"),type:"number",value:M,onChange:o=>T(parseInt(o.currentTarget.value)||1),fullWidth:!0,slotProps:{htmlInput:{min:1,max:3}}})]})]}),e(oe,{children:[e(N,{onClick:I,children:t("cancel")}),e(N,{onClick:L,variant:"contained",startIcon:e(H,{}),disabled:i===c.MASTER&&(!_||_.length!==6)||i!==c.MASTER&&A.trim()==="",children:t(a?"save":"generate")})]})]})})},Ae=({code:n,metadata:r,hasIndexConflict:p,onCopy:a,onEdit:t,onDelete:s})=>{const{t:l}=O("codes"),x=n.status===U.PENDING_DELETE,i=r.used,u=x||i;return e(de,{divider:!0,sx:{opacity:u?.6:1,backgroundColor:u?"action.selected":"inherit",textDecoration:u?"line-through":"none",borderLeft:"4px solid",borderLeftColor:n.status===U.ON_DEVICE?"primary.main":n.status===U.PENDING_ADD?"warning.main":n.status===U.PENDING_DELETE?"error.main":"default.main",pl:1},children:[e(re,{primary:e(v,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap"},children:[e(S,{variant:"body1",sx:{fontWeight:"bold"},children:n.name||n.description||l("unnamed")}),e(S,{variant:"caption",sx:{ml:1},children:[l("pin_label"),": ",n.code]})]}),secondary:null,slotProps:{primary:{component:"div"},secondary:{component:"div"}}}),e(ie,{children:[e(G,{title:l("copy_code"),children:e(w,{edge:"end","aria-label":"copy",onClick:()=>a(n.code),children:e(le,{})})}),e(G,{title:l("edit_description"),children:e(w,{edge:"end","aria-label":"edit",onClick:()=>t(n),children:e(ye,{})})}),e(w,{edge:"end","aria-label":"delete",onClick:()=>s(n.id),children:e(fe,{})})]})]})},F=({codes:n,deriveCodeMetadata:r,hasIndexConflict:p,onCopy:a,onEdit:t,onDelete:s})=>e(ce,{children:n.map(l=>e(Ae,{code:l,metadata:r(l),hasIndexConflict:p?p(l.index,l.id):!1,onCopy:a,onEdit:t,onDelete:s},l.id))}),Ee=({showAddForm:n,setShowAddForm:r,showNotification:p,hideNotification:a})=>{const{t}=O(["codes","common"]),{activeDevice:s}=X(),[l,x]=g(f(!1),"isAddDialogOpen"),[i,u]=g(f(new Set(["permanent","temporary"])),"expandedAccordions"),[_,C]=g(f(null),"editingCode"),{masterCodes:A,temporaryCodes:E,codeCount:h,refreshCodeCount:b,hasIndexConflict:M,handleAddCode:T,handleDeleteCode:D,deriveCodeMetadata:k,getFilteredCodes:I,handleCopyCode:L}=pe(p,a),o=he(y=>{C(y),x(!0)},[]);return e(v,{sx:{width:"100%"},children:[e(v,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2},children:[e(S,{variant:"h5",children:[t("title")," ",h&&`(Total: ${h.total})`]}),e(v,{sx:{display:"flex",gap:1},children:[e(N,{variant:"outlined",startIcon:e(ue,{}),onClick:b,size:"small",children:t("refresh")}),e(w,{color:"primary",onClick:()=>x(!0),"aria-label":t("add_new"),size:"small",children:e(H,{})})]})]}),s&&e(S,{variant:"subtitle1",color:"textSecondary",sx:{mb:2},children:s.friendly_name||s.ble_name}),e(_e,{open:l||n||!1,onClose:()=>{x(!1),r&&r(!1),C(null)},onSave:T,editingCode:_}),e(V,{expanded:i.has("permanent"),onChange:()=>{u(y=>{const d=new Set(y);return d.has("permanent")?d.delete("permanent"):d.add("permanent"),d})},elevation:0,sx:{backgroundColor:"transparent",width:"100%"},disableGutters:!0,children:[e(B,{expandIcon:e(q,{}),children:e(S,{children:[t("permanent_codes")," (",A.length,h&&` / ${h.master} ${t("codes:on_device_count")}`,")"]})}),e(Y,{sx:{padding:"0 0 0 0 !important"},children:e(F,{codes:I("master"),deriveCodeMetadata:k,hasIndexConflict:M,onCopy:L,onEdit:o,onDelete:D})})]}),e(V,{expanded:i.has("temporary"),onChange:()=>{u(y=>{const d=new Set(y);return d.has("temporary")?d.delete("temporary"):d.add("temporary"),d})},elevation:0,sx:{backgroundColor:"transparent",width:"100%"},disableGutters:!0,children:[e(B,{expandIcon:e(q,{}),children:e(S,{children:[t("temporary_codes")," (",E.length,h&&` / ${h.single} ${t("codes:on_device_count")}`,")"]})}),e(Y,{sx:{padding:"0 0 0 0 !important"},children:e(F,{codes:I("temporary"),deriveCodeMetadata:k,onCopy:L,onEdit:o,onDelete:D})})]})]})},Me=()=>{const n=me();if(!n)return null;const{showNotification:r,hideNotification:p}=n;return e(v,{sx:{p:2},children:e(Ee,{showNotification:r,hideNotification:p})})};export{Me as CodeManagerWrapper};
