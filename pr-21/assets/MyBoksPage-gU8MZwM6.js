import{h as Y,b as e,g as j,a as Q,D as Z,u as J,f as P,c as ee,l as E,Q as N,d as te,s as O,e as me,R as ge,U as he,i as X,q as $,t as A,V as fe,T as b,I as _e,H as pe,F as ve,o as v,W as L,X as ye,Y as B,Z as be,$ as Ie,n as x,a0 as Re,a1 as Se,a2 as Te,a3 as k,a4 as D,a5 as Ce,a6 as w,a7 as Ee,a8 as G,a9 as Ae,aa as we,ab as ne,ac as ae,ad as se,ae as H,af as xe,ag as ke,ah as De,C as Ne,ai as F,aj as Fe,k as Le,v as Oe}from"./index-kwrMoR9X.js";import{I as K,V as W,a as q,A as Ue}from"./VisibilityOff-DL9zN2xx.js";import{D as Pe}from"./Delete-B3BdSr8E.js";import{T as Ge,a as M}from"./Tabs-BNkRkAWc.js";const Me=Y(e("path",{d:"M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"}));function Ve(t){return j("MuiAvatar",t)}Q("MuiAvatar",["root","colorDefault","circular","rounded","square","img","fallback"]);const ze=t=>{const{classes:a,variant:n,colorDefault:s}=t;return te({root:["root",n,s&&"colorDefault"],img:["img"],fallback:["fallback"]},Ve,a)},Be=O("div",{name:"MuiAvatar",slot:"Root",overridesResolver:(t,a)=>{const{ownerState:n}=t;return[a.root,a[n.variant],n.colorDefault&&a.colorDefault]}})(me(({theme:t})=>({position:"relative",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0,width:40,height:40,fontFamily:t.typography.fontFamily,fontSize:t.typography.pxToRem(20),lineHeight:1,borderRadius:"50%",overflow:"hidden",userSelect:"none",variants:[{props:{variant:"rounded"},style:{borderRadius:(t.vars||t).shape.borderRadius}},{props:{variant:"square"},style:{borderRadius:0}},{props:{colorDefault:!0},style:{color:(t.vars||t).palette.background.default,...t.vars?{backgroundColor:t.vars.palette.Avatar.defaultBg}:{backgroundColor:t.palette.grey[400],...t.applyStyles("dark",{backgroundColor:t.palette.grey[600]})}}}]}))),Ye=O("img",{name:"MuiAvatar",slot:"Img"})({width:"100%",height:"100%",textAlign:"center",objectFit:"cover",color:"transparent",textIndent:1e4}),Xe=O(Me,{name:"MuiAvatar",slot:"Fallback"})({width:"75%",height:"75%"});function $e({crossOrigin:t,referrerPolicy:a,src:n,srcSet:s}){const[u,d]=E(!1);return N(()=>{if(!n&&!s)return;d(!1);let i=!0;const c=new Image;return c.onload=()=>{i&&d("loaded")},c.onerror=()=>{i&&d("error")},c.crossOrigin=t,c.referrerPolicy=a,c.src=n,s&&(c.srcset=s),()=>{i=!1}},[t,a,n,s]),u}const He=Z(function(a,n){const s=J({props:a,name:"MuiAvatar"}),{alt:u,children:d,className:i,component:c="div",slots:r={},slotProps:_={},imgProps:p,sizes:y,src:I,srcSet:T,variant:R="circular",...l}=s;let m=null;const o={...s,component:c,variant:R},g=$e({...p,...typeof _.img=="function"?_.img(o):_.img,src:I,srcSet:T}),S=I||T,h=S&&g!=="error";o.colorDefault=!h,delete o.ownerState;const C=ze(o),[U,ie]=P("root",{ref:n,className:ee(C.root,i),elementType:Be,externalForwardedProps:{slots:r,slotProps:_,component:c,...l},ownerState:o}),[ce,le]=P("img",{className:C.img,elementType:Ye,externalForwardedProps:{slots:r,slotProps:{img:{...p,..._.img}}},additionalProps:{alt:u,src:I,srcSet:T,sizes:y},ownerState:o}),[de,ue]=P("fallback",{className:C.fallback,elementType:Xe,externalForwardedProps:{slots:r,slotProps:_},shouldForwardComponentProp:!0,ownerState:o});return h?m=e(ce,{...le}):d||d===0?m=d:S&&u?m=u[0]:m=e(de,{...ue}),e(U,{...ie,children:m})});function Ke(t){return j("MuiListItemAvatar",t)}Q("MuiListItemAvatar",["root","alignItemsFlexStart"]);const We=t=>{const{alignItems:a,classes:n}=t;return te({root:["root",a==="flex-start"&&"alignItemsFlexStart"]},Ke,n)},qe=O("div",{name:"MuiListItemAvatar",slot:"Root",overridesResolver:(t,a)=>{const{ownerState:n}=t;return[a.root,n.alignItems==="flex-start"&&a.alignItemsFlexStart]}})({minWidth:56,flexShrink:0,variants:[{props:{alignItems:"flex-start"},style:{marginTop:8}}]}),je=Z(function(a,n){const s=J({props:a,name:"MuiListItemAvatar"}),{className:u,...d}=s,i=ge(he),c={...s,alignItems:i.alignItems},r=We(c);return e(qe,{className:ee(r.root,u),ownerState:c,ref:n,...d})}),Qe=Y(e("path",{d:"M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20z"})),Ze=Y(e("path",{d:"M20 2H4c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2m0 18H4V4h16zM18 6h-5c-1.1 0-2 .9-2 2v2.28c-.6.35-1 .98-1 1.72 0 1.1.9 2 2 2s2-.9 2-2c0-.74-.4-1.38-1-1.72V8h3v8H8V8h2V6H6v12h12z"})),oe=(t,a)=>{if(!t||!a)return 0;const n=t.replace(/[^0-9.]/g,""),s=a.replace(/[^0-9.]/g,""),u=n.split(".").map(Number),d=s.split(".").map(Number);for(let i=0;i<Math.max(u.length,d.length);i++){const c=u[i]||0,r=d[i]||0;if(c>r)return 1;if(c<r)return-1}return 0},Je=({deviceId:t})=>{const{t:a}=X(["common","settings"]),{activeDevice:n,updateDeviceDetails:s,removeDevice:u,toggleLaPoste:d}=$(),[i,c]=A(E({key:!n?.configuration_key,pin:!n?.door_pin_code}),"visibleFields"),[r,_]=A(E(n?.friendly_name||""),"deviceName"),[p,y]=A(E(n?.configuration_key||""),"configurationKey"),[I,T]=A(E(n?.door_pin_code||""),"doorPinCode");fe.useEffect(()=>{n&&(_(n.friendly_name||""),y(n.configuration_key||""),T(n.door_pin_code||""))},[n]);const R=h=>{c(C=>({...C,[h]:!C[h]}))},l=async()=>{if(n)try{await s(t,{friendly_name:r,configuration_key:p,door_pin_code:I})}catch(h){console.error("Failed to update device details:",h)}},m=async h=>{try{await d(h.target.checked)}catch(C){console.error("Failed to toggle La Poste:",C)}},o=async()=>{if(n)try{await u(t)}catch(h){console.error("Failed to remove device:",h)}},g=h=>{const U=h.trim().toUpperCase().replace(/[^0-9A-F]/g,"").slice(-8);y(U)},S=h=>{const C=h.trim().toUpperCase();T(C)};return n?e(v,{sx:{my:2},children:[e(b,{variant:"subtitle1",gutterBottom:!0,children:a("devices.title")}),e(_e,{sx:{mb:2}}),e(pe,{children:e(ve,{children:e(v,{sx:{display:"flex",flexDirection:"column",gap:2},children:[e(L,{label:a("devices.device_name"),value:r,onChange:h=>_(h.currentTarget.value),fullWidth:!0,size:"small"}),n.role===ye.Admin&&e(L,{label:a("settings:configuration_key.label"),value:p,onChange:h=>g(h.currentTarget.value),fullWidth:!0,size:"small",type:i.key?"text":"password",helperText:a("settings:configuration_key.helper"),slotProps:{input:{endAdornment:e(K,{position:"end",children:e(B,{"aria-label":a("settings:toggle_key_visibility"),onClick:()=>R("key"),edge:"end",size:"small",children:i.key?e(W,{}):e(q,{})})})}}}),e(L,{label:a("settings:door_pin_code"),value:I,onChange:h=>S(h.currentTarget.value),fullWidth:!0,size:"small",type:i.pin?"text":"password",slotProps:{input:{endAdornment:e(K,{position:"end",children:e(B,{"aria-label":a("settings:toggle_pin_visibility"),onClick:()=>R("pin"),edge:"end",size:"small",children:i.pin?e(W,{}):e(q,{})})})}}}),n.hardware_version==="4.0"&&n.software_revision&&oe(n.software_revision,"4.2.0")>=0&&e(v,{children:e(be,{control:e(Ie,{checked:n.la_poste_activated||!1,onChange:m}),label:a("settings:activate_la_poste")})}),e(v,{sx:{display:"flex",justifyContent:"space-between",mt:2},children:[e(x,{size:"small",color:"error",variant:"outlined",onClick:o,children:a("devices.forget")}),e(x,{size:"small",variant:"contained",onClick:l,children:a("save")})]})]})})})]}):null};var re=(t=>(t[t.LA_POSTE=1]="LA_POSTE",t[t.VIGIK_TERTIARY=2]="VIGIK_TERTIARY",t[t.USER_BADGE=3]="USER_BADGE",t))(re||{}),f=(t=>(t.IDLE="idle",t.SCANNING="scanning",t.FOUND="found",t.TIMEOUT="timeout",t.ERROR_EXISTS="error_exists",t.ERROR="error",t))(f||{});const et=()=>{const{activeDevice:t}=$(),{sendRequest:a}=Re(),{addListener:n,removeListener:s}=Se(),[u,d]=A(E(f.IDLE),"scanStatus"),[i,c]=A(E(null),"scannedUid"),r=t?.id,_=Te(()=>r?k.nfc_tags.where("device_id").equals(r).toArray():[],[r]),p=D(async()=>{if(!r)throw new Error("No active device");const l=await k.device_secrets.get(r);if(!l?.configuration_key)throw new Error("Configuration Key required");return l.configuration_key},[r]),y=D(async()=>{try{const l=await p();d(f.SCANNING),c(null),await a(new Ce(l))}catch(l){console.error("Failed to start scan",l),d(f.ERROR)}},[p,a]);N(()=>{const l=m=>{if([w.NOTIFY_NFC_TAG_REGISTER_SCAN_RESULT,w.NOTIFY_NFC_TAG_REGISTER_SCAN_ERROR_EXISTS,w.NOTIFY_NFC_TAG_REGISTER_SCAN_TIMEOUT].includes(m.opcode)){const o=new Ee(m.opcode);switch(o.parse(m.payload),o.status){case G.TIMEOUT:d(f.TIMEOUT);break;case G.ALREADY_EXISTS:d(f.ERROR_EXISTS),o.uid&&c(o.uid);break;case G.FOUND:d(f.FOUND),o.uid&&c(o.uid);break;default:d(f.ERROR)}}};return n(w.NOTIFY_NFC_TAG_REGISTER_SCAN_RESULT,l),n(w.NOTIFY_NFC_TAG_REGISTER_SCAN_ERROR_EXISTS,l),n(w.NOTIFY_NFC_TAG_REGISTER_SCAN_TIMEOUT,l),()=>{s(w.NOTIFY_NFC_TAG_REGISTER_SCAN_RESULT,l),s(w.NOTIFY_NFC_TAG_REGISTER_SCAN_ERROR_EXISTS,l),s(w.NOTIFY_NFC_TAG_REGISTER_SCAN_TIMEOUT,l)}},[n,s]);const I=D(async l=>{if(!(!i||!r))try{const m=await p(),o=new Uint8Array(i.split(":").map(h=>parseInt(h,16))),g=new Ae(m,o);await a(g);const S=await k.nfc_tags.where({device_id:r,uid:i}).first();S?await k.nfc_tags.update(S.id,{name:l,updated_at:Date.now()}):await k.nfc_tags.add({id:crypto.randomUUID(),device_id:r,uid:i,name:l,type:re.USER_BADGE,created_at:Date.now(),sync_status:"created"}),d(f.IDLE),c(null)}catch(m){throw console.error("Failed to register tag",m),m}},[i,r,p,a]),T=D(async l=>{if(r)try{const m=await p(),o=new Uint8Array(l.uid.split(":").map(S=>parseInt(S,16))),g=new we(m,o);await a(g),await k.nfc_tags.delete(l.id)}catch(m){throw console.error("Failed to unregister tag",m),m}},[r,p,a]),R=D(()=>{d(f.IDLE),c(null)},[]);return{tags:_,scanStatus:u,scannedUid:i,startScan:y,registerTag:I,unregisterTag:T,resetScan:R}},tt=()=>{const{t}=X(["common","settings"]),a=t,{tags:n,scanStatus:s,scannedUid:u,startScan:d,registerTag:i,unregisterTag:c,resetScan:r}=et(),[_,p]=A(E(!1),"openAddDialog"),[y,I]=A(E(""),"tagName"),T=()=>{r(),I(""),p(!0)},R=()=>{p(!1),r()},l=()=>{d()},m=async()=>{if(y.trim())try{await i(y.trim()),R()}catch(g){console.error(g)}},o=async g=>{if(confirm(a("common:confirm_delete")))try{await c(g)}catch(S){console.error(S),alert(t("settings:nfc.error_delete_failed"))}};return N(()=>{u&&!y&&I(`Badge ${u.substring(0,5)}`)},[u,y]),e(v,{sx:{p:2},children:[e(v,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2},children:[e(b,{variant:"h6",children:t("settings:nfc.title")}),e(x,{variant:"contained",startIcon:e(Ue,{}),onClick:T,children:t("settings:nfc.add_tag")})]}),n&&n.length>0?e(ne,{children:n.map(g=>e(ae,{secondaryAction:e(B,{edge:"end","aria-label":"delete",onClick:()=>o(g),children:e(Pe,{})}),children:[e(je,{children:e(He,{children:e(Ze,{})})}),e(se,{primary:g.name,secondary:e(H,{children:[e(b,{component:"span",variant:"body2",color:"textPrimary",children:g.uid}),e("br",{}),g.last_seen_at?t("settings:nfc.last_seen",{date:new Date(g.last_seen_at).toLocaleString()}):t("settings:nfc.never_seen")]})})]},g.id))}):e(b,{variant:"body1",color:"textSecondary",align:"center",sx:{mt:4},children:t("settings:nfc.no_tags")}),e(xe,{open:_,onClose:R,fullWidth:!0,maxWidth:"sm",children:[e(ke,{children:t("settings:nfc.dialog_title")}),e(De,{children:e(v,{sx:{display:"flex",flexDirection:"column",alignItems:"center",gap:2,py:2},children:[s===f.IDLE&&e(b,{children:t("settings:nfc.instructions_idle")}),s===f.SCANNING&&e(H,{children:[e(Ne,{}),e(b,{children:t("settings:nfc.instructions_scanning")})]}),s===f.TIMEOUT&&e(F,{severity:"warning",children:t("settings:nfc.error_timeout")}),s===f.ERROR&&e(F,{severity:"error",children:t("settings:nfc.error_generic")}),s===f.ERROR_EXISTS&&e(F,{severity:"info",children:[t("settings:nfc.error_exists"),u&&e(v,{sx:{mt:1},children:[e(b,{variant:"caption",children:["UID: ",u]}),e(b,{children:t("settings:nfc.instructions_exists_local")})]})]}),(s===f.FOUND||s===f.ERROR_EXISTS)&&u&&e(v,{sx:{width:"100%",mt:2},children:[e(F,{severity:"success",sx:{mb:2},children:t("settings:nfc.tag_found",{uid:u})}),e(L,{autoFocus:!0,margin:"dense",label:t("settings:nfc.input_label"),fullWidth:!0,value:y,onChange:g=>I(g.target.value)})]})]})}),e(Fe,{children:[e(x,{onClick:R,children:t("common:cancel")}),s===f.IDLE||s===f.TIMEOUT||s===f.ERROR?e(x,{onClick:l,variant:"contained",children:t("settings:nfc.button_start_scan")}):null,(s===f.FOUND||s===f.ERROR_EXISTS)&&e(x,{onClick:m,variant:"contained",disabled:!y,children:t("settings:nfc.add_tag")})]})]})]})};function V(t){const{children:a,value:n,index:s,...u}=t;return e("div",{role:"tabpanel",hidden:n!==s,id:`my-boks-tabpanel-${s}`,"aria-labelledby":`my-boks-tab-${s}`,...u,children:n===s&&e(v,{sx:{p:3},children:a})})}function z(t){return{id:`my-boks-tab-${t}`,"aria-controls":`my-boks-tabpanel-${t}`}}const rt=()=>{const{t}=X(["common","codes","logs","settings"]),{activeDevice:a,knownDevices:n,setActiveDevice:s}=$(),{isConnected:u}=Le(),d=Oe(),[i,c]=A(E(0),"value"),[r,_]=A(E(null),"selectedDeviceId");N(()=>{const g=new URLSearchParams(d.search).get("tab"),S=setTimeout(()=>{switch(g){case"settings":c(0);break;case"users":c(1);break;default:c(0);break}},0);return()=>clearTimeout(S)},[d.search]),N(()=>{(!a||!n.some(o=>o.id===a.id))&&r!==null&&setTimeout(()=>_(null),0)},[a,n,r]);const p=(o,g)=>{c(g)},y=o=>{_(o),s(o)},I=()=>{_(null),s(null)},T=n.length>1&&!r&&!a,R=a&&a.hardware_version==="4.0"&&a.software_revision&&oe(a.software_revision,"4.3.3")>=0;let l=t("common:my_boks");return a&&n.length===1||a&&n.length>1?l=a.friendly_name||a.ble_name:!a&&n.length===1&&(l=n[0].friendly_name||n[0].ble_name),T?e(v,{sx:{p:3},children:[e(b,{variant:"h5",gutterBottom:!0,children:t("common:my_boks")}),e(ne,{children:n.map(o=>e(ae,{onClick:()=>y(o.id),sx:{cursor:"pointer"},children:e(se,{primary:o.friendly_name||o.ble_name,secondary:o.ble_name})},o.id))})]}):a||n.find(o=>o.id===r)||(n.length===1?n[0]:null)?e(v,{sx:{width:"100%"},children:[e(v,{sx:{p:3,borderBottom:1,borderColor:"divider"},children:[n.length>1&&e(x,{startIcon:e(Qe,{}),onClick:I,sx:{mb:1},children:t("common:back_to_list")}),e(b,{variant:"h4",component:"h1",gutterBottom:!0,children:l}),e(b,{variant:"subtitle1",color:"textSecondary",children:t(u?"common:connected":"common:disconnected")})]}),e(v,{sx:{borderBottom:1,borderColor:"divider"},children:e(Ge,{value:i,onChange:p,"aria-label":"my boks tabs",children:[e(M,{label:t("settings:title"),...z(0)}),e(M,{label:t("common:users.title"),...z(1)}),R&&e(M,{label:"Tags NFC",...z(2)})]})}),e(V,{value:i,index:0,children:e(Je,{deviceId:a?.id||""})}),e(V,{value:i,index:1,children:e(v,{sx:{p:3},children:[e(b,{variant:"h6",children:t("common:users.title")}),e(b,{variant:"body1",color:"textSecondary",children:t("common:coming_soon")})]})}),R&&e(V,{value:i,index:2,children:e(tt,{})})]}):e(v,{sx:{p:3},children:[e(b,{variant:"h5",children:t("common:my_boks")}),e(b,{variant:"body1",color:"textSecondary",children:t("common:no_active_device")})]})};export{rt as MyBoksPage};
