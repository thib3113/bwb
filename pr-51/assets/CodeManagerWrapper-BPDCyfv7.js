import{e as Y,j as e,f as N,n as q,U as P,r as x,bl as u,b2 as W,a4 as H,a5 as X,a6 as Z,a7 as J,k as b,K as k,M as T,aT as Q,aU as ee,aV as te,aW as R,a8 as se,l as U,bm as L,a2 as ae,a3 as ne,T as A,bn as oe,ay as $,aq as ie,a1 as re,bo as de,aj as le,aX as O,aY as G,am as V,aZ as z,o as ce}from"./index-Bb-Yfg3Y.js";import{I as ue,V as xe,a as pe,A as K}from"./VisibilityOff-BjDcMQ28.js";import{D as me}from"./Delete-C82nXPOP.js";import{E as he}from"./Edit-hYb4B3eX.js";const je=Y(e.jsx("path",{d:"m19 8-4 4h3c0 3.31-2.69 6-6 6-1.01 0-1.97-.25-2.8-.7l-1.46 1.46C8.97 19.54 10.43 20 12 20c4.42 0 8-3.58 8-8h3zM6 12c0-3.31 2.69-6 6-6 1.01 0 1.97.25 2.8.7l1.46-1.46C15.03 4.46 13.57 4 12 4c-4.42 0-8 3.58-8 8H1l4 4 4-4z"})),fe=t=>{const i=new Uint32Array(1);return crypto.getRandomValues(i),i[0]%t},B=()=>{const t="0123456789AB";let i="";for(let d=0;d<6;d++)i+=t.charAt(fe(t.length));return i},ge=t=>t?t.toUpperCase().replace(/[^0-9AB]/g,""):"",Ce=({open:t,onClose:i,onSave:d,editingCode:o})=>{const{t:s}=N(["codes","common"]),{activeDevice:a}=q(),p=!!a?.configuration_key,h=a?.role===P.Owner||a?.role===P.Admin,[r,g]=x.useState(u.MASTER),[v,j]=x.useState(""),[I,_]=x.useState(""),[c,C]=x.useState(0),[D,E]=x.useState(1),[S,w]=x.useState(!0);x.useEffect(()=>{if(t){const n=setTimeout(()=>{o?(g(o.type),j(o.code),_(o.name||o.description||""),C(o.index||0),E(o.uses||1)):(g(u.MASTER),j(B()),_(""),C(0),E(1)),w(!0)},0);return()=>clearTimeout(n)}},[o,t]),x.useEffect(()=>{t&&a?.id&&r===u.MASTER&&W.loadCodes(a.id).then(n=>{const f=n.filter(m=>m.type===u.MASTER&&m.status!=="pending_delete").map(m=>m.index).filter(m=>m!==void 0),l=Math.max(...f,-1)+1;C(l)})},[t,a?.id,r]);const y=()=>{g(u.MASTER),j(""),_(""),C(0),E(1),i()},M=async()=>{const n=ge(v);if(j(n),r===u.MASTER&&a?.id){const l=(await W.loadCodes(a.id)).find(m=>m.type===u.MASTER&&m.index===c&&m.status!=="pending_delete"&&(!o||m.id!==o.id));if(l){d({type:r,code:n,name:I,index:c,maxUses:D},l.id),y();return}}d({type:r,code:n,name:I,index:c,maxUses:D},o?o.id:null),y()};return e.jsx(e.Fragment,{children:e.jsxs(H,{open:t,onClose:y,maxWidth:"sm",fullWidth:!0,children:[e.jsx(X,{children:s(o?"edit_code":"add_new")}),e.jsxs(Z,{children:[!a?.configuration_key&&e.jsx(J,{severity:"warning",sx:{mb:2},children:s("config_key_missing")}),e.jsxs(b,{sx:{display:"flex",flexDirection:"column",gap:2,mt:1},children:[e.jsxs(b,{sx:{display:"flex",gap:1},children:[e.jsx(k,{label:s("pin_label"),value:v,onChange:n=>j(n.currentTarget.value.trim().toUpperCase()),fullWidth:!0,type:S?"text":"password",inputProps:{maxLength:6,"data-testid":"code-pin-input"},InputProps:{endAdornment:e.jsx(ue,{position:"end",children:e.jsx(T,{"aria-label":"toggle code visibility",onClick:()=>w(!S),edge:"end",size:"small",children:S?e.jsx(xe,{}):e.jsx(pe,{})})})}}),e.jsx(T,{onClick:()=>j(B()),"aria-label":s("generate"),"data-testid":"generate-code-button",children:e.jsx(je,{})})]}),e.jsx(k,{label:s("description_label"),value:I,onChange:n=>_(n.currentTarget.value),placeholder:s("description_placeholder"),inputProps:{"data-testid":"code-name-input"},fullWidth:!0,required:!0}),e.jsxs(Q,{fullWidth:!0,children:[e.jsx(ee,{children:s("type_label")}),e.jsxs(te,{value:r,onChange:n=>g(n.target.value),label:s("type_label"),"data-testid":"code-type-select",children:[(!h||h&&p)&&e.jsx(R,{value:u.MASTER,children:s("master_code")}),e.jsx(R,{value:u.SINGLE,children:s("single_use_code")}),e.jsx(R,{value:u.MULTI,children:s("multi_use_code")})]})]}),r===u.MASTER&&e.jsx(k,{label:`${s("index_label")}: ${c}`,type:"number",value:c,onChange:n=>C(parseInt(n.currentTarget.value)||0),fullWidth:!0,disabled:!h,inputProps:{min:0,max:255,"data-testid":"code-index-input"}}),r===u.MULTI&&e.jsx(k,{label:s("uses_label"),type:"number",value:D,onChange:n=>E(parseInt(n.currentTarget.value)||1),fullWidth:!0,inputProps:{min:1,max:3,"data-testid":"code-uses-input"}})]})]}),e.jsxs(se,{children:[e.jsx(U,{onClick:y,children:s("cancel")}),e.jsx(U,{onClick:M,variant:"contained","data-testid":"save-code-button",startIcon:e.jsx(K,{}),disabled:!v||v.length!==6||I.trim()==="",children:s(o?"save":"generate")})]})]})})},ye=({code:t,metadata:i,onCopy:d,onEdit:o,onDelete:s})=>{const{t:a}=N("codes"),p=t.status===L.PENDING_DELETE,h=i.used,r=p||h;return e.jsxs(ae,{divider:!0,"data-testid":`code-item-${t.code}`,"data-status":t.status,sx:{opacity:r?.6:1,backgroundColor:r?"action.selected":"inherit",textDecoration:r?"line-through":"none",borderLeft:"4px solid",borderLeftColor:t.status===L.ON_DEVICE?"primary.main":t.status===L.PENDING_ADD?"warning.main":t.status===L.PENDING_DELETE?"error.main":"default.main",pl:1},children:[e.jsx(ne,{primary:e.jsxs(b,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap"},children:[e.jsx(A,{variant:"body1",sx:{fontWeight:"bold"},children:t.name||t.description||a("unnamed")}),e.jsxs(A,{variant:"caption",sx:{ml:1},children:[a("pin_label"),": ",t.code]})]}),secondary:null,slotProps:{primary:{component:"div"},secondary:{component:"div"}}}),e.jsxs(oe,{children:[e.jsx($,{title:a("copy_code"),children:e.jsx(T,{edge:"end","aria-label":"copy",onClick:()=>d(t.code),children:e.jsx(ie,{})})}),e.jsx($,{title:a("edit_description"),children:e.jsx(T,{edge:"end","aria-label":"edit",onClick:()=>o(t),"data-testid":`edit-code-${t.code}`,children:e.jsx(he,{})})}),e.jsx(T,{edge:"end","aria-label":"delete",onClick:()=>s(t.id),"data-testid":`delete-code-${t.code}`,children:e.jsx(me,{})})]})]})},F=({codes:t,deriveCodeMetadata:i,hasIndexConflict:d,onCopy:o,onEdit:s,onDelete:a})=>e.jsx(re,{children:t.map(p=>e.jsx(ye,{code:p,metadata:i(p),hasIndexConflict:d?d(p.index,p.id):!1,onCopy:o,onEdit:s,onDelete:a},p.id))}),be=({showAddForm:t,setShowAddForm:i,showNotification:d,hideNotification:o})=>{const{t:s}=N(["codes","common"]),{activeDevice:a}=q(),[p,h]=x.useState(!1),[r,g]=x.useState(new Set(["permanent","temporary"])),[v,j]=x.useState(null),{masterCodes:I,temporaryCodes:_,codeCount:c,refreshCodeCount:C,hasIndexConflict:D,handleAddCode:E,handleDeleteCode:S,deriveCodeMetadata:w,getFilteredCodes:y,handleCopyCode:M}=de(d),n=x.useCallback(f=>{j(f),h(!0)},[]);return e.jsxs(b,{sx:{width:"100%"},children:[e.jsxs(b,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2},children:[e.jsxs(A,{variant:"h5",children:[s("title")," ",c&&`(Total: ${c.total})`]}),e.jsxs(b,{sx:{display:"flex",gap:1},children:[e.jsx(U,{variant:"outlined",startIcon:e.jsx(le,{}),onClick:C,size:"small",children:s("refresh")}),e.jsx(T,{color:"primary",onClick:()=>h(!0),"aria-label":s("add_new"),"data-testid":"add-code-button",size:"small",children:e.jsx(K,{})})]})]}),a&&e.jsx(A,{variant:"subtitle1",color:"textSecondary",sx:{mb:2},children:a.friendly_name||a.ble_name}),e.jsx(Ce,{open:p||t||!1,onClose:()=>{h(!1),i&&i(!1),j(null)},onSave:E,editingCode:v}),e.jsxs(O,{expanded:r.has("permanent"),onChange:()=>{g(f=>{const l=new Set(f);return l.has("permanent")?l.delete("permanent"):l.add("permanent"),l})},elevation:0,sx:{backgroundColor:"transparent",width:"100%"},disableGutters:!0,children:[e.jsx(G,{expandIcon:e.jsx(V,{}),children:e.jsxs(A,{children:[s("permanent_codes")," (",I.length,c&&` / ${c.master} ${s("codes:on_device_count")}`,")"]})}),e.jsx(z,{sx:{padding:"0 0 0 0 !important"},children:e.jsx(F,{codes:y("master"),deriveCodeMetadata:w,hasIndexConflict:D,onCopy:M,onEdit:n,onDelete:S})})]}),e.jsxs(O,{expanded:r.has("temporary"),onChange:()=>{g(f=>{const l=new Set(f);return l.has("temporary")?l.delete("temporary"):l.add("temporary"),l})},elevation:0,sx:{backgroundColor:"transparent",width:"100%"},disableGutters:!0,children:[e.jsx(G,{expandIcon:e.jsx(V,{}),children:e.jsxs(A,{children:[s("temporary_codes")," (",_.length,c&&` / ${c.single} ${s("codes:on_device_count")}`,")"]})}),e.jsx(z,{sx:{padding:"0 0 0 0 !important"},children:e.jsx(F,{codes:y("temporary"),deriveCodeMetadata:w,onCopy:M,onEdit:n,onDelete:S})})]})]})},Se=()=>{const t=ce();if(!t)return null;const{showNotification:i,hideNotification:d}=t;return e.jsx(b,{sx:{p:2},children:e.jsx(be,{showNotification:i,hideNotification:d})})};export{Se as CodeManagerWrapper};
