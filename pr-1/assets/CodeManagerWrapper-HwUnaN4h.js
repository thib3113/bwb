import{h as P,b as e,i as $,q as K,a7 as O,t as C,l as g,aV as c,Y as z,aW as V,aX as X,aY as Z,aZ as J,aw as ee,o as I,a6 as R,a8 as M,a_ as ne,a$ as te,b0 as ae,b1 as U,b2 as oe,n as W,Q as se,b3 as N,ab as re,T as S,b4 as le,aP as B,aF as ie,aa as de,a9 as ce,b5 as he,a1 as pe,ay as ue,b6 as G,b7 as F,aB as Y,b8 as q,r as me}from"./index-CBGxyqjB.js";import{I as xe,V as Ce,a as ge}from"./VisibilityOff-adRH7hkY.js";import{D as ye}from"./Delete-Cm9vQpXc.js";const Q=P(e("path",{d:"M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6z"})),fe=P(e("path",{d:"m19 8-4 4h3c0 3.31-2.69 6-6 6-1.01 0-1.97-.25-2.8-.7l-1.46 1.46C8.97 19.54 10.43 20 12 20c4.42 0 8-3.58 8-8h3zM6 12c0-3.31 2.69-6 6-6 1.01 0 1.97.25 2.8.7l1.46-1.46C15.03 4.46 13.57 4 12 4c-4.42 0-8 3.58-8 8H1l4 4 4-4z"})),be=P(e("path",{d:"M3 17.25V21h3.75L17.81 9.94l-3.75-3.75zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34a.996.996 0 0 0-1.41 0l-1.83 1.83 3.75 3.75z"})),ve=n=>{const l=new Uint32Array(1);return crypto.getRandomValues(l),l[0]%n},H=()=>{const n="0123456789AB";let l="";for(let i=0;i<6;i++)l+=n.charAt(ve(n.length));return l},Ie=n=>n?n.toUpperCase().replace(/[^0-9AB]/g,""):"",_e=({open:n,onClose:l,onSave:i,editingCode:a})=>{const{t}=$(["codes","common"]),{activeDevice:o}=K(),p=!!o?.configuration_key,m=o?.role===O.Owner||o?.role===O.Admin,[r,f]=C(g(c.MASTER),"type"),[_,x]=C(g(""),"code"),[A,E]=C(g(""),"name"),[h,b]=C(g(0),"index"),[w,T]=C(g(1),"uses"),[D,k]=C(g(!0),"showCode");z(()=>{if(n){const s=setTimeout(()=>{a?(f(a.type),x(a.code),E(a.name||a.description||""),b(a.index||0),T(a.uses||1)):(f(c.MASTER),x(H()),E(""),b(0),T(1))},0);return()=>clearTimeout(s)}},[a,n]),z(()=>{n&&o?.id&&r===c.MASTER&&V.loadCodes(o.id).then(s=>{const y=s.filter(u=>u.type===c.MASTER&&u.status!=="pending_delete").map(u=>u.index).filter(u=>u!==void 0),d=Math.max(...y,-1)+1;b(d)})},[n,o?.id,r]);const v=()=>{f(c.MASTER),x(""),E(""),b(0),T(1),k(!1),l()},L=async()=>{const s=Ie(_);if(x(s),r===c.MASTER&&o?.id){const d=(await V.loadCodes(o.id)).find(u=>u.type===c.MASTER&&u.index===h&&u.status!=="pending_delete"&&(!a||u.id!==a.id));if(d){i({type:r,code:s,name:A,index:h,maxUses:w},d.id),v();return}}i({type:r,code:s,name:A,index:h,maxUses:w},a?a.id:null),v()};return e(se,{children:e(X,{open:n,onClose:v,maxWidth:"sm",fullWidth:!0,children:[e(Z,{children:t(a?"edit_code":"add_new")}),e(J,{children:[!o?.configuration_key&&e(ee,{severity:"warning",sx:{mb:2},children:t("config_key_missing")}),e(I,{sx:{display:"flex",flexDirection:"column",gap:2,mt:1},children:[e(I,{sx:{display:"flex",gap:1},children:[e(R,{label:t("pin_label"),value:_,onChange:s=>x(s.currentTarget.value.trim().toUpperCase()),fullWidth:!0,type:D?"text":"password",slotProps:{htmlInput:{maxLength:6},input:{endAdornment:e(xe,{position:"end",children:e(M,{"aria-label":"toggle code visibility",onClick:()=>k(!D),edge:"end",size:"small",children:D?e(Ce,{}):e(ge,{})})})}}}),e(M,{onClick:()=>x(H()),"aria-label":t("generate"),children:e(fe,{})})]}),e(R,{label:t("description_label"),value:A,onChange:s=>E(s.currentTarget.value),placeholder:t("description_placeholder"),fullWidth:!0}),e(ne,{fullWidth:!0,children:[e(te,{children:t("type_label")}),e(ae,{value:r,onChange:s=>f(s.target.value),label:t("type_label"),children:[(!m||m&&p)&&e(U,{value:c.MASTER,children:t("master_code")}),e(U,{value:c.SINGLE,children:t("single_use_code")}),e(U,{value:c.MULTI,children:t("multi_use_code")})]})]}),r===c.MASTER&&e(R,{label:`${t("index_label")}: ${h}`,type:"number",value:h,onChange:s=>b(parseInt(s.currentTarget.value)||0),fullWidth:!0,disabled:!m,slotProps:{htmlInput:{min:0,max:255}}}),r===c.MULTI&&e(R,{label:t("uses_label"),type:"number",value:w,onChange:s=>T(parseInt(s.currentTarget.value)||1),fullWidth:!0,slotProps:{htmlInput:{min:1,max:3}}})]})]}),e(oe,{children:[e(W,{onClick:v,children:t("cancel")}),e(W,{onClick:L,variant:"contained",startIcon:e(Q,{}),disabled:r===c.MASTER&&(!_||_.length!==6)||r!==c.MASTER&&A.trim()==="",children:t(a?"save":"generate")})]})]})})},Ae=({code:n,metadata:l,onCopy:i,onEdit:a,onDelete:t})=>{const{t:o}=$("codes"),p=n.status===N.PENDING_DELETE,m=l.used,r=p||m;return e(de,{divider:!0,sx:{opacity:r?.6:1,backgroundColor:r?"action.selected":"inherit",textDecoration:r?"line-through":"none",borderLeft:"4px solid",borderLeftColor:n.status===N.ON_DEVICE?"primary.main":n.status===N.PENDING_ADD?"warning.main":n.status===N.PENDING_DELETE?"error.main":"default.main",pl:1},children:[e(re,{primary:e(I,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap"},children:[e(S,{variant:"body1",sx:{fontWeight:"bold"},children:n.name||n.description||o("unnamed")}),e(S,{variant:"caption",sx:{ml:1},children:[o("pin_label"),": ",n.code]})]}),secondary:null,slotProps:{primary:{component:"div"},secondary:{component:"div"}}}),e(le,{children:[e(B,{title:o("copy_code"),children:e(M,{edge:"end","aria-label":"copy",onClick:()=>i(n.code),children:e(ie,{})})}),e(B,{title:o("edit_description"),children:e(M,{edge:"end","aria-label":"edit",onClick:()=>a(n),children:e(be,{})})}),e(M,{edge:"end","aria-label":"delete",onClick:()=>t(n.id),children:e(ye,{})})]})]})},j=({codes:n,deriveCodeMetadata:l,hasIndexConflict:i,onCopy:a,onEdit:t,onDelete:o})=>e(ce,{children:n.map(p=>e(Ae,{code:p,metadata:l(p),hasIndexConflict:i?i(p.index,p.id):!1,onCopy:a,onEdit:t,onDelete:o},p.id))}),Ee=({showAddForm:n,setShowAddForm:l,showNotification:i,hideNotification:a})=>{const{t}=$(["codes","common"]),{activeDevice:o}=K(),[p,m]=C(g(!1),"isAddDialogOpen"),[r,f]=C(g(new Set(["permanent","temporary"])),"expandedAccordions"),[_,x]=C(g(null),"editingCode"),{masterCodes:A,temporaryCodes:E,codeCount:h,refreshCodeCount:b,hasIndexConflict:w,handleAddCode:T,handleDeleteCode:D,deriveCodeMetadata:k,getFilteredCodes:v,handleCopyCode:L}=he(i,a),s=pe(y=>{x(y),m(!0)},[]);return e(I,{sx:{width:"100%"},children:[e(I,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2},children:[e(S,{variant:"h5",children:[t("title")," ",h&&`(Total: ${h.total})`]}),e(I,{sx:{display:"flex",gap:1},children:[e(W,{variant:"outlined",startIcon:e(ue,{}),onClick:b,size:"small",children:t("refresh")}),e(M,{color:"primary",onClick:()=>m(!0),"aria-label":t("add_new"),size:"small",children:e(Q,{})})]})]}),o&&e(S,{variant:"subtitle1",color:"textSecondary",sx:{mb:2},children:o.friendly_name||o.ble_name}),e(_e,{open:p||n||!1,onClose:()=>{m(!1),l&&l(!1),x(null)},onSave:T,editingCode:_}),e(G,{expanded:r.has("permanent"),onChange:()=>{f(y=>{const d=new Set(y);return d.has("permanent")?d.delete("permanent"):d.add("permanent"),d})},elevation:0,sx:{backgroundColor:"transparent",width:"100%"},disableGutters:!0,children:[e(F,{expandIcon:e(Y,{}),children:e(S,{children:[t("permanent_codes")," (",A.length,h&&` / ${h.master} ${t("codes:on_device_count")}`,")"]})}),e(q,{sx:{padding:"0 0 0 0 !important"},children:e(j,{codes:v("master"),deriveCodeMetadata:k,hasIndexConflict:w,onCopy:L,onEdit:s,onDelete:D})})]}),e(G,{expanded:r.has("temporary"),onChange:()=>{f(y=>{const d=new Set(y);return d.has("temporary")?d.delete("temporary"):d.add("temporary"),d})},elevation:0,sx:{backgroundColor:"transparent",width:"100%"},disableGutters:!0,children:[e(F,{expandIcon:e(Y,{}),children:e(S,{children:[t("temporary_codes")," (",E.length,h&&` / ${h.single} ${t("codes:on_device_count")}`,")"]})}),e(q,{sx:{padding:"0 0 0 0 !important"},children:e(j,{codes:v("temporary"),deriveCodeMetadata:k,onCopy:L,onEdit:s,onDelete:D})})]})]})},Me=()=>{const n=me();if(!n)return null;const{showNotification:l,hideNotification:i}=n;return e(I,{sx:{p:2},children:e(Ee,{showNotification:l,hideNotification:i})})};export{Me as CodeManagerWrapper};
