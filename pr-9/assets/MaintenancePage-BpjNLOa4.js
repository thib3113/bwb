import{g as w,a as E,D as P,u as R,b as t,c as O,d as A,s as I,h as k,i as S,T as h,t as C,l as f,q as T,F as L,at as M,o as D,P as U,a9 as N,aa as B,ab as K,n as $,H as q,aR as F,aL as v,aS as z,aT as H}from"./index-QolF83G2.js";import{C as W}from"./Container-DHvyDe5Q.js";import{L as Y}from"./LinearProgress-D3aeuORz.js";function j(s){return w("MuiCardActions",s)}E("MuiCardActions",["root","spacing"]);const G=s=>{const{classes:e,disableSpacing:n}=s;return A({root:["root",!n&&"spacing"]},j,e)},J=I("div",{name:"MuiCardActions",slot:"Root",overridesResolver:(s,e)=>{const{ownerState:n}=s;return[e.root,!n.disableSpacing&&e.spacing]}})({display:"flex",alignItems:"center",padding:8,variants:[{props:{disableSpacing:!1},style:{"& > :not(style) ~ :not(style)":{marginLeft:8}}}]}),Q=P(function(e,n){const a=R({props:e,name:"MuiCardActions"}),{disableSpacing:c=!1,className:l,...o}=a,d={...a,disableSpacing:c},r=G(d);return t(J,{className:O(r.root,l),ownerState:d,ref:n,...o})}),V=k(t("path",{d:"M8 5v14l11-7z"})),X=({script:s})=>{const{t:e}=S(["maintenance"]),[n,a]=C(f(!1),"running"),[c,l]=C(f(0),"progress"),[o,d]=C(f([]),"logs"),[r,u]=C(f(null),"error"),{activeDevice:x}=T(),p=async()=>{const i=z.getInstance();if(i.getState()!=="connected"){u(e("status.not_connected"));return}const g=x?.configuration_key;if(!g){u(e("status.missing_config_key"));return}a(!0),l(0),d([]),u(null);const _=m=>d(y=>[...y.slice(-4),m]);try{await s.run({setProgress:l,log:_,checkStop:()=>{},t:e},{bleService:i,configKey:g}),_(e("status.finished")),l(100)}catch(m){console.error(m);const y=m instanceof Error?m.message:String(m);u(e("status.error",{message:y})),_(e("status.error",{message:y}))}finally{a(!1)}};return t(q,{sx:{mb:2},children:[t(L,{children:[t(h,{variant:"h6",component:"div",children:e(s.titleKey)}),t(h,{sx:{mb:1.5},color:"text.secondary",children:e(s.descriptionKey)}),r&&t(M,{severity:"error",sx:{mb:2},children:r}),(n||o.length>0)&&t(D,{sx:{width:"100%",mb:2},children:[t(Y,{variant:"determinate",value:c}),t(h,{variant:"body2",color:"text.secondary",align:"right",children:e("progress",{percent:Math.round(c)})})]}),o.length>0&&t(U,{variant:"outlined",sx:{p:1,bgcolor:"background.default",maxHeight:100,overflow:"auto"},children:t(N,{dense:!0,disablePadding:!0,children:o.map((i,g)=>t(B,{disablePadding:!0,children:t(K,{primary:i,primaryTypographyProps:{variant:"caption",fontFamily:"monospace"}})},g))})})]}),t(Q,{children:t($,{size:"small",variant:"contained",startIcon:t(V,{}),onClick:p,disabled:n,children:e("run")})})]})},b=async s=>{const e=new H,n=await s.sendRequest(e,{expectResponse:!0});if(n.opcode!==v.NOTIFY_CODES_COUNT)throw new Error(`Unexpected response opcode: 0x${n.opcode.toString(16)}`);if(n.payload.length<2)throw new Error("Invalid payload length for CODES_COUNT");return n.payload[0]<<8|n.payload[1]},Z={id:"clean_master_codes",titleKey:"scripts.clean_master_codes.title",descriptionKey:"scripts.clean_master_codes.description",run:async({setProgress:s,log:e,checkStop:n,t:a},{bleService:c,configKey:l})=>{e(a("status.fetching_count"));let o=await b(c);if(e(a("status.initial_count",{count:o})),o===0){e(a("status.no_codes"));return}const d=256;for(let r=0;r<d;r++){n();const u=r/d*100;for(s(u);;){n(),e(a("status.deleting_index",{index:r,count:o}));const x=new F(l,r);let p=!1;try{const i=await c.sendRequest(x,{expectResponse:!0},l);i.opcode===v.CODE_OPERATION_SUCCESS?(e(a("status.success_index",{index:r})),p=!0):i.opcode===v.CODE_OPERATION_ERROR&&(e(a("status.error_index",{index:r})),p=!1)}catch(i){const g=i instanceof Error?i.message:String(i);e(a("status.error",{message:`Index ${r}: ${g}`})),p=!1}if(!p)break}if(o=await b(c),o===0){e(a("status.stopping_early"));break}}}},ne=()=>{const{t:s}=S(["maintenance"]);return t(W,{maxWidth:"sm",sx:{mt:2,pb:10},children:[t(h,{variant:"h4",gutterBottom:!0,children:s("title")}),t(h,{variant:"body2",color:"text.secondary",paragraph:!0,children:s("description")}),t(X,{script:Z})]})};export{ne as MaintenancePage};
