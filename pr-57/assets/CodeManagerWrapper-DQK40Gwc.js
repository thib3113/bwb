import{e as ne,j as e,f as B,n as ae,U as F,r as u,bm as c,b3 as q,a6 as le,a7 as ce,a8 as ue,a1 as xe,k as b,K as R,M as D,aT as pe,aU as me,aV as he,aW as P,a9 as fe,l as W,bn as U,a4 as je,a5 as ge,T as C,bo as ye,a2 as K,ar as Ce,a3 as be,bp as ve,bq as Ie,br as _e,i as Se,bs as Ee,aX as Y,aY as H,an as X,aZ as Z,ak as J,o as Ae}from"./index-DwoGkIdu.js";import{I as Te,V as De,a as ke,A as oe}from"./VisibilityOff-B1YuzzWY.js";import{L as we}from"./Lock-BViFd9Aw.js";import{D as Le}from"./Delete-CZvi4vH6.js";import{E as Me}from"./Edit-9SGoQ0rA.js";const Re=ne(e.jsx("path",{d:"m19 8-4 4h3c0 3.31-2.69 6-6 6-1.01 0-1.97-.25-2.8-.7l-1.46 1.46C8.97 19.54 10.43 20 12 20c4.42 0 8-3.58 8-8h3zM6 12c0-3.31 2.69-6 6-6 1.01 0 1.97.25 2.8.7l1.46-1.46C15.03 4.46 13.57 4 12 4c-4.42 0-8 3.58-8 8H1l4 4 4-4z"})),Q=ne(e.jsx("path",{d:"M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8m0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4z"})),Ue=t=>{const i=new Uint32Array(1);return crypto.getRandomValues(i),i[0]%t},ee=()=>{const t="0123456789AB";let i="";for(let r=0;r<6;r++)i+=t.charAt(Ue(t.length));return i},Ne=t=>t?t.toUpperCase().replace(/[^0-9AB]/g,""):"",Pe=({open:t,onClose:i,onSave:r,editingCode:a})=>{const{t:s}=B(["codes","common"]),{activeDevice:n}=ae(),x=!!n?.configuration_key,v=n?.role===F.Owner||n?.role===F.Admin,[d,S]=u.useState(c.MASTER),[E,f]=u.useState(""),[A,j]=u.useState(""),[g,y]=u.useState(0),[k,I]=u.useState(1),[w,L]=u.useState(!0);u.useEffect(()=>{if(t){const o=setTimeout(()=>{a?(S(a.type),f(a.code),j(a.name||a.description||""),y(a.index||0),I(a.uses||1)):(S(c.MASTER),f(ee()),j(""),y(0),I(1)),L(!0)},0);return()=>clearTimeout(o)}},[a,t]),u.useEffect(()=>{t&&n?.id&&d===c.MASTER&&q.loadCodes(n.id).then(o=>{const M=o.filter(l=>l.type===c.MASTER&&l.status!=="pending_delete").map(l=>l.index).filter(l=>l!==void 0),_=Math.max(...M,-1)+1;y(_)})},[t,n?.id,d]);const p=()=>{S(c.MASTER),f(""),j(""),y(0),I(1),i()},N=async()=>{const o=Ne(E);if(f(o),d===c.MASTER&&n?.id){const _=(await q.loadCodes(n.id)).find(l=>l.type===c.MASTER&&l.index===g&&l.status!=="pending_delete"&&(!a||l.id!==a.id));if(_){r({type:d,code:o,name:A,index:g,maxUses:k},_.id),p();return}}r({type:d,code:o,name:A,index:g,maxUses:k},a?a.id:null),p()};return e.jsx(e.Fragment,{children:e.jsxs(le,{open:t,onClose:p,maxWidth:"sm",fullWidth:!0,children:[e.jsx(ce,{children:s(a?"edit_code":"add_new")}),e.jsxs(ue,{children:[!n?.configuration_key&&e.jsx(xe,{severity:"warning",sx:{mb:2},children:s("config_key_missing")}),e.jsxs(b,{sx:{display:"flex",flexDirection:"column",gap:2,mt:1},children:[e.jsxs(b,{sx:{display:"flex",gap:1},children:[e.jsx(R,{label:s("pin_label"),value:E,onChange:o=>f(o.currentTarget.value.trim().toUpperCase()),fullWidth:!0,type:w?"text":"password",inputProps:{maxLength:6,"data-testid":"code-pin-input"},InputProps:{endAdornment:e.jsx(Te,{position:"end",children:e.jsx(D,{"aria-label":"toggle code visibility",onClick:()=>L(!w),edge:"end",size:"small",children:w?e.jsx(De,{}):e.jsx(ke,{})})})}}),e.jsx(D,{onClick:()=>f(ee()),"aria-label":s("generate"),"data-testid":"generate-code-button",children:e.jsx(Re,{})})]}),e.jsx(R,{label:s("description_label"),value:A,onChange:o=>j(o.currentTarget.value),placeholder:s("description_placeholder"),inputProps:{"data-testid":"code-name-input"},fullWidth:!0,required:!0}),e.jsxs(pe,{fullWidth:!0,children:[e.jsx(me,{children:s("type_label")}),e.jsxs(he,{value:d,onChange:o=>S(o.target.value),label:s("type_label"),"data-testid":"code-type-select",children:[(!v||v&&x)&&e.jsx(P,{value:c.MASTER,"data-testid":"option-master",children:s("master_code")}),e.jsx(P,{value:c.SINGLE,"data-testid":"option-single",children:s("single_use_code")}),e.jsx(P,{value:c.MULTI,"data-testid":"option-multi",children:s("multi_use_code")})]})]}),d===c.MASTER&&e.jsx(R,{label:`${s("index_label")}: ${g}`,type:"number",value:g,onChange:o=>y(parseInt(o.currentTarget.value)||0),fullWidth:!0,disabled:!v,inputProps:{min:0,max:255,"data-testid":"code-index-input"}}),d===c.MULTI&&e.jsx(R,{label:s("uses_label"),type:"number",value:k,onChange:o=>I(parseInt(o.currentTarget.value)||1),fullWidth:!0,inputProps:{min:1,max:3,"data-testid":"code-uses-input"}})]})]}),e.jsxs(fe,{children:[e.jsx(W,{onClick:p,children:s("cancel")}),e.jsx(W,{onClick:N,variant:"contained","data-testid":"save-code-button",startIcon:e.jsx(oe,{}),disabled:!E||E.length!==6||A.trim()==="",children:s(a?"save":"generate")})]})]})})},We=({code:t,metadata:i,onCopy:r,onEdit:a,onDelete:s})=>{const{t:n}=B("codes"),x=t.status===U.PENDING_DELETE,v=i.used,d=x||v;return e.jsxs(je,{divider:!0,"data-testid":`code-item-${t.code}`,"data-status":t.status,sx:{opacity:d?.6:1,backgroundColor:d?"action.selected":"inherit",textDecoration:d?"line-through":"none",borderLeft:"4px solid",borderLeftColor:t.status===U.ON_DEVICE?"primary.main":t.status===U.PENDING_ADD?"warning.main":t.status===U.PENDING_DELETE?"error.main":"default.main",pl:1},children:[e.jsx(ge,{primary:e.jsxs(b,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap"},children:[e.jsx(C,{variant:"body1",sx:{fontWeight:"bold"},children:t.name||t.description||n("unnamed")}),e.jsxs(C,{variant:"caption",sx:{ml:1},children:[n("pin_label"),": ",t.code]})]}),secondary:null,slotProps:{primary:{component:"div"},secondary:{component:"div"}}}),e.jsxs(ye,{children:[e.jsx(K,{title:n("copy_code"),children:e.jsx(D,{edge:"end","aria-label":"copy",onClick:()=>r(t.code),children:e.jsx(Ce,{})})}),e.jsx(K,{title:n("edit_description"),children:e.jsx(D,{edge:"end","aria-label":"edit",onClick:()=>a(t),"data-testid":`edit-code-${t.code}`,children:e.jsx(Me,{})})}),e.jsx(D,{edge:"end","aria-label":"delete",onClick:()=>s(t.id),"data-testid":`delete-code-${t.code}`,children:e.jsx(Le,{})})]})]})},te=({codes:t,deriveCodeMetadata:i,hasIndexConflict:r,onCopy:a,onEdit:s,onDelete:n})=>e.jsx(be,{children:t.map(x=>e.jsx(We,{code:x,metadata:i(x),hasIndexConflict:r?r(x.index,x.id):!1,onCopy:a,onEdit:s,onDelete:n},x.id))}),se={animation:"spin 1s linear infinite","@keyframes spin":{"0%":{transform:"rotate(0deg)"},"100%":{transform:"rotate(360deg)"}}},Be=({showAddForm:t,setShowAddForm:i,showNotification:r,hideNotification:a})=>{const{t:s}=B(["codes","common"]),{activeDevice:n}=ae(),{isRestricted:x}=ve(),{tasks:v,syncTasks:d,isProcessing:S}=Ie(),{isSyncingLogs:E}=_e(),{isConnected:f}=Se(),[A,j]=u.useState(!1),[g,y]=u.useState(new Set(["permanent","temporary"])),[k,I]=u.useState(null),{masterCodes:w,temporaryCodes:L,codeCount:p,refreshCodeCount:N,hasIndexConflict:o,handleAddCode:M,handleDeleteCode:_,deriveCodeMetadata:l,getFilteredCodes:$,handleCopyCode:O}=Ee(r),ie=n?.auto_sync??!1,V=v.filter(m=>m.status==="pending"&&m.deviceId===n?.id).length,T=!ie&&V>0,z=S||E,G=u.useCallback(m=>{I(m),j(!0)},[]),re=async()=>{try{T&&await d(),await N()}catch(m){console.error("Failed to refresh/sync:",m)}},de=()=>z?T?e.jsx(Q,{sx:se}):e.jsx(J,{sx:se}):T?e.jsx(Q,{}):e.jsx(J,{});return x?e.jsxs(b,{"data-testid":"feature-blocked-screen",sx:{width:"100%",p:4,textAlign:"center",display:"flex",flexDirection:"column",alignItems:"center"},children:[e.jsx(we,{sx:{fontSize:60,color:"text.secondary",mb:2}}),e.jsx(C,{variant:"h5",gutterBottom:!0,color:"text.secondary",children:s("common:feature_disabled")}),e.jsx(C,{variant:"body1",color:"text.secondary",sx:{maxWidth:400},children:s("common:errors.version.feature_restricted_message",{feature:s("codes:title")})})]}):e.jsxs(b,{sx:{width:"100%"},children:[e.jsxs(b,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2},children:[e.jsxs(C,{variant:"h5",children:[s("title")," ",p&&`(Total: ${p.total})`]}),e.jsxs(b,{sx:{display:"flex",gap:1},children:[e.jsx(W,{variant:T?"contained":"outlined",color:T?"warning":"primary",startIcon:de(),onClick:re,disabled:!f||z,size:"small",children:T?s("sync_pending",{count:V}):s("refresh")}),e.jsx(D,{color:"primary",onClick:()=>j(!0),"aria-label":s("add_new"),"data-testid":"add-code-button",size:"small",children:e.jsx(oe,{})})]})]}),n&&e.jsx(C,{variant:"subtitle1",color:"textSecondary",sx:{mb:2},children:n.friendly_name||n.ble_name}),e.jsx(Pe,{open:A||t||!1,onClose:()=>{j(!1),i&&i(!1),I(null)},onSave:M,editingCode:k}),e.jsxs(Y,{expanded:g.has("permanent"),onChange:()=>{y(m=>{const h=new Set(m);return h.has("permanent")?h.delete("permanent"):h.add("permanent"),h})},elevation:0,sx:{backgroundColor:"transparent",width:"100%"},disableGutters:!0,children:[e.jsx(H,{expandIcon:e.jsx(X,{}),children:e.jsxs(C,{children:[s("permanent_codes")," (",w.length,p&&` / ${p.master} ${s("codes:on_device_count")}`,")"]})}),e.jsx(Z,{sx:{padding:"0 0 0 0 !important"},children:e.jsx(te,{codes:$("master"),deriveCodeMetadata:l,hasIndexConflict:o,onCopy:O,onEdit:G,onDelete:_})})]}),e.jsxs(Y,{expanded:g.has("temporary"),onChange:()=>{y(m=>{const h=new Set(m);return h.has("temporary")?h.delete("temporary"):h.add("temporary"),h})},elevation:0,sx:{backgroundColor:"transparent",width:"100%"},disableGutters:!0,children:[e.jsx(H,{expandIcon:e.jsx(X,{}),children:e.jsxs(C,{children:[s("temporary_codes")," (",L.length,p&&` / ${p.single} ${s("codes:on_device_count")}`,")"]})}),e.jsx(Z,{sx:{padding:"0 0 0 0 !important"},children:e.jsx(te,{codes:$("temporary"),deriveCodeMetadata:l,onCopy:O,onEdit:G,onDelete:_})})]})]})},Fe=()=>{const t=Ae();if(!t)return null;const{showNotification:i,hideNotification:r}=t;return e.jsx(b,{sx:{p:2},children:e.jsx(Be,{showNotification:i,hideNotification:r})})};export{Fe as CodeManagerWrapper};
