import{e as B,j as e,g as q,a as $,r as h,u as Q,d as O,c as J,b as Z,s as L,m as le,J as ce,f as Y,n as H,R as de,k as v,T as b,D as ue,z as me,A as ge,K as F,U as fe,M as V,N as he,Q as xe,C as ee,l as w,V as pe,W as _e,X as ve,Y as k,Z as ye,_ as E,$ as be,a0 as je,a1 as Ie,a2 as U,a3 as te,a4 as se,a5 as ne,a6 as Se,a7 as Re,a8 as Ce,a9 as D,aa as Te,i as Ee,o as we,p as Ae}from"./index-VbT-EYZE.js";import{I as X,V as K,a as W,A as ke}from"./VisibilityOff-7qiEbPFj.js";import{D as Ne}from"./Delete-ZcRcs8BG.js";import{T as De,a as P}from"./Tabs-DJVkPsjY.js";const Fe=B(e.jsx("path",{d:"M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"}));function Le(t){return q("MuiAvatar",t)}$("MuiAvatar",["root","colorDefault","circular","rounded","square","img","fallback"]);const Oe=t=>{const{classes:n,variant:s,colorDefault:a}=t;return Z({root:["root",s,a&&"colorDefault"],img:["img"],fallback:["fallback"]},Le,n)},Ue=L("div",{name:"MuiAvatar",slot:"Root",overridesResolver:(t,n)=>{const{ownerState:s}=t;return[n.root,n[s.variant],s.colorDefault&&n.colorDefault]}})(le(({theme:t})=>({position:"relative",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0,width:40,height:40,fontFamily:t.typography.fontFamily,fontSize:t.typography.pxToRem(20),lineHeight:1,borderRadius:"50%",overflow:"hidden",userSelect:"none",variants:[{props:{variant:"rounded"},style:{borderRadius:(t.vars||t).shape.borderRadius}},{props:{variant:"square"},style:{borderRadius:0}},{props:{colorDefault:!0},style:{color:(t.vars||t).palette.background.default,...t.vars?{backgroundColor:t.vars.palette.Avatar.defaultBg}:{backgroundColor:t.palette.grey[400],...t.applyStyles("dark",{backgroundColor:t.palette.grey[600]})}}}]}))),Pe=L("img",{name:"MuiAvatar",slot:"Img"})({width:"100%",height:"100%",textAlign:"center",objectFit:"cover",color:"transparent",textIndent:1e4}),Ge=L(Fe,{name:"MuiAvatar",slot:"Fallback"})({width:"75%",height:"75%"});function Me({crossOrigin:t,referrerPolicy:n,src:s,srcSet:a}){const[i,d]=h.useState(!1);return h.useEffect(()=>{if(!s&&!a)return;d(!1);let u=!0;const l=new Image;return l.onload=()=>{u&&d("loaded")},l.onerror=()=>{u&&d("error")},l.crossOrigin=t,l.referrerPolicy=n,l.src=s,a&&(l.srcset=a),()=>{u=!1}},[t,n,s,a]),i}const Ve=h.forwardRef(function(n,s){const a=Q({props:n,name:"MuiAvatar"}),{alt:i,children:d,className:u,component:l="div",slots:o={},slotProps:_={},imgProps:p,sizes:y,src:j,srcSet:R,variant:C="circular",...c}=a;let m=null;const x={...a,component:l,variant:C},g=Me({...p,...typeof _.img=="function"?_.img(x):_.img,src:j,srcSet:R}),I=j||R,T=I&&g!=="error";x.colorDefault=!T,delete x.ownerState;const A=Oe(x),[r,S]=O("root",{ref:s,className:J(A.root,u),elementType:Ue,externalForwardedProps:{slots:o,slotProps:_,component:l,...c},ownerState:x}),[N,re]=O("img",{className:A.img,elementType:Pe,externalForwardedProps:{slots:o,slotProps:{img:{...p,..._.img}}},additionalProps:{alt:i,src:j,srcSet:R,sizes:y},ownerState:x}),[oe,ie]=O("fallback",{className:A.fallback,elementType:Ge,externalForwardedProps:{slots:o,slotProps:_},shouldForwardComponentProp:!0,ownerState:x});return T?m=e.jsx(N,{...re}):d||d===0?m=d:I&&i?m=i[0]:m=e.jsx(oe,{...ie}),e.jsx(r,{...S,children:m})});function ze(t){return q("MuiListItemAvatar",t)}$("MuiListItemAvatar",["root","alignItemsFlexStart"]);const Be=t=>{const{alignItems:n,classes:s}=t;return Z({root:["root",n==="flex-start"&&"alignItemsFlexStart"]},ze,s)},Ye=L("div",{name:"MuiListItemAvatar",slot:"Root",overridesResolver:(t,n)=>{const{ownerState:s}=t;return[n.root,s.alignItems==="flex-start"&&n.alignItemsFlexStart]}})({minWidth:56,flexShrink:0,variants:[{props:{alignItems:"flex-start"},style:{marginTop:8}}]}),He=h.forwardRef(function(n,s){const a=Q({props:n,name:"MuiListItemAvatar"}),{className:i,...d}=a,u=h.useContext(ce),l={...a,alignItems:u.alignItems},o=Be(l);return e.jsx(Ye,{className:J(o.root,i),ownerState:l,ref:s,...d})}),Xe=B(e.jsx("path",{d:"M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20z"})),Ke=B(e.jsx("path",{d:"M20 2H4c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2m0 18H4V4h16zM18 6h-5c-1.1 0-2 .9-2 2v2.28c-.6.35-1 .98-1 1.72 0 1.1.9 2 2 2s2-.9 2-2c0-.74-.4-1.38-1-1.72V8h3v8H8V8h2V6H6v12h12z"})),z=(t,n)=>{if(!t||!n)return 0;const s=t.replace(/[^0-9.]/g,""),a=n.replace(/[^0-9.]/g,""),i=s.split(".").map(Number),d=a.split(".").map(Number);for(let u=0;u<Math.max(i.length,d.length);u++){const l=i[u]||0,o=d[u]||0;if(l>o)return 1;if(l<o)return-1}return 0},We=({deviceId:t})=>{const{t:n}=Y(["common","settings"]),{activeDevice:s,updateDeviceDetails:a,removeDevice:i,toggleLaPoste:d}=H(),[u,l]=h.useState(!1),[o,_]=h.useState({key:!s?.configuration_key,pin:!s?.door_pin_code}),[p,y]=h.useState(s?.friendly_name||""),[j,R]=h.useState(s?.configuration_key||""),[C,c]=h.useState(s?.door_pin_code||"");de.useEffect(()=>{s&&(y(s.friendly_name||""),R(s.configuration_key||""),c(s.door_pin_code||""))},[s]);const m=r=>{_(S=>({...S,[r]:!S[r]}))},x=async()=>{if(s)try{await a(t,{friendly_name:p,configuration_key:j,door_pin_code:C})}catch(r){console.error("Failed to update device details:",r)}},g=async r=>{l(!0);try{await d(r.target.checked)}catch(S){console.error("Failed to toggle La Poste:",S)}finally{l(!1)}},I=async()=>{if(s)try{await i(t)}catch(r){console.error("Failed to remove device:",r)}},T=r=>{const N=r.trim().toUpperCase().replace(/[^0-9A-F]/g,"").slice(-8);R(N)},A=r=>{const S=r.trim().toUpperCase();c(S)};return s?e.jsxs(v,{sx:{my:2},children:[e.jsx(b,{variant:"subtitle1",gutterBottom:!0,children:n("devices.title")}),e.jsx(ue,{sx:{mb:2}}),e.jsx(me,{children:e.jsx(ge,{children:e.jsxs(v,{sx:{display:"flex",flexDirection:"column",gap:2},children:[e.jsx(F,{label:n("devices.device_name"),value:p,onChange:r=>y(r.currentTarget.value),fullWidth:!0,size:"small"}),s.role===fe.Admin&&e.jsx(F,{label:n("settings:configuration_key.label"),value:j,onChange:r=>T(r.currentTarget.value),fullWidth:!0,size:"small",type:o.key?"text":"password",helperText:n("settings:configuration_key.helper"),slotProps:{input:{endAdornment:e.jsx(X,{position:"end",children:e.jsx(V,{"aria-label":n("settings:toggle_key_visibility"),onClick:()=>m("key"),edge:"end",size:"small",children:o.key?e.jsx(K,{}):e.jsx(W,{})})})}}}),e.jsx(F,{label:n("settings:door_pin_code"),value:C,onChange:r=>A(r.currentTarget.value),fullWidth:!0,size:"small",type:o.pin?"text":"password",slotProps:{input:{endAdornment:e.jsx(X,{position:"end",children:e.jsx(V,{"aria-label":n("settings:toggle_pin_visibility"),onClick:()=>m("pin"),edge:"end",size:"small",children:o.pin?e.jsx(K,{}):e.jsx(W,{})})})}}}),s.hardware_version==="4.0"&&s.software_revision&&z(s.software_revision,"4.2.0")>=0&&e.jsxs(v,{sx:{display:"flex",alignItems:"center"},children:[e.jsx(he,{control:e.jsx(xe,{"data-testid":"la-poste-switch",checked:s.la_poste_activated||!1,onChange:g,disabled:u}),label:n("settings:activate_la_poste")}),u&&e.jsx(ee,{size:20,sx:{ml:1}})]}),e.jsxs(v,{sx:{display:"flex",justifyContent:"space-between",mt:2},children:[e.jsx(w,{size:"small",color:"error",variant:"outlined",onClick:I,children:n("devices.forget")}),e.jsx(w,{size:"small",variant:"contained",onClick:x,children:n("save")})]})]})})})]}):null};var ae=(t=>(t[t.LA_POSTE=1]="LA_POSTE",t[t.VIGIK_TERTIARY=2]="VIGIK_TERTIARY",t[t.USER_BADGE=3]="USER_BADGE",t))(ae||{}),f=(t=>(t.IDLE="idle",t.SCANNING="scanning",t.FOUND="found",t.TIMEOUT="timeout",t.ERROR_EXISTS="error_exists",t.ERROR="error",t))(f||{});const qe=()=>{const{activeDevice:t}=H(),{sendRequest:n}=pe(),{addListener:s,removeListener:a}=_e(),[i,d]=h.useState(f.IDLE),[u,l]=h.useState(null),o=t?.id,_=ve(()=>o?k.nfc_tags.where("device_id").equals(o).toArray():[],[o]),p=h.useCallback(async()=>{if(!o)throw new Error("No active device");const c=await k.device_secrets.get(o);if(!c?.configuration_key)throw new Error("Configuration Key required");return c.configuration_key},[o]),y=h.useCallback(async()=>{try{const c=await p();d(f.SCANNING),l(null),await n(new ye(c))}catch(c){console.error("Failed to start scan",c),d(f.ERROR)}},[p,n]);h.useEffect(()=>{const c=m=>{if(!(i!==f.SCANNING&&i!==f.IDLE)&&[E.NOTIFY_NFC_TAG_REGISTER_SCAN_RESULT,E.NOTIFY_NFC_TAG_REGISTER_SCAN_ERROR_EXISTS,E.NOTIFY_NFC_TAG_REGISTER_SCAN_TIMEOUT].includes(m.opcode)){const x=new Ie(m.opcode);switch(x.parse(m.payload),x.status){case U.TIMEOUT:d(f.TIMEOUT);break;case U.ALREADY_EXISTS:d(f.ERROR_EXISTS),x.uid&&l(x.uid);break;case U.FOUND:d(f.FOUND),x.uid&&l(x.uid);break;default:d(f.ERROR)}}};return s(E.NOTIFY_NFC_TAG_REGISTER_SCAN_RESULT,c),s(E.NOTIFY_NFC_TAG_REGISTER_SCAN_ERROR_EXISTS,c),s(E.NOTIFY_NFC_TAG_REGISTER_SCAN_TIMEOUT,c),()=>{a(E.NOTIFY_NFC_TAG_REGISTER_SCAN_RESULT,c),a(E.NOTIFY_NFC_TAG_REGISTER_SCAN_ERROR_EXISTS,c),a(E.NOTIFY_NFC_TAG_REGISTER_SCAN_TIMEOUT,c)}},[s,a,i]);const j=h.useCallback(async c=>{if(!(!u||!o))try{const m=await p(),x=new Uint8Array(u.split(":").map(I=>parseInt(I,16)));if(i===f.FOUND){const I=new be(m,x);await n(I)}const g=await k.nfc_tags.where({device_id:o,uid:u}).first();g?await k.nfc_tags.update(g.id,{name:c,updated_at:Date.now()}):await k.nfc_tags.add({id:crypto.randomUUID(),device_id:o,uid:u,name:c,type:ae.USER_BADGE,created_at:Date.now(),sync_status:"created"}),d(f.IDLE),l(null)}catch(m){throw console.error("Failed to register tag",m),m}},[u,o,p,n,i]),R=h.useCallback(async c=>{if(o)try{const m=await p(),x=new Uint8Array(c.uid.split(":").map(I=>parseInt(I,16))),g=new je(m,x);await n(g),await k.nfc_tags.delete(c.id)}catch(m){throw console.error("Failed to unregister tag",m),m}},[o,p,n]),C=h.useCallback(()=>{d(f.IDLE),l(null)},[]);return{tags:_,scanStatus:i,scannedUid:u,startScan:y,registerTag:j,unregisterTag:R,resetScan:C}},$e=()=>{const{t}=Y(["common","settings"]),n=t,{tags:s,scanStatus:a,scannedUid:i,startScan:d,registerTag:u,unregisterTag:l,resetScan:o}=qe(),[_,p]=h.useState(!1),[y,j]=h.useState(""),R=()=>{o(),j(""),p(!0)},C=()=>{p(!1),o()},c=()=>{d()},m=async()=>{if(y.trim())try{await u(y.trim()),C()}catch(g){console.error(g)}},x=async g=>{if(confirm(n("common:confirm_delete")))try{await l(g)}catch(I){console.error(I),alert(t("settings:nfc.error_delete_failed"))}};return h.useEffect(()=>{if(i&&!y){const g=`Badge ${i.substring(0,5)}`;y!==g&&j(g)}},[i]),e.jsxs(v,{sx:{p:2},children:[e.jsxs(v,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2},children:[e.jsx(b,{variant:"h6","data-testid":"nfc-tags-title",children:t("settings:nfc.title")}),e.jsx(w,{variant:"contained",startIcon:e.jsx(ke,{}),onClick:R,children:t("settings:nfc.add_tag")})]}),s&&s.length>0?e.jsx(te,{children:s.map(g=>e.jsxs(se,{secondaryAction:e.jsx(V,{edge:"end","aria-label":"delete",onClick:()=>x(g),children:e.jsx(Ne,{})}),children:[e.jsx(He,{children:e.jsx(Ve,{children:e.jsx(Ke,{})})}),e.jsx(ne,{primary:g.name,secondary:e.jsxs(e.Fragment,{children:[e.jsx(b,{component:"span",variant:"body2",color:"textPrimary",children:g.uid}),e.jsx("br",{}),g.last_seen_at?t("settings:nfc.last_seen",{date:new Date(g.last_seen_at).toLocaleString()}):t("settings:nfc.never_seen")]})})]},g.id))}):e.jsx(b,{variant:"body1",color:"textSecondary",align:"center",sx:{mt:4},children:t("settings:nfc.no_tags")}),e.jsxs(Se,{open:_,onClose:C,fullWidth:!0,maxWidth:"sm",children:[e.jsx(Re,{children:t("settings:nfc.dialog_title")}),e.jsx(Ce,{children:e.jsxs(v,{sx:{display:"flex",flexDirection:"column",alignItems:"center",gap:2,py:2},children:[a===f.IDLE&&e.jsx(b,{children:t("settings:nfc.instructions_idle")}),a===f.SCANNING&&e.jsxs(e.Fragment,{children:[e.jsx(ee,{}),e.jsx(b,{children:t("settings:nfc.instructions_scanning")})]}),a===f.TIMEOUT&&e.jsx(D,{severity:"warning",children:t("settings:nfc.error_timeout")}),a===f.ERROR&&e.jsx(D,{severity:"error",children:t("settings:nfc.error_generic")}),a===f.ERROR_EXISTS&&e.jsxs(D,{severity:"info",children:[t("settings:nfc.error_exists"),i&&e.jsxs(v,{sx:{mt:1},children:[e.jsxs(b,{variant:"caption",children:["UID: ",i]}),e.jsx(b,{children:t("settings:nfc.instructions_exists_local")})]})]}),(a===f.FOUND||a===f.ERROR_EXISTS)&&i&&e.jsxs(v,{sx:{width:"100%",mt:2},children:[e.jsx(D,{severity:"success",sx:{mb:2},children:t("settings:nfc.tag_found",{uid:i})}),e.jsx(F,{autoFocus:!0,margin:"dense",label:t("settings:nfc.input_label"),fullWidth:!0,value:y,onChange:g=>j(g.target.value)})]})]})}),e.jsxs(Te,{children:[e.jsx(w,{onClick:C,children:t("common:cancel")}),a===f.IDLE||a===f.TIMEOUT||a===f.ERROR?e.jsx(w,{onClick:c,variant:"contained",children:t("settings:nfc.button_start_scan")}):null,(a===f.FOUND||a===f.ERROR_EXISTS)&&e.jsx(w,{onClick:m,variant:"contained",disabled:!y,children:t("settings:nfc.add_tag")})]})]})]})};function G(t){const{children:n,value:s,index:a,...i}=t;return e.jsx("div",{role:"tabpanel",hidden:s!==a,id:`my-boks-tabpanel-${a}`,"aria-labelledby":`my-boks-tab-${a}`,...i,children:s===a&&e.jsx(v,{sx:{p:3},children:n})})}function M(t){return{id:`my-boks-tab-${t}`,"aria-controls":`my-boks-tabpanel-${t}`}}const tt=()=>{const{t}=Y(["common","codes","logs","settings"]),{activeDevice:n,knownDevices:s,setActiveDevice:a}=H(),{isConnected:i}=Ee(),{showNotification:d}=we(),u=Ae(),[l,o]=h.useState(0),[_,p]=h.useState(null);h.useEffect(()=>{const S=new URLSearchParams(u.search).get("tab"),N=setTimeout(()=>{switch(S){case"settings":o(0);break;case"users":o(1);break;default:o(0);break}},0);return()=>clearTimeout(N)},[u.search]),h.useEffect(()=>{(!n||!s.some(r=>r.id===n.id))&&_!==null&&setTimeout(()=>p(null),0)},[n,s,_]);const y=r=>n?.software_revision?z(n.software_revision,r)>=0:!1,j=r=>n?.hardware_version?z(n.hardware_version,r)>=0:!1,R=y("4.3.3"),C=j("4.0"),c=R&&C,m=(r,S)=>{if(S===2){if(!C){d("Version Hardware 4.0 required","warning");return}if(!R){d("Version Firmware 4.3.3 required","warning");return}}o(S)},x=r=>{p(r),a(r)},g=()=>{p(null),a(null)},I=s.length>1&&!_&&!n;let T=t("common:my_boks");return n&&s.length===1||n&&s.length>1?T=n.friendly_name||n.ble_name:!n&&s.length===1&&(T=s[0].friendly_name||s[0].ble_name),I?e.jsxs(v,{sx:{p:3},children:[e.jsx(b,{variant:"h5",gutterBottom:!0,children:t("common:my_boks")}),e.jsx(te,{children:s.map(r=>e.jsx(se,{onClick:()=>x(r.id),sx:{cursor:"pointer"},children:e.jsx(ne,{primary:r.friendly_name||r.ble_name,secondary:r.ble_name})},r.id))})]}):n||s.find(r=>r.id===_)||(s.length===1?s[0]:null)?e.jsxs(v,{sx:{width:"100%"},children:[e.jsxs(v,{sx:{p:3,borderBottom:1,borderColor:"divider"},children:[s.length>1&&e.jsx(w,{startIcon:e.jsx(Xe,{}),onClick:g,sx:{mb:1},children:t("common:back_to_list")}),e.jsx(b,{variant:"h4",component:"h1",gutterBottom:!0,children:T}),e.jsx(b,{variant:"subtitle1",color:"textSecondary",children:t(i?"common:connected":"common:disconnected")})]}),e.jsx(v,{sx:{borderBottom:1,borderColor:"divider"},children:e.jsxs(De,{value:l,onChange:m,"aria-label":"my boks tabs",children:[e.jsx(P,{"data-testid":"tab-settings",label:t("settings:title"),...M(0)}),e.jsx(P,{"data-testid":"tab-users",label:t("common:users.title"),...M(1)}),e.jsx(P,{"data-testid":"tab-nfc",label:"Tags NFC",...M(2),sx:{opacity:c?1:.5}})]})}),e.jsx(G,{value:l,index:0,children:e.jsx(We,{deviceId:n?.id||""})}),e.jsx(G,{value:l,index:1,children:e.jsxs(v,{sx:{p:3},children:[e.jsx(b,{variant:"h6",children:t("common:users.title")}),e.jsx(b,{variant:"body1",color:"textSecondary",children:t("common:coming_soon")})]})}),e.jsx(G,{value:l,index:2,children:c?e.jsx($e,{}):e.jsx(v,{sx:{p:3},children:"Feature Unavailable"})})]}):e.jsxs(v,{sx:{p:3},children:[e.jsx(b,{variant:"h5",children:t("common:my_boks")}),e.jsx(b,{variant:"body1",color:"textSecondary",children:t("common:no_active_device")})]})};export{tt as MyBoksPage};
