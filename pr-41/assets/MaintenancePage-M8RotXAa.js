import{g as S,a as b,r as m,u as w,j as s,c as E,b as R,s as P,e as A,f as v,T as h,n as O,z as k,A as I,a9 as M,k as T,P as L,a3 as D,a4 as U,a5 as N,l as B,aE as K,_,aF as z,aG as F}from"./index-B-fKcPRP.js";import{C as $}from"./Container-Cin4CDKx.js";import{L as q}from"./LinearProgress-CqU0hA_K.js";function G(t){return S("MuiCardActions",t)}b("MuiCardActions",["root","spacing"]);const H=t=>{const{classes:e,disableSpacing:n}=t;return R({root:["root",!n&&"spacing"]},G,e)},W=P("div",{name:"MuiCardActions",slot:"Root",overridesResolver:(t,e)=>{const{ownerState:n}=t;return[e.root,!n.disableSpacing&&e.spacing]}})({display:"flex",alignItems:"center",padding:8,variants:[{props:{disableSpacing:!1},style:{"& > :not(style) ~ :not(style)":{marginLeft:8}}}]}),Y=m.forwardRef(function(e,n){const a=w({props:e,name:"MuiCardActions"}),{disableSpacing:c=!1,className:l,...o}=a,d={...a,disableSpacing:c},r=H(d);return s.jsx(W,{className:E(r.root,l),ownerState:d,ref:n,...o})}),J=A(s.jsx("path",{d:"M8 5v14l11-7z"})),Q=({script:t})=>{const{t:e}=v("maintenance"),[n,a]=m.useState(!1),[c,l]=m.useState(0),[o,d]=m.useState([]),[r,u]=m.useState(null),{activeDevice:y}=O(),p=async()=>{const i=z.getInstance();if(i.getState()!=="connected"){u(e("status.not_connected"));return}const g=y?.configuration_key;if(!g){u(e("status.missing_config_key"));return}a(!0),l(0),d([]),u(null);const C=x=>d(f=>[...f.slice(-4),x]);try{await t.run({setProgress:l,log:C,checkStop:()=>{},t:e},{bleService:i,configKey:g}),C(e("status.finished")),l(100)}catch(x){console.error(x);const f=x instanceof Error?x.message:String(x);u(e("status.error",{message:f})),C(e("status.error",{message:f}))}finally{a(!1)}};return s.jsxs(k,{sx:{mb:2},children:[s.jsxs(I,{children:[s.jsx(h,{variant:"h6",component:"div",children:e(t.titleKey)}),s.jsx(h,{sx:{mb:1.5},color:"text.secondary",children:e(t.descriptionKey)}),r&&s.jsx(M,{severity:"error",sx:{mb:2},children:r}),(n||o.length>0)&&s.jsxs(T,{sx:{width:"100%",mb:2},children:[s.jsx(q,{variant:"determinate",value:c}),s.jsx(h,{variant:"body2",color:"text.secondary",align:"right",children:e("progress",{percent:Math.round(c)})})]}),o.length>0&&s.jsx(L,{variant:"outlined",sx:{p:1,bgcolor:"background.default",maxHeight:100,overflow:"auto"},children:s.jsx(D,{dense:!0,disablePadding:!0,children:o.map((i,g)=>s.jsx(U,{disablePadding:!0,children:s.jsx(N,{primary:i,primaryTypographyProps:{variant:"caption",fontFamily:"monospace"}})},g))})})]}),s.jsx(Y,{children:s.jsx(B,{size:"small",variant:"contained",startIcon:s.jsx(J,{}),onClick:p,disabled:n,children:e("run")})})]})},j=async t=>{const e=new F,n=await t.sendRequest(e,{expectResponse:!0});if(n.opcode!==_.NOTIFY_CODES_COUNT)throw new Error(`Unexpected response opcode: 0x${n.opcode.toString(16)}`);if(n.payload.length<2)throw new Error("Invalid payload length for CODES_COUNT");return n.payload[0]<<8|n.payload[1]},V={id:"clean_master_codes",titleKey:"scripts.clean_master_codes.title",descriptionKey:"scripts.clean_master_codes.description",run:async({setProgress:t,log:e,checkStop:n,t:a},{bleService:c,configKey:l})=>{e(a("status.fetching_count"));let o=await j(c);if(e(a("status.initial_count",{count:o})),o===0){e(a("status.no_codes"));return}const d=256;for(let r=0;r<d;r++){n();const u=r/d*100;for(t(u);;){n(),e(a("status.deleting_index",{index:r,count:o}));const y=new K(l,r);let p=!1;try{const i=await c.sendRequest(y,{expectResponse:!0},l);i.opcode===_.CODE_OPERATION_SUCCESS?(e(a("status.success_index",{index:r})),p=!0):i.opcode===_.CODE_OPERATION_ERROR&&(e(a("status.error_index",{index:r})),p=!1)}catch(i){const g=i instanceof Error?i.message:String(i);e(a("status.error",{message:`Index ${r}: ${g}`})),p=!1}if(!p)break}if(o=await j(c),o===0){e(a("status.stopping_early"));break}}}},se=()=>{const{t}=v("maintenance");return s.jsxs($,{maxWidth:"sm",sx:{mt:2,pb:10},children:[s.jsx(h,{variant:"h4",gutterBottom:!0,children:t("title")}),s.jsx(h,{variant:"body2",color:"text.secondary",paragraph:!0,children:t("description")}),s.jsx(Q,{script:V})]})};export{se as MaintenancePage};
