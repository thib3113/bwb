import{r as p,bq as M,f as T,j as e,M as O,ao as Y,ap as A,k as x,n as $,i as R,az as k,X as C,Y as D,br as V,bs as z,bt as F,T as y,l as P,C as W,al as q,a9 as Q,o as H}from"./index-VbT-EYZE.js";import{b as f,c as d,T as S,d as E,a as J}from"./TableRow-DAgWpTSO.js";const K=()=>{const o=p.useContext(M);if(o===void 0)throw new Error("useLogCount must be used within a DeviceProvider");return{logCount:o.logCount}};function X(o,t){const s=new Date(o),i=new Date,a=new Date;return a.setFullYear(i.getFullYear()-1),s<a?s.toLocaleDateString(t,{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit",hour12:!1}):s.toLocaleDateString(t,{day:"2-digit",month:"2-digit",hour:"2-digit",minute:"2-digit",hour12:!1})}function G(o,t){return{code_index:t("code_index"),code_value:t("code_value"),code:t("code_value"),method:t("method"),result:t("result"),reason:t("reason"),error_code:t("error_code"),weight:t("weight"),battery_level:t("battery_level"),tagId:t("tag_id"),tag_uid:t("tag_uid"),tag_type:t("tag_type"),initiatedBy:t("initiated_by"),bootReason:t("boot_reason"),payload:t("payload")}[o]||o}const N=({log:o})=>{const{t,i18n:s}=T("logs"),[i,a]=p.useState(!1),g=()=>{a(!i)};return e.jsxs(e.Fragment,{children:[e.jsxs(f,{children:[e.jsx(d,{title:o.fullDate,children:X(o.timestamp,s.language)}),e.jsx(d,{children:o.event}),e.jsx(d,{children:(()=>{const l={...o.details};return delete l.age,delete l.timestamp,Object.keys(l).length>0?e.jsx(O,{"aria-label":"expand row",size:"small",onClick:g,children:e.jsx(Y,{style:{transform:i?"rotate(180deg)":"rotate(0deg)"}})}):null})()})]}),e.jsx(f,{children:e.jsx(d,{style:{paddingBottom:0,paddingTop:0},colSpan:3,children:e.jsx(A,{in:i,timeout:"auto",unmountOnExit:!0,children:e.jsx(x,{sx:{margin:1},children:e.jsx(S,{size:"small","aria-label":"details",children:e.jsx(E,{children:(()=>{const l={...o.details};return delete l.age,delete l.timestamp,Object.entries(l).map(([m,u])=>e.jsxs(f,{children:[e.jsx(d,{component:"th",scope:"row",sx:{fontWeight:"bold"},children:G(m,t)}),e.jsx(d,{children:typeof u=="object"?JSON.stringify(u):String(u)})]},m))})()})})})})})})]})},U=({showNotification:o,hideNotification:t})=>{const{t:s,i18n:i}=T(["logs","common"]),{activeDevice:a}=$(),{isConnected:g}=R(),{isSyncingLogs:l,requestLogs:m}=k(),{logCount:u}=K(),b=C(()=>{const n=a?.id;return n?(console.log(`[LogViewer] Querying logs for device_id: ${n}`),D.logs.orderBy("timestamp").reverse().filter(r=>r.device_id===n).limit(50).toArray()):[]},[a?.id]),h=p.useMemo(()=>{const n=b??V;return console.log(`[LogViewer] raw logs count: ${n.length}`,n),n},[b]),w=C(()=>{const n=a?.id;return n?D.nfc_tags.where("device_id").equals(n).toArray():[]},[a?.id]),v=p.useMemo(()=>{if(h.length===0)return[];try{console.log(`[LogViewer] Starting parseLogs with ${h.length} logs`);const n=z(h).map(r=>{const j=new Date(r.timestamp).toLocaleString(i.language),c={...r.details};if(typeof c.tag_uid=="string"){const L=w?.find(I=>I.uid===c.tag_uid);L&&(c.tag_uid=`${L.name} (${c.tag_uid})`),c.tag_type!==void 0&&(c.tag_type=s(`nfc_tag_types.${c.tag_type}`))}return{...r,details:c,fullDate:j,event:s(r.description)}});return console.log(`[LogViewer] Parsing finished. parsedLogs: ${n.length}`,n),n}catch(n){const r=n instanceof Error?n.message:String(n);return console.error(s("parse_error"),r),[]}},[h,i.language,s,w]),B=p.useCallback(async()=>{if(!g){o&&o(s("not_connected"),"error");return}await F(m,{showNotification:o,hideNotification:t,loadingMsg:s("refresh_started"),successMsg:s("refresh_success"),errorMsg:s("refresh_failed")})},[g,m,o,t,s]);return e.jsxs(x,{sx:{p:2,mb:2,width:"100%"},children:[e.jsxs(x,{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2,children:[e.jsxs(y,{variant:"h5",component:"h2",children:[s("title")," ",u!==null&&u>0&&`(${u})`]}),e.jsx(P,{variant:"outlined",startIcon:l?e.jsx(W,{size:20}):e.jsx(q,{}),onClick:B,disabled:!g||l,children:s("refresh")})]}),!g&&!a&&h.length===0&&e.jsx(Q,{severity:"info",sx:{mb:2},children:s("connect_to_view")}),e.jsx(x,{sx:{height:"100%",width:"100%",overflowY:"auto",borderRadius:1,p:2,backgroundColor:"background.paper",fontFamily:"Courier New, monospace"},children:v.length>0?e.jsxs(S,{children:[e.jsx(J,{children:e.jsxs(f,{children:[e.jsx(d,{children:s("timestamp")}),e.jsx(d,{children:s("event_label")}),e.jsx(d,{})]})}),e.jsx(E,{children:v.map((n,r)=>e.jsx(N,{log:n},r))})]}):h.length>0?e.jsx(x,{children:h.map((n,r)=>{const _=new Date(n.timestamp),j=_.toLocaleDateString(i.language,{day:"2-digit",month:"2-digit",hour:"2-digit",minute:"2-digit"}),c=_.toLocaleString(i.language);return e.jsxs(x,{sx:{py:1,borderBottom:"1px solid",borderColor:"divider"},children:[e.jsx(y,{component:"span",fontWeight:"bold",title:c,children:j}),": ",n.event]},r)})}):e.jsx(y,{align:"center",sx:{fontStyle:"italic",py:2},component:"p",children:s(g||a?"no_logs_when_connected":"no_logs_when_disconnected")})})]})},te=()=>{const o=H();if(!o)return null;const{showNotification:t,hideNotification:s}=o;return e.jsx(U,{showNotification:t,hideNotification:s})};export{te as LogViewerWrapper};
