import{r as x,bt as M,f as T,j as e,M as O,am as A,an as Y,k as p,n as $,i as R,ax as V,V as C,W as D,bu as k,bv as W,bw as F,T as y,l as P,C as z,aj as Q,a7 as q,o as H}from"./index-0s38g4RU.js";import{b as f,c,T as S,d as E,a as J}from"./TableRow-TWYOCywh.js";const K=()=>{const o=x.useContext(M);if(o===void 0)throw new Error("useLogCount must be used within a DeviceProvider");return{logCount:o.logCount}};function G(o,t){const s=new Date(o),l=new Date,i=new Date;return i.setFullYear(l.getFullYear()-1),s<i?s.toLocaleDateString(t,{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit",hour12:!1}):s.toLocaleDateString(t,{day:"2-digit",month:"2-digit",hour:"2-digit",minute:"2-digit",hour12:!1})}function N(o,t){return{code_index:t("code_index"),code_value:t("code_value"),code:t("code_value"),method:t("method"),result:t("result"),reason:t("reason"),error_code:t("error_code"),weight:t("weight"),battery_level:t("battery_level"),tagId:t("tag_id"),tag_uid:t("tag_uid"),tag_type:t("tag_type"),initiatedBy:t("initiated_by"),bootReason:t("boot_reason"),payload:t("payload")}[o]||o}const U=({log:o})=>{const{t,i18n:s}=T("logs"),[l,i]=x.useState(!1),g=()=>{i(!l)};return e.jsxs(e.Fragment,{children:[e.jsxs(f,{children:[e.jsx(c,{title:o.fullDate,children:G(o.timestamp,s.language)}),e.jsx(c,{children:o.event}),e.jsx(c,{children:(()=>{const r={...o.details};return delete r.age,delete r.timestamp,delete r.opcode,Object.keys(r).length>0?e.jsx(O,{"aria-label":"expand row",size:"small",onClick:g,children:e.jsx(A,{style:{transform:l?"rotate(180deg)":"rotate(0deg)"}})}):null})()})]}),e.jsx(f,{children:e.jsx(c,{style:{paddingBottom:0,paddingTop:0},colSpan:3,children:e.jsx(Y,{in:l,timeout:"auto",unmountOnExit:!0,children:e.jsx(p,{sx:{margin:1},children:e.jsx(S,{size:"small","aria-label":"details",children:e.jsx(E,{children:(()=>{const r={...o.details};return delete r.age,delete r.timestamp,delete r.opcode,Object.entries(r).map(([m,u])=>e.jsxs(f,{children:[e.jsx(c,{component:"th",scope:"row",sx:{fontWeight:"bold"},children:N(m,t)}),e.jsx(c,{children:typeof u=="object"?JSON.stringify(u):String(u)})]},m))})()})})})})})})]})},X=({showNotification:o,hideNotification:t})=>{const{t:s,i18n:l}=T(["logs","common"]),{activeDevice:i}=$(),{isConnected:g}=R(),{isSyncingLogs:r,requestLogs:m}=V(),{logCount:u}=K(),b=C(()=>{const n=i?.id;return n?(console.log(`[LogViewer] Querying logs for device_id: ${n}`),D.logs.orderBy("timestamp").reverse().filter(a=>a.device_id===n).limit(50).toArray()):[]},[i?.id]),h=x.useMemo(()=>{const n=b??k;return console.log(`[LogViewer] raw logs count: ${n.length}`,n),n},[b]),w=C(()=>{const n=i?.id;return n?D.nfc_tags.where("device_id").equals(n).toArray():[]},[i?.id]),v=x.useMemo(()=>{if(h.length===0)return[];try{console.log(`[LogViewer] Starting parseLogs with ${h.length} logs`);const n=W(h,{preserveTimestamp:!0}).map(a=>{const _=new Date(a.timestamp).toLocaleString(l.language),d={...a.details};if(typeof d.tag_uid=="string"){const L=w?.find(I=>I.uid===d.tag_uid);L&&(d.tag_uid=`${L.name} (${d.tag_uid})`),d.tag_type!==void 0&&(d.tag_type=s(`nfc_tag_types.${d.tag_type}`))}return{...a,details:d,fullDate:_,event:s(a.description)}});return console.log(`[LogViewer] Parsing finished. parsedLogs: ${n.length}`,n),n}catch(n){const a=n instanceof Error?n.message:String(n);return console.error(s("parse_error"),a),[]}},[h,l.language,s,w]),B=x.useCallback(async()=>{if(!g){o&&o(s("not_connected"),"error");return}await F(m,{showNotification:o,hideNotification:t,loadingMsg:s("refresh_started"),successMsg:s("refresh_success"),errorMsg:s("refresh_failed")})},[g,m,o,t,s]);return e.jsxs(p,{sx:{p:2,mb:2,width:"100%"},children:[e.jsxs(p,{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2,children:[e.jsxs(y,{variant:"h5",component:"h2",children:[s("title")," ",u!==null&&u>0&&`(${u})`]}),e.jsx(P,{variant:"outlined",startIcon:r?e.jsx(z,{size:20}):e.jsx(Q,{}),onClick:B,disabled:!g||r,children:s("refresh")})]}),!g&&!i&&h.length===0&&e.jsx(q,{severity:"info",sx:{mb:2},children:s("connect_to_view")}),e.jsx(p,{sx:{height:"100%",width:"100%",overflowY:"auto",borderRadius:1,p:2,backgroundColor:"background.paper",fontFamily:"Courier New, monospace"},children:v.length>0?e.jsxs(S,{children:[e.jsx(J,{children:e.jsxs(f,{children:[e.jsx(c,{children:s("timestamp")}),e.jsx(c,{children:s("event_label")}),e.jsx(c,{})]})}),e.jsx(E,{children:v.map((n,a)=>e.jsx(U,{log:n},a))})]}):h.length>0?e.jsx(p,{children:h.map((n,a)=>{const j=new Date(n.timestamp),_=j.toLocaleDateString(l.language,{day:"2-digit",month:"2-digit",hour:"2-digit",minute:"2-digit"}),d=j.toLocaleString(l.language);return e.jsxs(p,{sx:{py:1,borderBottom:"1px solid",borderColor:"divider"},children:[e.jsx(y,{component:"span",fontWeight:"bold",title:d,children:_}),": ",n.event]},a)})}):e.jsx(y,{align:"center",sx:{fontStyle:"italic",py:2},component:"p",children:s(g||i?"no_logs_when_connected":"no_logs_when_disconnected")})})]})},te=()=>{const o=H();if(!o)return null;const{showNotification:t,hideNotification:s}=o;return e.jsx(X,{showNotification:t,hideNotification:s})};export{te as LogViewerWrapper};
