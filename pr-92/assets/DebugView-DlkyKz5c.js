import{aA as T,aB as w,r as f,j as t,k as p,T as i,a3 as j,M as I,au as L,a7 as R,a4 as N,a5 as D,a6 as O,X as h,D as b,av as _,ai as C,aC as v,aD as U,aE as B,ah as P,ak as $}from"./index-aZM34ylH.js";import{C as V}from"./Chip-pNlOeAJM.js";function F(r,n){if(!n||n.trim()==="")return"(empty)";try{const s=new Uint8Array(n.split(" ").filter(x=>x!=="").map(x=>parseInt(x,16))),l=new Uint8Array(2+s.length);l[0]=r,l[1]=s.length,l.set(s,2);const y=T(r,s,l);return y?y.toString():n}catch(s){return console.error(`Error formatting payload for opcode 0x${r.toString(16)}:`,s),n}}const G={[C]:"Battery Level (Standard)",[$]:"Battery Data (Proprietary)",[P]:"Battery Service",[B]:"Device Info Service",...Object.entries(v).reduce((r,[n,s])=>({...r,[s]:n}),{})},Y=()=>{const{debugLogs:r,clearDebugLogs:n}=w(),s=f.useRef(null),[l,y]=f.useState(!1);f.useEffect(()=>{console.log(`[DebugView] Rendered with ${r.length} logs`)},[r.length]);const x=()=>{n()},S=()=>{const e=r.map(o=>({timestamp:o.timestamp.toISOString(),type:o.type,direction:o.direction,opcode:o.opcode!==void 0?`0x${o.opcode.toString(16).toUpperCase().padStart(2,"0")}`:void 0,opcodeName:o.opcode!==void 0?g(o.opcode):void 0,payload:o.payload,raw:o.raw})),a=JSON.stringify(e);navigator.clipboard.writeText(a),y(!0)},g=e=>e===0?"UNPARSABLE / RAW":e===h.INTERNAL_GATT_OPERATION?"GATT READ":U[e]||`UNKNOWN (0x${e.toString(16).toUpperCase().padStart(2,"0")})`,A=e=>{if(e.opcode===h.INTERNAL_GATT_OPERATION){const a=e.uuid,o=a?Object.entries(G).find(([c])=>c.toLowerCase().includes(a.toLowerCase())||a.toLowerCase().includes(c.toLowerCase()))?.[1]:null;if(e.direction==="TX")return`READ: ${o||a||"Unknown"}`;if(a&&typeof e.payload=="string"){const c=e.payload.replace(/ /g,""),m=a.toLowerCase();if(m.includes(C.toLowerCase())||C.toLowerCase().includes(m))return`${parseInt(c,16)}% (${o||"Battery"})`;if(Object.values(v).some(d=>m.includes(d.toLowerCase())||d.toLowerCase().includes(m)))try{let d="";for(let u=0;u<c.length;u+=2){const E=parseInt(c.substr(u,2),16);E!==0&&(d+=String.fromCharCode(E))}return`"${d}" (${o})`}catch{}}return`${e.payload} ${o?`(${o})`:""}`}return F(e.opcode,e.payload||"")};return t.jsxs(p,{sx:{height:"100%",display:"flex",flexDirection:"column"},children:[t.jsxs(p,{sx:{p:2,display:"flex",justifyContent:"space-between",alignItems:"center",borderBottom:1,borderColor:"divider"},children:[t.jsx(i,{variant:"h6",children:"BLE Activity Logger"}),t.jsxs(p,{children:[t.jsx(j,{title:"Copier JSON",children:t.jsx(I,{onClick:S,children:t.jsx(L,{})})}),t.jsx(j,{title:"Effacer",children:t.jsx(I,{onClick:x,children:t.jsx(R,{})})})]})]}),t.jsxs(N,{sx:{flexGrow:1,overflow:"auto",p:0},ref:s,children:[r.length===0&&t.jsx(p,{sx:{p:3,textAlign:"center",color:"text.secondary"},children:"No activity captured yet"}),r.map(e=>t.jsxs("div",{children:[t.jsx(D,{alignItems:"flex-start",sx:{py:1},children:t.jsx(O,{primary:t.jsxs(p,{sx:{display:"flex",alignItems:"center",gap:1},children:[t.jsx(V,{label:e.type==="packet"?e.direction:e.type.toUpperCase(),size:"small",color:e.type==="error"?"error":e.type==="system"?"info":e.direction==="TX"?"primary":"secondary",variant:e.type==="packet"?"outlined":"filled"}),t.jsxs(i,{variant:"subtitle2",component:"span",sx:{fontFamily:"monospace"},children:[e.timestamp.toLocaleTimeString(),".",e.timestamp.getMilliseconds().toString().padStart(3,"0")]}),e.type==="packet"&&t.jsx(i,{variant:"subtitle2",component:"span",sx:{fontWeight:"bold"},children:g(e.opcode)})]}),secondary:t.jsx(p,{sx:{mt:.5,fontFamily:"monospace",fontSize:"0.85rem",wordBreak:"break-all"},children:e.type==="packet"?t.jsxs(t.Fragment,{children:[e.opcode!==h.INTERNAL_GATT_OPERATION&&t.jsxs(i,{variant:"caption",display:"block",color:"text.secondary",children:["Opcode: 0x",e.opcode.toString(16).padStart(2,"0").toUpperCase()]}),t.jsxs(i,{variant:"caption",display:"block",color:"text.secondary",children:["Payload: ",A(e)]}),t.jsxs(i,{variant:"caption",display:"block",color:"text.secondary",sx:{mt:1},children:["Raw: ",e.raw||"(empty)"]})]}):t.jsx(i,{variant:"body2",color:"text.primary",children:e.raw})}),slotProps:{primary:{component:"div"},secondary:{component:"div"}}})}),t.jsx(b,{component:"li"})]},e.id))]}),t.jsx(_,{open:l,autoHideDuration:3e3,onClose:()=>y(!1),message:"Logs copi√©s au format JSON"})]})};export{Y as DebugView};
