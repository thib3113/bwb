import{e as ee,j as e,f as B,n as te,U as Y,r as p,bt as j,b8 as q,a8 as re,a9 as ie,aa as de,a2 as le,k as h,K as U,M,aW as ce,aX as ue,aY as xe,aZ as H,ab as pe,l as L,bu as P,a5 as me,a6 as he,T as y,bv as fe,a3 as ge,au as je,aq as z,ar as ye,a7 as Ce,D as be,a4 as Ie,bw as ve,bx as Se,by as Ee,i as _e,bz as we,a_ as K,a$ as X,b0 as Z,C as De,an as Te,o as Ae}from"./index-aZM34ylH.js";import{I as ke,V as Me,a as Le,A as se}from"./VisibilityOff-BEzPQb54.js";import{L as Ne}from"./Lock-DwvtsUAw.js";import{E as Re}from"./Edit-DOFfOpQG.js";const Pe=ee(e.jsx("path",{d:"m19 8-4 4h3c0 3.31-2.69 6-6 6-1.01 0-1.97-.25-2.8-.7l-1.46 1.46C8.97 19.54 10.43 20 12 20c4.42 0 8-3.58 8-8h3zM6 12c0-3.31 2.69-6 6-6 1.01 0 1.97.25 2.8.7l1.46-1.46C15.03 4.46 13.57 4 12 4c-4.42 0-8 3.58-8 8H1l4 4 4-4z"})),Ue=ee(e.jsx("path",{d:"M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8m0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4z"})),ze=t=>{const r=new Uint32Array(1);return crypto.getRandomValues(r),r[0]%t},J=()=>{const t="0123456789AB";let r="";for(let o=0;o<6;o++)r+=t.charAt(ze(t.length));return r},Be=t=>t?t.toUpperCase().replace(/[^0-9AB]/g,""):"",Oe=({open:t,onClose:r,onSave:o,editingCode:a})=>{const{t:s}=B(["codes","common"]),{activeDevice:n}=te(),d=!!n?.configuration_key,c=n?.role===Y.Owner||n?.role===Y.Admin,[u,I]=p.useState(j.SINGLE),[v,m]=p.useState(""),[f,C]=p.useState(""),[x,S]=p.useState(0),[T,A]=p.useState(1),[_,N]=p.useState(!0);p.useEffect(()=>{if(t){const i=setTimeout(()=>{a?(I(a.type),m(a.code),C(a.name||a.description||""),S(a.index||0),A(a.uses||1)):(I(j.SINGLE),m(J()),C(""),S(0),A(1)),N(!0)},0);return()=>clearTimeout(i)}},[a,t]),p.useEffect(()=>{t&&n?.id&&u===j.MASTER&&q.loadCodes(n.id).then(i=>{const R=i.filter(l=>l.type===j.MASTER&&l.status!=="pending_delete").map(l=>l.index).filter(l=>l!==void 0),D=Math.max(...R,-1)+1;S(D)})},[t,n?.id,u]);const w=()=>{I(j.SINGLE),m(""),C(""),S(0),A(1),r()},E=async()=>{const i=Be(v);if(m(i),u===j.MASTER&&n?.id){const D=(await q.loadCodes(n.id)).find(l=>l.type===j.MASTER&&l.index===x&&l.status!=="pending_delete"&&(!a||l.id!==a.id));if(D){o({type:u,code:i,name:f,index:x,maxUses:T},D.id),w();return}}o({type:u,code:i,name:f,index:x,maxUses:T},a?a.id:null),w()};return e.jsx(e.Fragment,{children:e.jsxs(re,{open:t,onClose:w,maxWidth:"sm",fullWidth:!0,children:[e.jsx(ie,{children:s(a?"edit_code":"add_new")}),e.jsxs(de,{children:[!n?.configuration_key&&e.jsx(le,{severity:"warning",sx:{mb:2},children:s("config_key_missing")}),e.jsxs(h,{sx:{display:"flex",flexDirection:"column",gap:2,mt:1},children:[e.jsxs(h,{sx:{display:"flex",gap:1},children:[e.jsx(U,{label:s("pin_label"),value:v,onChange:i=>m(i.currentTarget.value.trim().toUpperCase()),fullWidth:!0,type:_?"text":"password",inputProps:{maxLength:6,"data-testid":"code-pin-input"},InputProps:{endAdornment:e.jsx(ke,{position:"end",children:e.jsx(M,{"aria-label":"toggle code visibility",onClick:()=>N(!_),edge:"end",size:"small",children:_?e.jsx(Me,{}):e.jsx(Le,{})})})}}),e.jsx(M,{onClick:()=>m(J()),"aria-label":s("generate"),"data-testid":"generate-code-button",children:e.jsx(Pe,{})})]}),e.jsx(U,{label:s("description_label"),value:f,onChange:i=>C(i.currentTarget.value),placeholder:s("description_placeholder"),inputProps:{"data-testid":"code-name-input"},fullWidth:!0,required:!0}),e.jsxs(ce,{fullWidth:!0,children:[e.jsx(ue,{children:s("type_label")}),e.jsxs(xe,{value:u,onChange:i=>I(i.target.value),label:s("type_label"),"data-testid":"code-type-select",children:[(!c||c&&d)&&e.jsx(H,{value:j.MASTER,"data-testid":"option-master",children:s("master_code")}),e.jsx(H,{value:j.SINGLE,"data-testid":"option-single",children:s("single_use_code")})]})]}),u===j.MASTER&&e.jsx(U,{label:`${s("index_label")}: ${x}`,type:"number",value:x,onChange:i=>S(parseInt(i.currentTarget.value)||0),fullWidth:!0,disabled:!c,inputProps:{min:0,max:255,"data-testid":"code-index-input"}})]})]}),e.jsxs(pe,{children:[e.jsx(L,{onClick:w,children:s("cancel")}),e.jsx(L,{onClick:E,variant:"contained","data-testid":"save-code-button",startIcon:e.jsx(se,{}),disabled:!v||v.length!==6||f.trim()==="",children:s(a?"save":"generate")})]})]})})};function We(t,r="en"){const o=new Intl.RelativeTimeFormat(r,{numeric:"auto"}),a=(t.getTime()-Date.now())/1e3;if(Math.abs(a)<60)return o.format(Math.round(a),"second");const s=a/60;if(Math.abs(s)<60)return o.format(Math.round(s),"minute");const n=s/60;if(Math.abs(n)<24)return o.format(Math.round(n),"hour");const d=n/24;if(Math.abs(d)<30)return o.format(Math.round(d),"day");const c=d/30;if(Math.abs(c)<12)return o.format(Math.round(c),"month");const u=d/365;return o.format(Math.round(u),"year")}const $e=({code:t,metadata:r,onCopy:o,onEdit:a,onDelete:s})=>{const{t:n,i18n:d}=B(["codes","common"]),[c,u]=p.useState(!1),I=t.status===P.PENDING_DELETE,v=r.used,m=r.usedDate||r.lastUsed,f=I||v,C=()=>u(!c);return e.jsxs(h,{component:"div",sx:{display:"flex",flexDirection:"column",width:"100%"},children:[e.jsxs(me,{divider:!1,"data-testid":`code-item-${t.code}`,"data-status":t.status,sx:{cursor:"pointer",opacity:f?.6:1,backgroundColor:f?"action.selected":"inherit",textDecoration:f?"line-through":"none",borderLeft:"4px solid",borderLeftColor:t.status===P.ON_DEVICE?"primary.main":t.status===P.PENDING_ADD?"warning.main":t.status===P.PENDING_DELETE?"error.main":"default.main",pl:1,pr:12},component:"div",onClick:C,children:[e.jsx(he,{primary:e.jsxs(h,{sx:{display:"flex",alignItems:"center",overflow:"hidden"},children:[e.jsx(y,{variant:"body1",sx:{fontWeight:"bold",whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis",flexShrink:1,minWidth:0},children:t.name||t.description||n("codes:unnamed")}),e.jsxs(y,{variant:"caption",sx:{ml:1,whiteSpace:"nowrap",flexShrink:0},children:[n("codes:pin_label"),": ",t.code]})]}),disableTypography:!0}),e.jsxs(fe,{children:[e.jsx(ge,{title:n("codes:copy_code"),children:e.jsx(M,{edge:"end","aria-label":"copy",onClick:x=>{x.stopPropagation(),o(t.code)},sx:{mr:1},children:e.jsx(je,{})})}),e.jsx(M,{edge:"end","aria-label":c?"collapse":"expand",onClick:x=>{x.stopPropagation(),C()},sx:{transform:c?"rotate(180deg)":"rotate(0deg)",transition:"transform 0.3s"},children:e.jsx(z,{})})]})]}),e.jsx(ye,{in:c,timeout:"auto",unmountOnExit:!0,children:e.jsxs(h,{sx:{pl:4,pr:2,pb:2,display:"flex",flexDirection:"column",gap:1,borderLeft:"4px solid transparent",ml:0},children:[e.jsx(y,{variant:"body2",sx:{whiteSpace:"pre-wrap",wordBreak:"break-word"},children:t.description||t.name||n("codes:unnamed")}),m&&e.jsxs(y,{variant:"caption",color:"text.secondary",children:[n("codes:last_used"),": ",We(new Date(m),d.language)]}),e.jsxs(h,{sx:{display:"flex",gap:1,mt:1,justifyContent:"flex-end"},children:[e.jsx(L,{startIcon:e.jsx(Re,{}),size:"small",onClick:()=>a(t),"data-testid":`edit-code-${t.code}`,children:n("common:edit")}),e.jsx(L,{startIcon:e.jsx(Ce,{}),size:"small",color:"error",onClick:()=>s(t.id),"data-testid":`delete-code-${t.code}`,children:n("common:delete")})]})]})}),e.jsx(be,{})]})},Q=({codes:t,deriveCodeMetadata:r,hasIndexConflict:o,onCopy:a,onEdit:s,onDelete:n})=>e.jsx(Ie,{component:"div",children:t.map(d=>e.jsx($e,{code:d,metadata:r(d),hasIndexConflict:o?o(d.index,d.id):!1,onCopy:a,onEdit:s,onDelete:n},d.id))}),Ge=({showAddForm:t,setShowAddForm:r,showNotification:o,hideNotification:a})=>{const{t:s}=B(["codes","common"]),{activeDevice:n,isSyncingCodes:d}=te(),{isRestricted:c}=ve(),{tasks:u,syncTasks:I,isProcessing:v}=Se(),{isSyncingLogs:m}=Ee(),{isConnected:f}=_e(),[C,x]=p.useState(!1),[S,T]=p.useState(new Set(["permanent","temporary"])),[A,_]=p.useState(null),{masterCodes:N,temporaryCodes:w,codeCount:E,refreshCodeCount:i,hasIndexConflict:R,handleAddCode:D,handleDeleteCode:l,deriveCodeMetadata:O,getFilteredCodes:W,handleCopyCode:$}=we(o),ne=n?.auto_sync??!1,G=u.filter(g=>g.status==="pending"&&g.deviceId===n?.id).length,k=!ne&&G>0,V=v||m||d,F=p.useCallback(g=>{_(g),x(!0)},[]),ae=async()=>{try{k&&await I(),await i()}catch(g){console.error("Failed to refresh/sync:",g)}},oe=()=>V?e.jsx(De,{size:20,color:"inherit"}):k?e.jsx(Ue,{}):e.jsx(Te,{});return c?e.jsxs(h,{"data-testid":"feature-blocked-screen",sx:{width:"100%",p:4,textAlign:"center",display:"flex",flexDirection:"column",alignItems:"center"},children:[e.jsx(Ne,{sx:{fontSize:60,color:"text.secondary",mb:2}}),e.jsx(y,{variant:"h5",gutterBottom:!0,color:"text.secondary",children:s("common:feature_disabled")}),e.jsx(y,{variant:"body1",color:"text.secondary",sx:{maxWidth:400},children:s("common:errors.version.feature_restricted_message",{feature:s("codes:title")})})]}):e.jsxs(h,{sx:{width:"100%"},children:[e.jsxs(h,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2},children:[e.jsxs(y,{variant:"h5","data-testid":"code-stats",children:[s("title")," ",E&&`(Total: ${E.total})`]}),e.jsxs(h,{sx:{display:"flex",gap:1},children:[e.jsx(L,{variant:k?"contained":"outlined",color:k?"warning":"primary",startIcon:oe(),onClick:ae,disabled:!f||V,size:"small",children:k?s("sync_pending",{count:G}):s("refresh")}),e.jsx(M,{color:"primary",onClick:()=>x(!0),"aria-label":s("add_new"),"data-testid":"add-code-button",size:"small",children:e.jsx(se,{})})]})]}),n&&e.jsx(y,{variant:"subtitle1",color:"textSecondary",sx:{mb:2},children:n.friendly_name||n.ble_name}),e.jsx(Oe,{open:C||t||!1,onClose:()=>{x(!1),r&&r(!1),_(null)},onSave:D,editingCode:A}),e.jsxs(K,{expanded:S.has("permanent"),onChange:()=>{T(g=>{const b=new Set(g);return b.has("permanent")?b.delete("permanent"):b.add("permanent"),b})},elevation:0,sx:{backgroundColor:"transparent",width:"100%"},disableGutters:!0,children:[e.jsx(X,{expandIcon:e.jsx(z,{}),children:e.jsxs(y,{children:[s("permanent_codes")," (",N.length,E&&` / ${E.master} ${s("codes:on_device_count")}`,")"]})}),e.jsx(Z,{sx:{padding:"0 0 0 0 !important"},children:e.jsx(Q,{codes:W("master"),deriveCodeMetadata:O,hasIndexConflict:R,onCopy:$,onEdit:F,onDelete:l})})]}),e.jsxs(K,{expanded:S.has("temporary"),onChange:()=>{T(g=>{const b=new Set(g);return b.has("temporary")?b.delete("temporary"):b.add("temporary"),b})},elevation:0,sx:{backgroundColor:"transparent",width:"100%"},disableGutters:!0,children:[e.jsx(X,{expandIcon:e.jsx(z,{}),children:e.jsxs(y,{children:[s("temporary_codes")," (",w.length,E&&` / ${E.single} ${s("codes:on_device_count")}`,")"]})}),e.jsx(Z,{sx:{padding:"0 0 0 0 !important"},children:e.jsx(Q,{codes:W("temporary"),deriveCodeMetadata:O,onCopy:$,onEdit:F,onDelete:l})})]})]})},He=()=>{const t=Ae();if(!t)return null;const{showNotification:r,hideNotification:o}=t;return e.jsx(h,{sx:{p:2},children:e.jsx(Ge,{showNotification:r,hideNotification:o})})};export{He as CodeManagerWrapper};
