import{R as E,bt as B,i as v,t as y,l as O,b as e,Y,az as A,aA as I,o as m,ae as R,q as $,k,aL as M,a2 as V,a3 as j,an as x,bu as q,bv as z,a4 as P,bw as W,T as w,n as F,C as Q,aw as N,ai as H,r as J}from"./index-Bp4QzDbV.js";import{b,c,T as D,d as C,a as K}from"./TableRow-BF6n43oh.js";const G=()=>{const o=E(B);if(o===void 0)throw new Error("useLogCount must be used within a DeviceProvider");return{logCount:o.logCount}};function U(o,n){const t=new Date(o),i=new Date,s=new Date;return s.setFullYear(i.getFullYear()-1),t<s?t.toLocaleDateString(n,{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit",hour12:!1}):t.toLocaleDateString(n,{day:"2-digit",month:"2-digit",hour:"2-digit",minute:"2-digit",hour12:!1})}function X(o,n){return{code_index:n("code_index"),code_value:n("code_value"),code:n("code_value"),method:n("method"),result:n("result"),reason:n("reason"),error_code:n("error_code"),weight:n("weight"),battery_level:n("battery_level"),tagId:n("tag_id"),initiatedBy:n("initiated_by"),bootReason:n("boot_reason"),payload:n("payload")}[o]||o}const Z=({log:o})=>{const{t:n,i18n:t}=v("logs"),[i,s]=y(O(!1),"isExpanded"),d=()=>{s(!i)};return e(R,{children:[e(b,{children:[e(c,{title:o.fullDate,children:U(o.timestamp,t.language)}),e(c,{children:o.event}),e(c,{children:(()=>{const l={...o.details};return delete l.age,delete l.timestamp,Object.keys(l).length>0?e(Y,{"aria-label":"expand row",size:"small",onClick:d,children:e(A,{style:{transform:i?"rotate(180deg)":"rotate(0deg)"}})}):null})()})]}),e(b,{children:e(c,{style:{paddingBottom:0,paddingTop:0},colSpan:3,children:e(I,{in:i,timeout:"auto",unmountOnExit:!0,children:e(m,{sx:{margin:1},children:e(D,{size:"small","aria-label":"details",children:e(C,{children:(()=>{const l={...o.details};return delete l.age,delete l.timestamp,Object.entries(l).map(([h,g])=>e(b,{children:[e(c,{component:"th",scope:"row",sx:{fontWeight:"bold"},children:X(h,n)}),e(c,{children:typeof g=="object"?JSON.stringify(g):String(g)})]},h))})()})})})})})})]})},ee=({showNotification:o,hideNotification:n})=>{const{t,i18n:i}=v(["logs","common"]),{activeDevice:s}=$(),{isConnected:d}=k(),{isSyncingLogs:l,requestLogs:h}=M(),{logCount:g}=G(),_=V(()=>s?.id?(console.log(`[LogViewer] Querying logs for device_id: ${s.id}`),j.logs.where("device_id").equals(s.id).toArray().then(r=>r.sort((a,p)=>Number(p.timestamp)-Number(a.timestamp)))):[],[s?.id]),u=y(x(()=>{const r=_??q;return console.log(`[LogViewer] raw logs count: ${r.length}`,r),r},[_]),"logs"),L=y(x(()=>{if(u.length===0)return[];try{console.log(`[LogViewer] Starting parseLogs with ${u.length} logs`);const r=z(u).map(a=>{const f=new Date(a.timestamp).toLocaleString(i.language);return{...a,fullDate:f,event:t(a.description)}});return console.log(`[LogViewer] Parsing finished. parsedLogs: ${r.length}`,r),r}catch(r){const a=r instanceof Error?r.message:String(r);return console.error(t("parse_error"),a),[]}},[u,i.language,t]),"parsedLogs"),T=P(async()=>{if(!d){o&&o(t("not_connected"),"error");return}await W(h,{showNotification:o,hideNotification:n,loadingMsg:t("refresh_started"),successMsg:t("refresh_success"),errorMsg:t("refresh_failed")})},[d,h,o,n,t]);return e(m,{sx:{p:2,mb:2,width:"100%"},children:[e(m,{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2,children:[e(w,{variant:"h5",component:"h2",children:[t("title")," ",g!==null&&g>0&&`(${g})`]}),e(F,{variant:"outlined",startIcon:l?e(Q,{size:20}):e(N,{}),onClick:T,disabled:!d||l,children:t("refresh")})]}),!d&&!s&&u.length===0&&e(H,{severity:"info",sx:{mb:2},children:t("connect_to_view")}),e(m,{sx:{height:"100%",width:"100%",overflowY:"auto",borderRadius:1,p:2,backgroundColor:"background.paper",fontFamily:"Courier New, monospace"},children:L.length>0?e(D,{children:[e(K,{children:e(b,{children:[e(c,{children:t("timestamp")}),e(c,{children:t("event_label")}),e(c,{})]})}),e(C,{children:L.map((r,a)=>e(Z,{log:r},a))})]}):u.length>0?e(m,{children:u.map((r,a)=>{const p=new Date(r.timestamp),f=p.toLocaleDateString(i.language,{day:"2-digit",month:"2-digit",hour:"2-digit",minute:"2-digit"}),S=p.toLocaleString(i.language);return e(m,{sx:{py:1,borderBottom:"1px solid",borderColor:"divider"},children:[e(w,{component:"span",fontWeight:"bold",title:S,children:f}),": ",r.event]},a)})}):e(w,{align:"center",sx:{fontStyle:"italic",py:2},component:"p",children:t(d||s?"no_logs_when_connected":"no_logs_when_disconnected")})})]})},oe=()=>{const o=J();if(!o)return null;const{showNotification:n,hideNotification:t}=o;return e(ee,{showNotification:n,hideNotification:t})};export{oe as LogViewerWrapper};
