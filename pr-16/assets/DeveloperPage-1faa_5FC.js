import{h as z,b as e,i as w,t as g,l as y,a3 as D,aX as V,aY as $,aZ as H,a_ as j,o as c,a2 as q,T as h,ac as G,a$ as ee,b0 as te,az as re,b1 as ne,ab as ae,W as F,ai as C,n as _,Y as M,a0 as K,P as Z,aO as se,an as B,b2 as W,b3 as le,Q as A,a6 as ie,F as I,I as oe,aw as ce,H as E,w as de,b4 as he,Z as ue,$ as pe,b5 as R}from"./index-EKlM98RO.js";import{S as ge}from"./Stack-WpnE4H2q.js";import{E as me}from"./Edit-Cl-d77Wi.js";import{D as J}from"./Delete-BCs097WX.js";import{T as ve,a as be,b as L,c as k,d as fe}from"./TableRow-BoOYonXK.js";import{C as ye}from"./Chip-CKf3EidG.js";import{T as xe,a as N}from"./Tabs-B26Yijyl.js";import{C as _e}from"./Container-CJkyayZB.js";const Se=z(e("path",{d:"M12 2C6.47 2 2 6.47 2 12s4.47 10 10 10 10-4.47 10-10S17.53 2 12 2m5 13.59L15.59 17 12 13.41 8.41 17 7 15.59 10.59 12 7 8.41 8.41 7 12 10.59 15.59 7 17 8.41 13.41 12z"})),ke=z(e("path",{d:"M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6zm2.46-7.12 1.41-1.41L12 12.59l2.12-2.12 1.41 1.41L13.41 14l2.12 2.12-1.41 1.41L12 15.41l-2.12 2.12-1.41-1.41L10.59 14zM15.5 4l-1-1h-5l-1 1H5v2h14V4z"})),Ce=z(e("path",{d:"M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3m3-10H5V5h10z"})),we=z(e("path",{d:"m12 16.5 4-4h-3v-9h-2v9H8zm9-13h-6v1.99h6v14.03H3V5.49h6V3.5H3c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2v-14c0-1.1-.9-2-2-2"})),De=({tableName:t,item:a,primaryKey:l})=>{const[s,i]=g(y(!1),"isEditing"),[r,d]=g(y(JSON.stringify(a,null,2)),"editValue"),[b,v]=g(y(null),"error"),o=async()=>{try{const x=JSON.parse(r);await D.table(t).put(x),i(!1),v(null)}catch(x){v(x instanceof Error?x.message:"Invalid JSON")}},p=async()=>{confirm("Are you sure you want to delete this record?")&&await D.table(t).delete(l)};return s?e(c,{sx:{p:1},children:[e(F,{fullWidth:!0,multiline:!0,minRows:3,value:r,onChange:x=>d(x.target.value),variant:"outlined",size:"small",sx:{fontFamily:"monospace",mb:1}}),b&&e(C,{severity:"error",sx:{mb:1},children:b}),e(ge,{direction:"row",spacing:1,justifyContent:"flex-end",children:[e(_,{startIcon:e(Se,{}),onClick:()=>{i(!1),d(JSON.stringify(a,null,2)),v(null)},size:"small",children:"Cancel"}),e(_,{startIcon:e(Ce,{}),onClick:o,variant:"contained",size:"small",children:"Save"})]})]}):e(c,{children:[e(c,{sx:{display:"flex",justifyContent:"flex-end",mb:1},children:[e(M,{size:"small",onClick:()=>i(!0),children:e(me,{fontSize:"small"})}),e(M,{size:"small",onClick:p,color:"error",children:e(J,{fontSize:"small"})})]}),e(c,{component:"pre",sx:{overflowX:"auto",fontSize:"0.75rem",m:0,p:1,bgcolor:"action.hover",borderRadius:1},children:JSON.stringify(a,null,2)})]})},Oe=({tableName:t})=>{const{t:a}=w(["settings"]),l=q(()=>D.table(t).toArray(),[t]),i=D.table(t).schema.primKey.name;return l?l.length===0?e(h,{children:a("settings:developer.no_records")}):e(ae,{children:l.map((r,d)=>{const b=r[i];return e(G,{disablePadding:!0,children:e(ee,{sx:{width:"100%"},children:[e(te,{expandIcon:e(re,{}),children:e(h,{noWrap:!0,children:r.id||r.name||r.key||`Record ${d}`})}),e(ne,{children:e(De,{tableName:t,item:r,primaryKey:b})})]})},b||d)})}):e(h,{children:a("settings:developer.loading")})},Te=()=>{const{t}=w(["settings"]),[a,l]=g(y(""),"selectedTable"),s=D.tables.map(r=>r.name),i=r=>{l(r.target.value)};return e(c,{sx:{mt:2},children:[e(V,{fullWidth:!0,size:"small",sx:{mb:2},children:[e($,{children:t("settings:developer.select_table")}),e(H,{value:a,label:t("settings:developer.select_table"),onChange:i,children:s.map(r=>e(j,{value:r,children:r},r))})]}),a&&e(Oe,{tableName:a})]})},Ie=()=>{const{t}=w(["settings"]),{debugLogs:a,clearDebugLogs:l}=K(),s=a.filter(r=>r.type==="packet").sort((r,d)=>new Date(d.timestamp).getTime()-new Date(r.timestamp).getTime()),i=r=>r===void 0?"UNKNOWN":se[r]||`OP_${r.toString(16).toUpperCase()}`;return e(c,{sx:{mt:4},children:[e(c,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2},children:[e(h,{variant:"h6",children:t("settings:developer.packet_logger_title")}),e(_,{variant:"outlined",color:"error",startIcon:e(J,{}),onClick:l,size:"small",children:t("settings:developer.clear_logs")})]}),e(Z,{variant:"outlined",sx:{width:"100%",overflow:"hidden"},children:e(c,{sx:{maxHeight:400,overflowY:"auto"},children:e(ve,{stickyHeader:!0,size:"small",children:[e(be,{children:e(L,{children:[e(k,{children:"Time"}),e(k,{children:"Dir"}),e(k,{children:"Opcode"}),e(k,{children:"Payload (Hex)"})]})}),e(fe,{children:s.length>0?s.map(r=>e(L,{hover:!0,children:[e(k,{sx:{whiteSpace:"nowrap",fontSize:"0.75rem"},children:new Date(r.timestamp).toLocaleTimeString([],{hour12:!1,hour:"2-digit",minute:"2-digit",second:"2-digit",fractionalSecondDigits:3})}),e(k,{children:e(ye,{label:r.direction,color:r.direction==="TX"?"primary":"success",size:"small",sx:{fontSize:"0.7rem",height:20}})}),e(k,{sx:{fontSize:"0.75rem",fontWeight:"bold"},children:i(r.opcode)}),e(k,{sx:{fontFamily:"monospace",fontSize:"0.75rem",wordBreak:"break-all"},children:r.payload||"-"})]},r.id)):e(L,{children:e(k,{colSpan:4,align:"center",children:e(h,{variant:"body2",color:"text.secondary",sx:{py:2},children:t("settings:developer.no_records")})})})})]})})})]})},Ee=t=>ie[t]||`UNKNOWN_OPCODE_${t}`,U={},ze=()=>{const{t}=w(["settings"]),{sendPacket:a,isConnected:l}=K(),[s,i]=g(y(""),"selectedOpcode"),[r,d]=g(y({}),"formData"),[b,v]=g(y(null),"validationError"),[o,p]=g(y(null),"successMessage"),x=g(B(()=>Array.from(W.getRegisteredTXPackets().entries()).sort((n,m)=>n[0]-m[0]),[]),"registeredPackets"),u=g(B(()=>s===""?null:W.getRegisteredTXPackets().get(s),[s]),"SelectedPacketClass"),f=g(B(()=>!u||!u.schema?null:u.schema instanceof le?u.schema.shape:null,[u]),"schemaShape");A(()=>{if(!f){d({});return}const n={};Object.keys(f).forEach(m=>{n[m]=U[m]||""}),d(n)},[f]);const X=n=>{i(n.target.value),v(null),p(null)},Y=(n,m)=>{d(S=>({...S,[n]:m})),U[n]=m,v(null),p(null)},Q=async()=>{if(u){v(null),p(null);try{let n={};if(u.schema){const S=u.schema.safeParse(r);if(!S.success){const O=S.error.errors.map(T=>`${T.path.join(".")}: ${T.message}`).join(", ");v(O);return}n=S.data}const m=new u;Object.assign(m,n),await a(m),console.log("Packet sent successfully",m),p(t("settings:developer.packet_sent_success"))}catch(n){console.error("Failed to send packet",n),v(n.message||t("settings:developer.packet_send_error"))}}};return e(c,{sx:{display:"flex",flexDirection:"column",gap:3},children:[e(C,{severity:l?"success":"warning",children:t(l?"settings:developer.enabled_success":"settings:developer.not_connected_warning")}),e(V,{fullWidth:!0,children:[e($,{children:t("settings:developer.packet_type_label")}),e(H,{value:s,label:t("settings:developer.packet_type_label"),onChange:X,children:x.map(([n])=>e(j,{value:n,children:[Ee(n)," (",n,")"]},n))})]}),u&&e(Z,{variant:"outlined",sx:{p:2},children:[e(h,{variant:"h6",gutterBottom:!0,children:t("settings:developer.packet_parameters_title")}),e(c,{sx:{display:"flex",flexDirection:"column",gap:2},children:[f?Object.keys(f).length>0?Object.keys(f).map(n=>{const m=f[n];let S=!1,O=m._def.typeName;return(O==="ZodNumber"||O==="ZodEffects"&&m._def.schema?._def.typeName==="ZodNumber")&&(S=!0),e(F,{label:n,variant:"outlined",fullWidth:!0,type:S?"number":"text",value:r[n]||"",onChange:T=>Y(n,T.target.value),helperText:S?"Number":"String"},n)}):e(h,{color:"text.secondary",children:t("settings:developer.no_parameters")}):e(h,{color:"text.secondary",children:t("settings:developer.no_schema")}),b&&e(C,{severity:"error",children:b}),o&&e(C,{severity:"success",children:o}),e(_,{variant:"contained",onClick:Q,disabled:!l&&!window.BOKS_SIMULATOR_ENABLED,children:t("settings:developer.send_packet")})]})]}),e(Ie,{})]})},Be=()=>{const{t}=w(["settings"]),[a,l]=g(y([]),"registrations"),[s,i]=g(y(null),"message"),r=async()=>{if("serviceWorker"in navigator){const o=await navigator.serviceWorker.getRegistrations();l([...o])}};A(()=>{r()},[]);const d=async o=>{try{await o.update(),i("Update requested"),r()}catch(p){i("Update failed: "+p)}},b=async o=>{try{const p=await o.unregister();i(p?"Unregistered successfully":"Unregister failed"),r()}catch(p){i("Unregister error: "+p)}},v=()=>{window.location.reload()};return"serviceWorker"in navigator?e(E,{sx:{mt:2},children:e(I,{children:[e(h,{variant:"h6",gutterBottom:!0,children:t("settings:developer.sw_title")}),e(oe,{sx:{mb:2}}),s&&e(C,{severity:"info",sx:{mb:2},onClose:()=>i(null),children:s}),a.length===0?e(h,{variant:"body2",color:"text.secondary",children:[t("settings:developer.no_records")," (No active registrations)"]}):a.map((o,p)=>e(c,{sx:{mb:2,p:1,border:"1px solid #ddd",borderRadius:1},children:[e(h,{variant:"subtitle2",children:["Scope: ",o.scope]}),e(h,{variant:"body2",color:"text.secondary",gutterBottom:!0,children:t("settings:developer.sw_status",{status:o.installing?"Installing":o.waiting?"Waiting":o.active?"Active":"Unknown"})}),e(c,{sx:{display:"flex",gap:1,flexWrap:"wrap",mt:1},children:[e(_,{size:"small",variant:"outlined",startIcon:e(we,{}),onClick:()=>d(o),children:t("settings:developer.sw_check_update")}),e(_,{size:"small",variant:"outlined",color:"error",startIcon:e(ke,{}),onClick:()=>b(o),children:t("settings:developer.sw_unregister")})]})]},p)),e(c,{sx:{mt:2},children:e(_,{fullWidth:!0,variant:"contained",color:"primary",startIcon:e(ce,{}),onClick:v,children:t("settings:developer.sw_reload")})})]})}):e(C,{severity:"warning",children:"Service Worker API not supported"})};function P(t){const{children:a,value:l,index:s,...i}=t;return e("div",{role:"tabpanel",hidden:l!==s,id:`simple-tabpanel-${s}`,"aria-labelledby":`simple-tab-${s}`,...i,children:l===s&&e(c,{sx:{p:2},children:a})})}const Ve=()=>{const{t}=w(["settings"]),a=de(),{isDeveloperMode:l,disableDeveloperMode:s}=he(),[i,r]=g(y(!1),"simulatorEnabled"),[d,b]=g(y(0),"tabValue");A(()=>{l||a("/");const u=localStorage.getItem("BOKS_SIMULATOR_ENABLED")==="true";r(u)},[l,a]);const v=()=>{s(),a("/")},o=u=>{const f=u.target.checked;r(f),f?localStorage.setItem("BOKS_SIMULATOR_ENABLED","true"):localStorage.removeItem("BOKS_SIMULATOR_ENABLED"),window.location.reload()},p=async()=>{try{confirm(t("settings:developer.mock_data_confirm"))&&(await R.mockData(),alert(t("settings:developer.mock_data_success")))}catch(u){console.error(u),alert(t("settings:developer.mock_data_failed"))}},x=(u,f)=>{b(f)};return e(_e,{maxWidth:"md",sx:{py:2},children:[e(c,{sx:{mb:3,display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e(h,{variant:"h4",children:t("settings:developer.page_title")}),e(_,{variant:"outlined",color:"error",onClick:v,children:t("settings:developer.disable_mode")})]}),e(c,{sx:{borderBottom:1,borderColor:"divider"},children:e(xe,{value:d,onChange:x,"aria-label":"developer tabs",children:[e(N,{label:t("settings:developer.tabs.general")}),e(N,{label:t("settings:developer.tabs.database")}),e(N,{label:t("settings:developer.tabs.bluetooth")})]})}),e(P,{value:d,index:0,children:[e(E,{sx:{mb:3},children:e(I,{children:e(c,{sx:{display:"flex",flexDirection:"column",gap:2},children:[e(h,{variant:"h6",children:t("settings:developer.simulators_tools")}),e(ue,{control:e(pe,{checked:i,onChange:o}),label:t("settings:developer.enable_simulator")}),e(c,{children:[e(c,{sx:{display:"flex",gap:2},children:[e(_,{variant:"contained",onClick:p,children:t("settings:developer.load_mock_data")}),e(_,{variant:"outlined",color:"error",onClick:()=>{confirm(t("settings:developer.clear_db_confirm"))&&R.clearAllData()},children:t("settings:developer.clear_db")})]}),e(h,{variant:"caption",display:"block",color:"text.secondary",sx:{mt:1},children:t("settings:developer.mock_data_helper")})]})]})})}),e(Be,{})]}),e(P,{value:d,index:1,children:e(E,{children:e(I,{children:[e(h,{variant:"h6",gutterBottom:!0,children:t("settings:developer.db_editor")}),e(h,{variant:"body2",color:"text.secondary",paragraph:!0,children:t("settings:developer.db_editor_helper")}),e(Te,{})]})})}),e(P,{value:d,index:2,children:e(E,{children:e(I,{children:[e(h,{variant:"h6",gutterBottom:!0,children:"Bluetooth Debugger"}),e(ze,{})]})})})]})};export{Ve as DeveloperPage};
