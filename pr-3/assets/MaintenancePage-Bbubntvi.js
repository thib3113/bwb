import{g as w,a as E,D as P,u as R,b as t,c as O,d as A,s as I,h as T,i as b,T as h,t as f,l as x,q as k,F as L,at as M,o as D,P as U,a9 as N,aa as B,ab as K,n as $,H as q,aR as F,aL as _,aS as z,aT as H}from"./index-6IdjXkk5.js";import{C as W}from"./Container-Ctq5DtGF.js";import{L as Y}from"./LinearProgress-B8DqW7WJ.js";function j(n){return w("MuiCardActions",n)}E("MuiCardActions",["root","spacing"]);const G=n=>{const{classes:e,disableSpacing:s}=n;return A({root:["root",!s&&"spacing"]},j,e)},J=I("div",{name:"MuiCardActions",slot:"Root",overridesResolver:(n,e)=>{const{ownerState:s}=n;return[e.root,!s.disableSpacing&&e.spacing]}})({display:"flex",alignItems:"center",padding:8,variants:[{props:{disableSpacing:!1},style:{"& > :not(style) ~ :not(style)":{marginLeft:8}}}]}),Q=P(function(e,s){const a=R({props:e,name:"MuiCardActions"}),{disableSpacing:c=!1,className:l,...r}=a,d={...a,disableSpacing:c},o=G(d);return t(J,{className:O(o.root,l),ownerState:d,ref:s,...r})}),V=T(t("path",{d:"M8 5v14l11-7z"})),X=({script:n})=>{const{t:e}=b(["maintenance"]),[s,a]=f(x(!1),"running"),[c,l]=f(x(0),"progress"),[r,d]=f(x([]),"logs"),[o,u]=f(x(null),"error"),{activeDevice:p}=k(),v=async()=>{const g=z.getInstance();if(g.getState()!=="connected"){u(e("status.not_connected"));return}const i=p?.configuration_key;if(!i){u(e("status.missing_config_key"));return}a(!0),l(0),d([]),u(null);const y=m=>d(C=>[...C.slice(-4),m]);try{await n.run({setProgress:l,log:y,checkStop:()=>{},t:e},{bleService:g,configKey:i}),y(e("status.finished")),l(100)}catch(m){console.error(m);const C=m instanceof Error?m.message:String(m);u(e("status.error",{message:C})),y(e("status.error",{message:C}))}finally{a(!1)}};return t(q,{sx:{mb:2},children:[t(L,{children:[t(h,{variant:"h6",component:"div",children:e(n.titleKey)}),t(h,{sx:{mb:1.5},color:"text.secondary",children:e(n.descriptionKey)}),o&&t(M,{severity:"error",sx:{mb:2},children:o}),s&&t(D,{sx:{width:"100%",mb:2},children:[t(Y,{variant:"determinate",value:c}),t(h,{variant:"body2",color:"text.secondary",align:"right",children:e("progress",{percent:Math.round(c)})})]}),s&&t(U,{variant:"outlined",sx:{p:1,bgcolor:"background.default",maxHeight:100,overflow:"auto"},children:t(N,{dense:!0,disablePadding:!0,children:r.map((g,i)=>t(B,{disablePadding:!0,children:t(K,{primary:g,primaryTypographyProps:{variant:"caption",fontFamily:"monospace"}})},i))})})]}),t(Q,{children:t($,{size:"small",variant:"contained",startIcon:t(V,{}),onClick:v,disabled:s,children:e("run")})})]})},S=async n=>{const e=new H,s=await n.sendRequest(e,{expectResponse:!0});if(s.opcode!==_.NOTIFY_CODES_COUNT)throw new Error(`Unexpected response opcode: 0x${s.opcode.toString(16)}`);if(s.payload.length<2)throw new Error("Invalid payload length for CODES_COUNT");return s.payload[0]<<8|s.payload[1]},Z={id:"clean_master_codes",titleKey:"scripts.clean_master_codes.title",descriptionKey:"scripts.clean_master_codes.description",run:async({setProgress:n,log:e,checkStop:s,t:a},{bleService:c,configKey:l})=>{e(a("status.fetching_count"));let r=await S(c);if(e(a("status.initial_count",{count:r})),r===0){e(a("status.no_codes"));return}const d=256;for(let o=0;o<d;o++){s();const u=o/d*100;if(n(u),r===0){e(a("status.stopping_early"));break}let p=!0;for(;p;){s(),p=!1;const v=r;e(a("status.deleting_index",{index:o,count:r}));const g=new F(l,o);try{const i=await c.sendRequest(g,{expectResponse:!0},l);i.opcode===_.CODE_OPERATION_ERROR||(i.opcode,_.CODE_OPERATION_SUCCESS)}catch(i){const y=i instanceof Error?i.message:String(i);e(a("status.error",{message:`Index ${o}: ${y}`}))}r=await S(c),r<v&&(e(a("status.retry_index",{count:r,index:o})),p=!0,r===0&&(p=!1))}}}},ne=()=>{const{t:n}=b(["maintenance"]);return t(W,{maxWidth:"sm",sx:{mt:2,pb:10},children:[t(h,{variant:"h4",gutterBottom:!0,children:n("title")}),t(h,{variant:"body2",color:"text.secondary",paragraph:!0,children:n("description")}),t(X,{script:Z})]})};export{ne as MaintenancePage};
