import{g as S,a as b,D as w,u as E,b as e,c as P,d as I,s as M,h as O,i as A,T as C,t as h,l as m,q as D,F as k,at as T,o as L,P as _,a9 as U,aa as $,ab as N,n as B,H as F,aR as q,aL as x,aS as z,aT as H}from"./index-DJ1ccK2a.js";import{C as W}from"./Container-CFqFafSi.js";import{L as K}from"./LinearProgress-h7MhScGW.js";function Y(s){return S("MuiCardActions",s)}b("MuiCardActions",["root","spacing"]);const j=s=>{const{classes:t,disableSpacing:n}=s;return I({root:["root",!n&&"spacing"]},Y,t)},G=M("div",{name:"MuiCardActions",slot:"Root",overridesResolver:(s,t)=>{const{ownerState:n}=s;return[t.root,!n.disableSpacing&&t.spacing]}})({display:"flex",alignItems:"center",padding:8,variants:[{props:{disableSpacing:!1},style:{"& > :not(style) ~ :not(style)":{marginLeft:8}}}]}),J=w(function(t,n){const o=E({props:t,name:"MuiCardActions"}),{disableSpacing:c=!1,className:a,...l}=o,r={...o,disableSpacing:c},d=j(r);return e(G,{className:P(d.root,a),ownerState:r,ref:n,...l})}),Q=O(e("path",{d:"M8 5v14l11-7z"})),V=({script:s})=>{const[t,n]=h(m(!1),"running"),[o,c]=h(m(0),"progress"),[a,l]=h(m([]),"logs"),[r,d]=h(m(null),"error"),{activeDevice:u}=D(),f=async()=>{const p=z.getInstance();if(p.getState()!=="connected"){d("Device not connected");return}const i=u?.configuration_key;if(!i){d("Configuration Key is missing for this device.");return}n(!0),c(0),l([]),d(null);const y=g=>l(R=>[...R.slice(-4),g]);try{await s.run({setProgress:c,log:y,checkStop:()=>{}},{bleService:p,configKey:i}),y("Script finished successfully."),c(100)}catch(g){console.error(g),d(g.message||"Unknown error"),y(`Error: ${g.message}`)}finally{n(!1)}};return e(F,{sx:{mb:2},children:[e(k,{children:[e(C,{variant:"h6",component:"div",children:s.title}),e(C,{sx:{mb:1.5},color:"text.secondary",children:s.description}),r&&e(T,{severity:"error",sx:{mb:2},children:r}),t&&e(L,{sx:{width:"100%",mb:2},children:[e(K,{variant:"determinate",value:o}),e(C,{variant:"body2",color:"text.secondary",align:"right",children:[Math.round(o),"%"]})]}),t&&e(_,{variant:"outlined",sx:{p:1,bgcolor:"background.default",maxHeight:100,overflow:"auto"},children:e(U,{dense:!0,disablePadding:!0,children:a.map((p,i)=>e($,{disablePadding:!0,children:e(N,{primary:p,primaryTypographyProps:{variant:"caption",fontFamily:"monospace"}})},i))})})]}),e(J,{children:e(B,{size:"small",variant:"contained",startIcon:e(Q,{}),onClick:f,disabled:t,children:"Run"})})]})},v=async s=>{const t=new H,n=await s.sendRequest(t,{expectResponse:!0});if(n.opcode!==x.NOTIFY_CODES_COUNT)throw new Error(`Unexpected response opcode: 0x${n.opcode.toString(16)}`);if(n.payload.length<2)throw new Error("Invalid payload length for CODES_COUNT");return n.payload[0]<<8|n.payload[1]},X={id:"clean_master_codes",title:"Clean Master Codes",description:"Deletes all master codes (indexes 0-255). Retries index if deletion successful.",run:async({setProgress:s,log:t,checkStop:n},{bleService:o,configKey:c})=>{t("Fetching initial code count...");let a=await v(o);if(t(`Initial Master Code Count: ${a}`),a===0){t("No master codes found. Finished.");return}const l=256;for(let r=0;r<l;r++){n();const d=r/l*100;if(s(d),a===0){t("Count reached 0. Stopping early.");break}let u=!0;for(;u;){n(),u=!1;const f=a;t(`Deleting Index ${r} (Count: ${a})...`);const p=new q(c,r);try{const i=await o.sendRequest(p,{expectResponse:!0},c);i.opcode===x.CODE_OPERATION_ERROR||(i.opcode,x.CODE_OPERATION_SUCCESS)}catch(i){t(`Warning: Failed to delete index ${r}: ${i}`)}a=await v(o),a<f&&(t(`Count dropped to ${a}. Retrying index ${r}...`),u=!0,a===0&&(u=!1))}}}},ne=()=>{const{t:s}=A();return e(W,{maxWidth:"sm",sx:{mt:2,pb:10},children:[e(C,{variant:"h4",gutterBottom:!0,children:"Maintenance"}),e(C,{variant:"body2",color:"text.secondary",paragraph:!0,children:"Execute maintenance scripts on the connected Boks device."}),e(V,{script:X,onRun:()=>{}})]})};export{ne as MaintenancePage};
