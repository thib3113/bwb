import{g as oe,a as re,D as ae,u as ie,f as Y,c as H,b as e,V as Z,W as ue,d as se,s as A,P as Me,e as K,av as Ye,aw as ke,R as ee,ax as Pe,h as le,ay as Ke,O as Je,_ as Xe,az as Ze,k as Se,t as k,l as B,a3 as We,aA as qe,aB as et,aC as _e,aD as tt,aE as G,i as ce,T as p,o as b,at as $,n as R,C as q,aF as Ue,H as te,F as ne,I as Be,aG as nt,aH as Re,a8 as we,aI as ot,aa as Ve,aJ as rt,aK as at,an as it,ao as st,ap as lt,aL as ct,aM as dt,K as pt,aN as ut,aO as mt,aP as ht,j as yt,aQ as vt,q as gt,aR as ft,X as bt,Q,aS as xt}from"./index-DGfrVH4F.js";import{S as P}from"./Stack-D1famun3.js";import{C as St}from"./Chip-BOKCBj2i.js";import{L as wt}from"./LinearProgress-D0mCxCSf.js";import{C as Ct}from"./Container-DRoviwad.js";function It(t){return oe("MuiMobileStepper",t)}re("MuiMobileStepper",["root","positionBottom","positionTop","positionStatic","dots","dot","dotActive","progress"]);const Lt=t=>{const{classes:o,position:n}=t,i={root:["root",`position${ue(n)}`],dots:["dots"],dot:["dot"],dotActive:["dotActive"],progress:["progress"]};return se(i,It,o)},zt=A(Me,{name:"MuiMobileStepper",slot:"Root",overridesResolver:(t,o)=>{const{ownerState:n}=t;return[o.root,o[`position${ue(n.position)}`]]}})(K(({theme:t})=>({display:"flex",flexDirection:"row",justifyContent:"space-between",alignItems:"center",background:(t.vars||t).palette.background.default,padding:8,variants:[{props:({position:o})=>o==="top"||o==="bottom",style:{position:"fixed",left:0,right:0,zIndex:(t.vars||t).zIndex.mobileStepper}},{props:{position:"top"},style:{top:0}},{props:{position:"bottom"},style:{bottom:0}}]}))),Tt=A("div",{name:"MuiMobileStepper",slot:"Dots"})({variants:[{props:{variant:"dots"},style:{display:"flex",flexDirection:"row"}}]}),Dt=A("div",{name:"MuiMobileStepper",slot:"Dot",shouldForwardProp:t=>Ye(t)&&t!=="dotActive",overridesResolver:(t,o)=>{const{dotActive:n}=t;return[o.dot,n&&o.dotActive]}})(K(({theme:t})=>({variants:[{props:{variant:"dots"},style:{transition:t.transitions.create("background-color",{duration:t.transitions.duration.shortest}),backgroundColor:(t.vars||t).palette.action.disabled,borderRadius:"50%",width:8,height:8,margin:"0 2px"}},{props:{variant:"dots",dotActive:!0},style:{backgroundColor:(t.vars||t).palette.primary.main}}]}))),_t=A(wt,{name:"MuiMobileStepper",slot:"Progress"})({variants:[{props:{variant:"progress"},style:{width:"50%"}}]}),Rt=ae(function(o,n){const i=ie({props:o,name:"MuiMobileStepper"}),{activeStep:c=0,backButton:s,className:g,LinearProgressProps:a,nextButton:m,position:y="bottom",steps:f,variant:l="dots",slots:r={},slotProps:S={},...h}=i,x={...i,activeStep:c,position:y,variant:l};let d;l==="progress"&&(f===1?d=100:d=Math.ceil(c/(f-1)*100));const u=Lt(x),v={slots:r,slotProps:{progress:a,...S}},[w,_]=Y("root",{ref:n,elementType:zt,shouldForwardComponentProp:!0,className:H(u.root,g),externalForwardedProps:{...v,...h},ownerState:x,additionalProps:{square:!0,elevation:0}}),[C,z]=Y("dots",{className:u.dots,elementType:Tt,externalForwardedProps:v,ownerState:x}),[I,T]=Y("dot",{elementType:Dt,externalForwardedProps:v,ownerState:x}),[D,W]=Y("progress",{className:u.progress,elementType:_t,shouldForwardComponentProp:!0,externalForwardedProps:v,ownerState:x,additionalProps:{value:d,variant:"determinate"}});return e(w,{..._,children:[s,l==="text"&&e(Z,{children:[c+1," / ",f]}),l==="dots"&&e(C,{...z,children:[...new Array(f)].map((M,U)=>e(I,{...T,className:H(u.dot,T.className,U===c&&u.dotActive),dotActive:U===c},U))}),l==="progress"&&e(D,{...W}),m]})}),me=ke({}),Ce=ke({});function At(t){return oe("MuiStep",t)}re("MuiStep",["root","horizontal","vertical","alternativeLabel","completed"]);const Mt=t=>{const{classes:o,orientation:n,alternativeLabel:i,completed:c}=t;return se({root:["root",n,i&&"alternativeLabel",c&&"completed"]},At,o)},kt=A("div",{name:"MuiStep",slot:"Root",overridesResolver:(t,o)=>{const{ownerState:n}=t;return[o.root,o[n.orientation],n.alternativeLabel&&o.alternativeLabel,n.completed&&o.completed]}})({variants:[{props:{orientation:"horizontal"},style:{paddingLeft:8,paddingRight:8}},{props:{alternativeLabel:!0},style:{flex:1,position:"relative"}}]}),Pt=ae(function(o,n){const i=ie({props:o,name:"MuiStep"}),{active:c,children:s,className:g,component:a="div",completed:m,disabled:y,expanded:f=!1,index:l,last:r,...S}=i,{activeStep:h,connector:x,alternativeLabel:d,orientation:u,nonLinear:v}=ee(me);let[w=!1,_=!1,C=!1]=[c,m,y];h===l?w=c!==void 0?c:!0:!v&&h>l?_=m!==void 0?m:!0:!v&&h<l&&(C=y!==void 0?y:!0);const z=Pe(()=>({index:l,last:r,expanded:f,icon:l+1,active:w,completed:_,disabled:C}),[l,r,f,w,_,C]),I={...i,active:w,orientation:u,alternativeLabel:d,completed:_,disabled:C,expanded:f,component:a},T=Mt(I),D=e(kt,{as:a,className:H(T.root,g),ref:n,ownerState:I,...S,children:[x&&d&&l!==0?x:null,s]});return e(Ce.Provider,{value:z,children:x&&!d&&l!==0?e(Z,{children:[x,D]}):D})}),Wt=le(e("path",{d:"M12 0a12 12 0 1 0 0 24 12 12 0 0 0 0-24zm-2 17l-5-5 1.4-1.4 3.6 3.6 7.6-7.6L19 8l-9 9z"})),Ut=le(e("path",{d:"M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"}));function Bt(t){return oe("MuiStepIcon",t)}const be=re("MuiStepIcon",["root","active","completed","error","text"]);var Ae;const Vt=t=>{const{classes:o,active:n,completed:i,error:c}=t;return se({root:["root",n&&"active",i&&"completed",c&&"error"],text:["text"]},Bt,o)},xe=A(Ke,{name:"MuiStepIcon",slot:"Root"})(K(({theme:t})=>({display:"block",transition:t.transitions.create("color",{duration:t.transitions.duration.shortest}),color:(t.vars||t).palette.text.disabled,[`&.${be.completed}`]:{color:(t.vars||t).palette.primary.main},[`&.${be.active}`]:{color:(t.vars||t).palette.primary.main},[`&.${be.error}`]:{color:(t.vars||t).palette.error.main}}))),$t=A("text",{name:"MuiStepIcon",slot:"Text"})(K(({theme:t})=>({fill:(t.vars||t).palette.primary.contrastText,fontSize:t.typography.caption.fontSize,fontFamily:t.typography.fontFamily}))),Nt=ae(function(o,n){const i=ie({props:o,name:"MuiStepIcon"}),{active:c=!1,className:s,completed:g=!1,error:a=!1,icon:m,...y}=i,f={...i,active:c,completed:g,error:a},l=Vt(f);if(typeof m=="number"||typeof m=="string"){const r=H(s,l.root);return a?e(xe,{as:Ut,className:r,ref:n,ownerState:f,...y}):g?e(xe,{as:Wt,className:r,ref:n,ownerState:f,...y}):e(xe,{className:r,ref:n,ownerState:f,...y,children:[Ae||(Ae=e("circle",{cx:"12",cy:"12",r:"12"})),e($t,{className:l.text,x:"12",y:"12",textAnchor:"middle",dominantBaseline:"central",ownerState:f,children:m})]})}return m});function Et(t){return oe("MuiStepLabel",t)}const j=re("MuiStepLabel",["root","horizontal","vertical","label","active","completed","error","disabled","iconContainer","alternativeLabel","labelContainer"]),Ft=t=>{const{classes:o,orientation:n,active:i,completed:c,error:s,disabled:g,alternativeLabel:a}=t;return se({root:["root",n,s&&"error",g&&"disabled",a&&"alternativeLabel"],label:["label",i&&"active",c&&"completed",s&&"error",g&&"disabled",a&&"alternativeLabel"],iconContainer:["iconContainer",i&&"active",c&&"completed",s&&"error",g&&"disabled",a&&"alternativeLabel"],labelContainer:["labelContainer",a&&"alternativeLabel"]},Et,o)},jt=A("span",{name:"MuiStepLabel",slot:"Root",overridesResolver:(t,o)=>{const{ownerState:n}=t;return[o.root,o[n.orientation]]}})({display:"flex",alignItems:"center",[`&.${j.alternativeLabel}`]:{flexDirection:"column"},[`&.${j.disabled}`]:{cursor:"default"},variants:[{props:{orientation:"vertical"},style:{textAlign:"left",padding:"8px 0"}}]}),Ht=A("span",{name:"MuiStepLabel",slot:"Label"})(K(({theme:t})=>({...t.typography.body2,display:"block",transition:t.transitions.create("color",{duration:t.transitions.duration.shortest}),[`&.${j.active}`]:{color:(t.vars||t).palette.text.primary,fontWeight:500},[`&.${j.completed}`]:{color:(t.vars||t).palette.text.primary,fontWeight:500},[`&.${j.alternativeLabel}`]:{marginTop:16},[`&.${j.error}`]:{color:(t.vars||t).palette.error.main}}))),Ot=A("span",{name:"MuiStepLabel",slot:"IconContainer"})({flexShrink:0,display:"flex",paddingRight:8,[`&.${j.alternativeLabel}`]:{paddingRight:0}}),Gt=A("span",{name:"MuiStepLabel",slot:"LabelContainer"})(K(({theme:t})=>({width:"100%",color:(t.vars||t).palette.text.secondary,[`&.${j.alternativeLabel}`]:{textAlign:"center"}}))),$e=ae(function(o,n){const i=ie({props:o,name:"MuiStepLabel"}),{children:c,className:s,componentsProps:g={},error:a=!1,icon:m,optional:y,slots:f={},slotProps:l={},StepIconComponent:r,StepIconProps:S,...h}=i,{alternativeLabel:x,orientation:d}=ee(me),{active:u,disabled:v,completed:w,icon:_}=ee(Ce),C=m||_;let z=r;C&&!z&&(z=Nt);const I={...i,active:u,alternativeLabel:x,completed:w,disabled:v,error:a,orientation:d},T=Ft(I),D={slots:f,slotProps:{stepIcon:S,...g,...l}},[W,M]=Y("root",{elementType:jt,externalForwardedProps:{...D,...h},ownerState:I,ref:n,className:H(T.root,s)}),[U,J]=Y("label",{elementType:Ht,externalForwardedProps:D,ownerState:I}),[V,he]=Y("stepIcon",{elementType:z,externalForwardedProps:D,ownerState:I});return e(W,{...M,children:[C||V?e(Ot,{className:T.iconContainer,ownerState:I,children:e(V,{completed:w,active:u,error:a,icon:C,...he})}):null,e(Gt,{className:T.labelContainer,ownerState:I,children:[c?e(U,{...J,className:H(T.label,J?.className),children:c}):null,y]})]})});$e.muiName="StepLabel";function Qt(t){return oe("MuiStepConnector",t)}re("MuiStepConnector",["root","horizontal","vertical","alternativeLabel","active","completed","disabled","line","lineHorizontal","lineVertical"]);const Yt=t=>{const{classes:o,orientation:n,alternativeLabel:i,active:c,completed:s,disabled:g}=t,a={root:["root",n,i&&"alternativeLabel",c&&"active",s&&"completed",g&&"disabled"],line:["line",`line${ue(n)}`]};return se(a,Qt,o)},Kt=A("div",{name:"MuiStepConnector",slot:"Root",overridesResolver:(t,o)=>{const{ownerState:n}=t;return[o.root,o[n.orientation],n.alternativeLabel&&o.alternativeLabel,n.completed&&o.completed]}})({flex:"1 1 auto",variants:[{props:{orientation:"vertical"},style:{marginLeft:12}},{props:{alternativeLabel:!0},style:{position:"absolute",top:12,left:"calc(-50% + 20px)",right:"calc(50% + 20px)"}}]}),Jt=A("span",{name:"MuiStepConnector",slot:"Line",overridesResolver:(t,o)=>{const{ownerState:n}=t;return[o.line,o[`line${ue(n.orientation)}`]]}})(K(({theme:t})=>{const o=t.palette.mode==="light"?t.palette.grey[400]:t.palette.grey[600];return{display:"block",borderColor:t.vars?t.vars.palette.StepConnector.border:o,variants:[{props:{orientation:"horizontal"},style:{borderTopStyle:"solid",borderTopWidth:1}},{props:{orientation:"vertical"},style:{borderLeftStyle:"solid",borderLeftWidth:1,minHeight:24}}]}})),Xt=ae(function(o,n){const i=ie({props:o,name:"MuiStepConnector"}),{className:c,...s}=i,{alternativeLabel:g,orientation:a="horizontal"}=ee(me),{active:m,disabled:y,completed:f}=ee(Ce),l={...i,alternativeLabel:g,orientation:a,active:m,completed:f,disabled:y},r=Yt(l);return e(Kt,{className:H(r.root,c),ref:n,ownerState:l,...s,children:e(Jt,{className:r.line,ownerState:l})})});function Zt(t){return oe("MuiStepper",t)}re("MuiStepper",["root","horizontal","vertical","nonLinear","alternativeLabel"]);const qt=t=>{const{orientation:o,nonLinear:n,alternativeLabel:i,classes:c}=t;return se({root:["root",o,n&&"nonLinear",i&&"alternativeLabel"]},Zt,c)},en=A("div",{name:"MuiStepper",slot:"Root",overridesResolver:(t,o)=>{const{ownerState:n}=t;return[o.root,o[n.orientation],n.alternativeLabel&&o.alternativeLabel,n.nonLinear&&o.nonLinear]}})({display:"flex",variants:[{props:{orientation:"horizontal"},style:{flexDirection:"row",alignItems:"center"}},{props:{orientation:"vertical"},style:{flexDirection:"column"}},{props:{alternativeLabel:!0},style:{alignItems:"flex-start"}}]}),tn=e(Xt,{}),nn=ae(function(o,n){const i=ie({props:o,name:"MuiStepper"}),{activeStep:c=0,alternativeLabel:s=!1,children:g,className:a,component:m="div",connector:y=tn,nonLinear:f=!1,orientation:l="horizontal",...r}=i,S={...i,nonLinear:f,alternativeLabel:s,orientation:l,component:m},h=qt(S),x=Je.toArray(g).filter(Boolean),d=x.map((v,w)=>Xe(v,{index:w,last:w+1===x.length,...v.props})),u=Pe(()=>({activeStep:c,alternativeLabel:s,connector:y,nonLinear:f,orientation:l}),[c,s,y,f,l]);return e(me.Provider,{value:u,children:e(en,{as:m,ownerState:S,className:H(h.root,a),ref:n,...r,children:d})})}),on=le(e("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m-2 15-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8z"})),rn=le(e("path",{d:"m12 8-6 6 1.41 1.41L12 10.83l4.59 4.58L18 14z"})),an=le(e("path",{d:"M21 6h-2v9H6v2c0 .55.45 1 1 1h11l4 4V7c0-.55-.45-1-1-1m-4 6V3c0-.55-.45-1-1-1H3c-.55 0-1 .45-1 1v14l4-4h10c.55 0 1-.45 1-1"})),sn=le(e("path",{d:"M19.8 18.4 14 10.67V6.5l1.35-1.69c.26-.33.03-.81-.39-.81H9.04c-.42 0-.65.48-.39.81L10 6.5v4.17L4.2 18.4c-.49.66-.02 1.6.8 1.6h14c.82 0 1.29-.94.8-1.6"})),ln=()=>{const t=ee(Ze);if(t===void 0)throw new Error("useSession must be used within a SessionProvider");return t},cn=t=>{const{readCharacteristic:o}=Se(),[n,i]=k(B(!1),"isReading"),[c,s]=k(B(t?.batteryData||null),"batteryData"),[g,a]=k(B(t?.analysis||null),"analysis"),m=We(async(y,f)=>{if(!y||!y.gatt||!y.gatt.connected)throw new Error("Device not connected");console.log("[BatteryDiag] Starting diagnostics using context read..."),i(!0);const l={standardLevel:null,standardError:null,rawHex:null,serviceUuid:null,parsed:null,error:null};try{try{console.log("[BatteryDiag] Reading Standard Battery Service...");const r=await o(qe,et);l.standardLevel=r.getUint8(0),console.log("[BatteryDiag] Standard Level:",l.standardLevel)}catch(r){const S=r instanceof Error?r.message:String(r);console.warn("[BatteryDiag] Standard Battery Read Failed:",S),l.standardError=S}try{console.log("[BatteryDiag] Reading Proprietary Battery Characteristic...");const r=await o(_e,tt),S=new Uint8Array(r.buffer);l.rawHex=Array.from(S).map(u=>u.toString(16).padStart(2,"0").toUpperCase()).join(" "),l.serviceUuid=_e,console.log("[BatteryDiag] Proprietary Data (HEX):",l.rawHex);const h=r.byteLength;let x="Unknown";h===1?x="Single Measure":h===4?x="T1/T5/T10":h===6&&(x="Min/Mean/Max");const d={format:x};if(h===1)d.level=r.getUint8(0);else if(h===4)d.level=r.getUint8(0),d.t1=r.getUint8(1),d.t5=r.getUint8(2),d.temp_C=r.getUint8(3)-25;else if(h===6){const u=new Uint8Array(r.buffer),v=w=>w===G;v(u[0])&&v(u[1])&&v(u[2])&&v(u[3])&&v(u[4])?l.error="Données invalides (255)":(d.first_mV=u[0]===G?null:u[0]*100,d.min_mV=u[1]===G?null:u[1]*100,d.mean_mV=u[2]===G?null:u[2]*100,d.max_mV=u[3]===G?null:u[3]*100,d.last_mV=u[4]===G?null:u[4]*100,d.temp_C=u[5]===G?null:u[5]-25)}else d.rawLength=h;l.parsed=d}catch(r){const S=r instanceof Error?r.message:String(r);console.error("[BatteryDiag] Proprietary Read Error:",S),l.error=S}if(s(l),l.parsed)try{const r=dn(l,f);a(r)}catch(r){console.error("Error analyzing battery data:",r);const S=r instanceof Error?r.message:String(r);l.error=(l.error||"")+` | Analysis failed: ${S}`}}catch(r){console.error("[BatteryDiag] Global Error:",r)}finally{i(!1)}},[o]);return{isReading:n,batteryData:c,analysis:g,readBatteryDiagnostics:m}};function dn(t,o){const n={userClaimType:null,userClaimText:"Inconnue",detectedType:"Unknown",detectedText:"Incertain",finalType:"aaa",consistencyStatus:"neutral",consistencyText:""};if(!t.parsed)return n.consistencyStatus="error",n.consistencyText="Données propriétaires non disponibles",n;const i=t.parsed.last_mV;return o&&(o.answer==="Oui"&&o.inference?(n.userClaimType=o.inference.battery,n.userClaimText=o.inference.label+" (Confirmé)"):o.answer==="Non"?(n.userClaimText="Infirmé par l'utilisateur",n.userClaimType="rejected"):o.answer==="Inconnu"&&(n.userClaimText="Inconnu (Utilisateur)",n.userClaimType="unknown")),i&&(i>5e3?(n.detectedType="aaa",n.detectedText="8x AAA ( > 5V )"):i<4500?(n.detectedType="lsh14",n.detectedText="LSH14 ( < 4.5V )"):n.detectedText=`Ambigu (${(i/1e3).toFixed(2)}V)`),n.userClaimType==="aaa"||n.userClaimType==="lsh14"?n.detectedType!=="Unknown"?n.userClaimType===n.detectedType?(n.finalType=n.detectedType||"aaa",n.consistencyStatus="success",n.consistencyText="✅ Cohérent : Le voltage confirme le matériel."):(n.finalType=n.detectedType||"aaa",n.consistencyStatus="error",n.consistencyText="❌ Incohérence : Le voltage contredit le matériel déclaré !"):(n.finalType=n.userClaimType,n.consistencyStatus="warning",n.consistencyText="⚠️ Voltage ambigu, utilisation du type déclaré."):n.detectedType!=="Unknown"?(n.finalType=n.detectedType||"aaa",n.consistencyStatus="success",n.consistencyText="ℹ️ Type déduit automatiquement du voltage."):(n.finalType="aaa",n.consistencyStatus="warning",n.consistencyText="⚠️ Impossible de déterminer le type (Voltage ambigu). Par défaut : AAA."),n}const pn=({isConnected:t,isConnecting:o,connect:n,error:i,device:c,firmwareVersion:s,isLoadingInfo:g,onRetryFetch:a})=>{const{t:m}=ce(["wizard","common"]);return e(b,{sx:{mt:2},children:[e(p,{variant:"h6",gutterBottom:!0,children:m("connect.title")}),e(p,{variant:"body2",color:"text.secondary",sx:{mb:2},children:m("connect.desc")}),t?e(te,{variant:"outlined",sx:{mt:2,borderColor:"success.main"},children:e(ne,{children:[e(P,{direction:"row",alignItems:"center",spacing:2,sx:{mb:2},children:[e(on,{color:"success",fontSize:"large"}),e(b,{children:[e(p,{variant:"h6",color:"success.main",children:m("connect.success")}),e(p,{variant:"body2",color:"text.secondary",children:m("connect.ready")})]})]}),e(Be,{sx:{my:2}}),e(p,{variant:"subtitle2",gutterBottom:!0,children:"Informations de l'appareil :"}),e(P,{spacing:1,children:[e(b,{display:"flex",justifyContent:"space-between",children:[e(p,{variant:"body2",color:"text.secondary",children:"Nom :"}),e(p,{variant:"body2",fontWeight:"medium",children:c?.name||"Inconnu"})]}),e(b,{display:"flex",justifyContent:"space-between",children:[e(p,{variant:"body2",color:"text.secondary",children:"ID :"}),e(p,{variant:"body2",fontWeight:"medium",children:c?.id||"Inconnu"})]}),e(b,{display:"flex",justifyContent:"space-between",alignItems:"center",children:[e(p,{variant:"body2",color:"text.secondary",children:"Firmware :"}),e(b,{display:"flex",alignItems:"center",gap:1,children:[e(p,{variant:"body2",fontWeight:"medium",children:g?e(q,{size:12}):s||"Inconnu"}),!g&&e(R,{size:"small",onClick:a,sx:{minWidth:0,p:.5},children:e(nt,{sx:{fontSize:16}})})]})]})]})]})}):e(b,{sx:{display:"flex",flexDirection:"column",alignItems:"center",gap:2,py:4},children:[i&&e($,{severity:"error",sx:{width:"100%",mb:2},children:i.startsWith("errors.")?m(`common:${i}`):i}),e(R,{variant:"contained",size:"large",startIcon:o?e(q,{size:20,color:"inherit"}):e(Ue,{}),onClick:()=>n(),disabled:o,children:m(o?"common:connecting":"connect.button")})]})]})},un=({pinCode:t,updateDebugWizardState:o,onOpenDoor:n,isOpening:i,isConnected:c,openDoorSuccess:s,openDoorError:g,batteryData:a,waitingForClose:m,isReadingBattery:y,isPreparing:f,analysis:l})=>{const{t:r}=ce();return e(b,{sx:{mt:2},children:[e(p,{variant:"h6",gutterBottom:!0,children:r("wizard:door.title")}),e(p,{variant:"body2",color:"text.secondary",sx:{mb:2},children:r("wizard:door.desc")}),e(P,{spacing:3,children:[e(te,{variant:"outlined",children:e(ne,{children:[e(P,{direction:"row",alignItems:"center",spacing:1,sx:{mb:2},children:[e(Re,{color:"primary"}),e(p,{variant:"h6",children:r("wizard:door.open")})]}),e(b,{sx:{display:"flex",flexDirection:"column",gap:2},children:[e(we,{label:r("codes:pin_label"),variant:"outlined",size:"small",value:t||"",onChange:S=>{const h=S.currentTarget.value.toUpperCase();/^[0-9AB]*$/.test(h)&&h.length<=6&&o({pinCode:h})},placeholder:r("wizard:door.pin_placeholder"),type:"text",fullWidth:!0,inputProps:{maxLength:6}}),e(R,{variant:"contained",onClick:n,disabled:i||!c,startIcon:i?e(q,{size:20,color:"inherit"}):e(Re,{}),children:r(i?"wizard:door.opening":"wizard:door.open")}),s&&!g&&e($,{severity:"success",children:r("wizard:door.success")}),g&&e($,{severity:"error",children:g})]})]})}),e(te,{variant:"outlined",children:e(ne,{children:[e(P,{direction:"row",alignItems:"center",spacing:1,sx:{mb:2},children:[e(ot,{color:"primary"}),e(p,{variant:"h6",children:r("battery_level")})]}),e(b,{sx:{display:"flex",flexDirection:"column",gap:2},children:[!a&&!m&&!y&&!f&&e($,{severity:"info",children:r("wizard:battery.wait")}),m&&e($,{severity:"info",icon:e(q,{size:20}),children:r("wizard:battery.waiting_close")}),(y||f)&&e($,{severity:"info",icon:e(q,{size:20}),children:r("wizard:battery.analyzing")}),a&&e(b,{sx:{mt:2,p:2,bgcolor:"background.paper",borderRadius:1,border:1,borderColor:"divider"},children:[e(b,{display:"flex",justifyContent:"space-between",mb:1,children:[e(p,{variant:"body2",color:"text.primary",children:[r("wizard:battery.standard_level"),":"]}),e(p,{variant:"body2",fontWeight:"bold",color:"text.primary",children:a.standardLevel!==null?`${a.standardLevel}%`:"N/A"})]}),a.parsed&&e(Z,{children:[e(Be,{sx:{my:1}}),e(p,{variant:"subtitle2",gutterBottom:!0,color:"text.primary",children:[r("wizard:battery.proprietary_data")," (",a.parsed.format,")"]}),a.parsed.level!==void 0&&e(b,{display:"flex",justifyContent:"space-between",children:[e(p,{variant:"body2",color:"text.primary",children:[r("battery_level")," (Proprietary):"]}),e(p,{variant:"body2",fontWeight:"bold",color:"text.primary",children:[a.parsed.level,"%"]})]}),a.parsed.first_mV!==void 0&&e(b,{display:"flex",justifyContent:"space-between",children:[e(p,{variant:"body2",color:"text.primary",children:"Voltage (First):"}),e(p,{variant:"body2",fontWeight:"bold",color:"text.primary",children:a.parsed.first_mV!==null?`${(a.parsed.first_mV/1e3).toFixed(2)} V`:"N/A"})]}),a.parsed.min_mV!==void 0&&e(b,{display:"flex",justifyContent:"space-between",children:[e(p,{variant:"body2",color:"text.primary",children:"Voltage (Min):"}),e(p,{variant:"body2",fontWeight:"bold",color:"text.primary",children:a.parsed.min_mV!==null?`${(a.parsed.min_mV/1e3).toFixed(2)} V`:"N/A"})]}),a.parsed.mean_mV!==void 0&&e(b,{display:"flex",justifyContent:"space-between",children:[e(p,{variant:"body2",color:"text.primary",children:"Voltage (Mean):"}),e(p,{variant:"body2",fontWeight:"bold",color:"text.primary",children:a.parsed.mean_mV!==null?`${(a.parsed.mean_mV/1e3).toFixed(2)} V`:"N/A"})]}),a.parsed.max_mV!==void 0&&e(b,{display:"flex",justifyContent:"space-between",children:[e(p,{variant:"body2",color:"text.primary",children:"Voltage (Max):"}),e(p,{variant:"body2",fontWeight:"bold",color:"text.primary",children:a.parsed.max_mV!==null?`${(a.parsed.max_mV/1e3).toFixed(2)} V`:"N/A"})]}),a.parsed.last_mV!==void 0&&e(b,{display:"flex",justifyContent:"space-between",children:[e(p,{variant:"body2",color:"text.primary",children:[r("wizard:battery.voltage_last"),":"]}),e(p,{variant:"body2",fontWeight:"bold",color:"text.primary",children:a.parsed.last_mV!==null?`${(a.parsed.last_mV/1e3).toFixed(2)} V`:"N/A"})]}),a.parsed.t1!==void 0&&e(b,{display:"flex",justifyContent:"space-between",children:[e(p,{variant:"body2",color:"text.primary",children:"T1:"}),e(p,{variant:"body2",fontWeight:"bold",color:"text.primary",children:a.parsed.t1})]}),a.parsed.t5!==void 0&&e(b,{display:"flex",justifyContent:"space-between",children:[e(p,{variant:"body2",color:"text.primary",children:"T5:"}),e(p,{variant:"body2",fontWeight:"bold",color:"text.primary",children:a.parsed.t5})]}),a.parsed.temp_C!==void 0&&e(b,{display:"flex",justifyContent:"space-between",children:[e(p,{variant:"body2",color:"text.primary",children:[r("wizard:battery.temperature"),":"]}),e(p,{variant:"body2",fontWeight:"bold",color:"text.primary",children:a.parsed.temp_C!==null?`${a.parsed.temp_C}°C`:"N/A"})]}),l&&e(b,{sx:{mt:2,p:1,border:"1px solid",borderColor:"divider",borderRadius:1,bgcolor:"background.paper"},children:[e(p,{variant:"caption",display:"block",color:"text.secondary",children:[r("wizard:battery.analysis"),":"]}),e(p,{variant:"body2",gutterBottom:!0,color:"text.primary",children:[r("wizard:battery.detected_type"),":"," ",e("strong",{children:l.detectedText})]}),e(p,{variant:"body2",color:l.consistencyStatus==="success"?"success.main":l.consistencyStatus==="error"?"error.main":"warning.main",fontWeight:"medium",children:l.consistencyText})]})]}),a.error&&e($,{severity:"warning",sx:{mt:1},children:a.error})]})]})]})})]})]})},mn=({questionAnswers:t,onAnswerQuestion:o})=>{const{t:n}=ce(["wizard","common"]),i=[{id:"has_scale",text:n("questions.has_scale"),expected:"Non"},{id:"anything_special",text:n("questions.anything_special"),expected:"Non"}];return e(b,{sx:{mt:2},children:[e(p,{variant:"h6",gutterBottom:!0,children:n("questions.title")}),e(p,{variant:"body2",color:"text.secondary",sx:{mb:2},children:n("questions.desc")}),e(P,{spacing:2,children:i.map(c=>{const s=t.find(g=>g.id===c.id);return e(te,{variant:"outlined",children:e(ne,{children:[e(P,{direction:"row",spacing:1,alignItems:"flex-start",mb:2,children:[e(an,{color:"action"}),e(p,{variant:"subtitle1",fontWeight:"medium",children:c.text})]}),e(P,{direction:"row",spacing:1,children:[e(R,{variant:s?.answer==="Oui"?"contained":"outlined",onClick:()=>o(c.id,"Oui",c.expected),color:s?.answer==="Oui"?"primary":"inherit",children:n("common:yes")}),e(R,{variant:s?.answer==="Non"?"contained":"outlined",onClick:()=>o(c.id,"Non",c.expected),color:s?.answer==="Non"?"primary":"inherit",children:n("common:no")}),e(R,{variant:s?.answer==="Inconnu"?"contained":"outlined",onClick:()=>o(c.id,"Inconnu",c.expected),color:s?.answer==="Inconnu"?"secondary":"inherit",children:n("common:unknown")})]})]})},c.id)})})]})},hn=({customUuids:t,customResults:o,updateDebugWizardState:n})=>{const{t:i}=ce(["wizard","common","codes"]),{connect:c,disconnect:s,device:g}=Se(),[a,m]=k(B(!1),"showAdvanced"),[y,f]=k(B(""),"customUuidInput"),[l,r]=k(B(!1),"isDiscoveringCustom"),S=()=>{if(!y)return;const d=y.trim().toLowerCase();t.includes(d)||(n({customUuids:[...t,d]}),f(""))},h=d=>{n({customUuids:t.filter(u=>u!==d)})},x=async()=>{if(t.length!==0){r(!0);try{console.log("DebugWizard: Disconnecting for custom discovery..."),s(),await new Promise(v=>setTimeout(v,ct)),console.log("DebugWizard: Reconnecting with custom services:",t),await c(t),await new Promise(v=>setTimeout(v,dt));const d=[],u=g;u?.gatt?.connected||console.warn("Device not marked as connected yet, checking GATT directly...");for(const v of t)try{console.log(`DebugWizard: Accessing service ${v}`);const w=u?.gatt;if(!w)continue;const C=await(await w.getPrimaryService(v)).getCharacteristics();for(const z of C)try{console.log(`DebugWizard: Reading characteristic ${z.uuid}`);const I=await z.readValue(),T=new Uint8Array(I.buffer),D=Array.from(T).map(W=>W.toString(16).padStart(2,"0").toUpperCase()).join(" ");d.push({serviceUuid:v,charUuid:z.uuid,value:D,timestamp:new Date().toISOString()})}catch(I){console.warn(`Failed to read char ${z.uuid} in service ${v}`,I)}}catch(w){console.warn(`Failed to access service ${v}`,w)}n({customResults:d})}catch(d){console.error("Custom discovery failed:",d)}finally{r(!1)}}};return e(b,{sx:{mt:2},children:[e(p,{variant:"h6",gutterBottom:!0,children:i("advanced.title")}),e($,{severity:"info",sx:{mb:3},children:i("advanced.warning")}),e(P,{spacing:3,children:[e(te,{variant:"outlined",children:e(ne,{children:[e(b,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",cursor:"pointer"},onClick:()=>m(!a),children:[e(P,{direction:"row",alignItems:"center",spacing:1,children:[e(sn,{color:"primary"}),e(p,{variant:"h6",children:i("advanced.tutorial_title")})]}),e(Ve,{children:a?e(rn,{}):e(rt,{})})]}),e(at,{in:a,children:e(b,{sx:{mt:3},children:[e(p,{variant:"body2",sx:{mb:2},children:i("advanced.tutorial_desc")}),e(P,{direction:"row",spacing:2,sx:{mt:2,justifyContent:"center"},children:[e(R,{variant:"outlined",href:"https://play.google.com/store/apps/details?id=no.nordicsemi.android.mcp",target:"_blank",rel:"noopener noreferrer",children:"Android (Play Store)"}),e(R,{variant:"outlined",href:"https://apps.apple.com/us/app/nrf-connect-for-mobile/id1054362403",target:"_blank",rel:"noopener noreferrer",children:"iOS (App Store)"})]})]})})]})}),e(te,{variant:"outlined",children:e(ne,{children:[e(p,{variant:"subtitle1",gutterBottom:!0,fontWeight:"bold",children:i("advanced.explorer_title")}),e(p,{variant:"body2",color:"text.secondary",sx:{mb:2},children:i("advanced.explorer_desc")}),e(b,{sx:{display:"flex",gap:1,mb:2},children:[e(we,{size:"small",fullWidth:!0,placeholder:"ex: 0000180f-0000-1000-8000-00805f9b34fb",value:y,onChange:d=>f(d.currentTarget.value),onKeyPress:d=>d.key==="Enter"&&S()}),e(R,{variant:"outlined",onClick:S,children:i("codes:add_new")})]}),e(b,{sx:{display:"flex",flexWrap:"wrap",gap:1,mb:3},children:t.map(d=>e(St,{label:d,onDelete:()=>h(d),size:"small",color:"primary",variant:"outlined"},d))}),e(R,{variant:"contained",fullWidth:!0,disabled:t.length===0||l,onClick:x,startIcon:l?e(q,{size:20,color:"inherit"}):e(Ue,{}),children:i(l?"advanced.exploring":"advanced.explore_button")}),o.length>0&&e(b,{sx:{mt:3},children:[e(p,{variant:"subtitle2",gutterBottom:!0,children:["Résultats trouvés : ",o.length]}),e(it,{dense:!0,children:o.map((d,u)=>e(st,{divider:!0,children:e(lt,{primary:`Char: ${d.charUuid.substring(0,8)}...`,secondary:`Service: ${d.serviceUuid.substring(0,8)}... | Val: ${d.value}`,secondaryTypographyProps:{sx:{fontFamily:"monospace",fontSize:"0.75rem"}}})},u))})]})]})})]})]})},yn=({device:t,firmwareVersion:o,hardwareInference:n,deviceInfo:i,batteryData:c,analysis:s,pinCode:g,openDoorSuccess:a,openDoorError:m,questionAnswers:y,customUuids:f,customResults:l,serviceUuid:r,serviceResults:S})=>{const{t:h}=ce(["wizard","common","codes"]),[x,d]=k(B(!1),"copySuccess"),u={device:{name:t?.name,id:t?.id,firmwareVersion:o,hardwareInference:n,deviceInfo:i},status:{battery:c,analysis:s,doorTest:{attempted:!!g,success:a,error:m}},questionAnswers:y,customDiscovery:{uuids:f,results:l},advanced:{serviceUuid:r,results:S},timestamp:new Date().toISOString()},v=JSON.stringify(u,null,2),w=()=>{navigator.clipboard.writeText(v),d(!0)},_=!n||n.version==="Unknown",C=l.length>0,z=s?.consistencyStatus==="error"||s?.consistencyStatus==="warning",I=y.find(M=>M.id==="has_scale"&&M.answer==="Oui"),T=y.find(M=>M.id==="anything_special"&&M.answer==="Oui"),D=_||C||z||I||T,W=()=>{const M=`Debug Data: ${t?.name||"Unknown Boks"} - ${o||"Unknown FW"}`,U="```",J=`Please find below the debug data captured via the Boks Web BLE tool.

${U}json
${v}
${U}`,V=new URLSearchParams;return V.set("title",M),V.set("body",J),`${ht}?${V.toString()}`};return e(b,{sx:{mt:2},children:[e(p,{variant:"h6",gutterBottom:!0,children:h("recap.title")}),e(p,{variant:"body2",color:"text.secondary",sx:{mb:2},children:h("recap.desc")}),D&&e($,{severity:"info",icon:e(pt,{}),sx:{mb:3},action:e(R,{color:"inherit",size:"small",href:W(),target:"_blank",onClick:()=>{},children:[" ",h("recap.open_issue")]}),children:h("recap.interesting_found")}),e(b,{sx:{position:"relative"},children:[e(we,{multiline:!0,fullWidth:!0,minRows:10,maxRows:20,value:v,variant:"outlined",InputProps:{readOnly:!0,style:{fontFamily:"monospace",fontSize:"0.875rem"}}}),e(Ve,{onClick:w,sx:{position:"absolute",top:8,right:8,bgcolor:"background.paper"},title:h("codes:copy_to_clipboard"),children:e(ut,{})})]}),e(mt,{open:x,autoHideDuration:3e3,onClose:()=>d(!1),message:"Données de débogage copiées dans le presse-papier"})]})},Sn=()=>{const{t}=ce(),o=[t("wizard:steps.step1"),t("wizard:steps.step2"),t("wizard:steps.step3"),t("wizard:steps.step4"),t("wizard:steps.step5")],n=yt(),i=vt(n.breakpoints.down("sm")),{debugWizardState:c,updateDebugWizardState:s,resetDebugWizardState:g}=ln(),{activeDevice:a}=gt(),{device:m,isConnected:y,connect:f,disconnect:l,getAllDeviceInfo:r,error:S}=Se(),{activeStep:h,firmwareVersion:x,hardwareInference:d,deviceInfo:u,pinCode:v,openDoorSuccess:w,openDoorError:_,questionAnswers:C=[],serviceUuid:z,serviceResults:I=[],batteryData:T,batteryAnalysis:D,customUuids:W=[],customResults:M=[]}=c,{openDoor:U,isOpening:J,doorStatus:V}=ft(),{isReading:he,batteryData:ye,analysis:Ie,readBatteryDiagnostics:Le}=cn({batteryData:c.batteryData,analysis:c.batteryAnalysis}),[pe,ze]=k(B(!1),"isLoadingInfo"),de=k(bt(!1),"isFetchingRef"),[ve,ge]=k(B(!1),"waitingForClose"),[fe,Te]=k(B(!1),"isPreparing");Q(()=>(console.log("DebugWizard: Component Mounted"),()=>console.log("DebugWizard: Component Unmounted")),[]),Q(()=>{console.log(`DebugWizard: isConnected=${y}, activeDevice=${a?.id||"none"}`)},[y,a?.id]),Q(()=>{a?.door_pin_code&&!v&&s({pinCode:a.door_pin_code})},[a,v,s]),Q(()=>{console.log("DebugWizard: Check conditions - isConnected:",y,"firmwareVersion:",x,"isLoadingInfo:",pe,"isFetchingRef:",de.current);const L=!0;y&&!x&&!pe&&!de.current&&(async()=>{if(de.current){console.log("DebugWizard: already fetching, skipping");return}console.log("DebugWizard: condition met, starting fetchInfo"),de.current=!0,ze(!0);try{console.log("DebugWizard: Starting device info fetch sequence...");const N=await r(),E=N["Firmware Revision"];console.log("DebugWizard: Raw firmware revision:",E);const F=xt(E);console.log("DebugWizard: Hardware Inference result:",F);let O=E||"Inconnu";F.version!=="Unknown"&&(O+=` (v${F.version} - ${F.label})`),console.log("DebugWizard: Final display version string:",O),s({firmwareVersion:O,hardwareInference:F,deviceInfo:N}),console.log("DebugWizard: Called updateDebugWizardState with:",O)}catch(N){console.error("DebugWizard: Error in fetchInfo:",N)}finally{setTimeout(()=>{ze(!1),de.current=!1,console.log("DebugWizard: Fetch sequence finished and lock cleared.")},500)}})()},[y,x,pe,s,r]);const Ne=()=>{s({firmwareVersion:null})},Ee=()=>{s({activeStep:h+1})},Fe=()=>{s({activeStep:h-1})},je=()=>{g(),l()},He=async()=>{if(s({openDoorError:null,openDoorSuccess:!1}),!v||v.length<4){s({openDoorError:"Veuillez entrer un code PIN valide (au moins 4 chiffres)"});return}try{await U(v),ge(!0),s({openDoorSuccess:!0})}catch(L){ge(!1);const X=L instanceof Error?L.message:String(L);s({openDoorError:X||"Échec de l'ouverture de la porte"})}},De=We(async()=>{if(!m){console.warn("DebugWizard: No device for battery check");return}console.log("DebugWizard: Executing battery diagnostics...");const L=C.find(N=>N.id==="hardware_check"),X=L?{answer:L.answer,inference:d}:void 0;await Le(m,X)},[m,C,d,Le]);Q(()=>{ve&&V==="closed"&&(console.log("DebugWizard: Door closed, initiating battery check sequence"),ge(!1),Te(!0))},[V,ve]),Q(()=>{if(fe){const L=setTimeout(()=>{console.log("DebugWizard: Preparation delay finished, checking battery..."),Te(!1),De()},2e3);return()=>clearTimeout(L)}},[fe,De]),Q(()=>{ye&&s({batteryData:ye,batteryAnalysis:Ie})},[ye,Ie,s]);const Oe=(L,X,N)=>{const E=[...C||[]],F=E.findIndex(Qe=>Qe.id===L),O={id:L,answer:X,expected:N,timestamp:new Date().toISOString()};F>=0?E[F]=O:E.push(O),s({questionAnswers:E})},Ge=L=>{switch(L){case 0:return e(pn,{isConnected:y,isConnecting:!1,connect:f,error:S,device:m,firmwareVersion:x,isLoadingInfo:pe,onRetryFetch:Ne});case 1:return e(un,{pinCode:v,updateDebugWizardState:s,onOpenDoor:He,isOpening:J,isConnected:y,openDoorSuccess:w,openDoorError:_,batteryData:T,waitingForClose:ve,isReadingBattery:he,isPreparing:fe,analysis:D});case 2:return e(mn,{questionAnswers:C,onAnswerQuestion:Oe});case 3:return e(hn,{customUuids:W,customResults:M,updateDebugWizardState:s});case 4:return e(yn,{device:m,firmwareVersion:x,hardwareInference:d,deviceInfo:u,batteryData:T,analysis:D,pinCode:v,openDoorSuccess:w,openDoorError:_,questionAnswers:C,customUuids:W,customResults:M,serviceUuid:z,serviceResults:I});default:return"Unknown step"}};return e(Ct,{maxWidth:"md",sx:{mt:4,mb:4,px:i?1:3},children:e(Me,{sx:{p:i?2:4},children:[e(p,{variant:i?"h5":"h4",component:"h1",gutterBottom:!0,align:"center",children:t("wizard:title")}),i?e(b,{sx:{mb:2},children:[e(Rt,{variant:"text",steps:o.length,position:"static",activeStep:h,nextButton:null,backButton:null,sx:{bgcolor:"transparent",justifyContent:"center","& .MuiMobileStepper-dot":{mx:.5}}}),e(p,{variant:"subtitle2",align:"center",color:"primary",sx:{mt:1},children:h<o.length?o[h]:t("common:finish")})]}):e(nn,{activeStep:h,sx:{pt:3,pb:5},alternativeLabel:!0,children:o.map(L=>e(Pt,{children:e($e,{children:L})},L))}),e(Z,{children:h===o.length?e(Z,{children:[e(p,{variant:"h5",gutterBottom:!0,children:t("wizard:finished.title")}),e(p,{variant:"subtitle1",children:t("wizard:finished.desc")}),e(b,{sx:{display:"flex",justifyContent:"flex-end",mt:3},children:e(R,{onClick:je,children:t("common:reset")})})]}):e(Z,{children:[Ge(h),e(b,{sx:{display:"flex",justifyContent:"flex-end",mt:3},children:[h!==0&&e(R,{onClick:Fe,sx:{mr:1},children:t("common:back")}),e(R,{variant:"contained",onClick:Ee,disabled:h===0&&!y,children:h===o.length-1?t("common:finish"):t("common:next")})]})]})})]})})};export{Sn as DebugWizardPage};
