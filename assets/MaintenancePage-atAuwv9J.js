import{g as b,a as O,r as p,u as k,j as t,c as A,b as I,s as T,e as w,f as R,T as f,n as D,z as M,A as U,a1 as L,k as B,P as N,a3 as z,a4 as K,a5 as $,l as v,aC as q,X as j,aD as Y,aE as F}from"./index-BYx3cClg.js";import{C as H}from"./Container-Bab6zPxc.js";import{L as W}from"./LinearProgress-CCmPfai2.js";function X(s){return b("MuiCardActions",s)}O("MuiCardActions",["root","spacing"]);const G=s=>{const{classes:e,disableSpacing:n}=s;return I({root:["root",!n&&"spacing"]},X,e)},J=T("div",{name:"MuiCardActions",slot:"Root",overridesResolver:(s,e)=>{const{ownerState:n}=s;return[e.root,!n.disableSpacing&&e.spacing]}})({display:"flex",alignItems:"center",padding:8,variants:[{props:{disableSpacing:!1},style:{"& > :not(style) ~ :not(style)":{marginLeft:8}}}]}),Q=p.forwardRef(function(e,n){const a=k({props:e,name:"MuiCardActions"}),{disableSpacing:u=!1,className:i,...o}=a,c={...a,disableSpacing:u},r=G(c);return t.jsx(J,{className:A(r.root,i),ownerState:c,ref:n,...o})}),V=w(t.jsx("path",{d:"M8 5v14l11-7z"})),Z=w(t.jsx("path",{d:"M6 6h12v12H6z"})),ee=({script:s})=>{const{t:e}=R("maintenance"),[n,a]=p.useState(!1),[u,i]=p.useState("idle"),[o,c]=p.useState(0),[r,h]=p.useState([]),[y,d]=p.useState(null),{activeDevice:l}=D(),g=p.useRef(!1),P=async()=>{const C=Y.getInstance();if(C.getState()!=="connected"){d(e("status.not_connected"));return}const S=l?.configuration_key;if(!S){d(e("status.missing_config_key"));return}a(!0),i("running"),c(0),h([]),d(null),g.current=!1;const _=x=>h(m=>[...m.slice(-4),x]);try{await s.run({setProgress:c,log:_,checkStop:()=>{if(g.current)throw new Error("STOPPED_BY_USER")},t:e},{bleService:C,configKey:S}),_(e("status.finished")),i("finished"),c(100)}catch(x){console.error(x);const m=x instanceof Error?x.message:String(x);m==="STOPPED_BY_USER"?(i("stopped"),_(e("status.stopped_user"))):(i("error"),d(e("status.error",{message:m})),_(e("status.error",{message:m})))}finally{a(!1)}};return t.jsxs(M,{sx:{mb:2},"data-testid":`script-card-${s.id}`,"data-status":u,children:[t.jsxs(U,{children:[t.jsx(f,{variant:"h6",component:"div",children:e(s.titleKey)}),t.jsx(f,{sx:{mb:1.5},color:"text.secondary",children:e(s.descriptionKey)}),y&&t.jsx(L,{severity:"error",sx:{mb:2},children:y}),(n||r.length>0)&&t.jsxs(B,{sx:{width:"100%",mb:2},children:[t.jsx(W,{variant:"determinate",value:o}),t.jsx(f,{variant:"body2",color:"text.secondary",align:"right",children:e("progress",{percent:Math.round(o)})})]}),r.length>0&&t.jsx(N,{variant:"outlined",sx:{p:1,bgcolor:"background.default",maxHeight:100,overflow:"auto"},children:t.jsx(z,{dense:!0,disablePadding:!0,children:r.map((C,S)=>t.jsx(K,{disablePadding:!0,"data-testid":"maintenance-log-item",children:t.jsx($,{primary:C,primaryTypographyProps:{variant:"caption",fontFamily:"monospace"}})},S))})})]}),t.jsx(Q,{children:n?t.jsx(v,{size:"small",variant:"contained",color:"error",startIcon:t.jsx(Z,{}),onClick:()=>{g.current=!0},children:e("stop")}):t.jsx(v,{size:"small",variant:"contained",startIcon:t.jsx(V,{}),onClick:P,children:e("run")})})]})},E=async s=>{const e=new F,n=await s.sendRequest(e,{expectResponse:!0});if(n.opcode!==j.NOTIFY_CODES_COUNT)throw new Error(`Unexpected response opcode: 0x${n.opcode.toString(16)}`);if(n.payload.length<2)throw new Error("Invalid payload length for CODES_COUNT");return n.payload[0]<<8|n.payload[1]},te={id:"clean_master_codes",titleKey:"scripts.clean_master_codes.title",descriptionKey:"scripts.clean_master_codes.description",run:async({setProgress:s,log:e,checkStop:n,t:a},{bleService:u,configKey:i})=>{e(a("status.fetching_count"));let o=await E(u);if(e(a("status.initial_count",{count:o})),o===0){e(a("status.no_codes"));return}const c=256;for(let r=0;r<c;r++){n();const h=r/c*100;for(s(h);;){n(),e(a("status.deleting_index",{index:r,count:o}));const y=new q(i,r);let d=!1;try{const l=await u.sendRequest(y,{expectResponse:!0},i);l.opcode===j.CODE_OPERATION_SUCCESS?(e(a("status.success_index",{index:r})),d=!0):l.opcode===j.CODE_OPERATION_ERROR&&(e(a("status.error_index",{index:r})),d=!1)}catch(l){const g=l instanceof Error?l.message:String(l);e(a("status.error",{message:`Index ${r}: ${g}`})),d=!1}if(!d)break}if(o=await E(u),o===0){e(a("status.stopping_early"));break}}}},re=()=>{const{t:s}=R("maintenance");return t.jsxs(H,{maxWidth:"sm",sx:{mt:2,pb:10},children:[t.jsx(f,{variant:"h4",gutterBottom:!0,children:s("title")}),t.jsx(f,{variant:"body2",color:"text.secondary",paragraph:!0,children:s("description")}),t.jsx(ee,{script:te})]})};export{re as MaintenancePage};
