import{h as Y,b as e,g as j,a as Q,D as Z,u as J,f as P,c as ee,l as E,Q as N,d as te,s as O,e as me,R as ge,U as he,i as X,q as $,t as A,V as fe,T as b,I as _e,H as pe,F as ve,o as v,W as L,X as ye,Y as B,Z as be,$ as Ie,n as x,a0 as Re,a1 as Se,a2 as Te,a3 as k,a4 as D,a5 as Ce,a6 as w,a7 as Ee,a8 as G,a9 as Ae,aa as we,ab as ne,ac as ae,ad as se,ae as H,af as xe,ag as ke,ah as De,C as Ne,ai as F,aj as Fe,k as Le,v as Oe}from"./index-hp7OEmYE.js";import{I as K,V as W,a as q,A as Ue}from"./VisibilityOff-DueMmnKo.js";import{D as Pe}from"./Delete-BakEoGeS.js";import{T as Ge,a as M}from"./Tabs-QKTSJ9HG.js";const Me=Y(e("path",{d:"M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"}));function Ve(t){return j("MuiAvatar",t)}Q("MuiAvatar",["root","colorDefault","circular","rounded","square","img","fallback"]);const ze=t=>{const{classes:a,variant:n,colorDefault:s}=t;return te({root:["root",n,s&&"colorDefault"],img:["img"],fallback:["fallback"]},Ve,a)},Be=O("div",{name:"MuiAvatar",slot:"Root",overridesResolver:(t,a)=>{const{ownerState:n}=t;return[a.root,a[n.variant],n.colorDefault&&a.colorDefault]}})(me(({theme:t})=>({position:"relative",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0,width:40,height:40,fontFamily:t.typography.fontFamily,fontSize:t.typography.pxToRem(20),lineHeight:1,borderRadius:"50%",overflow:"hidden",userSelect:"none",variants:[{props:{variant:"rounded"},style:{borderRadius:(t.vars||t).shape.borderRadius}},{props:{variant:"square"},style:{borderRadius:0}},{props:{colorDefault:!0},style:{color:(t.vars||t).palette.background.default,...t.vars?{backgroundColor:t.vars.palette.Avatar.defaultBg}:{backgroundColor:t.palette.grey[400],...t.applyStyles("dark",{backgroundColor:t.palette.grey[600]})}}}]}))),Ye=O("img",{name:"MuiAvatar",slot:"Img"})({width:"100%",height:"100%",textAlign:"center",objectFit:"cover",color:"transparent",textIndent:1e4}),Xe=O(Me,{name:"MuiAvatar",slot:"Fallback"})({width:"75%",height:"75%"});function $e({crossOrigin:t,referrerPolicy:a,src:n,srcSet:s}){const[o,u]=E(!1);return N(()=>{if(!n&&!s)return;u(!1);let c=!0;const l=new Image;return l.onload=()=>{c&&u("loaded")},l.onerror=()=>{c&&u("error")},l.crossOrigin=t,l.referrerPolicy=a,l.src=n,s&&(l.srcset=s),()=>{c=!1}},[t,a,n,s]),o}const He=Z(function(a,n){const s=J({props:a,name:"MuiAvatar"}),{alt:o,children:u,className:c,component:l="div",slots:i={},slotProps:_={},imgProps:p,sizes:y,src:I,srcSet:T,variant:S="circular",...d}=s;let h=null;const r={...s,component:l,variant:S},m=$e({...p,...typeof _.img=="function"?_.img(r):_.img,src:I,srcSet:T}),R=I||T,f=R&&m!=="error";r.colorDefault=!f,delete r.ownerState;const C=ze(r),[U,ie]=P("root",{ref:n,className:ee(C.root,c),elementType:Be,externalForwardedProps:{slots:i,slotProps:_,component:l,...d},ownerState:r}),[ce,le]=P("img",{className:C.img,elementType:Ye,externalForwardedProps:{slots:i,slotProps:{img:{...p,..._.img}}},additionalProps:{alt:o,src:I,srcSet:T,sizes:y},ownerState:r}),[de,ue]=P("fallback",{className:C.fallback,elementType:Xe,externalForwardedProps:{slots:i,slotProps:_},shouldForwardComponentProp:!0,ownerState:r});return f?h=e(ce,{...le}):u||u===0?h=u:R&&o?h=o[0]:h=e(de,{...ue}),e(U,{...ie,children:h})});function Ke(t){return j("MuiListItemAvatar",t)}Q("MuiListItemAvatar",["root","alignItemsFlexStart"]);const We=t=>{const{alignItems:a,classes:n}=t;return te({root:["root",a==="flex-start"&&"alignItemsFlexStart"]},Ke,n)},qe=O("div",{name:"MuiListItemAvatar",slot:"Root",overridesResolver:(t,a)=>{const{ownerState:n}=t;return[a.root,n.alignItems==="flex-start"&&a.alignItemsFlexStart]}})({minWidth:56,flexShrink:0,variants:[{props:{alignItems:"flex-start"},style:{marginTop:8}}]}),je=Z(function(a,n){const s=J({props:a,name:"MuiListItemAvatar"}),{className:o,...u}=s,c=ge(he),l={...s,alignItems:c.alignItems},i=We(l);return e(qe,{className:ee(i.root,o),ownerState:l,ref:n,...u})}),Qe=Y(e("path",{d:"M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20z"})),Ze=Y(e("path",{d:"M20 2H4c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2m0 18H4V4h16zM18 6h-5c-1.1 0-2 .9-2 2v2.28c-.6.35-1 .98-1 1.72 0 1.1.9 2 2 2s2-.9 2-2c0-.74-.4-1.38-1-1.72V8h3v8H8V8h2V6H6v12h12z"})),re=(t,a)=>{if(!t||!a)return 0;const n=t.replace(/[^0-9.]/g,""),s=a.replace(/[^0-9.]/g,""),o=n.split(".").map(Number),u=s.split(".").map(Number);for(let c=0;c<Math.max(o.length,u.length);c++){const l=o[c]||0,i=u[c]||0;if(l>i)return 1;if(l<i)return-1}return 0},Je=({deviceId:t})=>{const{t:a}=X(["common","settings"]),{activeDevice:n,updateDeviceDetails:s,removeDevice:o,toggleLaPoste:u}=$(),[c,l]=A(E({key:!n?.configuration_key,pin:!n?.door_pin_code}),"visibleFields"),[i,_]=A(E(n?.friendly_name||""),"deviceName"),[p,y]=A(E(n?.configuration_key||""),"configurationKey"),[I,T]=A(E(n?.door_pin_code||""),"doorPinCode");fe.useEffect(()=>{n&&(_(n.friendly_name||""),y(n.configuration_key||""),T(n.door_pin_code||""))},[n]);const S=f=>{l(C=>({...C,[f]:!C[f]}))},d=async()=>{if(n)try{await s(t,{friendly_name:i,configuration_key:p,door_pin_code:I})}catch(f){console.error("Failed to update device details:",f)}},h=async f=>{try{await u(f.target.checked)}catch(C){console.error("Failed to toggle La Poste:",C)}},r=async()=>{if(n)try{await o(t)}catch(f){console.error("Failed to remove device:",f)}},m=f=>{const U=f.trim().toUpperCase().replace(/[^0-9A-F]/g,"").slice(-8);y(U)},R=f=>{const C=f.trim().toUpperCase();T(C)};return n?e(v,{sx:{my:2},children:[e(b,{variant:"subtitle1",gutterBottom:!0,children:a("devices.title")}),e(_e,{sx:{mb:2}}),e(pe,{children:e(ve,{children:e(v,{sx:{display:"flex",flexDirection:"column",gap:2},children:[e(L,{label:a("devices.device_name"),value:i,onChange:f=>_(f.currentTarget.value),fullWidth:!0,size:"small"}),n.role===ye.Admin&&e(L,{label:a("settings:configuration_key.label"),value:p,onChange:f=>m(f.currentTarget.value),fullWidth:!0,size:"small",type:c.key?"text":"password",helperText:a("settings:configuration_key.helper"),slotProps:{input:{endAdornment:e(K,{position:"end",children:e(B,{"aria-label":a("settings:toggle_key_visibility"),onClick:()=>S("key"),edge:"end",size:"small",children:c.key?e(W,{}):e(q,{})})})}}}),e(L,{label:a("settings:door_pin_code"),value:I,onChange:f=>R(f.currentTarget.value),fullWidth:!0,size:"small",type:c.pin?"text":"password",slotProps:{input:{endAdornment:e(K,{position:"end",children:e(B,{"aria-label":a("settings:toggle_pin_visibility"),onClick:()=>S("pin"),edge:"end",size:"small",children:c.pin?e(W,{}):e(q,{})})})}}}),n.hardware_version==="4.0"&&n.software_revision&&re(n.software_revision,"4.2.0")>=0&&e(v,{children:e(be,{control:e(Ie,{checked:n.la_poste_activated||!1,onChange:h}),label:a("settings:activate_la_poste")})}),e(v,{sx:{display:"flex",justifyContent:"space-between",mt:2},children:[e(x,{size:"small",color:"error",variant:"outlined",onClick:r,children:a("devices.forget")}),e(x,{size:"small",variant:"contained",onClick:d,children:a("save")})]})]})})})]}):null};var oe=(t=>(t[t.LA_POSTE=1]="LA_POSTE",t[t.VIGIK_TERTIARY=2]="VIGIK_TERTIARY",t[t.USER_BADGE=3]="USER_BADGE",t))(oe||{}),g=(t=>(t.IDLE="idle",t.SCANNING="scanning",t.FOUND="found",t.TIMEOUT="timeout",t.ERROR_EXISTS="error_exists",t.ERROR="error",t))(g||{});const et=()=>{const{activeDevice:t}=$(),{sendRequest:a}=Re(),{addListener:n,removeListener:s}=Se(),[o,u]=A(E(g.IDLE),"scanStatus"),[c,l]=A(E(null),"scannedUid"),i=t?.id,_=Te(()=>i?k.nfc_tags.where("device_id").equals(i).toArray():[],[i]),p=D(async()=>{if(!i)throw new Error("No active device");const d=await k.device_secrets.get(i);if(!d?.configuration_key)throw new Error("Configuration Key required");return d.configuration_key},[i]),y=D(async()=>{try{const d=await p();u(g.SCANNING),l(null),await a(new Ce(d))}catch(d){console.error("Failed to start scan",d),u(g.ERROR)}},[p,a]);N(()=>{const d=h=>{if(!(o!==g.SCANNING&&o!==g.IDLE)&&[w.NOTIFY_NFC_TAG_REGISTER_SCAN_RESULT,w.NOTIFY_NFC_TAG_REGISTER_SCAN_ERROR_EXISTS,w.NOTIFY_NFC_TAG_REGISTER_SCAN_TIMEOUT].includes(h.opcode)){const r=new Ee(h.opcode);switch(r.parse(h.payload),r.status){case G.TIMEOUT:u(g.TIMEOUT);break;case G.ALREADY_EXISTS:u(g.ERROR_EXISTS),r.uid&&l(r.uid);break;case G.FOUND:u(g.FOUND),r.uid&&l(r.uid);break;default:u(g.ERROR)}}};return n(w.NOTIFY_NFC_TAG_REGISTER_SCAN_RESULT,d),n(w.NOTIFY_NFC_TAG_REGISTER_SCAN_ERROR_EXISTS,d),n(w.NOTIFY_NFC_TAG_REGISTER_SCAN_TIMEOUT,d),()=>{s(w.NOTIFY_NFC_TAG_REGISTER_SCAN_RESULT,d),s(w.NOTIFY_NFC_TAG_REGISTER_SCAN_ERROR_EXISTS,d),s(w.NOTIFY_NFC_TAG_REGISTER_SCAN_TIMEOUT,d)}},[n,s,o]);const I=D(async d=>{if(!(!c||!i))try{const h=await p(),r=new Uint8Array(c.split(":").map(R=>parseInt(R,16)));if(o===g.FOUND){const R=new Ae(h,r);await a(R)}const m=await k.nfc_tags.where({device_id:i,uid:c}).first();m?await k.nfc_tags.update(m.id,{name:d,updated_at:Date.now()}):await k.nfc_tags.add({id:crypto.randomUUID(),device_id:i,uid:c,name:d,type:oe.USER_BADGE,created_at:Date.now(),sync_status:"created"}),u(g.IDLE),l(null)}catch(h){throw console.error("Failed to register tag",h),h}},[c,i,p,a,o]),T=D(async d=>{if(i)try{const h=await p(),r=new Uint8Array(d.uid.split(":").map(R=>parseInt(R,16))),m=new we(h,r);await a(m),await k.nfc_tags.delete(d.id)}catch(h){throw console.error("Failed to unregister tag",h),h}},[i,p,a]),S=D(()=>{u(g.IDLE),l(null)},[]);return{tags:_,scanStatus:o,scannedUid:c,startScan:y,registerTag:I,unregisterTag:T,resetScan:S}},tt=()=>{const{t}=X(["common","settings"]),a=t,{tags:n,scanStatus:s,scannedUid:o,startScan:u,registerTag:c,unregisterTag:l,resetScan:i}=et(),[_,p]=A(E(!1),"openAddDialog"),[y,I]=A(E(""),"tagName"),T=()=>{i(),I(""),p(!0)},S=()=>{p(!1),i()},d=()=>{u()},h=async()=>{if(y.trim())try{await c(y.trim()),S()}catch(m){console.error(m)}},r=async m=>{if(confirm(a("common:confirm_delete")))try{await l(m)}catch(R){console.error(R),alert(t("settings:nfc.error_delete_failed"))}};return N(()=>{o&&!y&&I(`Badge ${o.substring(0,5)}`)},[o,y]),e(v,{sx:{p:2},children:[e(v,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2},children:[e(b,{variant:"h6",children:t("settings:nfc.title")}),e(x,{variant:"contained",startIcon:e(Ue,{}),onClick:T,children:t("settings:nfc.add_tag")})]}),n&&n.length>0?e(ne,{children:n.map(m=>e(ae,{secondaryAction:e(B,{edge:"end","aria-label":"delete",onClick:()=>r(m),children:e(Pe,{})}),children:[e(je,{children:e(He,{children:e(Ze,{})})}),e(se,{primary:m.name,secondary:e(H,{children:[e(b,{component:"span",variant:"body2",color:"textPrimary",children:m.uid}),e("br",{}),m.last_seen_at?t("settings:nfc.last_seen",{date:new Date(m.last_seen_at).toLocaleString()}):t("settings:nfc.never_seen")]})})]},m.id))}):e(b,{variant:"body1",color:"textSecondary",align:"center",sx:{mt:4},children:t("settings:nfc.no_tags")}),e(xe,{open:_,onClose:S,fullWidth:!0,maxWidth:"sm",children:[e(ke,{children:t("settings:nfc.dialog_title")}),e(De,{children:e(v,{sx:{display:"flex",flexDirection:"column",alignItems:"center",gap:2,py:2},children:[s===g.IDLE&&e(b,{children:t("settings:nfc.instructions_idle")}),s===g.SCANNING&&e(H,{children:[e(Ne,{}),e(b,{children:t("settings:nfc.instructions_scanning")})]}),s===g.TIMEOUT&&e(F,{severity:"warning",children:t("settings:nfc.error_timeout")}),s===g.ERROR&&e(F,{severity:"error",children:t("settings:nfc.error_generic")}),s===g.ERROR_EXISTS&&e(F,{severity:"info",children:[t("settings:nfc.error_exists"),o&&e(v,{sx:{mt:1},children:[e(b,{variant:"caption",children:["UID: ",o]}),e(b,{children:t("settings:nfc.instructions_exists_local")})]})]}),(s===g.FOUND||s===g.ERROR_EXISTS)&&o&&e(v,{sx:{width:"100%",mt:2},children:[e(F,{severity:"success",sx:{mb:2},children:t("settings:nfc.tag_found",{uid:o})}),e(L,{autoFocus:!0,margin:"dense",label:t("settings:nfc.input_label"),fullWidth:!0,value:y,onChange:m=>I(m.target.value)})]})]})}),e(Fe,{children:[e(x,{onClick:S,children:t("common:cancel")}),s===g.IDLE||s===g.TIMEOUT||s===g.ERROR?e(x,{onClick:d,variant:"contained",children:t("settings:nfc.button_start_scan")}):null,(s===g.FOUND||s===g.ERROR_EXISTS)&&e(x,{onClick:h,variant:"contained",disabled:!y,children:t("settings:nfc.add_tag")})]})]})]})};function V(t){const{children:a,value:n,index:s,...o}=t;return e("div",{role:"tabpanel",hidden:n!==s,id:`my-boks-tabpanel-${s}`,"aria-labelledby":`my-boks-tab-${s}`,...o,children:n===s&&e(v,{sx:{p:3},children:a})})}function z(t){return{id:`my-boks-tab-${t}`,"aria-controls":`my-boks-tabpanel-${t}`}}const ot=()=>{const{t}=X(["common","codes","logs","settings"]),{activeDevice:a,knownDevices:n,setActiveDevice:s}=$(),{isConnected:o}=Le(),u=Oe(),[c,l]=A(E(0),"value"),[i,_]=A(E(null),"selectedDeviceId");N(()=>{const m=new URLSearchParams(u.search).get("tab"),R=setTimeout(()=>{switch(m){case"settings":l(0);break;case"users":l(1);break;default:l(0);break}},0);return()=>clearTimeout(R)},[u.search]),N(()=>{(!a||!n.some(r=>r.id===a.id))&&i!==null&&setTimeout(()=>_(null),0)},[a,n,i]);const p=(r,m)=>{l(m)},y=r=>{_(r),s(r)},I=()=>{_(null),s(null)},T=n.length>1&&!i&&!a,S=a&&a.hardware_version==="4.0"&&a.software_revision&&re(a.software_revision,"4.3.3")>=0;let d=t("common:my_boks");return a&&n.length===1||a&&n.length>1?d=a.friendly_name||a.ble_name:!a&&n.length===1&&(d=n[0].friendly_name||n[0].ble_name),T?e(v,{sx:{p:3},children:[e(b,{variant:"h5",gutterBottom:!0,children:t("common:my_boks")}),e(ne,{children:n.map(r=>e(ae,{onClick:()=>y(r.id),sx:{cursor:"pointer"},children:e(se,{primary:r.friendly_name||r.ble_name,secondary:r.ble_name})},r.id))})]}):a||n.find(r=>r.id===i)||(n.length===1?n[0]:null)?e(v,{sx:{width:"100%"},children:[e(v,{sx:{p:3,borderBottom:1,borderColor:"divider"},children:[n.length>1&&e(x,{startIcon:e(Qe,{}),onClick:I,sx:{mb:1},children:t("common:back_to_list")}),e(b,{variant:"h4",component:"h1",gutterBottom:!0,children:d}),e(b,{variant:"subtitle1",color:"textSecondary",children:t(o?"common:connected":"common:disconnected")})]}),e(v,{sx:{borderBottom:1,borderColor:"divider"},children:e(Ge,{value:c,onChange:p,"aria-label":"my boks tabs",children:[e(M,{label:t("settings:title"),...z(0)}),e(M,{label:t("common:users.title"),...z(1)}),S&&e(M,{label:"Tags NFC",...z(2)})]})}),e(V,{value:c,index:0,children:e(Je,{deviceId:a?.id||""})}),e(V,{value:c,index:1,children:e(v,{sx:{p:3},children:[e(b,{variant:"h6",children:t("common:users.title")}),e(b,{variant:"body1",color:"textSecondary",children:t("common:coming_soon")})]})}),S&&e(V,{value:c,index:2,children:e(tt,{})})]}):e(v,{sx:{p:3},children:[e(b,{variant:"h5",children:t("common:my_boks")}),e(b,{variant:"body1",color:"textSecondary",children:t("common:no_active_device")})]})};export{ot as MyBoksPage};
