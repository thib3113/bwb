import{h as B,b as e,i as C,t as g,l as f,a3 as D,aT as H,aU as j,aV as F,aW as U,o as d,a2 as q,T as u,ac as G,aX as ee,aY as te,az as re,aZ as se,ab as ne,W as K,ai as k,n as x,Y as R,a0 as Z,P as J,aO as ae,an as L,a_ as W,a$ as le,Q as A,a6 as ie,F as I,I as oe,aw as ce,H as z,w as de,b0 as he,Z as ue,$ as pe,b1 as V}from"./index-B06_FYHA.js";import{S as ge}from"./Stack-5QjJx5I9.js";import{E as me}from"./Edit-CcuHDFG1.js";import{D as X}from"./Delete-a8vl1j2v.js";import{T as ve,a as be,b as N,c as S,d as fe}from"./TableRow-C97CHdwt.js";import{C as _e}from"./Chip-BkyNIWZj.js";import{T as ye,a as M}from"./Tabs-Bd026aX5.js";import{C as xe}from"./Container-BidYCuGy.js";const we=B(e("path",{d:"M12 2C6.47 2 2 6.47 2 12s4.47 10 10 10 10-4.47 10-10S17.53 2 12 2m5 13.59L15.59 17 12 13.41 8.41 17 7 15.59 10.59 12 7 8.41 8.41 7 12 10.59 15.59 7 17 8.41 13.41 12z"})),Se=B(e("path",{d:"M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6zm2.46-7.12 1.41-1.41L12 12.59l2.12-2.12 1.41 1.41L13.41 14l2.12 2.12-1.41 1.41L12 15.41l-2.12 2.12-1.41-1.41L10.59 14zM15.5 4l-1-1h-5l-1 1H5v2h14V4z"})),ke=B(e("path",{d:"M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3m3-10H5V5h10z"})),Ce=B(e("path",{d:"m12 16.5 4-4h-3v-9h-2v9H8zm9-13h-6v1.99h6v14.03H3V5.49h6V3.5H3c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2v-14c0-1.1-.9-2-2-2"})),De=({tableName:t,item:n,primaryKey:l})=>{const[a,i]=g(f(!1),"isEditing"),[r,h]=g(f(JSON.stringify(n,null,2)),"editValue"),[b,v]=g(f(null),"error"),o=async()=>{try{const _=JSON.parse(r);await D.table(t).put(_),i(!1),v(null)}catch(_){v(_ instanceof Error?_.message:"Invalid JSON")}},p=async()=>{confirm("Are you sure you want to delete this record?")&&await D.table(t).delete(l)};return a?e(d,{sx:{p:1},children:[e(K,{fullWidth:!0,multiline:!0,minRows:3,value:r,onChange:_=>h(_.target.value),variant:"outlined",size:"small",sx:{fontFamily:"monospace",mb:1}}),b&&e(k,{severity:"error",sx:{mb:1},children:b}),e(ge,{direction:"row",spacing:1,justifyContent:"flex-end",children:[e(x,{startIcon:e(we,{}),onClick:()=>{i(!1),h(JSON.stringify(n,null,2)),v(null)},size:"small",children:"Cancel"}),e(x,{startIcon:e(ke,{}),onClick:o,variant:"contained",size:"small",children:"Save"})]})]}):e(d,{children:[e(d,{sx:{display:"flex",justifyContent:"flex-end",mb:1},children:[e(R,{size:"small",onClick:()=>i(!0),children:e(me,{fontSize:"small"})}),e(R,{size:"small",onClick:p,color:"error",children:e(X,{fontSize:"small"})})]}),e(d,{component:"pre",sx:{overflowX:"auto",fontSize:"0.75rem",m:0,p:1,bgcolor:"action.hover",borderRadius:1},children:JSON.stringify(n,null,2)})]})},Te=({tableName:t})=>{const{t:n}=C(["settings"]),l=q(()=>D.table(t).toArray(),[t]),i=D.table(t).schema.primKey.name;return l?l.length===0?e(u,{children:n("settings:developer.no_records")}):e(ne,{children:l.map((r,h)=>{const b=r[i];return e(G,{disablePadding:!0,children:e(ee,{sx:{width:"100%"},children:[e(te,{expandIcon:e(re,{}),children:e(u,{noWrap:!0,children:r.id||r.name||r.key||`Record ${h}`})}),e(se,{children:e(De,{tableName:t,item:r,primaryKey:b})})]})},b||h)})}):e(u,{children:n("settings:developer.loading")})},Oe=()=>{const{t}=C(["settings"]),[n,l]=g(f(""),"selectedTable"),a=D.tables.map(r=>r.name),i=r=>{l(r.target.value)};return e(d,{sx:{mt:2},children:[e(H,{fullWidth:!0,size:"small",sx:{mb:2},children:[e(j,{children:t("settings:developer.select_table")}),e(F,{value:n,label:t("settings:developer.select_table"),onChange:i,children:a.map(r=>e(U,{value:r,children:r},r))})]}),n&&e(Te,{tableName:n})]})},Ee=()=>{const{t}=C(["settings"]),{debugLogs:n,clearDebugLogs:l}=Z(),a=n.filter(r=>r.type==="packet").sort((r,h)=>new Date(h.timestamp).getTime()-new Date(r.timestamp).getTime()),i=r=>r===void 0?"UNKNOWN":ae[r]||`OP_${r.toString(16).toUpperCase()}`;return e(d,{sx:{mt:4},children:[e(d,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2},children:[e(u,{variant:"h6",children:t("settings:developer.packet_logger_title")}),e(x,{variant:"outlined",color:"error",startIcon:e(X,{}),onClick:l,size:"small",children:t("settings:developer.clear_logs")})]}),e(J,{variant:"outlined",sx:{width:"100%",overflow:"hidden"},children:e(d,{sx:{maxHeight:400,overflowY:"auto"},children:e(ve,{stickyHeader:!0,size:"small",children:[e(be,{children:e(N,{children:[e(S,{children:"Time"}),e(S,{children:"Dir"}),e(S,{children:"Opcode"}),e(S,{children:"Payload (Hex)"})]})}),e(fe,{children:a.length>0?a.map(r=>e(N,{hover:!0,children:[e(S,{sx:{whiteSpace:"nowrap",fontSize:"0.75rem"},children:new Date(r.timestamp).toLocaleTimeString([],{hour12:!1,hour:"2-digit",minute:"2-digit",second:"2-digit",fractionalSecondDigits:3})}),e(S,{children:e(_e,{label:r.direction,color:r.direction==="TX"?"primary":"success",size:"small",sx:{fontSize:"0.7rem",height:20}})}),e(S,{sx:{fontSize:"0.75rem",fontWeight:"bold"},children:i(r.opcode)}),e(S,{sx:{fontFamily:"monospace",fontSize:"0.75rem",wordBreak:"break-all"},children:r.payload||"-"})]},r.id)):e(N,{children:e(S,{colSpan:4,align:"center",children:e(u,{variant:"body2",color:"text.secondary",sx:{py:2},children:t("settings:developer.no_records")})})})})]})})})]})},Ie=t=>ie[t]||`UNKNOWN_OPCODE_${t}`,$={},ze=()=>{const{t}=C(["settings"]),{sendPacket:n,isConnected:l}=Z(),[a,i]=g(f(""),"selectedOpcode"),[r,h]=g(f({}),"formData"),[b,v]=g(f(null),"validationError"),[o,p]=g(f(null),"successMessage"),_=g(L(()=>Array.from(W.getRegisteredTXPackets().entries()).sort((s,m)=>s[0]-m[0]),[]),"registeredPackets"),c=g(L(()=>a===""?null:W.getRegisteredTXPackets().get(a),[a]),"SelectedPacketClass"),y=g(L(()=>!c||!c.schema?null:c.schema instanceof le?c.schema.shape:null,[c]),"schemaShape");A(()=>{if(!y){h({});return}const s={};Object.keys(y).forEach(m=>{s[m]=$[m]||""}),h(s)},[y]);const T=s=>{i(s.target.value),v(null),p(null)},Y=(s,m)=>{h(w=>({...w,[s]:m})),$[s]=m,v(null),p(null)},Q=async()=>{if(c){v(null),p(null);try{let s={};if(c.schema){const w=c.schema.safeParse(r);if(!w.success){const O=w.error.errors.map(E=>`${E.path.join(".")}: ${E.message}`).join(", ");v(O);return}s=w.data}const m=new c;Object.assign(m,s),await n(m),console.log("Packet sent successfully",m),p(t("settings:developer.packet_sent_success"))}catch(s){console.error("Failed to send packet",s),v(s.message||t("settings:developer.packet_send_error"))}}};return e(d,{sx:{display:"flex",flexDirection:"column",gap:3},children:[e(k,{severity:l?"success":"warning",children:t(l?"settings:developer.enabled_success":"settings:developer.not_connected_warning")}),e(H,{fullWidth:!0,children:[e(j,{children:t("settings:developer.packet_type_label")}),e(F,{value:a,label:t("settings:developer.packet_type_label"),onChange:T,children:_.map(([s])=>e(U,{value:s,children:[Ie(s)," (",s,")"]},s))})]}),c&&e(J,{variant:"outlined",sx:{p:2},children:[e(u,{variant:"h6",gutterBottom:!0,children:t("settings:developer.packet_parameters_title")}),e(d,{sx:{display:"flex",flexDirection:"column",gap:2},children:[y?Object.keys(y).length>0?Object.keys(y).map(s=>{const m=y[s];let w=!1;const O=m._def.typeName;return(O==="ZodNumber"||O==="ZodEffects"&&m._def.schema?._def.typeName==="ZodNumber")&&(w=!0),e(K,{label:s,variant:"outlined",fullWidth:!0,type:w?"number":"text",value:r[s]||"",onChange:E=>Y(s,E.target.value),helperText:w?"Number":"String"},s)}):e(u,{color:"text.secondary",children:t("settings:developer.no_parameters")}):e(u,{color:"text.secondary",children:t("settings:developer.no_schema")}),b&&e(k,{severity:"error",children:b}),o&&e(k,{severity:"success",children:o}),e(x,{variant:"contained",onClick:Q,disabled:!l&&!window.BOKS_SIMULATOR_ENABLED,children:t("settings:developer.send_packet")})]})]}),e(Ee,{})]})},Be=()=>{const{t}=C(["settings"]),[n,l]=g(f([]),"registrations"),[a,i]=g(f(null),"message"),r=async()=>{if("serviceWorker"in navigator){const o=await navigator.serviceWorker.getRegistrations();l([...o])}};A(()=>{r()},[]);const h=async o=>{try{await o.update(),i(t("settings:developer.sw_update_requested")),r()}catch(p){i(t("settings:developer.sw_update_failed",{error:String(p)}))}},b=async o=>{try{const p=await o.unregister();i(t(p?"settings:developer.sw_unregister_success":"settings:developer.sw_unregister_failed")),r()}catch(p){i(t("settings:developer.sw_unregister_error",{error:String(p)}))}},v=()=>{window.location.reload()};return"serviceWorker"in navigator?e(z,{sx:{mt:2},children:e(I,{children:[e(u,{variant:"h6",gutterBottom:!0,children:t("settings:developer.sw_title")}),e(oe,{sx:{mb:2}}),a&&e(k,{severity:"info",sx:{mb:2},onClose:()=>i(null),children:a}),n.length===0?e(u,{variant:"body2",color:"text.secondary",children:t("settings:developer.sw_no_active")}):n.map((o,p)=>e(d,{sx:{mb:2,p:1,border:"1px solid #ddd",borderRadius:1},children:[e(u,{variant:"subtitle2",children:t("settings:developer.sw_scope",{scope:o.scope})}),e(u,{variant:"body2",color:"text.secondary",gutterBottom:!0,children:t("settings:developer.sw_status",{status:o.installing?t("settings:developer.sw_installing"):o.waiting?t("settings:developer.sw_waiting"):o.active?t("settings:developer.sw_active"):t("settings:developer.sw_unknown")})}),e(d,{sx:{display:"flex",gap:1,flexWrap:"wrap",mt:1},children:[e(x,{size:"small",variant:"outlined",startIcon:e(Ce,{}),onClick:()=>h(o),children:t("settings:developer.sw_check_update")}),e(x,{size:"small",variant:"outlined",color:"error",startIcon:e(Se,{}),onClick:()=>b(o),children:t("settings:developer.sw_unregister")})]})]},p)),e(d,{sx:{mt:2},children:e(x,{fullWidth:!0,variant:"contained",color:"primary",startIcon:e(ce,{}),onClick:v,children:t("settings:developer.sw_reload")})})]})}):e(k,{severity:"warning",children:t("settings:developer.sw_not_supported")})};function P(t){const{children:n,value:l,index:a,...i}=t;return e("div",{role:"tabpanel",hidden:l!==a,id:`simple-tabpanel-${a}`,"aria-labelledby":`simple-tab-${a}`,...i,children:l===a&&e(d,{sx:{p:2},children:n})})}const $e=()=>{const{t}=C(["settings"]),n=de(),{isDeveloperMode:l,disableDeveloperMode:a}=he(),[i,r]=g(f(!1),"simulatorEnabled"),[h,b]=g(f(0),"tabValue");A(()=>{l||n("/");const c=localStorage.getItem("BOKS_SIMULATOR_ENABLED")==="true";r(c)},[l,n]);const v=()=>{a(),n("/")},o=c=>{const T=c.target.checked;r(T),T?localStorage.setItem("BOKS_SIMULATOR_ENABLED","true"):localStorage.removeItem("BOKS_SIMULATOR_ENABLED"),window.location.reload()},p=async()=>{try{confirm(t("settings:developer.mock_data_confirm"))&&(await V.mockData(),alert(t("settings:developer.mock_data_success")))}catch(c){console.error(c),alert(t("settings:developer.mock_data_failed"))}},_=(c,y)=>{b(y)};return e(xe,{maxWidth:"md",sx:{py:2},children:[e(d,{sx:{mb:3,display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e(u,{variant:"h4",children:t("settings:developer.page_title")}),e(x,{variant:"outlined",color:"error",onClick:v,children:t("settings:developer.disable_mode")})]}),e(d,{sx:{borderBottom:1,borderColor:"divider"},children:e(ye,{value:h,onChange:_,"aria-label":"developer tabs",children:[e(M,{label:t("settings:developer.tabs.general")}),e(M,{label:t("settings:developer.tabs.database")}),e(M,{label:t("settings:developer.tabs.bluetooth")})]})}),e(P,{value:h,index:0,children:[e(z,{sx:{mb:3},children:e(I,{children:e(d,{sx:{display:"flex",flexDirection:"column",gap:2},children:[e(u,{variant:"h6",children:t("settings:developer.simulators_tools")}),e(ue,{control:e(pe,{checked:i,onChange:c=>o(c)}),label:t("settings:developer.enable_simulator")})]})})}),e(Be,{})]}),e(P,{value:h,index:1,children:e(z,{children:e(I,{children:[e(d,{sx:{mb:4},children:[e(d,{sx:{display:"flex",gap:2},children:[e(x,{variant:"contained",onClick:p,children:t("settings:developer.load_mock_data")}),e(x,{variant:"outlined",color:"error",onClick:()=>{confirm(t("settings:developer.clear_db_confirm"))&&V.clearAllData()},children:t("settings:developer.clear_db")})]}),e(u,{variant:"caption",display:"block",color:"text.secondary",sx:{mt:1},children:t("settings:developer.mock_data_helper")})]}),e(u,{variant:"h6",gutterBottom:!0,children:t("settings:developer.db_editor")}),e(u,{variant:"body2",color:"text.secondary",paragraph:!0,children:t("settings:developer.db_editor_helper")}),e(Oe,{})]})})}),e(P,{value:h,index:2,children:e(z,{children:e(I,{children:[e(u,{variant:"h6",gutterBottom:!0,children:"Bluetooth Debugger"}),e(ze,{})]})})})]})};export{$e as DeveloperPage};
