import{g as oe,a as re,D as ie,u as ae,f as Q,c as H,b as e,ae as Z,ak as me,d as se,s as k,P as Re,e as q,al as qe,am as Me,R as ee,an as Ue,h as le,ao as Je,O as Ke,_ as Ze,ap as Xe,k as Se,t as U,l as B,a4 as We,aq as et,ar as tt,as as _e,at as nt,au as G,i as ce,T as c,o as x,ai as V,n as A,C as X,av as Pe,H as te,F as ne,I as Be,aw as ot,ax as Ae,W as we,ay as rt,Y as Ve,az as it,aA as at,ab as st,ac as lt,ad as ct,aB as dt,aC as pt,K as ut,aD as mt,aE as ht,aF as yt,j as vt,aG as gt,q as ft,aH as bt,aI as xt,Q as Y,aJ as St}from"./index-CG-F3lNP.js";import{S as W}from"./Stack-CAesfFdp.js";import{C as wt}from"./Chip-BKUrOpOP.js";import{L as Ct}from"./LinearProgress-BMf6BeGU.js";import{C as It}from"./Container-BGhM0gBw.js";function Lt(t){return oe("MuiMobileStepper",t)}re("MuiMobileStepper",["root","positionBottom","positionTop","positionStatic","dots","dot","dotActive","progress"]);const zt=t=>{const{classes:o,position:n}=t,i={root:["root",`position${me(n)}`],dots:["dots"],dot:["dot"],dotActive:["dotActive"],progress:["progress"]};return se(i,Lt,o)},Tt=k(Re,{name:"MuiMobileStepper",slot:"Root",overridesResolver:(t,o)=>{const{ownerState:n}=t;return[o.root,o[`position${me(n.position)}`]]}})(q(({theme:t})=>({display:"flex",flexDirection:"row",justifyContent:"space-between",alignItems:"center",background:(t.vars||t).palette.background.default,padding:8,variants:[{props:({position:o})=>o==="top"||o==="bottom",style:{position:"fixed",left:0,right:0,zIndex:(t.vars||t).zIndex.mobileStepper}},{props:{position:"top"},style:{top:0}},{props:{position:"bottom"},style:{bottom:0}}]}))),Dt=k("div",{name:"MuiMobileStepper",slot:"Dots"})({variants:[{props:{variant:"dots"},style:{display:"flex",flexDirection:"row"}}]}),_t=k("div",{name:"MuiMobileStepper",slot:"Dot",shouldForwardProp:t=>qe(t)&&t!=="dotActive",overridesResolver:(t,o)=>{const{dotActive:n}=t;return[o.dot,n&&o.dotActive]}})(q(({theme:t})=>({variants:[{props:{variant:"dots"},style:{transition:t.transitions.create("background-color",{duration:t.transitions.duration.shortest}),backgroundColor:(t.vars||t).palette.action.disabled,borderRadius:"50%",width:8,height:8,margin:"0 2px"}},{props:{variant:"dots",dotActive:!0},style:{backgroundColor:(t.vars||t).palette.primary.main}}]}))),At=k(Ct,{name:"MuiMobileStepper",slot:"Progress"})({variants:[{props:{variant:"progress"},style:{width:"50%"}}]}),kt=ie(function(o,n){const i=ae({props:o,name:"MuiMobileStepper"}),{activeStep:s=0,backButton:m,className:p,LinearProgressProps:r,nextButton:f,position:h="bottom",steps:v,variant:a="dots",slots:d={},slotProps:u={},...S}=i,g={...i,activeStep:s,position:h,variant:a};let l;a==="progress"&&(v===1?l=100:l=Math.ceil(s/(v-1)*100));const y=zt(g),b={slots:d,slotProps:{progress:r,...u}},[w,_]=Q("root",{ref:n,elementType:Tt,shouldForwardComponentProp:!0,className:H(y.root,p),externalForwardedProps:{...b,...S},ownerState:g,additionalProps:{square:!0,elevation:0}}),[z,C]=Q("dots",{className:y.dots,elementType:Dt,externalForwardedProps:b,ownerState:g}),[I,T]=Q("dot",{elementType:_t,externalForwardedProps:b,ownerState:g}),[D,P]=Q("progress",{className:y.progress,elementType:At,shouldForwardComponentProp:!0,externalForwardedProps:b,ownerState:g,additionalProps:{value:l,variant:"determinate"}});return e(w,{..._,children:[m,a==="text"&&e(Z,{children:[s+1," / ",v]}),a==="dots"&&e(z,{...C,children:[...new Array(v)].map((R,M)=>e(I,{...T,className:H(y.dot,T.className,M===s&&y.dotActive),dotActive:M===s},M))}),a==="progress"&&e(D,{...P}),f]})}),he=Me({}),Ce=Me({});function Rt(t){return oe("MuiStep",t)}re("MuiStep",["root","horizontal","vertical","alternativeLabel","completed"]);const Mt=t=>{const{classes:o,orientation:n,alternativeLabel:i,completed:s}=t;return se({root:["root",n,i&&"alternativeLabel",s&&"completed"]},Rt,o)},Ut=k("div",{name:"MuiStep",slot:"Root",overridesResolver:(t,o)=>{const{ownerState:n}=t;return[o.root,o[n.orientation],n.alternativeLabel&&o.alternativeLabel,n.completed&&o.completed]}})({variants:[{props:{orientation:"horizontal"},style:{paddingLeft:8,paddingRight:8}},{props:{alternativeLabel:!0},style:{flex:1,position:"relative"}}]}),Wt=ie(function(o,n){const i=ae({props:o,name:"MuiStep"}),{active:s,children:m,className:p,component:r="div",completed:f,disabled:h,expanded:v=!1,index:a,last:d,...u}=i,{activeStep:S,connector:g,alternativeLabel:l,orientation:y,nonLinear:b}=ee(he);let[w=!1,_=!1,z=!1]=[s,f,h];S===a?w=s!==void 0?s:!0:!b&&S>a?_=f!==void 0?f:!0:!b&&S<a&&(z=h!==void 0?h:!0);const C=Ue(()=>({index:a,last:d,expanded:v,icon:a+1,active:w,completed:_,disabled:z}),[a,d,v,w,_,z]),I={...i,active:w,orientation:y,alternativeLabel:l,completed:_,disabled:z,expanded:v,component:r},T=Mt(I),D=e(Ut,{as:r,className:H(T.root,p),ref:n,ownerState:I,...u,children:[g&&l&&a!==0?g:null,m]});return e(Ce.Provider,{value:C,children:g&&!l&&a!==0?e(Z,{children:[g,D]}):D})}),Pt=le(e("path",{d:"M12 0a12 12 0 1 0 0 24 12 12 0 0 0 0-24zm-2 17l-5-5 1.4-1.4 3.6 3.6 7.6-7.6L19 8l-9 9z"})),Bt=le(e("path",{d:"M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"}));function Vt(t){return oe("MuiStepIcon",t)}const be=re("MuiStepIcon",["root","active","completed","error","text"]);var ke;const $t=t=>{const{classes:o,active:n,completed:i,error:s}=t;return se({root:["root",n&&"active",i&&"completed",s&&"error"],text:["text"]},Vt,o)},xe=k(Je,{name:"MuiStepIcon",slot:"Root"})(q(({theme:t})=>({display:"block",transition:t.transitions.create("color",{duration:t.transitions.duration.shortest}),color:(t.vars||t).palette.text.disabled,[`&.${be.completed}`]:{color:(t.vars||t).palette.primary.main},[`&.${be.active}`]:{color:(t.vars||t).palette.primary.main},[`&.${be.error}`]:{color:(t.vars||t).palette.error.main}}))),Nt=k("text",{name:"MuiStepIcon",slot:"Text"})(q(({theme:t})=>({fill:(t.vars||t).palette.primary.contrastText,fontSize:t.typography.caption.fontSize,fontFamily:t.typography.fontFamily}))),Et=ie(function(o,n){const i=ae({props:o,name:"MuiStepIcon"}),{active:s=!1,className:m,completed:p=!1,error:r=!1,icon:f,...h}=i,v={...i,active:s,completed:p,error:r},a=$t(v);if(typeof f=="number"||typeof f=="string"){const d=H(m,a.root);return r?e(xe,{as:Bt,className:d,ref:n,ownerState:v,...h}):p?e(xe,{as:Pt,className:d,ref:n,ownerState:v,...h}):e(xe,{className:d,ref:n,ownerState:v,...h,children:[ke||(ke=e("circle",{cx:"12",cy:"12",r:"12"})),e(Nt,{className:a.text,x:"12",y:"12",textAnchor:"middle",dominantBaseline:"central",ownerState:v,children:f})]})}return f});function Ft(t){return oe("MuiStepLabel",t)}const j=re("MuiStepLabel",["root","horizontal","vertical","label","active","completed","error","disabled","iconContainer","alternativeLabel","labelContainer"]),jt=t=>{const{classes:o,orientation:n,active:i,completed:s,error:m,disabled:p,alternativeLabel:r}=t;return se({root:["root",n,m&&"error",p&&"disabled",r&&"alternativeLabel"],label:["label",i&&"active",s&&"completed",m&&"error",p&&"disabled",r&&"alternativeLabel"],iconContainer:["iconContainer",i&&"active",s&&"completed",m&&"error",p&&"disabled",r&&"alternativeLabel"],labelContainer:["labelContainer",r&&"alternativeLabel"]},Ft,o)},Ht=k("span",{name:"MuiStepLabel",slot:"Root",overridesResolver:(t,o)=>{const{ownerState:n}=t;return[o.root,o[n.orientation]]}})({display:"flex",alignItems:"center",[`&.${j.alternativeLabel}`]:{flexDirection:"column"},[`&.${j.disabled}`]:{cursor:"default"},variants:[{props:{orientation:"vertical"},style:{textAlign:"left",padding:"8px 0"}}]}),Ot=k("span",{name:"MuiStepLabel",slot:"Label"})(q(({theme:t})=>({...t.typography.body2,display:"block",transition:t.transitions.create("color",{duration:t.transitions.duration.shortest}),[`&.${j.active}`]:{color:(t.vars||t).palette.text.primary,fontWeight:500},[`&.${j.completed}`]:{color:(t.vars||t).palette.text.primary,fontWeight:500},[`&.${j.alternativeLabel}`]:{marginTop:16},[`&.${j.error}`]:{color:(t.vars||t).palette.error.main}}))),Gt=k("span",{name:"MuiStepLabel",slot:"IconContainer"})({flexShrink:0,display:"flex",paddingRight:8,[`&.${j.alternativeLabel}`]:{paddingRight:0}}),Yt=k("span",{name:"MuiStepLabel",slot:"LabelContainer"})(q(({theme:t})=>({width:"100%",color:(t.vars||t).palette.text.secondary,[`&.${j.alternativeLabel}`]:{textAlign:"center"}}))),$e=ie(function(o,n){const i=ae({props:o,name:"MuiStepLabel"}),{children:s,className:m,componentsProps:p={},error:r=!1,icon:f,optional:h,slots:v={},slotProps:a={},StepIconComponent:d,StepIconProps:u,...S}=i,{alternativeLabel:g,orientation:l}=ee(he),{active:y,disabled:b,completed:w,icon:_}=ee(Ce),z=f||_;let C=d;z&&!C&&(C=Et);const I={...i,active:y,alternativeLabel:g,completed:w,disabled:b,error:r,orientation:l},T=jt(I),D={slots:v,slotProps:{stepIcon:u,...p,...a}},[P,R]=Q("root",{elementType:Ht,externalForwardedProps:{...D,...S},ownerState:I,ref:n,className:H(T.root,m)}),[M,J]=Q("label",{elementType:Ot,externalForwardedProps:D,ownerState:I}),[$,pe]=Q("stepIcon",{elementType:C,externalForwardedProps:D,ownerState:I});return e(P,{...R,children:[z||$?e(Gt,{className:T.iconContainer,ownerState:I,children:e($,{completed:w,active:y,error:r,icon:z,...pe})}):null,e(Yt,{className:T.labelContainer,ownerState:I,children:[s?e(M,{...J,className:H(T.label,J?.className),children:s}):null,h]})]})});$e.muiName="StepLabel";function Qt(t){return oe("MuiStepConnector",t)}re("MuiStepConnector",["root","horizontal","vertical","alternativeLabel","active","completed","disabled","line","lineHorizontal","lineVertical"]);const qt=t=>{const{classes:o,orientation:n,alternativeLabel:i,active:s,completed:m,disabled:p}=t,r={root:["root",n,i&&"alternativeLabel",s&&"active",m&&"completed",p&&"disabled"],line:["line",`line${me(n)}`]};return se(r,Qt,o)},Jt=k("div",{name:"MuiStepConnector",slot:"Root",overridesResolver:(t,o)=>{const{ownerState:n}=t;return[o.root,o[n.orientation],n.alternativeLabel&&o.alternativeLabel,n.completed&&o.completed]}})({flex:"1 1 auto",variants:[{props:{orientation:"vertical"},style:{marginLeft:12}},{props:{alternativeLabel:!0},style:{position:"absolute",top:12,left:"calc(-50% + 20px)",right:"calc(50% + 20px)"}}]}),Kt=k("span",{name:"MuiStepConnector",slot:"Line",overridesResolver:(t,o)=>{const{ownerState:n}=t;return[o.line,o[`line${me(n.orientation)}`]]}})(q(({theme:t})=>{const o=t.palette.mode==="light"?t.palette.grey[400]:t.palette.grey[600];return{display:"block",borderColor:t.vars?t.vars.palette.StepConnector.border:o,variants:[{props:{orientation:"horizontal"},style:{borderTopStyle:"solid",borderTopWidth:1}},{props:{orientation:"vertical"},style:{borderLeftStyle:"solid",borderLeftWidth:1,minHeight:24}}]}})),Zt=ie(function(o,n){const i=ae({props:o,name:"MuiStepConnector"}),{className:s,...m}=i,{alternativeLabel:p,orientation:r="horizontal"}=ee(he),{active:f,disabled:h,completed:v}=ee(Ce),a={...i,alternativeLabel:p,orientation:r,active:f,completed:v,disabled:h},d=qt(a);return e(Jt,{className:H(d.root,s),ref:n,ownerState:a,...m,children:e(Kt,{className:d.line,ownerState:a})})});function Xt(t){return oe("MuiStepper",t)}re("MuiStepper",["root","horizontal","vertical","nonLinear","alternativeLabel"]);const en=t=>{const{orientation:o,nonLinear:n,alternativeLabel:i,classes:s}=t;return se({root:["root",o,n&&"nonLinear",i&&"alternativeLabel"]},Xt,s)},tn=k("div",{name:"MuiStepper",slot:"Root",overridesResolver:(t,o)=>{const{ownerState:n}=t;return[o.root,o[n.orientation],n.alternativeLabel&&o.alternativeLabel,n.nonLinear&&o.nonLinear]}})({display:"flex",variants:[{props:{orientation:"horizontal"},style:{flexDirection:"row",alignItems:"center"}},{props:{orientation:"vertical"},style:{flexDirection:"column"}},{props:{alternativeLabel:!0},style:{alignItems:"flex-start"}}]}),nn=e(Zt,{}),on=ie(function(o,n){const i=ae({props:o,name:"MuiStepper"}),{activeStep:s=0,alternativeLabel:m=!1,children:p,className:r,component:f="div",connector:h=nn,nonLinear:v=!1,orientation:a="horizontal",...d}=i,u={...i,nonLinear:v,alternativeLabel:m,orientation:a,component:f},S=en(u),g=Ke.toArray(p).filter(Boolean),l=g.map((b,w)=>Ze(b,{index:w,last:w+1===g.length,...b.props})),y=Ue(()=>({activeStep:s,alternativeLabel:m,connector:h,nonLinear:v,orientation:a}),[s,m,h,v,a]);return e(he.Provider,{value:y,children:e(tn,{as:f,ownerState:u,className:H(S.root,r),ref:n,...d,children:l})})}),rn=le(e("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m-2 15-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8z"})),an=le(e("path",{d:"m12 8-6 6 1.41 1.41L12 10.83l4.59 4.58L18 14z"})),sn=le(e("path",{d:"M21 6h-2v9H6v2c0 .55.45 1 1 1h11l4 4V7c0-.55-.45-1-1-1m-4 6V3c0-.55-.45-1-1-1H3c-.55 0-1 .45-1 1v14l4-4h10c.55 0 1-.45 1-1"})),ln=le(e("path",{d:"M19.8 18.4 14 10.67V6.5l1.35-1.69c.26-.33.03-.81-.39-.81H9.04c-.42 0-.65.48-.39.81L10 6.5v4.17L4.2 18.4c-.49.66-.02 1.6.8 1.6h14c.82 0 1.29-.94.8-1.6"})),cn=()=>{const t=ee(Xe);if(t===void 0)throw new Error("useSession must be used within a SessionProvider");return t},dn=t=>{const{readCharacteristic:o}=Se(),[n,i]=U(B(!1),"isReading"),[s,m]=U(B(t?.batteryData||null),"batteryData"),[p,r]=U(B(t?.analysis||null),"analysis"),f=We(async(h,v)=>{if(!h||!h.gatt||!h.gatt.connected)throw new Error("Device not connected");console.log("[BatteryDiag] Starting diagnostics using context read..."),i(!0);const a={standardLevel:null,standardError:null,rawHex:null,serviceUuid:null,parsed:null,error:null};try{try{console.log("[BatteryDiag] Reading Standard Battery Service...");const d=await o(et,tt);a.standardLevel=d.getUint8(0),console.log("[BatteryDiag] Standard Level:",a.standardLevel)}catch(d){const u=d instanceof Error?d.message:String(d);console.warn("[BatteryDiag] Standard Battery Read Failed:",u),a.standardError=u}try{console.log("[BatteryDiag] Reading Proprietary Battery Characteristic...");const d=await o(_e,nt),u=new Uint8Array(d.buffer);a.rawHex=Array.from(u).map(y=>y.toString(16).padStart(2,"0").toUpperCase()).join(" "),a.serviceUuid=_e,console.log("[BatteryDiag] Proprietary Data (HEX):",a.rawHex);const S=d.byteLength;let g="Unknown";S===1?g="Single Measure":S===4?g="T1/T5/T10":S===6&&(g="Min/Mean/Max");const l={format:g};if(S===1)l.level=d.getUint8(0);else if(S===4)l.level=d.getUint8(0),l.t1=d.getUint8(1),l.t5=d.getUint8(2),l.temp_C=d.getUint8(3)-25;else if(S===6){const y=new Uint8Array(d.buffer),b=w=>w===G;b(y[0])&&b(y[1])&&b(y[2])&&b(y[3])&&b(y[4])?a.error="Données invalides (255)":(l.first_mV=y[0]===G?void 0:y[0]*100,l.min_mV=y[1]===G?void 0:y[1]*100,l.mean_mV=y[2]===G?void 0:y[2]*100,l.max_mV=y[3]===G?void 0:y[3]*100,l.last_mV=y[4]===G?void 0:y[4]*100,l.temp_C=y[5]===G?void 0:y[5]-25)}else l.rawLength=S;a.parsed=l}catch(d){const u=d instanceof Error?d.message:String(d);console.error("[BatteryDiag] Proprietary Read Error:",u),a.error=u}if(m(a),a.parsed)try{const d=pn(a,v);r(d)}catch(d){console.error("Error analyzing battery data:",d);const u=d instanceof Error?d.message:String(d);a.error=(a.error||"")+` | Analysis failed: ${u}`}}catch(d){console.error("[BatteryDiag] Global Error:",d)}finally{i(!1)}},[o]);return{isReading:n,batteryData:s,analysis:p,readBatteryDiagnostics:f}};function pn(t,o){const n={userClaimType:null,userClaimText:"Inconnue",detectedType:"Unknown",detectedText:"Incertain",finalType:"aaa",consistencyStatus:"neutral",consistencyText:""};if(!t.parsed)return n.consistencyStatus="error",n.consistencyText="Données propriétaires non disponibles",n;const i=t.parsed.last_mV;return o&&(o.answer==="Oui"&&o.inference?(n.userClaimType=o.inference.battery,n.userClaimText=o.inference.label+" (Confirmé)"):o.answer==="Non"?(n.userClaimText="Infirmé par l'utilisateur",n.userClaimType="rejected"):o.answer==="Inconnu"&&(n.userClaimText="Inconnu (Utilisateur)",n.userClaimType="unknown")),i&&(i>5e3?(n.detectedType="aaa",n.detectedText="8x AAA ( > 5V )"):i<4500?(n.detectedType="lsh14",n.detectedText="LSH14 ( < 4.5V )"):n.detectedText=`Ambigu (${(i/1e3).toFixed(2)}V)`),n.userClaimType==="aaa"||n.userClaimType==="lsh14"?n.detectedType!=="Unknown"?n.userClaimType===n.detectedType?(n.finalType=n.detectedType||"aaa",n.consistencyStatus="success",n.consistencyText="✅ Cohérent : Le voltage confirme le matériel."):(n.finalType=n.detectedType||"aaa",n.consistencyStatus="error",n.consistencyText="❌ Incohérence : Le voltage contredit le matériel déclaré !"):(n.finalType=n.userClaimType,n.consistencyStatus="warning",n.consistencyText="⚠️ Voltage ambigu, utilisation du type déclaré."):n.detectedType!=="Unknown"?(n.finalType=n.detectedType||"aaa",n.consistencyStatus="success",n.consistencyText="ℹ️ Type déduit automatiquement du voltage."):(n.finalType="aaa",n.consistencyStatus="warning",n.consistencyText="⚠️ Impossible de déterminer le type (Voltage ambigu). Par défaut : AAA."),n}const un=({isConnected:t,isConnecting:o,connect:n,error:i,device:s,firmwareVersion:m,isLoadingInfo:p,onRetryFetch:r})=>{const{t:f}=ce(["wizard","common"]),h=f;return e(x,{sx:{mt:2},children:[e(c,{variant:"h6",gutterBottom:!0,children:h("connect.title")}),e(c,{variant:"body2",color:"text.secondary",sx:{mb:2},children:h("connect.desc")}),t?e(te,{variant:"outlined",sx:{mt:2,borderColor:"success.main"},children:e(ne,{children:[e(W,{direction:"row",alignItems:"center",spacing:2,sx:{mb:2},children:[e(rn,{color:"success",fontSize:"large"}),e(x,{children:[e(c,{variant:"h6",color:"success.main",children:h("connect.success")}),e(c,{variant:"body2",color:"text.secondary",children:h("connect.ready")})]})]}),e(Be,{sx:{my:2}}),e(c,{variant:"subtitle2",gutterBottom:!0,children:"Informations de l'appareil :"}),e(W,{spacing:1,children:[e(x,{display:"flex",justifyContent:"space-between",children:[e(c,{variant:"body2",color:"text.secondary",children:"Nom :"}),e(c,{variant:"body2",fontWeight:"medium",children:s?.name||"Inconnu"})]}),e(x,{display:"flex",justifyContent:"space-between",children:[e(c,{variant:"body2",color:"text.secondary",children:"ID :"}),e(c,{variant:"body2",fontWeight:"medium",children:s?.id||"Inconnu"})]}),e(x,{display:"flex",justifyContent:"space-between",alignItems:"center",children:[e(c,{variant:"body2",color:"text.secondary",children:"Firmware :"}),e(x,{display:"flex",alignItems:"center",gap:1,children:[e(c,{variant:"body2",fontWeight:"medium",children:p?e(X,{size:12}):m||"Inconnu"}),!p&&e(A,{size:"small",onClick:r,sx:{minWidth:0,p:.5},children:e(ot,{sx:{fontSize:16}})})]})]})]})]})}):e(x,{sx:{display:"flex",flexDirection:"column",alignItems:"center",gap:2,py:4},children:[i&&e(V,{severity:"error",sx:{width:"100%",mb:2},children:i.startsWith("errors.")?h(`common:${i}`):i}),e(A,{variant:"contained",size:"large",startIcon:o?e(X,{size:20,color:"inherit"}):e(Pe,{}),onClick:()=>n(),disabled:o,children:h(o?"common:connecting":"connect.button")})]})]})},mn=({pinCode:t,updateDebugWizardState:o,onOpenDoor:n,isOpening:i,isConnected:s,openDoorSuccess:m,openDoorError:p,batteryData:r,waitingForClose:f,isReadingBattery:h,isPreparing:v,analysis:a})=>{const{t:d}=ce(),u=d;return e(x,{sx:{mt:2},children:[e(c,{variant:"h6",gutterBottom:!0,children:u("wizard:door.title")}),e(c,{variant:"body2",color:"text.secondary",sx:{mb:2},children:u("wizard:door.desc")}),e(W,{spacing:3,children:[e(te,{variant:"outlined",children:e(ne,{children:[e(W,{direction:"row",alignItems:"center",spacing:1,sx:{mb:2},children:[e(Ae,{color:"primary"}),e(c,{variant:"h6",children:u("wizard:door.open")})]}),e(x,{sx:{display:"flex",flexDirection:"column",gap:2},children:[e(we,{label:u("codes:pin_label"),variant:"outlined",size:"small",value:t||"",onChange:S=>{const g=S.currentTarget.value.toUpperCase();/^[0-9AB]*$/.test(g)&&g.length<=6&&o({pinCode:g})},placeholder:u("wizard:door.pin_placeholder"),type:"text",fullWidth:!0,inputProps:{maxLength:6}}),e(A,{variant:"contained",onClick:n,disabled:i||!s,startIcon:i?e(X,{size:20,color:"inherit"}):e(Ae,{}),children:u(i?"wizard:door.opening":"wizard:door.open")}),m&&!p&&e(V,{severity:"success",children:u("wizard:door.success")}),p&&e(V,{severity:"error",children:p})]})]})}),e(te,{variant:"outlined",children:e(ne,{children:[e(W,{direction:"row",alignItems:"center",spacing:1,sx:{mb:2},children:[e(rt,{color:"primary"}),e(c,{variant:"h6",children:u("battery_level")})]}),e(x,{sx:{display:"flex",flexDirection:"column",gap:2},children:[!r&&!f&&!h&&!v&&e(V,{severity:"info",children:u("wizard:battery.wait")}),f&&e(V,{severity:"info",icon:e(X,{size:20}),children:u("wizard:battery.waiting_close")}),(h||v)&&e(V,{severity:"info",icon:e(X,{size:20}),children:u("wizard:battery.analyzing")}),r&&e(x,{sx:{mt:2,p:2,bgcolor:"background.paper",borderRadius:1,border:1,borderColor:"divider"},children:[e(x,{display:"flex",justifyContent:"space-between",mb:1,children:[e(c,{variant:"body2",color:"text.primary",children:[u("wizard:battery.standard_level"),":"]}),e(c,{variant:"body2",fontWeight:"bold",color:"text.primary",children:r.standardLevel!==null?`${r.standardLevel}%`:"N/A"})]}),r.parsed&&e(Z,{children:[e(Be,{sx:{my:1}}),e(c,{variant:"subtitle2",gutterBottom:!0,color:"text.primary",children:[u("wizard:battery.proprietary_data")," (",r.parsed.format,")"]}),r.parsed.level!==void 0&&e(x,{display:"flex",justifyContent:"space-between",children:[e(c,{variant:"body2",color:"text.primary",children:[u("battery_level")," (Proprietary):"]}),e(c,{variant:"body2",fontWeight:"bold",color:"text.primary",children:[r.parsed.level,"%"]})]}),r.parsed.first_mV!==void 0&&e(x,{display:"flex",justifyContent:"space-between",children:[e(c,{variant:"body2",color:"text.primary",children:"Voltage (First):"}),e(c,{variant:"body2",fontWeight:"bold",color:"text.primary",children:r.parsed.first_mV!==null?`${(r.parsed.first_mV/1e3).toFixed(2)} V`:"N/A"})]}),r.parsed.min_mV!==void 0&&e(x,{display:"flex",justifyContent:"space-between",children:[e(c,{variant:"body2",color:"text.primary",children:"Voltage (Min):"}),e(c,{variant:"body2",fontWeight:"bold",color:"text.primary",children:r.parsed.min_mV!==null?`${(r.parsed.min_mV/1e3).toFixed(2)} V`:"N/A"})]}),r.parsed.mean_mV!==void 0&&e(x,{display:"flex",justifyContent:"space-between",children:[e(c,{variant:"body2",color:"text.primary",children:"Voltage (Mean):"}),e(c,{variant:"body2",fontWeight:"bold",color:"text.primary",children:r.parsed.mean_mV!==null?`${(r.parsed.mean_mV/1e3).toFixed(2)} V`:"N/A"})]}),r.parsed.max_mV!==void 0&&e(x,{display:"flex",justifyContent:"space-between",children:[e(c,{variant:"body2",color:"text.primary",children:"Voltage (Max):"}),e(c,{variant:"body2",fontWeight:"bold",color:"text.primary",children:r.parsed.max_mV!==null?`${(r.parsed.max_mV/1e3).toFixed(2)} V`:"N/A"})]}),r.parsed.last_mV!==void 0&&e(x,{display:"flex",justifyContent:"space-between",children:[e(c,{variant:"body2",color:"text.primary",children:[u("wizard:battery.voltage_last"),":"]}),e(c,{variant:"body2",fontWeight:"bold",color:"text.primary",children:r.parsed.last_mV!==null?`${(r.parsed.last_mV/1e3).toFixed(2)} V`:"N/A"})]}),r.parsed.t1!==void 0&&e(x,{display:"flex",justifyContent:"space-between",children:[e(c,{variant:"body2",color:"text.primary",children:"T1:"}),e(c,{variant:"body2",fontWeight:"bold",color:"text.primary",children:r.parsed.t1})]}),r.parsed.t5!==void 0&&e(x,{display:"flex",justifyContent:"space-between",children:[e(c,{variant:"body2",color:"text.primary",children:"T5:"}),e(c,{variant:"body2",fontWeight:"bold",color:"text.primary",children:r.parsed.t5})]}),r.parsed.temp_C!==void 0&&e(x,{display:"flex",justifyContent:"space-between",children:[e(c,{variant:"body2",color:"text.primary",children:[u("wizard:battery.temperature"),":"]}),e(c,{variant:"body2",fontWeight:"bold",color:"text.primary",children:r.parsed.temp_C!==null?`${r.parsed.temp_C}°C`:"N/A"})]}),a&&e(x,{sx:{mt:2,p:1,border:"1px solid",borderColor:"divider",borderRadius:1,bgcolor:"background.paper"},children:[e(c,{variant:"caption",display:"block",color:"text.secondary",children:[u("wizard:battery.analysis"),":"]}),e(c,{variant:"body2",gutterBottom:!0,color:"text.primary",children:[u("wizard:battery.detected_type"),":"," ",e("strong",{children:a.detectedText})]}),e(c,{variant:"body2",color:a.consistencyStatus==="success"?"success.main":a.consistencyStatus==="error"?"error.main":"warning.main",fontWeight:"medium",children:a.consistencyText})]})]}),r.error&&e(V,{severity:"warning",sx:{mt:1},children:r.error})]})]})]})})]})]})},hn=({questionAnswers:t,onAnswerQuestion:o})=>{const{t:n}=ce(["wizard","common"]),i=[{id:"has_scale",text:n("questions.has_scale"),expected:"Non"},{id:"anything_special",text:n("questions.anything_special"),expected:"Non"}];return e(x,{sx:{mt:2},children:[e(c,{variant:"h6",gutterBottom:!0,children:n("questions.title")}),e(c,{variant:"body2",color:"text.secondary",sx:{mb:2},children:n("questions.desc")}),e(W,{spacing:2,children:i.map(s=>{const m=t.find(p=>p.id===s.id);return e(te,{variant:"outlined",children:e(ne,{children:[e(W,{direction:"row",spacing:1,alignItems:"flex-start",mb:2,children:[e(sn,{color:"action"}),e(c,{variant:"subtitle1",fontWeight:"medium",children:s.text})]}),e(W,{direction:"row",spacing:1,children:[e(A,{variant:m?.answer==="Oui"?"contained":"outlined",onClick:()=>o(s.id,"Oui",s.expected),color:m?.answer==="Oui"?"primary":"inherit",children:n("common:yes")}),e(A,{variant:m?.answer==="Non"?"contained":"outlined",onClick:()=>o(s.id,"Non",s.expected),color:m?.answer==="Non"?"primary":"inherit",children:n("common:no")}),e(A,{variant:m?.answer==="Inconnu"?"contained":"outlined",onClick:()=>o(s.id,"Inconnu",s.expected),color:m?.answer==="Inconnu"?"secondary":"inherit",children:n("common:unknown")})]})]})},s.id)})})]})},yn=({customUuids:t,customResults:o,updateDebugWizardState:n})=>{const{t:i}=ce(["wizard","common","codes"]),{connect:s,disconnect:m,device:p}=Se(),[r,f]=U(B(!1),"showAdvanced"),[h,v]=U(B(""),"customUuidInput"),[a,d]=U(B(!1),"isDiscoveringCustom"),u=()=>{if(!h)return;const l=h.trim().toLowerCase();t.includes(l)||(n({customUuids:[...t,l]}),v(""))},S=l=>{n({customUuids:t.filter(y=>y!==l)})},g=async()=>{if(t.length!==0){d(!0);try{console.log("DebugWizard: Disconnecting for custom discovery..."),m(),await new Promise(b=>setTimeout(b,dt)),console.log("DebugWizard: Reconnecting with custom services:",t),await s(t),await new Promise(b=>setTimeout(b,pt));const l=[],y=p;y?.gatt?.connected||console.warn("Device not marked as connected yet, checking GATT directly...");for(const b of t)try{console.log(`DebugWizard: Accessing service ${b}`);const w=y?.gatt;if(!w)continue;const z=await(await w.getPrimaryService(b)).getCharacteristics();for(const C of z)try{console.log(`DebugWizard: Reading characteristic ${C.uuid}`);const I=await C.readValue(),T=new Uint8Array(I.buffer),D=Array.from(T).map(P=>P.toString(16).padStart(2,"0").toUpperCase()).join(" ");l.push({serviceUuid:b,charUuid:C.uuid,value:D,timestamp:new Date().toISOString()})}catch(I){console.warn(`Failed to read char ${C.uuid} in service ${b}`,I)}}catch(w){console.warn(`Failed to access service ${b}`,w)}n({customResults:l})}catch(l){console.error("Custom discovery failed:",l)}finally{d(!1)}}};return e(x,{sx:{mt:2},children:[e(c,{variant:"h6",gutterBottom:!0,children:i("advanced.title")}),e(V,{severity:"info",sx:{mb:3},children:i("advanced.warning")}),e(W,{spacing:3,children:[e(te,{variant:"outlined",children:e(ne,{children:[e(x,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",cursor:"pointer"},onClick:()=>f(!r),children:[e(W,{direction:"row",alignItems:"center",spacing:1,children:[e(ln,{color:"primary"}),e(c,{variant:"h6",children:i("advanced.tutorial_title")})]}),e(Ve,{children:r?e(an,{}):e(it,{})})]}),e(at,{in:r,children:e(x,{sx:{mt:3},children:[e(c,{variant:"body2",sx:{mb:2},children:i("advanced.tutorial_desc")}),e(W,{direction:"row",spacing:2,sx:{mt:2,justifyContent:"center"},children:[e(A,{variant:"outlined",href:"https://play.google.com/store/apps/details?id=no.nordicsemi.android.mcp",target:"_blank",rel:"noopener noreferrer",children:"Android (Play Store)"}),e(A,{variant:"outlined",href:"https://apps.apple.com/us/app/nrf-connect-for-mobile/id1054362403",target:"_blank",rel:"noopener noreferrer",children:"iOS (App Store)"})]})]})})]})}),e(te,{variant:"outlined",children:e(ne,{children:[e(c,{variant:"subtitle1",gutterBottom:!0,fontWeight:"bold",children:i("advanced.explorer_title")}),e(c,{variant:"body2",color:"text.secondary",sx:{mb:2},children:i("advanced.explorer_desc")}),e(x,{sx:{display:"flex",gap:1,mb:2},children:[e(we,{size:"small",fullWidth:!0,placeholder:"ex: 0000180f-0000-1000-8000-00805f9b34fb",value:h,onChange:l=>v(l.currentTarget.value),onKeyPress:l=>l.key==="Enter"&&u()}),e(A,{variant:"outlined",onClick:u,children:i("codes:add_new")})]}),e(x,{sx:{display:"flex",flexWrap:"wrap",gap:1,mb:3},children:t.map(l=>e(wt,{label:l,onDelete:()=>S(l),size:"small",color:"primary",variant:"outlined"},l))}),e(A,{variant:"contained",fullWidth:!0,disabled:t.length===0||a,onClick:g,startIcon:a?e(X,{size:20,color:"inherit"}):e(Pe,{}),children:i(a?"advanced.exploring":"advanced.explore_button")}),o.length>0&&e(x,{sx:{mt:3},children:[e(c,{variant:"subtitle2",gutterBottom:!0,children:["Résultats trouvés : ",o.length]}),e(st,{dense:!0,children:o.map((l,y)=>e(lt,{divider:!0,children:e(ct,{primary:`Char: ${l.charUuid.substring(0,8)}...`,secondary:`Service: ${l.serviceUuid.substring(0,8)}... | Val: ${l.value}`,secondaryTypographyProps:{sx:{fontFamily:"monospace",fontSize:"0.75rem"}}})},y))})]})]})})]})]})},vn=({device:t,firmwareVersion:o,hardwareInference:n,deviceInfo:i,batteryData:s,analysis:m,pinCode:p,openDoorSuccess:r,openDoorError:f,questionAnswers:h,customUuids:v,customResults:a,serviceUuid:d,serviceResults:u})=>{const{t:S}=ce(["wizard","common","codes"]),[g,l]=U(B(!1),"copySuccess"),y={device:{name:t?.name,id:t?.id,firmwareVersion:o,hardwareInference:n,deviceInfo:i},status:{battery:s,analysis:m,doorTest:{attempted:!!p,success:r,error:f}},questionAnswers:h,customDiscovery:{uuids:v,results:a},advanced:{serviceUuid:d,results:u},timestamp:new Date().toISOString()},b=JSON.stringify(y,null,2),w=()=>{navigator.clipboard.writeText(b),l(!0)},_=!n||n.version==="Unknown",z=a.length>0,C=m?.consistencyStatus==="error"||m?.consistencyStatus==="warning",I=h.find(R=>R.id==="has_scale"&&R.answer==="Oui"),T=h.find(R=>R.id==="anything_special"&&R.answer==="Oui"),D=_||z||C||I||T,P=()=>{const R=`Debug Data: ${t?.name||"Unknown Boks"} - ${o||"Unknown FW"}`,M="```",J=`Please find below the debug data captured via the Boks Web BLE tool.

${M}json
${b}
${M}`,$=new URLSearchParams;return $.set("title",R),$.set("body",J),`${yt}?${$.toString()}`};return e(x,{sx:{mt:2},children:[e(c,{variant:"h6",gutterBottom:!0,children:S("recap.title")}),e(c,{variant:"body2",color:"text.secondary",sx:{mb:2},children:S("recap.desc")}),D&&e(V,{severity:"info",icon:e(ut,{}),sx:{mb:3},action:e(A,{color:"inherit",size:"small",href:P(),target:"_blank",onClick:()=>{},children:[" ",S("recap.open_issue")]}),children:S("recap.interesting_found")}),e(x,{sx:{position:"relative"},children:[e(we,{multiline:!0,fullWidth:!0,minRows:10,maxRows:20,value:b,variant:"outlined",InputProps:{readOnly:!0,style:{fontFamily:"monospace",fontSize:"0.875rem"}}}),e(Ve,{onClick:w,sx:{position:"absolute",top:8,right:8,bgcolor:"background.paper"},title:S("codes:copy_to_clipboard"),children:e(mt,{})})]}),e(ht,{open:g,autoHideDuration:3e3,onClose:()=>l(!1),message:"Données de débogage copiées dans le presse-papier"})]})},wn=()=>{const{t}=ce(),o=t,n=[o("wizard:steps.step1"),o("wizard:steps.step2"),o("wizard:steps.step3"),o("wizard:steps.step4"),o("wizard:steps.step5")],i=vt(),s=gt(i.breakpoints.down("sm")),{debugWizardState:m,updateDebugWizardState:p,resetDebugWizardState:r}=cn(),{activeDevice:f}=ft(),{device:h,isConnected:v,connect:a,disconnect:d,getDeviceInfo:u,error:S}=Se(),{activeStep:g,firmwareVersion:l,hardwareInference:y,deviceInfo:b,pinCode:w,openDoorSuccess:_,openDoorError:z,questionAnswers:C=[],serviceUuid:I,serviceResults:T=[],batteryData:D,batteryAnalysis:P,customUuids:R=[],customResults:M=[]}=m,{openDoor:J,isOpening:$,doorStatus:pe}=bt(),{isReading:Ne,batteryData:ye,analysis:Ie,readBatteryDiagnostics:Le}=dn({batteryData:m.batteryData,analysis:m.batteryAnalysis}),[ue,ze]=U(B(!1),"isLoadingInfo"),de=U(xt(!1),"isFetchingRef"),[ve,ge]=U(B(!1),"waitingForClose"),[fe,Te]=U(B(!1),"isPreparing");Y(()=>(console.log("DebugWizard: Component Mounted"),()=>console.log("DebugWizard: Component Unmounted")),[]),Y(()=>{console.log(`DebugWizard: isConnected=${v}, activeDevice=${f?.id||"none"}`)},[v,f?.id]),Y(()=>{f?.door_pin_code&&!w&&p({pinCode:f.door_pin_code})},[f,w,p]),Y(()=>{console.log("DebugWizard: Check conditions - isConnected:",v,"firmwareVersion:",l,"isLoadingInfo:",ue,"isFetchingRef:",de.current);const L=!0;v&&!l&&!ue&&!de.current&&(async()=>{if(de.current){console.log("DebugWizard: already fetching, skipping");return}console.log("DebugWizard: condition met, starting fetchInfo"),de.current=!0,ze(!0);try{console.log("DebugWizard: Starting device info fetch sequence...");const N=await u(),E=N["Firmware Revision"];console.log("DebugWizard: Raw firmware revision:",E);const F=St(E);console.log("DebugWizard: Hardware Inference result:",F);let O=E||"Inconnu";F.version!=="Unknown"&&(O+=` (v${F.version} - ${F.label})`),console.log("DebugWizard: Final display version string:",O),p({firmwareVersion:O,hardwareInference:F,deviceInfo:N}),console.log("DebugWizard: Called updateDebugWizardState with:",O)}catch(N){console.error("DebugWizard: Error in fetchInfo:",N)}finally{setTimeout(()=>{ze(!1),de.current=!1,console.log("DebugWizard: Fetch sequence finished and lock cleared.")},500)}})()},[v,l,ue,p,u]);const Ee=()=>{p({firmwareVersion:null})},Fe=()=>{p({activeStep:g+1})},je=()=>{p({activeStep:g-1})},He=()=>{r(),d()},Oe=async()=>{if(p({openDoorError:null,openDoorSuccess:!1}),!w||w.length<4){p({openDoorError:"Veuillez entrer un code PIN valide (au moins 4 chiffres)"});return}try{await J(w),ge(!0),p({openDoorSuccess:!0})}catch(L){ge(!1);const K=L instanceof Error?L.message:String(L);p({openDoorError:K||"Échec de l'ouverture de la porte"})}},De=We(async()=>{if(!h){console.warn("DebugWizard: No device for battery check");return}console.log("DebugWizard: Executing battery diagnostics...");const L=C.find(N=>N.id==="hardware_check"),K=L?{answer:L.answer,inference:y||{battery:"Unknown",label:"Unknown"}}:void 0;await Le(h,K)},[h,C,y,Le]);Y(()=>{ve&&pe==="closed"&&(console.log("DebugWizard: Door closed, initiating battery check sequence"),ge(!1),Te(!0))},[pe,ve]),Y(()=>{if(fe){const L=setTimeout(()=>{console.log("DebugWizard: Preparation delay finished, checking battery..."),Te(!1),De()},2e3);return()=>clearTimeout(L)}},[fe,De]),Y(()=>{ye&&p({batteryData:ye,batteryAnalysis:Ie})},[ye,Ie,p]);const Ge=(L,K,N)=>{const E=[...C||[]],F=E.findIndex(Qe=>Qe.id===L),O={id:L,answer:K,expected:N,timestamp:new Date().toISOString()};F>=0?E[F]=O:E.push(O),p({questionAnswers:E})},Ye=L=>{switch(L){case 0:return e(un,{isConnected:v,isConnecting:!1,connect:a,error:S,device:h,firmwareVersion:l,isLoadingInfo:ue,onRetryFetch:Ee});case 1:return e(mn,{pinCode:w,updateDebugWizardState:p,onOpenDoor:Oe,isOpening:$,isConnected:v,openDoorSuccess:_,openDoorError:z,batteryData:D,waitingForClose:ve,isReadingBattery:Ne,isPreparing:fe,analysis:P});case 2:return e(hn,{questionAnswers:C,onAnswerQuestion:Ge});case 3:return e(yn,{customUuids:R,customResults:M,updateDebugWizardState:p});case 4:return e(vn,{device:h,firmwareVersion:l,hardwareInference:y,deviceInfo:b,batteryData:D,analysis:P,pinCode:w,openDoorSuccess:_,openDoorError:z,questionAnswers:C,customUuids:R,customResults:M,serviceUuid:I,serviceResults:T});default:return"Unknown step"}};return e(It,{maxWidth:"md",sx:{mt:4,mb:4,px:s?1:3},children:e(Re,{sx:{p:s?2:4},children:[e(c,{variant:s?"h5":"h4",component:"h1",gutterBottom:!0,align:"center",children:o("wizard:title")}),s?e(x,{sx:{mb:2},children:[e(kt,{variant:"text",steps:n.length,position:"static",activeStep:g,nextButton:null,backButton:null,sx:{bgcolor:"transparent",justifyContent:"center","& .MuiMobileStepper-dot":{mx:.5}}}),e(c,{variant:"subtitle2",align:"center",color:"primary",sx:{mt:1},children:g<n.length?n[g]:o("common:finish")})]}):e(on,{activeStep:g,sx:{pt:3,pb:5},alternativeLabel:!0,children:n.map(L=>e(Wt,{children:e($e,{children:L})},L))}),e(Z,{children:g===n.length?e(Z,{children:[e(c,{variant:"h5",gutterBottom:!0,children:o("wizard:finished.title")}),e(c,{variant:"subtitle1",children:o("wizard:finished.desc")}),e(x,{sx:{display:"flex",justifyContent:"flex-end",mt:3},children:e(A,{onClick:He,children:o("common:reset")})})]}):e(Z,{children:[Ye(g),e(x,{sx:{display:"flex",justifyContent:"flex-end",mt:3},children:[g!==0&&e(A,{onClick:je,sx:{mr:1},children:o("common:back")}),e(A,{variant:"contained",onClick:Fe,disabled:g===0&&!v,children:g===n.length-1?o("common:finish"):o("common:next")})]})]})})]})})};export{wn as DebugWizardPage};
