import{e as X,j as e,g as ee,a as te,r as d,u as se,d as G,c as ae,b as ne,s as P,m as de,J as ue,f as K,n as W,R as ge,k as y,T as j,D as me,z as fe,A as he,K as U,U as xe,M as Y,N as H,C as oe,l as k,Q as _e,S as pe,V as ve,W as F,X as ye,Y as w,Z as be,_ as je,$ as Se,a0 as M,a1 as re,a2 as ie,a3 as ce,a4 as Ie,a5 as Ce,a6 as Re,a7 as O,a8 as Te,i as Ee,o as we,p as Ae}from"./index-C2JwI2fF.js";import{I as q,V as $,a as Q,A as ke}from"./VisibilityOff-BVGRa_jO.js";import{F as J,S as Z,T as De,a as z}from"./Tabs-DL3bDUqS.js";import{D as Fe}from"./Delete-DT6nOAMU.js";const Ne=X(e.jsx("path",{d:"M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"}));function Le(t){return ee("MuiAvatar",t)}te("MuiAvatar",["root","colorDefault","circular","rounded","square","img","fallback"]);const Oe=t=>{const{classes:a,variant:s,colorDefault:n}=t;return ne({root:["root",s,n&&"colorDefault"],img:["img"],fallback:["fallback"]},Le,a)},Ue=P("div",{name:"MuiAvatar",slot:"Root",overridesResolver:(t,a)=>{const{ownerState:s}=t;return[a.root,a[s.variant],s.colorDefault&&a.colorDefault]}})(de(({theme:t})=>({position:"relative",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0,width:40,height:40,fontFamily:t.typography.fontFamily,fontSize:t.typography.pxToRem(20),lineHeight:1,borderRadius:"50%",overflow:"hidden",userSelect:"none",variants:[{props:{variant:"rounded"},style:{borderRadius:(t.vars||t).shape.borderRadius}},{props:{variant:"square"},style:{borderRadius:0}},{props:{colorDefault:!0},style:{color:(t.vars||t).palette.background.default,...t.vars?{backgroundColor:t.vars.palette.Avatar.defaultBg}:{backgroundColor:t.palette.grey[400],...t.applyStyles("dark",{backgroundColor:t.palette.grey[600]})}}}]}))),Pe=P("img",{name:"MuiAvatar",slot:"Img"})({width:"100%",height:"100%",textAlign:"center",objectFit:"cover",color:"transparent",textIndent:1e4}),Ge=P(Ne,{name:"MuiAvatar",slot:"Fallback"})({width:"75%",height:"75%"});function Me({crossOrigin:t,referrerPolicy:a,src:s,srcSet:n}){const[r,u]=d.useState(!1);return d.useEffect(()=>{if(!s&&!n)return;u(!1);let h=!0;const c=new Image;return c.onload=()=>{h&&u("loaded")},c.onerror=()=>{h&&u("error")},c.crossOrigin=t,c.referrerPolicy=a,c.src=s,n&&(c.srcset=n),()=>{h=!1}},[t,a,s,n]),r}const ze=d.forwardRef(function(a,s){const n=se({props:a,name:"MuiAvatar"}),{alt:r,children:u,className:h,component:c="div",slots:o={},slotProps:v={},imgProps:p,sizes:b,src:S,srcSet:C,variant:R="circular",...i}=n;let g=null;const m={...n,component:c,variant:R},l=Me({...p,...typeof v.img=="function"?v.img(m):v.img,src:S,srcSet:C}),I=S||C,E=I&&l!=="error";m.colorDefault=!E,delete m.ownerState;const D=Oe(m),[x,A]=G("root",{ref:s,className:ae(D.root,h),elementType:Ue,externalForwardedProps:{slots:o,slotProps:v,component:c,...i},ownerState:m}),[N,_]=G("img",{className:D.img,elementType:Pe,externalForwardedProps:{slots:o,slotProps:{img:{...p,...v.img}}},additionalProps:{alt:r,src:S,srcSet:C,sizes:b},ownerState:m}),[T,L]=G("fallback",{className:D.fallback,elementType:Ge,externalForwardedProps:{slots:o,slotProps:v},shouldForwardComponentProp:!0,ownerState:m});return E?g=e.jsx(N,{..._}):u||u===0?g=u:I&&r?g=r[0]:g=e.jsx(T,{...L}),e.jsx(x,{...A,children:g})});function Ve(t){return ee("MuiListItemAvatar",t)}te("MuiListItemAvatar",["root","alignItemsFlexStart"]);const Be=t=>{const{alignItems:a,classes:s}=t;return ne({root:["root",a==="flex-start"&&"alignItemsFlexStart"]},Ve,s)},Ye=P("div",{name:"MuiListItemAvatar",slot:"Root",overridesResolver:(t,a)=>{const{ownerState:s}=t;return[a.root,s.alignItems==="flex-start"&&a.alignItemsFlexStart]}})({minWidth:56,flexShrink:0,variants:[{props:{alignItems:"flex-start"},style:{marginTop:8}}]}),He=d.forwardRef(function(a,s){const n=se({props:a,name:"MuiListItemAvatar"}),{className:r,...u}=n,h=d.useContext(ue),c={...n,alignItems:h.alignItems},o=Be(c);return e.jsx(Ye,{className:ae(o.root,r),ownerState:c,ref:s,...u})}),Xe=X(e.jsx("path",{d:"M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20z"})),Ke=X(e.jsx("path",{d:"M20 2H4c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2m0 18H4V4h16zM18 6h-5c-1.1 0-2 .9-2 2v2.28c-.6.35-1 .98-1 1.72 0 1.1.9 2 2 2s2-.9 2-2c0-.74-.4-1.38-1-1.72V8h3v8H8V8h2V6H6v12h12z"})),We=({deviceId:t})=>{const{t:a}=K(["common","settings"]),{activeDevice:s,updateDeviceDetails:n,removeDevice:r,toggleLaPoste:u}=W(),[h,c]=d.useState(!1),[o,v]=d.useState({key:!s?.configuration_key,pin:!s?.door_pin_code}),[p,b]=d.useState(s?.friendly_name||""),[S,C]=d.useState(s?.configuration_key||""),[R,i]=d.useState(s?.door_pin_code||""),[g,m]=d.useState(s?.auto_sync??!1);ge.useEffect(()=>{s&&(b(s.friendly_name||""),C(s.configuration_key||""),i(s.door_pin_code||""),m(s.auto_sync??!1))},[s]);const l=_=>{v(T=>({...T,[_]:!T[_]}))},I=async()=>{if(s)try{await n(t,{friendly_name:p,configuration_key:S,door_pin_code:R})}catch(_){console.error("Failed to update device details:",_)}},E=async _=>{c(!0);try{await u(_.target.checked)}catch(T){console.error("Failed to toggle La Poste:",T)}finally{c(!1)}},D=async()=>{if(s)try{await r(t)}catch(_){console.error("Failed to remove device:",_)}},x=_=>{const L=_.trim().toUpperCase().replace(/[^0-9A-F]/g,"").slice(-8);C(L)},A=async _=>{const T=_.target.checked;if(m(T),s)try{await n(t,{auto_sync:T})}catch(L){console.error("Failed to update auto sync:",L)}},N=_=>{const T=_.trim().toUpperCase();i(T)};return s?e.jsxs(y,{sx:{my:2},children:[e.jsx(j,{variant:"subtitle1",gutterBottom:!0,children:a("devices.title")}),e.jsx(me,{sx:{mb:2}}),e.jsx(fe,{children:e.jsx(he,{children:e.jsxs(y,{sx:{display:"flex",flexDirection:"column",gap:2},children:[e.jsx(U,{label:a("devices.device_name"),value:p,onChange:_=>b(_.currentTarget.value),fullWidth:!0,size:"small"}),s.role===xe.Admin&&e.jsx(U,{label:a("settings:configuration_key.label"),value:S,onChange:_=>x(_.currentTarget.value),fullWidth:!0,size:"small",type:o.key?"text":"password",helperText:a("settings:configuration_key.helper"),slotProps:{input:{endAdornment:e.jsx(q,{position:"end",children:e.jsx(Y,{"aria-label":a("settings:toggle_key_visibility"),onClick:()=>l("key"),edge:"end",size:"small",children:o.key?e.jsx($,{}):e.jsx(Q,{})})})}}}),e.jsx(U,{label:a("settings:door_pin_code"),value:R,onChange:_=>N(_.currentTarget.value),fullWidth:!0,size:"small",type:o.pin?"text":"password",slotProps:{input:{endAdornment:e.jsx(q,{position:"end",children:e.jsx(Y,{"aria-label":a("settings:toggle_pin_visibility"),onClick:()=>l("pin"),edge:"end",size:"small",children:o.pin?e.jsx($,{}):e.jsx(Q,{})})})}}}),e.jsx(J,{control:e.jsx(Z,{checked:g,onChange:A}),label:a("settings:device_auto_sync")}),s.hardware_version==="4.0"&&s.software_revision&&H(s.software_revision,"4.2.0")>=0&&e.jsxs(y,{sx:{display:"flex",alignItems:"center"},children:[e.jsx(J,{control:e.jsx(Z,{"data-testid":"la-poste-switch",checked:s.la_poste_activated||!1,onChange:E,disabled:h}),label:a("settings:activate_la_poste")}),h&&e.jsx(oe,{size:20,sx:{ml:1}})]}),e.jsxs(y,{sx:{display:"flex",justifyContent:"space-between",mt:2},children:[e.jsx(k,{size:"small",color:"error",variant:"outlined",onClick:D,children:a("devices.forget")}),e.jsx(k,{size:"small",variant:"contained",onClick:I,children:a("save")})]})]})})})]}):null};var le=(t=>(t[t.LA_POSTE=1]="LA_POSTE",t[t.VIGIK_TERTIARY=2]="VIGIK_TERTIARY",t[t.USER_BADGE=3]="USER_BADGE",t))(le||{}),f=(t=>(t.IDLE="idle",t.SCANNING="scanning",t.FOUND="found",t.TIMEOUT="timeout",t.ERROR_EXISTS="error_exists",t.ERROR="error",t))(f||{});const qe=()=>{const{activeDevice:t}=W(),{sendRequest:a}=_e(),{addListener:s,removeListener:n}=pe(),[r,u]=d.useState(f.IDLE),[h,c]=d.useState(null),o=t?.id,v=ve(()=>o?F.nfc_tags.where("device_id").equals(o).toArray():[],[o]),p=d.useCallback(async()=>{if(!o)throw new Error("No active device");const i=await F.device_secrets.get(o);if(!i?.configuration_key)throw new Error("Configuration Key required");return i.configuration_key},[o]),b=d.useCallback(async()=>{try{const i=await p();u(f.SCANNING),c(null),await a(new ye(i))}catch(i){console.error("Failed to start scan",i),u(f.ERROR)}},[p,a]);d.useEffect(()=>{const i=g=>{if(!(r!==f.SCANNING&&r!==f.IDLE)&&[w.NOTIFY_NFC_TAG_REGISTER_SCAN_RESULT,w.NOTIFY_NFC_TAG_REGISTER_SCAN_ERROR_EXISTS,w.NOTIFY_NFC_TAG_REGISTER_SCAN_TIMEOUT].includes(g.opcode)){const m=new Se(g.opcode);switch(m.parse(g.payload),m.status){case M.TIMEOUT:u(f.TIMEOUT);break;case M.ALREADY_EXISTS:u(f.ERROR_EXISTS),m.uid&&c(m.uid);break;case M.FOUND:u(f.FOUND),m.uid&&c(m.uid);break;default:u(f.ERROR)}}};return s(w.NOTIFY_NFC_TAG_REGISTER_SCAN_RESULT,i),s(w.NOTIFY_NFC_TAG_REGISTER_SCAN_ERROR_EXISTS,i),s(w.NOTIFY_NFC_TAG_REGISTER_SCAN_TIMEOUT,i),()=>{n(w.NOTIFY_NFC_TAG_REGISTER_SCAN_RESULT,i),n(w.NOTIFY_NFC_TAG_REGISTER_SCAN_ERROR_EXISTS,i),n(w.NOTIFY_NFC_TAG_REGISTER_SCAN_TIMEOUT,i)}},[s,n,r]);const S=d.useCallback(async i=>{if(!(!h||!o))try{const g=await p(),m=new Uint8Array(h.split(":").map(I=>parseInt(I,16)));if(r===f.FOUND){const I=new be(g,m);await a(I)}const l=await F.nfc_tags.where({device_id:o,uid:h}).first();l?await F.nfc_tags.update(l.id,{name:i,updated_at:Date.now()}):await F.nfc_tags.add({id:crypto.randomUUID(),device_id:o,uid:h,name:i,type:le.USER_BADGE,created_at:Date.now(),sync_status:"created"}),u(f.IDLE),c(null)}catch(g){throw console.error("Failed to register tag",g),g}},[h,o,p,a,r]),C=d.useCallback(async i=>{if(o)try{const g=await p(),m=new Uint8Array(i.uid.split(":").map(I=>parseInt(I,16))),l=new je(g,m);await a(l),await F.nfc_tags.delete(i.id)}catch(g){throw console.error("Failed to unregister tag",g),g}},[o,p,a]),R=d.useCallback(()=>{u(f.IDLE),c(null)},[]);return{tags:v,scanStatus:r,scannedUid:h,startScan:b,registerTag:S,unregisterTag:C,resetScan:R}},$e=()=>{const{t}=K(["common","settings"]),a=t,{tags:s,scanStatus:n,scannedUid:r,startScan:u,registerTag:h,unregisterTag:c,resetScan:o}=qe(),[v,p]=d.useState(!1),[b,S]=d.useState(""),C=()=>{o(),S(""),p(!0)},R=()=>{p(!1),o()},i=()=>{u()},g=async()=>{if(b.trim())try{await h(b.trim()),R()}catch(l){console.error(l)}},m=async l=>{if(confirm(a("common:confirm_delete")))try{await c(l)}catch(I){console.error(I),alert(t("settings:nfc.error_delete_failed"))}};return d.useEffect(()=>{if(r&&!b){const l=`Badge ${r.substring(0,5)}`;b!==l&&S(l)}},[r]),e.jsxs(y,{sx:{p:2},children:[e.jsxs(y,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2},children:[e.jsx(j,{variant:"h6","data-testid":"nfc-tags-title",children:t("settings:nfc.title")}),e.jsx(k,{variant:"contained",startIcon:e.jsx(ke,{}),onClick:C,children:t("settings:nfc.add_tag")})]}),s&&s.length>0?e.jsx(re,{children:s.map(l=>e.jsxs(ie,{secondaryAction:e.jsx(Y,{edge:"end","aria-label":"delete",onClick:()=>m(l),children:e.jsx(Fe,{})}),children:[e.jsx(He,{children:e.jsx(ze,{children:e.jsx(Ke,{})})}),e.jsx(ce,{primary:l.name,secondary:e.jsxs(e.Fragment,{children:[e.jsx(j,{component:"span",variant:"body2",color:"textPrimary",children:l.uid}),e.jsx("br",{}),l.last_seen_at?t("settings:nfc.last_seen",{date:new Date(l.last_seen_at).toLocaleString()}):t("settings:nfc.never_seen")]})})]},l.id))}):e.jsx(j,{variant:"body1",color:"textSecondary",align:"center",sx:{mt:4},children:t("settings:nfc.no_tags")}),e.jsxs(Ie,{open:v,onClose:R,fullWidth:!0,maxWidth:"sm",children:[e.jsx(Ce,{children:t("settings:nfc.dialog_title")}),e.jsx(Re,{children:e.jsxs(y,{sx:{display:"flex",flexDirection:"column",alignItems:"center",gap:2,py:2},children:[n===f.IDLE&&e.jsx(j,{children:t("settings:nfc.instructions_idle")}),n===f.SCANNING&&e.jsxs(e.Fragment,{children:[e.jsx(oe,{}),e.jsx(j,{children:t("settings:nfc.instructions_scanning")})]}),n===f.TIMEOUT&&e.jsx(O,{severity:"warning",children:t("settings:nfc.error_timeout")}),n===f.ERROR&&e.jsx(O,{severity:"error",children:t("settings:nfc.error_generic")}),n===f.ERROR_EXISTS&&e.jsxs(O,{severity:"info",children:[t("settings:nfc.error_exists"),r&&e.jsxs(y,{sx:{mt:1},children:[e.jsxs(j,{variant:"caption",children:["UID: ",r]}),e.jsx(j,{children:t("settings:nfc.instructions_exists_local")})]})]}),(n===f.FOUND||n===f.ERROR_EXISTS)&&r&&e.jsxs(y,{sx:{width:"100%",mt:2},children:[e.jsx(O,{severity:"success",sx:{mb:2},children:t("settings:nfc.tag_found",{uid:r})}),e.jsx(U,{autoFocus:!0,margin:"dense",label:t("settings:nfc.input_label"),fullWidth:!0,value:b,onChange:l=>S(l.target.value)})]})]})}),e.jsxs(Te,{children:[e.jsx(k,{onClick:R,children:t("common:cancel")}),n===f.IDLE||n===f.TIMEOUT||n===f.ERROR?e.jsx(k,{onClick:i,variant:"contained",children:t("settings:nfc.button_start_scan")}):null,(n===f.FOUND||n===f.ERROR_EXISTS)&&e.jsx(k,{onClick:g,variant:"contained",disabled:!b,children:t("settings:nfc.add_tag")})]})]})]})};function V(t){const{children:a,value:s,index:n,...r}=t;return e.jsx("div",{role:"tabpanel",hidden:s!==n,id:`my-boks-tabpanel-${n}`,"aria-labelledby":`my-boks-tab-${n}`,...r,children:s===n&&e.jsx(y,{sx:{p:3},children:a})})}function B(t){return{id:`my-boks-tab-${t}`,"aria-controls":`my-boks-tabpanel-${t}`}}const tt=()=>{const{t}=K(["common","codes","logs","settings"]),{activeDevice:a,knownDevices:s,setActiveDevice:n}=W(),{isConnected:r}=Ee(),{showNotification:u}=we(),h=Ae(),[c,o]=d.useState(0),[v,p]=d.useState(null);d.useEffect(()=>{const A=new URLSearchParams(h.search).get("tab"),N=setTimeout(()=>{switch(A){case"settings":o(0);break;case"users":o(1);break;default:o(0);break}},0);return()=>clearTimeout(N)},[h.search]),d.useEffect(()=>{(!a||!s.some(x=>x.id===a.id))&&v!==null&&setTimeout(()=>p(null),0)},[a,s,v]);const b=x=>a?.software_revision?H(a.software_revision,x)>=0:!1,S=x=>a?.hardware_version?H(a.hardware_version,x)>=0:!1,C=b("4.3.3"),R=S("4.0"),i=C&&R,g=(x,A)=>{if(A===2){if(!R){u("Version Hardware 4.0 required","warning");return}if(!C){u("Version Firmware 4.3.3 required","warning");return}}o(A)},m=x=>{p(x),n(x)},l=()=>{p(null),n(null)},I=s.length>1&&!v&&!a;let E=t("common:my_boks");return a&&s.length===1||a&&s.length>1?E=a.friendly_name||a.ble_name:!a&&s.length===1&&(E=s[0].friendly_name||s[0].ble_name),I?e.jsxs(y,{sx:{p:3},children:[e.jsx(j,{variant:"h5",gutterBottom:!0,children:t("common:my_boks")}),e.jsx(re,{children:s.map(x=>e.jsx(ie,{onClick:()=>m(x.id),sx:{cursor:"pointer"},children:e.jsx(ce,{primary:x.friendly_name||x.ble_name,secondary:x.ble_name})},x.id))})]}):a||s.find(x=>x.id===v)||(s.length===1?s[0]:null)?e.jsxs(y,{sx:{width:"100%"},children:[e.jsxs(y,{sx:{p:3,borderBottom:1,borderColor:"divider"},children:[s.length>1&&e.jsx(k,{startIcon:e.jsx(Xe,{}),onClick:l,sx:{mb:1},children:t("common:back_to_list")}),e.jsx(j,{variant:"h4",component:"h1",gutterBottom:!0,children:E}),e.jsx(j,{variant:"subtitle1",color:"textSecondary",children:t(r?"common:connected":"common:disconnected")})]}),e.jsx(y,{sx:{borderBottom:1,borderColor:"divider"},children:e.jsxs(De,{value:c,onChange:g,"aria-label":"my boks tabs",children:[e.jsx(z,{"data-testid":"tab-settings",label:t("settings:title"),...B(0)}),e.jsx(z,{"data-testid":"tab-users",label:t("common:users.title"),...B(1)}),e.jsx(z,{"data-testid":"tab-nfc",label:"Tags NFC",...B(2),sx:{opacity:i?1:.5}})]})}),e.jsx(V,{value:c,index:0,children:e.jsx(We,{deviceId:a?.id||""})}),e.jsx(V,{value:c,index:1,children:e.jsxs(y,{sx:{p:3},children:[e.jsx(j,{variant:"h6",children:t("common:users.title")}),e.jsx(j,{variant:"body1",color:"textSecondary",children:t("common:coming_soon")})]})}),e.jsx(V,{value:c,index:2,children:i?e.jsx($e,{}):e.jsx(y,{sx:{p:3},children:"Feature Unavailable"})})]}):e.jsxs(y,{sx:{p:3},children:[e.jsx(j,{variant:"h5",children:t("common:my_boks")}),e.jsx(j,{variant:"body1",color:"textSecondary",children:t("common:no_active_device")})]})};export{tt as MyBoksPage};
