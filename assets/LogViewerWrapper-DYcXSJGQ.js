import{R as Y,bD as R,i as A,t as v,l as k,b as e,Y as M,az as V,aA as j,o as m,ae as q,q as z,k as F,aL as P,a2 as T,a3 as E,an as S,bE as W,bF as Q,a4 as G,bG as H,T as w,n as J,C as K,aw as N,ai as U,r as X}from"./index-CTPJPStG.js";import{b as f,c as g,T as B,d as I,a as Z}from"./TableRow-CTMD5FbR.js";const ee=()=>{const o=Y(R);if(o===void 0)throw new Error("useLogCount must be used within a DeviceProvider");return{logCount:o.logCount}};function te(o,t){const s=new Date(o),l=new Date,r=new Date;return r.setFullYear(l.getFullYear()-1),s<r?s.toLocaleDateString(t,{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit",hour12:!1}):s.toLocaleDateString(t,{day:"2-digit",month:"2-digit",hour:"2-digit",minute:"2-digit",hour12:!1})}function ne(o,t){return{code_index:t("code_index"),code_value:t("code_value"),code:t("code_value"),method:t("method"),result:t("result"),reason:t("reason"),error_code:t("error_code"),weight:t("weight"),battery_level:t("battery_level"),tagId:t("tag_id"),tag_uid:t("tag_uid"),tag_type:t("tag_type"),initiatedBy:t("initiated_by"),bootReason:t("boot_reason"),payload:t("payload")}[o]||o}const oe=({log:o})=>{const{t,i18n:s}=A("logs"),[l,r]=v(k(!1),"isExpanded"),c=()=>{r(!l)};return e(q,{children:[e(f,{children:[e(g,{title:o.fullDate,children:te(o.timestamp,s.language)}),e(g,{children:o.event}),e(g,{children:(()=>{const a={...o.details};return delete a.age,delete a.timestamp,Object.keys(a).length>0?e(M,{"aria-label":"expand row",size:"small",onClick:c,children:e(V,{style:{transform:l?"rotate(180deg)":"rotate(0deg)"}})}):null})()})]}),e(f,{children:e(g,{style:{paddingBottom:0,paddingTop:0},colSpan:3,children:e(j,{in:l,timeout:"auto",unmountOnExit:!0,children:e(m,{sx:{margin:1},children:e(B,{size:"small","aria-label":"details",children:e(I,{children:(()=>{const a={...o.details};return delete a.age,delete a.timestamp,Object.entries(a).map(([h,p])=>e(f,{children:[e(g,{component:"th",scope:"row",sx:{fontWeight:"bold"},children:ne(h,t)}),e(g,{children:typeof p=="object"?JSON.stringify(p):String(p)})]},h))})()})})})})})})]})},re=({showNotification:o,hideNotification:t})=>{const{t:s,i18n:l}=A(["logs","common"]),r=s,{activeDevice:c}=z(),{isConnected:a}=F(),{isSyncingLogs:h,requestLogs:p}=P(),{logCount:_}=ee(),x=T(()=>{const n=c?.id;return n?(console.log(`[LogViewer] Querying logs for device_id: ${n}`),E.logs.orderBy("timestamp").reverse().filter(i=>i.device_id===n).limit(50).toArray()):[]},[c?.id]),u=v(S(()=>{const n=x??W;return console.log(`[LogViewer] raw logs count: ${n.length}`,n),n},[x]),"logs"),L=T(()=>{const n=c?.id;return n?E.nfc_tags.where("device_id").equals(n).toArray():[]},[c?.id]),D=v(S(()=>{if(u.length===0)return[];try{console.log(`[LogViewer] Starting parseLogs with ${u.length} logs`);const n=Q(u).map(i=>{const b=new Date(i.timestamp).toLocaleString(l.language),d={...i.details};if(typeof d.tag_uid=="string"){const C=L?.find(O=>O.uid===d.tag_uid);C&&(d.tag_uid=`${C.name} (${d.tag_uid})`),d.tag_type!==void 0&&(d.tag_type=r(`nfc_tag_types.${d.tag_type}`))}return{...i,details:d,fullDate:b,event:r(i.description)}});return console.log(`[LogViewer] Parsing finished. parsedLogs: ${n.length}`,n),n}catch(n){const i=n instanceof Error?n.message:String(n);return console.error(r("parse_error"),i),[]}},[u,l.language,s,L]),"parsedLogs"),$=G(async()=>{if(!a){o&&o(r("not_connected"),"error");return}await H(p,{showNotification:o,hideNotification:t,loadingMsg:r("refresh_started"),successMsg:r("refresh_success"),errorMsg:r("refresh_failed")})},[a,p,o,t,s]);return e(m,{sx:{p:2,mb:2,width:"100%"},children:[e(m,{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2,children:[e(w,{variant:"h5",component:"h2",children:[r("title")," ",_!==null&&_>0&&`(${_})`]}),e(J,{variant:"outlined",startIcon:h?e(K,{size:20}):e(N,{}),onClick:$,disabled:!a||h,children:r("refresh")})]}),!a&&!c&&u.length===0&&e(U,{severity:"info",sx:{mb:2},children:r("connect_to_view")}),e(m,{sx:{height:"100%",width:"100%",overflowY:"auto",borderRadius:1,p:2,backgroundColor:"background.paper",fontFamily:"Courier New, monospace"},children:D.length>0?e(B,{children:[e(Z,{children:e(f,{children:[e(g,{children:r("timestamp")}),e(g,{children:r("event_label")}),e(g,{})]})}),e(I,{children:D.map((n,i)=>e(oe,{log:n},i))})]}):u.length>0?e(m,{children:u.map((n,i)=>{const y=new Date(n.timestamp),b=y.toLocaleDateString(l.language,{day:"2-digit",month:"2-digit",hour:"2-digit",minute:"2-digit"}),d=y.toLocaleString(l.language);return e(m,{sx:{py:1,borderBottom:"1px solid",borderColor:"divider"},children:[e(w,{component:"span",fontWeight:"bold",title:d,children:b}),": ",n.event]},i)})}):e(w,{align:"center",sx:{fontStyle:"italic",py:2},component:"p",children:r(a||c?"no_logs_when_connected":"no_logs_when_disconnected")})})]})},ie=()=>{const o=X();if(!o)return null;const{showNotification:t,hideNotification:s}=o;return e(re,{showNotification:t,hideNotification:s})};export{ie as LogViewerWrapper};
