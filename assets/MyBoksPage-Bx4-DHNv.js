import{e as Y,j as e,g as J,a as Z,r as f,u as ee,d as z,c as te,b as se,s as P,m as le,J as de,f as q,n as G,R as ue,k as p,T as _,D as me,z as ge,A as he,K as O,U as fe,M as U,l as D,N as xe,Q as _e,S as pe,V as N,W as ve,X as A,Y as ye,Z as be,_ as je,$ as B,a0 as V,a1 as F,a2 as Se,a3 as ae,a4 as ne,a5 as re,a6 as Ce,a7 as Ie,a8 as Re,C as Te,a9 as we,i as Ee,o as Ae,p as ke,aa as De}from"./index-Dv6YayPH.js";import{I as H,V as W,a as X,A as Ne}from"./VisibilityOff-CdfNdGKp.js";import{F as ie,S as oe,T as Fe,a as K}from"./Tabs-CmOKafPK.js";import{D as Le}from"./Delete-B64SUFfl.js";const Oe=Y(e.jsx("path",{d:"M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"}));function Ue(t){return J("MuiAvatar",t)}Z("MuiAvatar",["root","colorDefault","circular","rounded","square","img","fallback"]);const Pe=t=>{const{classes:n,variant:s,colorDefault:a}=t;return se({root:["root",s,a&&"colorDefault"],img:["img"],fallback:["fallback"]},Ue,n)},Ge=P("div",{name:"MuiAvatar",slot:"Root",overridesResolver:(t,n)=>{const{ownerState:s}=t;return[n.root,n[s.variant],s.colorDefault&&n.colorDefault]}})(le(({theme:t})=>({position:"relative",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0,width:40,height:40,fontFamily:t.typography.fontFamily,fontSize:t.typography.pxToRem(20),lineHeight:1,borderRadius:"50%",overflow:"hidden",userSelect:"none",variants:[{props:{variant:"rounded"},style:{borderRadius:(t.vars||t).shape.borderRadius}},{props:{variant:"square"},style:{borderRadius:0}},{props:{colorDefault:!0},style:{color:(t.vars||t).palette.background.default,...t.vars?{backgroundColor:t.vars.palette.Avatar.defaultBg}:{backgroundColor:t.palette.grey[400],...t.applyStyles("dark",{backgroundColor:t.palette.grey[600]})}}}]}))),Me=P("img",{name:"MuiAvatar",slot:"Img"})({width:"100%",height:"100%",textAlign:"center",objectFit:"cover",color:"transparent",textIndent:1e4}),ze=P(Oe,{name:"MuiAvatar",slot:"Fallback"})({width:"75%",height:"75%"});function Be({crossOrigin:t,referrerPolicy:n,src:s,srcSet:a}){const[g,u]=f.useState(!1);return f.useEffect(()=>{if(!s&&!a)return;u(!1);let r=!0;const i=new Image;return i.onload=()=>{r&&u("loaded")},i.onerror=()=>{r&&u("error")},i.crossOrigin=t,i.referrerPolicy=n,i.src=s,a&&(i.srcset=a),()=>{r=!1}},[t,n,s,a]),g}const Ve=f.forwardRef(function(n,s){const a=ee({props:n,name:"MuiAvatar"}),{alt:g,children:u,className:r,component:i="div",slots:d={},slotProps:v={},imgProps:y,sizes:w,src:S,srcSet:C,variant:R="circular",...o}=a;let m=null;const c={...a,component:i,variant:R},j=Be({...y,...typeof v.img=="function"?v.img(c):v.img,src:S,srcSet:C}),l=S||C,I=l&&j!=="error";c.colorDefault=!I,delete c.ownerState;const E=Pe(c),[x,T]=z("root",{ref:s,className:te(E.root,r),elementType:Ge,externalForwardedProps:{slots:d,slotProps:v,component:i,...o},ownerState:c}),[k,M]=z("img",{className:E.img,elementType:Me,externalForwardedProps:{slots:d,slotProps:{img:{...y,...v.img}}},additionalProps:{alt:g,src:S,srcSet:C,sizes:w},ownerState:c}),[b,L]=z("fallback",{className:E.fallback,elementType:ze,externalForwardedProps:{slots:d,slotProps:v},shouldForwardComponentProp:!0,ownerState:c});return I?m=e.jsx(k,{...M}):u||u===0?m=u:l&&g?m=g[0]:m=e.jsx(b,{...L}),e.jsx(x,{...T,children:m})});function Ye(t){return J("MuiListItemAvatar",t)}Z("MuiListItemAvatar",["root","alignItemsFlexStart"]);const qe=t=>{const{alignItems:n,classes:s}=t;return se({root:["root",n==="flex-start"&&"alignItemsFlexStart"]},Ye,s)},He=P("div",{name:"MuiListItemAvatar",slot:"Root",overridesResolver:(t,n)=>{const{ownerState:s}=t;return[n.root,s.alignItems==="flex-start"&&n.alignItemsFlexStart]}})({minWidth:56,flexShrink:0,variants:[{props:{alignItems:"flex-start"},style:{marginTop:8}}]}),We=f.forwardRef(function(n,s){const a=ee({props:n,name:"MuiListItemAvatar"}),{className:g,...u}=a,r=f.useContext(de),i={...a,alignItems:r.alignItems},d=qe(i);return e.jsx(He,{className:te(d.root,g),ownerState:i,ref:s,...u})}),Xe=Y(e.jsx("path",{d:"M11 18h2v-2h-2zm1-16C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8m0-14c-2.21 0-4 1.79-4 4h2c0-1.1.9-2 2-2s2 .9 2 2c0 2-3 1.75-3 5h2c0-2.25 3-2.5 3-5 0-2.21-1.79-4-4-4"})),Ke=Y(e.jsx("path",{d:"M20 2H4c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2m0 18H4V4h16zM18 6h-5c-1.1 0-2 .9-2 2v2.28c-.6.35-1 .98-1 1.72 0 1.1.9 2 2 2s2-.9 2-2c0-.74-.4-1.38-1-1.72V8h3v8H8V8h2V6H6v12h12z"})),$e=({deviceId:t,showNotification:n})=>{const{t:s}=q(["common","settings"]),{activeDevice:a,updateDeviceDetails:g,removeDevice:u}=G(),[r,i]=f.useState({key:!a?.configuration_key,pin:!a?.door_pin_code}),[d,v]=f.useState(a?.friendly_name||""),[y,w]=f.useState(a?.configuration_key||""),[S,C]=f.useState(a?.door_pin_code||""),[R,o]=f.useState(a?.auto_sync??!1);ue.useEffect(()=>{a&&(v(a.friendly_name||""),w(a.configuration_key||""),C(a.door_pin_code||""),o(a.auto_sync??!1))},[a]);const m=x=>{i(T=>({...T,[x]:!T[x]}))},c=async()=>{if(a)try{await g(t,{friendly_name:d,configuration_key:y,door_pin_code:S}),n(s("settings:saved"),"success")}catch(x){console.error("Failed to update device details:",x)}},j=async()=>{if(a)try{await u(t)}catch(x){console.error("Failed to remove device:",x)}},l=x=>{const k=x.trim().toUpperCase().replace(/[^0-9A-F]/g,"").slice(-8);w(k)},I=async x=>{const T=x.target.checked;if(o(T),a)try{await g(t,{auto_sync:T}),n(s("settings:saved"),"success")}catch(k){console.error("Failed to update auto sync:",k)}},E=x=>{const T=x.trim().toUpperCase();C(T)};return a?e.jsxs(p,{sx:{my:2},children:[e.jsx(_,{variant:"subtitle1",gutterBottom:!0,children:s("devices.title")}),e.jsx(me,{sx:{mb:2}}),e.jsxs(p,{sx:{mb:2,p:2,border:"1px solid",borderColor:"divider",borderRadius:1},children:[e.jsx(_,{variant:"subtitle2",gutterBottom:!0,color:"primary",children:s("settings:device_info.title")}),e.jsxs(p,{sx:{display:"grid",gridTemplateColumns:"auto 1fr",columnGap:2,rowGap:.5},children:[e.jsxs(_,{variant:"body2",color:"textSecondary",children:[s("settings:device_info.hardware_version"),":"]}),e.jsx(_,{variant:"body2",sx:{fontWeight:"medium"},children:a.hardware_version||"N/A"}),e.jsxs(_,{variant:"body2",color:"textSecondary",children:[s("settings:device_info.firmware_revision"),":"]}),e.jsx(_,{variant:"body2",sx:{fontWeight:"medium"},children:a.firmware_revision||"N/A"}),e.jsxs(_,{variant:"body2",color:"textSecondary",children:[s("settings:device_info.software_revision"),":"]}),e.jsx(_,{variant:"body2",sx:{fontWeight:"medium"},children:a.software_revision||"N/A"})]})]}),e.jsx(ge,{children:e.jsx(he,{children:e.jsxs(p,{sx:{display:"flex",flexDirection:"column",gap:2},children:[e.jsx(O,{label:s("devices.device_name"),value:d,onChange:x=>v(x.currentTarget.value),fullWidth:!0,size:"small"}),a.role===fe.Admin&&e.jsx(O,{label:s("settings:configuration_key.label"),value:y,onChange:x=>l(x.currentTarget.value),fullWidth:!0,size:"small",type:r.key?"text":"password",helperText:s("settings:configuration_key.helper"),slotProps:{input:{endAdornment:e.jsx(H,{position:"end",children:e.jsx(U,{"aria-label":s("settings:toggle_key_visibility"),onClick:()=>m("key"),edge:"end",size:"small",children:r.key?e.jsx(W,{}):e.jsx(X,{})})})}}}),e.jsx(O,{label:s("settings:door_pin_code"),value:S,onChange:x=>E(x.currentTarget.value),fullWidth:!0,size:"small",type:r.pin?"text":"password",slotProps:{input:{endAdornment:e.jsx(H,{position:"end",children:e.jsx(U,{"aria-label":s("settings:toggle_pin_visibility"),onClick:()=>m("pin"),edge:"end",size:"small",children:r.pin?e.jsx(W,{}):e.jsx(X,{})})})}}}),e.jsx(ie,{control:e.jsx(oe,{checked:R,onChange:I}),label:s("settings:device_auto_sync")}),e.jsxs(p,{sx:{display:"flex",justifyContent:"space-between",mt:2},children:[e.jsx(D,{size:"small",color:"error",variant:"outlined",onClick:j,children:s("devices.forget")}),e.jsx(D,{size:"small",variant:"contained",onClick:c,children:s("save")})]})]})})})]}):null};var ce=(t=>(t[t.LA_POSTE=1]="LA_POSTE",t[t.VIGIK_TERTIARY=2]="VIGIK_TERTIARY",t[t.USER_BADGE=3]="USER_BADGE",t))(ce||{}),h=(t=>(t.IDLE="idle",t.SCANNING="scanning",t.FOUND="found",t.TIMEOUT="timeout",t.ERROR_EXISTS="error_exists",t.ERROR="error",t))(h||{});const Qe=()=>{const{activeDevice:t}=G(),{sendRequest:n}=xe(),{addListener:s,removeListener:a}=_e(),[g,u]=f.useState(h.IDLE),[r,i]=f.useState(null),d=t?.id,v=pe(()=>d?N.nfc_tags.where("device_id").equals(d).toArray():[],[d]),y=f.useCallback(async()=>{if(!d)throw new Error("No active device");const o=await N.device_secrets.get(d);if(!o?.configuration_key)throw new Error("Configuration Key required");return o.configuration_key},[d]),w=f.useCallback(async()=>{try{const o=await y();u(h.SCANNING),i(null),await n(new ve(o))}catch(o){console.error("Failed to start scan",o),u(h.ERROR)}},[y,n]);f.useEffect(()=>{const o=m=>{if(!(g!==h.SCANNING&&g!==h.IDLE)&&[A.NOTIFY_NFC_TAG_REGISTER_SCAN_RESULT,A.NOTIFY_NFC_TAG_REGISTER_SCAN_ERROR_EXISTS,A.NOTIFY_NFC_TAG_REGISTER_SCAN_TIMEOUT].includes(m.opcode)){const c=new je(m.opcode);switch(c.parse(m.payload),c.status){case B.TIMEOUT:u(h.TIMEOUT);break;case B.ALREADY_EXISTS:u(h.ERROR_EXISTS),c.uid&&i(c.uid);break;case B.FOUND:u(h.FOUND),c.uid&&i(c.uid);break;default:u(h.ERROR)}}};return s(A.NOTIFY_NFC_TAG_REGISTER_SCAN_RESULT,o),s(A.NOTIFY_NFC_TAG_REGISTER_SCAN_ERROR_EXISTS,o),s(A.NOTIFY_NFC_TAG_REGISTER_SCAN_TIMEOUT,o),()=>{a(A.NOTIFY_NFC_TAG_REGISTER_SCAN_RESULT,o),a(A.NOTIFY_NFC_TAG_REGISTER_SCAN_ERROR_EXISTS,o),a(A.NOTIFY_NFC_TAG_REGISTER_SCAN_TIMEOUT,o)}},[s,a,g]);const S=f.useCallback(async o=>{if(!(!r||!d))try{const m=await y(),c=new Uint8Array(r.split(":").map(l=>parseInt(l,16)));if(g===h.FOUND){const l=new ye(m,c);await n(l)}const j=await N.nfc_tags.where({device_id:d,uid:r}).first();j?await N.nfc_tags.update(j.id,{name:o,updated_at:Date.now()}):await N.nfc_tags.add({id:crypto.randomUUID(),device_id:d,uid:r,name:o,type:ce.USER_BADGE,created_at:Date.now(),sync_status:"created"}),u(h.IDLE),i(null)}catch(m){throw console.error("Failed to register tag",m),m}},[r,d,y,n,g]),C=f.useCallback(async o=>{if(d)try{const m=await y(),c=new Uint8Array(o.uid.split(":").map(l=>parseInt(l,16))),j=new be(m,c);await n(j),await N.nfc_tags.delete(o.id)}catch(m){throw console.error("Failed to unregister tag",m),m}},[d,y,n]),R=f.useCallback(()=>{u(h.IDLE),i(null)},[]);return{tags:v,scanStatus:g,scannedUid:r,startScan:w,registerTag:S,unregisterTag:C,resetScan:R}},Je=()=>{const{t,i18n:n}=q(["common","settings"]),s=t,{activeDevice:a,toggleLaPoste:g}=G(),{tags:u,scanStatus:r,scannedUid:i,startScan:d,registerTag:v,unregisterTag:y,resetScan:w}=Qe(),[S,C]=f.useState(!1),[R,o]=f.useState(""),m=a?.software_revision||"0.0.0",c=V(m,"4.2.0")>=0,j=V(m,"4.3.3")>=0,l=()=>{w(),o(""),C(!0)},I=()=>{C(!1),w()},E=()=>{d()},x=async()=>{if(R.trim())try{await v(R.trim()),I()}catch(b){console.error(b)}},T=async b=>{if(confirm(s("common:confirm_delete")))try{await y(b)}catch(L){console.error(L),alert(t("settings:nfc.error_delete_failed"))}},k=async b=>{try{g&&await g(b.target.checked)}catch(L){console.error(L),alert("Failed to update La Poste setting")}},M=n.language==="fr"?"https://github.com/thib3113/ha-boks/blob/main/documentation/FR/create_user_tag.md":"https://github.com/thib3113/ha-boks/blob/main/documentation/EN/create_user_tag.md";return e.jsxs(p,{sx:{p:2},children:[e.jsxs(p,{sx:{mb:4},children:[e.jsx(_,{variant:"h6",gutterBottom:!0,children:t("settings:activate_la_poste")}),e.jsx(ie,{control:e.jsx(oe,{"data-testid":"la-poste-switch",checked:a?.la_poste_activated||!1,onChange:k,disabled:!c}),label:c?a?.la_poste_activated?"Activé":"Désactivé":"Non disponible"}),!c&&e.jsx(F,{"data-testid":"laposte-update-required-alert",severity:"warning",sx:{mt:1},children:t("settings:device_info.warnings.update_required_laposte")})]}),e.jsxs(p,{sx:{opacity:j?1:.6},children:[e.jsxs(p,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2},children:[e.jsxs(p,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(_,{variant:"h6","data-testid":"nfc-tags-title",children:t("settings:nfc.title")}),!j&&e.jsx(Se,{title:"Help",children:e.jsx(U,{size:"small",href:M,target:"_blank",rel:"noopener noreferrer",children:e.jsx(Xe,{})})})]}),e.jsx(D,{variant:"contained",startIcon:e.jsx(Ne,{}),onClick:l,disabled:!j,children:t("settings:nfc.add_tag")})]}),!j&&e.jsx(F,{"data-testid":"nfc-update-required-alert",severity:"warning",sx:{mb:2},children:t("settings:device_info.warnings.update_required_nfc")}),u&&u.length>0?e.jsx(ae,{children:u.map(b=>e.jsxs(ne,{secondaryAction:e.jsx(U,{edge:"end","aria-label":"delete",onClick:()=>T(b),disabled:!j,children:e.jsx(Le,{})}),children:[e.jsx(We,{children:e.jsx(Ve,{children:e.jsx(Ke,{})})}),e.jsx(re,{primary:b.name,secondary:e.jsxs(e.Fragment,{children:[e.jsx(_,{component:"span",variant:"body2",color:"textPrimary",children:b.uid}),e.jsx("br",{}),b.last_seen_at?t("settings:nfc.last_seen",{date:new Date(b.last_seen_at).toLocaleString()}):t("settings:nfc.never_seen")]})})]},b.id))}):e.jsx(_,{variant:"body1",color:"textSecondary",align:"center",sx:{mt:4},children:t("settings:nfc.no_tags")})]}),e.jsxs(Ce,{open:S,onClose:I,fullWidth:!0,maxWidth:"sm",children:[e.jsx(Ie,{children:t("settings:nfc.dialog_title")}),e.jsx(Re,{children:e.jsxs(p,{sx:{display:"flex",flexDirection:"column",alignItems:"center",gap:2,py:2},children:[r===h.IDLE&&e.jsx(_,{children:t("settings:nfc.instructions_idle")}),r===h.SCANNING&&e.jsxs(e.Fragment,{children:[e.jsx(Te,{}),e.jsx(_,{children:t("settings:nfc.instructions_scanning")})]}),r===h.TIMEOUT&&e.jsx(F,{severity:"warning",children:t("settings:nfc.error_timeout")}),r===h.ERROR&&e.jsx(F,{severity:"error",children:t("settings:nfc.error_generic")}),r===h.ERROR_EXISTS&&e.jsxs(F,{severity:"info",children:[t("settings:nfc.error_exists"),i&&e.jsxs(p,{sx:{mt:1},children:[e.jsxs(_,{variant:"caption",children:["UID: ",i]}),e.jsx(_,{children:t("settings:nfc.instructions_exists_local")})]})]}),(r===h.FOUND||r===h.ERROR_EXISTS)&&i&&e.jsxs(p,{sx:{width:"100%",mt:2},children:[e.jsx(F,{severity:"success",sx:{mb:2},children:t("settings:nfc.tag_found",{uid:i})}),e.jsx(O,{autoFocus:!0,margin:"dense",label:t("settings:nfc.input_label"),fullWidth:!0,value:R,onChange:b=>o(b.target.value),required:!0})]})]})}),e.jsxs(we,{children:[e.jsx(D,{onClick:I,children:t("common:cancel")}),r===h.IDLE||r===h.TIMEOUT||r===h.ERROR?e.jsx(D,{onClick:E,variant:"contained",children:t("settings:nfc.button_start_scan")}):null,(r===h.FOUND||r===h.ERROR_EXISTS)&&e.jsx(D,{onClick:x,variant:"contained",disabled:!R.trim(),children:t("settings:nfc.add_tag")})]})]})]})};function $(t){const{children:n,value:s,index:a,...g}=t;return e.jsx("div",{role:"tabpanel",hidden:s!==a,id:`my-boks-tabpanel-${a}`,"aria-labelledby":`my-boks-tab-${a}`,...g,children:s===a&&e.jsx(p,{sx:{p:3},children:n})})}function Q(t){return{id:`my-boks-tab-${t}`,"aria-controls":`my-boks-tabpanel-${t}`}}const at=()=>{const{t}=q(["common","codes","logs","settings"]),{activeDevice:n,knownDevices:s,setActiveDevice:a}=G(),{isConnected:g}=Ee(),{showNotification:u}=Ae(),r=ke(),[i,d]=f.useState(0),[v,y]=f.useState(null);f.useEffect(()=>{const I=new URLSearchParams(r.search).get("tab"),E=setTimeout(()=>{switch(I){case"settings":d(0);break;case"nfc":d(1);break;default:d(0);break}},0);return()=>clearTimeout(E)},[r.search]),f.useEffect(()=>{(!n||!s.some(l=>l.id===n.id))&&v!==null&&setTimeout(()=>y(null),0)},[n,s,v]);const S=(l=>n?.hardware_version?V(n.hardware_version,l)>=0:!1)("4.0"),C=(l,I)=>{if(I===1&&!S){u("Version Hardware 4.0 required","warning");return}d(I)},R=l=>{y(l),a(l)},o=()=>{y(null),a(null)},m=s.length>1&&!v&&!n;let c=t("common:my_boks");return n&&s.length===1||n&&s.length>1?c=n.friendly_name||n.ble_name:!n&&s.length===1&&(c=s[0].friendly_name||s[0].ble_name),m?e.jsxs(p,{sx:{p:3},children:[e.jsx(_,{variant:"h5",gutterBottom:!0,children:t("common:my_boks")}),e.jsx(ae,{children:s.map(l=>e.jsx(ne,{onClick:()=>R(l.id),sx:{cursor:"pointer"},children:e.jsx(re,{primary:l.friendly_name||l.ble_name,secondary:l.ble_name})},l.id))})]}):n||s.find(l=>l.id===v)||(s.length===1?s[0]:null)?e.jsxs(p,{sx:{width:"100%"},children:[e.jsxs(p,{sx:{p:3,borderBottom:1,borderColor:"divider"},children:[s.length>1&&e.jsx(D,{startIcon:e.jsx(De,{}),onClick:o,sx:{mb:1},children:t("common:back_to_list")}),e.jsx(_,{variant:"h4",component:"h1",gutterBottom:!0,children:c}),e.jsx(_,{variant:"subtitle1",color:"textSecondary",children:t(g?"common:connected":"common:disconnected")})]}),e.jsx(p,{sx:{borderBottom:1,borderColor:"divider"},children:e.jsxs(Fe,{value:i,onChange:C,variant:"scrollable",scrollButtons:"auto","aria-label":"my boks tabs",children:[e.jsx(K,{"data-testid":"tab-settings",label:t("settings:title"),...Q(0)}),S&&e.jsx(K,{"data-testid":"tab-nfc",label:"Tags NFC",...Q(1)})]})}),e.jsx($,{value:i,index:0,children:e.jsx($e,{deviceId:n?.id||"",showNotification:u})}),e.jsx($,{value:i,index:1,children:S?e.jsx(Je,{}):null})]}):e.jsxs(p,{sx:{p:3},children:[e.jsx(_,{variant:"h5",children:t("common:my_boks")}),e.jsx(_,{variant:"body1",color:"textSecondary",children:t("common:no_active_device")})]})};export{at as MyBoksPage};
