import{r as f,bz as k,f as T,j as e,M,ao as O,ap as R,k as m,n as V,i as Y,az as $,bu as z,S as C,V as D,bA as W,bB as F,bC as P,T as p,l as Q,C as q,al as H,a1 as J,o as K}from"./index-UQNX8rmM.js";import{L as G}from"./Lock-CqXv52dU.js";import{b as j,c as d,T as S,d as B,a as N}from"./TableRow-CozTGwh3.js";const U=()=>{const o=f.useContext(k);if(o===void 0)throw new Error("useLogCount must be used within a DeviceProvider");return{logCount:o.logCount}};function X(o,s){const t=new Date(o),l=new Date,a=new Date;return a.setFullYear(l.getFullYear()-1),t<a?t.toLocaleDateString(s,{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit",hour12:!1}):t.toLocaleDateString(s,{day:"2-digit",month:"2-digit",hour:"2-digit",minute:"2-digit",hour12:!1})}function Z(o,s){return{code_index:s("code_index"),code_value:s("code_value"),code:s("code_value"),method:s("method"),result:s("result"),reason:s("reason"),error_code:s("error_code"),weight:s("weight"),battery_level:s("battery_level"),tagId:s("tag_id"),tag_uid:s("tag_uid"),tag_type:s("tag_type"),initiatedBy:s("initiated_by"),bootReason:s("boot_reason"),payload:s("payload")}[o]||o}const ee=({log:o})=>{const{t:s,i18n:t}=T("logs"),[l,a]=f.useState(!1),g=()=>{a(!l)};return e.jsxs(e.Fragment,{children:[e.jsxs(j,{children:[e.jsx(d,{title:o.fullDate,children:X(o.timestamp,t.language)}),e.jsx(d,{children:o.event}),e.jsx(d,{children:(()=>{const r={...o.details};return delete r.age,delete r.timestamp,delete r.opcode,Object.keys(r).length>0?e.jsx(M,{"aria-label":"expand row",size:"small",onClick:g,children:e.jsx(O,{style:{transform:l?"rotate(180deg)":"rotate(0deg)"}})}):null})()})]}),e.jsx(j,{children:e.jsx(d,{style:{paddingBottom:0,paddingTop:0},colSpan:3,children:e.jsx(R,{in:l,timeout:"auto",unmountOnExit:!0,children:e.jsx(m,{sx:{margin:1},children:e.jsx(S,{size:"small","aria-label":"details",children:e.jsx(B,{children:(()=>{const r={...o.details};return delete r.age,delete r.timestamp,delete r.opcode,Object.entries(r).map(([x,u])=>e.jsxs(j,{children:[e.jsx(d,{component:"th",scope:"row",sx:{fontWeight:"bold"},children:Z(x,s)}),e.jsx(d,{children:typeof u=="object"?JSON.stringify(u):String(u)})]},x))})()})})})})})})]})},te=({showNotification:o,hideNotification:s})=>{const{t,i18n:l}=T(["logs","common"]),{activeDevice:a}=V(),{isConnected:g}=Y(),{isSyncingLogs:r,requestLogs:x}=$(),{logCount:u}=U(),{isRestricted:E}=z(),b=C(()=>{const n=a?.id;return n?(console.log(`[LogViewer] Querying logs for device_id: ${n}`),D.logs.orderBy("timestamp").reverse().filter(i=>i.device_id===n).limit(50).toArray()):[]},[a?.id]),h=f.useMemo(()=>{const n=b??W;return console.log(`[LogViewer] raw logs count: ${n.length}`,n),n},[b]),v=C(()=>{const n=a?.id;return n?D.nfc_tags.where("device_id").equals(n).toArray():[]},[a?.id]),w=f.useMemo(()=>{if(h.length===0)return[];try{console.log(`[LogViewer] Starting parseLogs with ${h.length} logs`);const n=F(h,{preserveTimestamp:!0}).map(i=>{const y=new Date(i.timestamp).toLocaleString(l.language),c={...i.details};if(typeof c.tag_uid=="string"){const L=v?.find(A=>A.uid===c.tag_uid);L&&(c.tag_uid=`${L.name} (${c.tag_uid})`),c.tag_type!==void 0&&(c.tag_type=t(`nfc_tag_types.${c.tag_type}`))}return{...i,details:c,fullDate:y,event:t(i.description)}});return console.log(`[LogViewer] Parsing finished. parsedLogs: ${n.length}`,n),n}catch(n){const i=n instanceof Error?n.message:String(n);return console.error(t("parse_error"),i),[]}},[h,l.language,t,v]),I=f.useCallback(async()=>{if(!g){o&&o(t("not_connected"),"error");return}await P(x,{showNotification:o,hideNotification:s,loadingMsg:t("refresh_started"),successMsg:t("refresh_success"),errorMsg:t("refresh_failed")})},[g,x,o,s,t]);return E?e.jsxs(m,{"data-testid":"feature-blocked-screen",sx:{width:"100%",p:4,textAlign:"center",display:"flex",flexDirection:"column",alignItems:"center"},children:[e.jsx(G,{sx:{fontSize:60,color:"text.secondary",mb:2}}),e.jsx(p,{variant:"h5",gutterBottom:!0,color:"text.secondary",children:t("common:feature_disabled")}),e.jsx(p,{variant:"body1",color:"text.secondary",sx:{maxWidth:400},children:t("common:errors.version.feature_restricted_message",{feature:t("logs:title")})})]}):e.jsxs(m,{sx:{p:2,mb:2,width:"100%"},children:[e.jsxs(m,{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2,children:[e.jsxs(p,{variant:"h5",component:"h2",children:[t("title")," ",u!==null&&u>0&&`(${u})`]}),e.jsx(Q,{variant:"outlined",startIcon:r?e.jsx(q,{size:20,color:"inherit"}):e.jsx(H,{}),onClick:I,disabled:!g||r,children:t("refresh")})]}),!g&&!a&&h.length===0&&e.jsx(J,{severity:"info",sx:{mb:2},children:t("connect_to_view")}),e.jsx(m,{sx:{height:"100%",width:"100%",overflowY:"auto",borderRadius:1,p:2,backgroundColor:"background.paper",fontFamily:"Courier New, monospace"},children:w.length>0?e.jsxs(S,{children:[e.jsx(N,{children:e.jsxs(j,{children:[e.jsx(d,{children:t("timestamp")}),e.jsx(d,{children:t("event_label")}),e.jsx(d,{})]})}),e.jsx(B,{children:w.map((n,i)=>e.jsx(ee,{log:n},i))})]}):h.length>0?e.jsx(m,{children:h.map((n,i)=>{const _=new Date(n.timestamp),y=_.toLocaleDateString(l.language,{day:"2-digit",month:"2-digit",hour:"2-digit",minute:"2-digit"}),c=_.toLocaleString(l.language);return e.jsxs(m,{sx:{py:1,borderBottom:"1px solid",borderColor:"divider"},children:[e.jsx(p,{component:"span",fontWeight:"bold",title:c,children:y}),": ",n.event]},i)})}):e.jsx(p,{align:"center",sx:{fontStyle:"italic",py:2},component:"p",children:t(g||a?"no_logs_when_connected":"no_logs_when_disconnected")})})]})},re=()=>{const o=K();if(!o)return null;const{showNotification:s,hideNotification:t}=o;return e.jsx(te,{showNotification:s,hideNotification:t})};export{re as LogViewerWrapper};
