import{e as q,j as e,f as N,n as K,U as W,r as u,bl as c,b2 as P,a4 as H,a5 as X,a6 as Z,a7 as J,k as b,K as k,M as T,aT as Q,aU as ee,aV as te,aW as L,a8 as se,l as U,bm as R,a2 as ne,a3 as ae,T as A,bn as oe,ay as O,aq as re,a1 as le,bo as ie,aj as de,aX as $,aY as G,am as V,aZ as z,o as ce}from"./index-C2JwI2fF.js";import{I as xe,V as ue,a as pe,A as Y}from"./VisibilityOff-BVGRa_jO.js";import{D as me}from"./Delete-DT6nOAMU.js";import{E as he}from"./Edit-CEB3HGcf.js";const je=q(e.jsx("path",{d:"m19 8-4 4h3c0 3.31-2.69 6-6 6-1.01 0-1.97-.25-2.8-.7l-1.46 1.46C8.97 19.54 10.43 20 12 20c4.42 0 8-3.58 8-8h3zM6 12c0-3.31 2.69-6 6-6 1.01 0 1.97.25 2.8.7l1.46-1.46C15.03 4.46 13.57 4 12 4c-4.42 0-8 3.58-8 8H1l4 4 4-4z"})),fe=t=>{const l=new Uint32Array(1);return crypto.getRandomValues(l),l[0]%t},B=()=>{const t="0123456789AB";let l="";for(let i=0;i<6;i++)l+=t.charAt(fe(t.length));return l},Ce=t=>t?t.toUpperCase().replace(/[^0-9AB]/g,""):"",ge=({open:t,onClose:l,onSave:i,editingCode:o})=>{const{t:s}=N(["codes","common"]),{activeDevice:n}=K(),p=!!n?.configuration_key,h=n?.role===W.Owner||n?.role===W.Admin,[r,C]=u.useState(c.MASTER),[I,j]=u.useState(""),[v,E]=u.useState(""),[x,g]=u.useState(0),[D,_]=u.useState(1),[S,M]=u.useState(!0);u.useEffect(()=>{if(t){const a=setTimeout(()=>{o?(C(o.type),j(o.code),E(o.name||o.description||""),g(o.index||0),_(o.uses||1)):(C(c.MASTER),j(B()),E(""),g(0),_(1)),M(!0)},0);return()=>clearTimeout(a)}},[o,t]),u.useEffect(()=>{t&&n?.id&&r===c.MASTER&&P.loadCodes(n.id).then(a=>{const f=a.filter(m=>m.type===c.MASTER&&m.status!=="pending_delete").map(m=>m.index).filter(m=>m!==void 0),d=Math.max(...f,-1)+1;g(d)})},[t,n?.id,r]);const y=()=>{C(c.MASTER),j(""),E(""),g(0),_(1),l()},w=async()=>{const a=Ce(I);if(j(a),r===c.MASTER&&n?.id){const d=(await P.loadCodes(n.id)).find(m=>m.type===c.MASTER&&m.index===x&&m.status!=="pending_delete"&&(!o||m.id!==o.id));if(d){i({type:r,code:a,name:v,index:x,maxUses:D},d.id),y();return}}i({type:r,code:a,name:v,index:x,maxUses:D},o?o.id:null),y()};return e.jsx(e.Fragment,{children:e.jsxs(H,{open:t,onClose:y,maxWidth:"sm",fullWidth:!0,children:[e.jsx(X,{children:s(o?"edit_code":"add_new")}),e.jsxs(Z,{children:[!n?.configuration_key&&e.jsx(J,{severity:"warning",sx:{mb:2},children:s("config_key_missing")}),e.jsxs(b,{sx:{display:"flex",flexDirection:"column",gap:2,mt:1},children:[e.jsxs(b,{sx:{display:"flex",gap:1},children:[e.jsx(k,{label:s("pin_label"),value:I,onChange:a=>j(a.currentTarget.value.trim().toUpperCase()),fullWidth:!0,type:S?"text":"password",slotProps:{htmlInput:{maxLength:6},input:{endAdornment:e.jsx(xe,{position:"end",children:e.jsx(T,{"aria-label":"toggle code visibility",onClick:()=>M(!S),edge:"end",size:"small",children:S?e.jsx(ue,{}):e.jsx(pe,{})})})}}}),e.jsx(T,{onClick:()=>j(B()),"aria-label":s("generate"),children:e.jsx(je,{})})]}),e.jsx(k,{label:s("description_label"),value:v,onChange:a=>E(a.currentTarget.value),placeholder:s("description_placeholder"),fullWidth:!0}),e.jsxs(Q,{fullWidth:!0,children:[e.jsx(ee,{children:s("type_label")}),e.jsxs(te,{value:r,onChange:a=>C(a.target.value),label:s("type_label"),children:[(!h||h&&p)&&e.jsx(L,{value:c.MASTER,children:s("master_code")}),e.jsx(L,{value:c.SINGLE,children:s("single_use_code")}),e.jsx(L,{value:c.MULTI,children:s("multi_use_code")})]})]}),r===c.MASTER&&e.jsx(k,{label:`${s("index_label")}: ${x}`,type:"number",value:x,onChange:a=>g(parseInt(a.currentTarget.value)||0),fullWidth:!0,disabled:!h,slotProps:{htmlInput:{min:0,max:255}}}),r===c.MULTI&&e.jsx(k,{label:s("uses_label"),type:"number",value:D,onChange:a=>_(parseInt(a.currentTarget.value)||1),fullWidth:!0,slotProps:{htmlInput:{min:1,max:3}}})]})]}),e.jsxs(se,{children:[e.jsx(U,{onClick:y,children:s("cancel")}),e.jsx(U,{onClick:w,variant:"contained","data-testid":"save-code-button",startIcon:e.jsx(Y,{}),disabled:r===c.MASTER&&(!I||I.length!==6)||r!==c.MASTER&&v.trim()==="",children:s(o?"save":"generate")})]})]})})},ye=({code:t,metadata:l,onCopy:i,onEdit:o,onDelete:s})=>{const{t:n}=N("codes"),p=t.status===R.PENDING_DELETE,h=l.used,r=p||h;return e.jsxs(ne,{divider:!0,sx:{opacity:r?.6:1,backgroundColor:r?"action.selected":"inherit",textDecoration:r?"line-through":"none",borderLeft:"4px solid",borderLeftColor:t.status===R.ON_DEVICE?"primary.main":t.status===R.PENDING_ADD?"warning.main":t.status===R.PENDING_DELETE?"error.main":"default.main",pl:1},children:[e.jsx(ae,{primary:e.jsxs(b,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap"},children:[e.jsx(A,{variant:"body1",sx:{fontWeight:"bold"},children:t.name||t.description||n("unnamed")}),e.jsxs(A,{variant:"caption",sx:{ml:1},children:[n("pin_label"),": ",t.code]})]}),secondary:null,slotProps:{primary:{component:"div"},secondary:{component:"div"}}}),e.jsxs(oe,{children:[e.jsx(O,{title:n("copy_code"),children:e.jsx(T,{edge:"end","aria-label":"copy",onClick:()=>i(t.code),children:e.jsx(re,{})})}),e.jsx(O,{title:n("edit_description"),children:e.jsx(T,{edge:"end","aria-label":"edit",onClick:()=>o(t),children:e.jsx(he,{})})}),e.jsx(T,{edge:"end","aria-label":"delete",onClick:()=>s(t.id),children:e.jsx(me,{})})]})]})},F=({codes:t,deriveCodeMetadata:l,hasIndexConflict:i,onCopy:o,onEdit:s,onDelete:n})=>e.jsx(le,{children:t.map(p=>e.jsx(ye,{code:p,metadata:l(p),hasIndexConflict:i?i(p.index,p.id):!1,onCopy:o,onEdit:s,onDelete:n},p.id))}),be=({showAddForm:t,setShowAddForm:l,showNotification:i,hideNotification:o})=>{const{t:s}=N(["codes","common"]),{activeDevice:n}=K(),[p,h]=u.useState(!1),[r,C]=u.useState(new Set(["permanent","temporary"])),[I,j]=u.useState(null),{masterCodes:v,temporaryCodes:E,codeCount:x,refreshCodeCount:g,hasIndexConflict:D,handleAddCode:_,handleDeleteCode:S,deriveCodeMetadata:M,getFilteredCodes:y,handleCopyCode:w}=ie(i),a=u.useCallback(f=>{j(f),h(!0)},[]);return e.jsxs(b,{sx:{width:"100%"},children:[e.jsxs(b,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2},children:[e.jsxs(A,{variant:"h5",children:[s("title")," ",x&&`(Total: ${x.total})`]}),e.jsxs(b,{sx:{display:"flex",gap:1},children:[e.jsx(U,{variant:"outlined",startIcon:e.jsx(de,{}),onClick:g,size:"small",children:s("refresh")}),e.jsx(T,{color:"primary",onClick:()=>h(!0),"aria-label":s("add_new"),"data-testid":"add-code-button",size:"small",children:e.jsx(Y,{})})]})]}),n&&e.jsx(A,{variant:"subtitle1",color:"textSecondary",sx:{mb:2},children:n.friendly_name||n.ble_name}),e.jsx(ge,{open:p||t||!1,onClose:()=>{h(!1),l&&l(!1),j(null)},onSave:_,editingCode:I}),e.jsxs($,{expanded:r.has("permanent"),onChange:()=>{C(f=>{const d=new Set(f);return d.has("permanent")?d.delete("permanent"):d.add("permanent"),d})},elevation:0,sx:{backgroundColor:"transparent",width:"100%"},disableGutters:!0,children:[e.jsx(G,{expandIcon:e.jsx(V,{}),children:e.jsxs(A,{children:[s("permanent_codes")," (",v.length,x&&` / ${x.master} ${s("codes:on_device_count")}`,")"]})}),e.jsx(z,{sx:{padding:"0 0 0 0 !important"},children:e.jsx(F,{codes:y("master"),deriveCodeMetadata:M,hasIndexConflict:D,onCopy:w,onEdit:a,onDelete:S})})]}),e.jsxs($,{expanded:r.has("temporary"),onChange:()=>{C(f=>{const d=new Set(f);return d.has("temporary")?d.delete("temporary"):d.add("temporary"),d})},elevation:0,sx:{backgroundColor:"transparent",width:"100%"},disableGutters:!0,children:[e.jsx(G,{expandIcon:e.jsx(V,{}),children:e.jsxs(A,{children:[s("temporary_codes")," (",E.length,x&&` / ${x.single} ${s("codes:on_device_count")}`,")"]})}),e.jsx(z,{sx:{padding:"0 0 0 0 !important"},children:e.jsx(F,{codes:y("temporary"),deriveCodeMetadata:M,onCopy:w,onEdit:a,onDelete:S})})]})]})},Se=()=>{const t=ce();if(!t)return null;const{showNotification:l,hideNotification:i}=t;return e.jsx(b,{sx:{p:2},children:e.jsx(be,{showNotification:l,hideNotification:i})})};export{Se as CodeManagerWrapper};
