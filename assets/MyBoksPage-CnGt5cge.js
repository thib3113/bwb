import{e as H,j as e,g as ee,a as te,r as g,u as se,d as G,c as ne,b as ae,s as P,m as de,J as ue,f as X,n as q,R as me,k as y,T as v,D as ge,z as he,A as xe,K as U,U as fe,M as Y,N as W,C as re,l as k,Q as _e,S as ve,V as pe,W as D,X as ye,Y as E,Z as be,_ as je,$ as Se,a0 as M,a1 as oe,a2 as ie,a3 as ce,a4 as Ce,a5 as Ie,a6 as Re,a7 as O,a8 as we,i as Te,o as Ee,p as Ae}from"./index-4fZ3R_Jy.js";import{I as K,V as $,a as Q,A as ke}from"./VisibilityOff-CUvWyLV_.js";import{F as J,S as Z,T as Ne,a as z}from"./Tabs-RdYquzCo.js";import{D as De}from"./Delete-CEHW9nJ-.js";const Fe=H(e.jsx("path",{d:"M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"}));function Le(t){return ee("MuiAvatar",t)}te("MuiAvatar",["root","colorDefault","circular","rounded","square","img","fallback"]);const Oe=t=>{const{classes:n,variant:s,colorDefault:a}=t;return ae({root:["root",s,a&&"colorDefault"],img:["img"],fallback:["fallback"]},Le,n)},Ue=P("div",{name:"MuiAvatar",slot:"Root",overridesResolver:(t,n)=>{const{ownerState:s}=t;return[n.root,n[s.variant],s.colorDefault&&n.colorDefault]}})(de(({theme:t})=>({position:"relative",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0,width:40,height:40,fontFamily:t.typography.fontFamily,fontSize:t.typography.pxToRem(20),lineHeight:1,borderRadius:"50%",overflow:"hidden",userSelect:"none",variants:[{props:{variant:"rounded"},style:{borderRadius:(t.vars||t).shape.borderRadius}},{props:{variant:"square"},style:{borderRadius:0}},{props:{colorDefault:!0},style:{color:(t.vars||t).palette.background.default,...t.vars?{backgroundColor:t.vars.palette.Avatar.defaultBg}:{backgroundColor:t.palette.grey[400],...t.applyStyles("dark",{backgroundColor:t.palette.grey[600]})}}}]}))),Pe=P("img",{name:"MuiAvatar",slot:"Img"})({width:"100%",height:"100%",textAlign:"center",objectFit:"cover",color:"transparent",textIndent:1e4}),Ge=P(Fe,{name:"MuiAvatar",slot:"Fallback"})({width:"75%",height:"75%"});function Me({crossOrigin:t,referrerPolicy:n,src:s,srcSet:a}){const[c,l]=g.useState(!1);return g.useEffect(()=>{if(!s&&!a)return;l(!1);let x=!0;const i=new Image;return i.onload=()=>{x&&l("loaded")},i.onerror=()=>{x&&l("error")},i.crossOrigin=t,i.referrerPolicy=n,i.src=s,a&&(i.srcset=a),()=>{x=!1}},[t,n,s,a]),c}const ze=g.forwardRef(function(n,s){const a=se({props:n,name:"MuiAvatar"}),{alt:c,children:l,className:x,component:i="div",slots:r={},slotProps:b={},imgProps:p,sizes:S,src:C,srcSet:I,variant:R="circular",...o}=a;let d=null;const u={...a,component:i,variant:R},h=Me({...p,...typeof b.img=="function"?b.img(u):b.img,src:C,srcSet:I}),j=C||I,T=j&&h!=="error";u.colorDefault=!T,delete u.ownerState;const N=Oe(u),[f,A]=G("root",{ref:s,className:ne(N.root,x),elementType:Ue,externalForwardedProps:{slots:r,slotProps:b,component:i,...o},ownerState:u}),[F,_]=G("img",{className:N.img,elementType:Pe,externalForwardedProps:{slots:r,slotProps:{img:{...p,...b.img}}},additionalProps:{alt:c,src:C,srcSet:I,sizes:S},ownerState:u}),[w,L]=G("fallback",{className:N.fallback,elementType:Ge,externalForwardedProps:{slots:r,slotProps:b},shouldForwardComponentProp:!0,ownerState:u});return T?d=e.jsx(F,{..._}):l||l===0?d=l:j&&c?d=c[0]:d=e.jsx(w,{...L}),e.jsx(f,{...A,children:d})});function Ve(t){return ee("MuiListItemAvatar",t)}te("MuiListItemAvatar",["root","alignItemsFlexStart"]);const Be=t=>{const{alignItems:n,classes:s}=t;return ae({root:["root",n==="flex-start"&&"alignItemsFlexStart"]},Ve,s)},Ye=P("div",{name:"MuiListItemAvatar",slot:"Root",overridesResolver:(t,n)=>{const{ownerState:s}=t;return[n.root,s.alignItems==="flex-start"&&n.alignItemsFlexStart]}})({minWidth:56,flexShrink:0,variants:[{props:{alignItems:"flex-start"},style:{marginTop:8}}]}),We=g.forwardRef(function(n,s){const a=se({props:n,name:"MuiListItemAvatar"}),{className:c,...l}=a,x=g.useContext(ue),i={...a,alignItems:x.alignItems},r=Be(i);return e.jsx(Ye,{className:ne(r.root,c),ownerState:i,ref:s,...l})}),He=H(e.jsx("path",{d:"M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20z"})),Xe=H(e.jsx("path",{d:"M20 2H4c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2m0 18H4V4h16zM18 6h-5c-1.1 0-2 .9-2 2v2.28c-.6.35-1 .98-1 1.72 0 1.1.9 2 2 2s2-.9 2-2c0-.74-.4-1.38-1-1.72V8h3v8H8V8h2V6H6v12h12z"})),qe=({deviceId:t})=>{const{t:n}=X(["common","settings"]),{activeDevice:s,updateDeviceDetails:a,removeDevice:c,toggleLaPoste:l}=q(),[x,i]=g.useState(!1),[r,b]=g.useState({key:!s?.configuration_key,pin:!s?.door_pin_code}),[p,S]=g.useState(s?.friendly_name||""),[C,I]=g.useState(s?.configuration_key||""),[R,o]=g.useState(s?.door_pin_code||""),[d,u]=g.useState(s?.auto_sync??!1);me.useEffect(()=>{s&&(S(s.friendly_name||""),I(s.configuration_key||""),o(s.door_pin_code||""),u(s.auto_sync??!1))},[s]);const h=_=>{b(w=>({...w,[_]:!w[_]}))},j=async()=>{if(s)try{await a(t,{friendly_name:p,configuration_key:C,door_pin_code:R})}catch(_){console.error("Failed to update device details:",_)}},T=async _=>{i(!0);try{await l(_.target.checked)}catch(w){console.error("Failed to toggle La Poste:",w)}finally{i(!1)}},N=async()=>{if(s)try{await c(t)}catch(_){console.error("Failed to remove device:",_)}},f=_=>{const L=_.trim().toUpperCase().replace(/[^0-9A-F]/g,"").slice(-8);I(L)},A=async _=>{const w=_.target.checked;if(u(w),s)try{await a(t,{auto_sync:w})}catch(L){console.error("Failed to update auto sync:",L)}},F=_=>{const w=_.trim().toUpperCase();o(w)};return s?e.jsxs(y,{sx:{my:2},children:[e.jsx(v,{variant:"subtitle1",gutterBottom:!0,children:n("devices.title")}),e.jsx(ge,{sx:{mb:2}}),e.jsxs(y,{sx:{mb:2,p:2,border:"1px solid",borderColor:"divider",borderRadius:1},children:[e.jsx(v,{variant:"subtitle2",gutterBottom:!0,color:"primary",children:n("settings:device_info.title")}),e.jsxs(y,{sx:{display:"grid",gridTemplateColumns:"auto 1fr",columnGap:2,rowGap:.5},children:[e.jsxs(v,{variant:"body2",color:"textSecondary",children:[n("settings:device_info.hardware_version"),":"]}),e.jsx(v,{variant:"body2",sx:{fontWeight:"medium"},children:s.hardware_version||"N/A"}),e.jsxs(v,{variant:"body2",color:"textSecondary",children:[n("settings:device_info.firmware_revision"),":"]}),e.jsx(v,{variant:"body2",sx:{fontWeight:"medium"},children:s.firmware_revision||"N/A"}),e.jsxs(v,{variant:"body2",color:"textSecondary",children:[n("settings:device_info.software_revision"),":"]}),e.jsx(v,{variant:"body2",sx:{fontWeight:"medium"},children:s.software_revision||"N/A"})]})]}),e.jsx(he,{children:e.jsx(xe,{children:e.jsxs(y,{sx:{display:"flex",flexDirection:"column",gap:2},children:[e.jsx(U,{label:n("devices.device_name"),value:p,onChange:_=>S(_.currentTarget.value),fullWidth:!0,size:"small"}),s.role===fe.Admin&&e.jsx(U,{label:n("settings:configuration_key.label"),value:C,onChange:_=>f(_.currentTarget.value),fullWidth:!0,size:"small",type:r.key?"text":"password",helperText:n("settings:configuration_key.helper"),slotProps:{input:{endAdornment:e.jsx(K,{position:"end",children:e.jsx(Y,{"aria-label":n("settings:toggle_key_visibility"),onClick:()=>h("key"),edge:"end",size:"small",children:r.key?e.jsx($,{}):e.jsx(Q,{})})})}}}),e.jsx(U,{label:n("settings:door_pin_code"),value:R,onChange:_=>F(_.currentTarget.value),fullWidth:!0,size:"small",type:r.pin?"text":"password",slotProps:{input:{endAdornment:e.jsx(K,{position:"end",children:e.jsx(Y,{"aria-label":n("settings:toggle_pin_visibility"),onClick:()=>h("pin"),edge:"end",size:"small",children:r.pin?e.jsx($,{}):e.jsx(Q,{})})})}}}),e.jsx(J,{control:e.jsx(Z,{checked:d,onChange:A}),label:n("settings:device_auto_sync")}),s.hardware_version==="4.0"&&s.software_revision&&W(s.software_revision,"4.2.0")>=0&&e.jsxs(y,{sx:{display:"flex",alignItems:"center"},children:[e.jsx(J,{control:e.jsx(Z,{"data-testid":"la-poste-switch",checked:s.la_poste_activated||!1,onChange:T,disabled:x}),label:n("settings:activate_la_poste")}),x&&e.jsx(re,{size:20,sx:{ml:1}})]}),e.jsxs(y,{sx:{display:"flex",justifyContent:"space-between",mt:2},children:[e.jsx(k,{size:"small",color:"error",variant:"outlined",onClick:N,children:n("devices.forget")}),e.jsx(k,{size:"small",variant:"contained",onClick:j,children:n("save")})]})]})})})]}):null};var le=(t=>(t[t.LA_POSTE=1]="LA_POSTE",t[t.VIGIK_TERTIARY=2]="VIGIK_TERTIARY",t[t.USER_BADGE=3]="USER_BADGE",t))(le||{}),m=(t=>(t.IDLE="idle",t.SCANNING="scanning",t.FOUND="found",t.TIMEOUT="timeout",t.ERROR_EXISTS="error_exists",t.ERROR="error",t))(m||{});const Ke=()=>{const{activeDevice:t}=q(),{sendRequest:n}=_e(),{addListener:s,removeListener:a}=ve(),[c,l]=g.useState(m.IDLE),[x,i]=g.useState(null),r=t?.id,b=pe(()=>r?D.nfc_tags.where("device_id").equals(r).toArray():[],[r]),p=g.useCallback(async()=>{if(!r)throw new Error("No active device");const o=await D.device_secrets.get(r);if(!o?.configuration_key)throw new Error("Configuration Key required");return o.configuration_key},[r]),S=g.useCallback(async()=>{try{const o=await p();l(m.SCANNING),i(null),await n(new ye(o))}catch(o){console.error("Failed to start scan",o),l(m.ERROR)}},[p,n]);g.useEffect(()=>{const o=d=>{if(!(c!==m.SCANNING&&c!==m.IDLE)&&[E.NOTIFY_NFC_TAG_REGISTER_SCAN_RESULT,E.NOTIFY_NFC_TAG_REGISTER_SCAN_ERROR_EXISTS,E.NOTIFY_NFC_TAG_REGISTER_SCAN_TIMEOUT].includes(d.opcode)){const u=new Se(d.opcode);switch(u.parse(d.payload),u.status){case M.TIMEOUT:l(m.TIMEOUT);break;case M.ALREADY_EXISTS:l(m.ERROR_EXISTS),u.uid&&i(u.uid);break;case M.FOUND:l(m.FOUND),u.uid&&i(u.uid);break;default:l(m.ERROR)}}};return s(E.NOTIFY_NFC_TAG_REGISTER_SCAN_RESULT,o),s(E.NOTIFY_NFC_TAG_REGISTER_SCAN_ERROR_EXISTS,o),s(E.NOTIFY_NFC_TAG_REGISTER_SCAN_TIMEOUT,o),()=>{a(E.NOTIFY_NFC_TAG_REGISTER_SCAN_RESULT,o),a(E.NOTIFY_NFC_TAG_REGISTER_SCAN_ERROR_EXISTS,o),a(E.NOTIFY_NFC_TAG_REGISTER_SCAN_TIMEOUT,o)}},[s,a,c]);const C=g.useCallback(async o=>{if(!(!x||!r))try{const d=await p(),u=new Uint8Array(x.split(":").map(j=>parseInt(j,16)));if(c===m.FOUND){const j=new be(d,u);await n(j)}const h=await D.nfc_tags.where({device_id:r,uid:x}).first();h?await D.nfc_tags.update(h.id,{name:o,updated_at:Date.now()}):await D.nfc_tags.add({id:crypto.randomUUID(),device_id:r,uid:x,name:o,type:le.USER_BADGE,created_at:Date.now(),sync_status:"created"}),l(m.IDLE),i(null)}catch(d){throw console.error("Failed to register tag",d),d}},[x,r,p,n,c]),I=g.useCallback(async o=>{if(r)try{const d=await p(),u=new Uint8Array(o.uid.split(":").map(j=>parseInt(j,16))),h=new je(d,u);await n(h),await D.nfc_tags.delete(o.id)}catch(d){throw console.error("Failed to unregister tag",d),d}},[r,p,n]),R=g.useCallback(()=>{l(m.IDLE),i(null)},[]);return{tags:b,scanStatus:c,scannedUid:x,startScan:S,registerTag:C,unregisterTag:I,resetScan:R}},$e=()=>{const{t}=X(["common","settings"]),n=t,{tags:s,scanStatus:a,scannedUid:c,startScan:l,registerTag:x,unregisterTag:i,resetScan:r}=Ke(),[b,p]=g.useState(!1),[S,C]=g.useState(""),I=()=>{r(),C(""),p(!0)},R=()=>{p(!1),r()},o=()=>{l()},d=async()=>{if(S.trim())try{await x(S.trim()),R()}catch(h){console.error(h)}},u=async h=>{if(confirm(n("common:confirm_delete")))try{await i(h)}catch(j){console.error(j),alert(t("settings:nfc.error_delete_failed"))}};return e.jsxs(y,{sx:{p:2},children:[e.jsxs(y,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2},children:[e.jsx(v,{variant:"h6","data-testid":"nfc-tags-title",children:t("settings:nfc.title")}),e.jsx(k,{variant:"contained",startIcon:e.jsx(ke,{}),onClick:I,children:t("settings:nfc.add_tag")})]}),s&&s.length>0?e.jsx(oe,{children:s.map(h=>e.jsxs(ie,{secondaryAction:e.jsx(Y,{edge:"end","aria-label":"delete",onClick:()=>u(h),children:e.jsx(De,{})}),children:[e.jsx(We,{children:e.jsx(ze,{children:e.jsx(Xe,{})})}),e.jsx(ce,{primary:h.name,secondary:e.jsxs(e.Fragment,{children:[e.jsx(v,{component:"span",variant:"body2",color:"textPrimary",children:h.uid}),e.jsx("br",{}),h.last_seen_at?t("settings:nfc.last_seen",{date:new Date(h.last_seen_at).toLocaleString()}):t("settings:nfc.never_seen")]})})]},h.id))}):e.jsx(v,{variant:"body1",color:"textSecondary",align:"center",sx:{mt:4},children:t("settings:nfc.no_tags")}),e.jsxs(Ce,{open:b,onClose:R,fullWidth:!0,maxWidth:"sm",children:[e.jsx(Ie,{children:t("settings:nfc.dialog_title")}),e.jsx(Re,{children:e.jsxs(y,{sx:{display:"flex",flexDirection:"column",alignItems:"center",gap:2,py:2},children:[a===m.IDLE&&e.jsx(v,{children:t("settings:nfc.instructions_idle")}),a===m.SCANNING&&e.jsxs(e.Fragment,{children:[e.jsx(re,{}),e.jsx(v,{children:t("settings:nfc.instructions_scanning")})]}),a===m.TIMEOUT&&e.jsx(O,{severity:"warning",children:t("settings:nfc.error_timeout")}),a===m.ERROR&&e.jsx(O,{severity:"error",children:t("settings:nfc.error_generic")}),a===m.ERROR_EXISTS&&e.jsxs(O,{severity:"info",children:[t("settings:nfc.error_exists"),c&&e.jsxs(y,{sx:{mt:1},children:[e.jsxs(v,{variant:"caption",children:["UID: ",c]}),e.jsx(v,{children:t("settings:nfc.instructions_exists_local")})]})]}),(a===m.FOUND||a===m.ERROR_EXISTS)&&c&&e.jsxs(y,{sx:{width:"100%",mt:2},children:[e.jsx(O,{severity:"success",sx:{mb:2},children:t("settings:nfc.tag_found",{uid:c})}),e.jsx(U,{autoFocus:!0,margin:"dense",label:t("settings:nfc.input_label"),fullWidth:!0,value:S,onChange:h=>C(h.target.value),required:!0})]})]})}),e.jsxs(we,{children:[e.jsx(k,{onClick:R,children:t("common:cancel")}),a===m.IDLE||a===m.TIMEOUT||a===m.ERROR?e.jsx(k,{onClick:o,variant:"contained",children:t("settings:nfc.button_start_scan")}):null,(a===m.FOUND||a===m.ERROR_EXISTS)&&e.jsx(k,{onClick:d,variant:"contained",disabled:!S.trim(),children:t("settings:nfc.add_tag")})]})]})]})};function V(t){const{children:n,value:s,index:a,...c}=t;return e.jsx("div",{role:"tabpanel",hidden:s!==a,id:`my-boks-tabpanel-${a}`,"aria-labelledby":`my-boks-tab-${a}`,...c,children:s===a&&e.jsx(y,{sx:{p:3},children:n})})}function B(t){return{id:`my-boks-tab-${t}`,"aria-controls":`my-boks-tabpanel-${t}`}}const tt=()=>{const{t}=X(["common","codes","logs","settings"]),{activeDevice:n,knownDevices:s,setActiveDevice:a}=q(),{isConnected:c}=Te(),{showNotification:l}=Ee(),x=Ae(),[i,r]=g.useState(0),[b,p]=g.useState(null);g.useEffect(()=>{const A=new URLSearchParams(x.search).get("tab"),F=setTimeout(()=>{switch(A){case"settings":r(0);break;case"users":r(1);break;default:r(0);break}},0);return()=>clearTimeout(F)},[x.search]),g.useEffect(()=>{(!n||!s.some(f=>f.id===n.id))&&b!==null&&setTimeout(()=>p(null),0)},[n,s,b]);const S=f=>n?.software_revision?W(n.software_revision,f)>=0:!1,C=f=>n?.hardware_version?W(n.hardware_version,f)>=0:!1,I=S("4.3.3"),R=C("4.0"),o=I&&R,d=(f,A)=>{if(A===2){if(!R){l("Version Hardware 4.0 required","warning");return}if(!I){l("Version Firmware 4.3.3 required","warning");return}}r(A)},u=f=>{p(f),a(f)},h=()=>{p(null),a(null)},j=s.length>1&&!b&&!n;let T=t("common:my_boks");return n&&s.length===1||n&&s.length>1?T=n.friendly_name||n.ble_name:!n&&s.length===1&&(T=s[0].friendly_name||s[0].ble_name),j?e.jsxs(y,{sx:{p:3},children:[e.jsx(v,{variant:"h5",gutterBottom:!0,children:t("common:my_boks")}),e.jsx(oe,{children:s.map(f=>e.jsx(ie,{onClick:()=>u(f.id),sx:{cursor:"pointer"},children:e.jsx(ce,{primary:f.friendly_name||f.ble_name,secondary:f.ble_name})},f.id))})]}):n||s.find(f=>f.id===b)||(s.length===1?s[0]:null)?e.jsxs(y,{sx:{width:"100%"},children:[e.jsxs(y,{sx:{p:3,borderBottom:1,borderColor:"divider"},children:[s.length>1&&e.jsx(k,{startIcon:e.jsx(He,{}),onClick:h,sx:{mb:1},children:t("common:back_to_list")}),e.jsx(v,{variant:"h4",component:"h1",gutterBottom:!0,children:T}),e.jsx(v,{variant:"subtitle1",color:"textSecondary",children:t(c?"common:connected":"common:disconnected")})]}),e.jsx(y,{sx:{borderBottom:1,borderColor:"divider"},children:e.jsxs(Ne,{value:i,onChange:d,"aria-label":"my boks tabs",children:[e.jsx(z,{"data-testid":"tab-settings",label:t("settings:title"),...B(0)}),e.jsx(z,{"data-testid":"tab-users",label:t("common:users.title"),...B(1)}),e.jsx(z,{"data-testid":"tab-nfc",label:"Tags NFC",...B(2),sx:{opacity:o?1:.5}})]})}),e.jsx(V,{value:i,index:0,children:e.jsx(qe,{deviceId:n?.id||""})}),e.jsx(V,{value:i,index:1,children:e.jsxs(y,{sx:{p:3},children:[e.jsx(v,{variant:"h6",children:t("common:users.title")}),e.jsx(v,{variant:"body1",color:"textSecondary",children:t("common:coming_soon")})]})}),e.jsx(V,{value:i,index:2,children:o?e.jsx($e,{}):e.jsx(y,{sx:{p:3},children:"Feature Unavailable"})})]}):e.jsxs(y,{sx:{p:3},children:[e.jsx(v,{variant:"h5",children:t("common:my_boks")}),e.jsx(v,{variant:"body1",color:"textSecondary",children:t("common:no_active_device")})]})};export{tt as MyBoksPage};
