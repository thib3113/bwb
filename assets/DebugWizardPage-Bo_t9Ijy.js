import{g as q,a as ee,r as v,u as te,d as G,c as F,j as e,a9 as ie,b as ne,s as k,P as ze,m as Y,aa as Ee,e as oe,ab as $e,ac as Ne,i as ve,ad as Fe,ae as He,af as Ce,ag as Oe,ah as O,f as re,k as S,T as d,a7 as B,l as R,C as Z,ai as Te,z as J,A as X,D as _e,aj as Ge,ak as Ie,K as ye,al as Ye,M as De,am as Qe,an as Ke,a1 as Ze,a2 as Je,a3 as Xe,ao as qe,ap as et,E as tt,aq as nt,ar as ot,as as rt,h as st,at,n as it,au as lt,av as ct}from"./index-Lk4dMPcU.js";import{S as A}from"./Stack-C_MQ6yhr.js";import{C as dt}from"./Chip-Chpx1dAW.js";import{C as pt}from"./Container-Due64Hl4.js";import{L as ut}from"./LinearProgress-DDe0B0-7.js";function xt(t){return q("MuiMobileStepper",t)}ee("MuiMobileStepper",["root","positionBottom","positionTop","positionStatic","dots","dot","dotActive","progress"]);const mt=t=>{const{classes:o,position:n}=t,s={root:["root",`position${ie(n)}`],dots:["dots"],dot:["dot"],dotActive:["dotActive"],progress:["progress"]};return ne(s,xt,o)},ht=k(ze,{name:"MuiMobileStepper",slot:"Root",overridesResolver:(t,o)=>{const{ownerState:n}=t;return[o.root,o[`position${ie(n.position)}`]]}})(Y(({theme:t})=>({display:"flex",flexDirection:"row",justifyContent:"space-between",alignItems:"center",background:(t.vars||t).palette.background.default,padding:8,variants:[{props:({position:o})=>o==="top"||o==="bottom",style:{position:"fixed",left:0,right:0,zIndex:(t.vars||t).zIndex.mobileStepper}},{props:{position:"top"},style:{top:0}},{props:{position:"bottom"},style:{bottom:0}}]}))),vt=k("div",{name:"MuiMobileStepper",slot:"Dots"})({variants:[{props:{variant:"dots"},style:{display:"flex",flexDirection:"row"}}]}),yt=k("div",{name:"MuiMobileStepper",slot:"Dot",shouldForwardProp:t=>Ee(t)&&t!=="dotActive",overridesResolver:(t,o)=>{const{dotActive:n}=t;return[o.dot,n&&o.dotActive]}})(Y(({theme:t})=>({variants:[{props:{variant:"dots"},style:{transition:t.transitions.create("background-color",{duration:t.transitions.duration.shortest}),backgroundColor:(t.vars||t).palette.action.disabled,borderRadius:"50%",width:8,height:8,margin:"0 2px"}},{props:{variant:"dots",dotActive:!0},style:{backgroundColor:(t.vars||t).palette.primary.main}}]}))),ft=k(ut,{name:"MuiMobileStepper",slot:"Progress"})({variants:[{props:{variant:"progress"},style:{width:"50%"}}]}),gt=v.forwardRef(function(o,n){const s=te({props:o,name:"MuiMobileStepper"}),{activeStep:l=0,backButton:a,className:f,LinearProgressProps:r,nextButton:g,position:u="bottom",steps:b,variant:i="dots",slots:p={},slotProps:x={},...y}=s,j={...s,activeStep:l,position:u,variant:i};let c;i==="progress"&&(b===1?c=100:c=Math.ceil(l/(b-1)*100));const m=mt(j),h={slots:p,slotProps:{progress:r,...x}},[w,D]=G("root",{ref:n,elementType:ht,shouldForwardComponentProp:!0,className:F(m.root,f),externalForwardedProps:{...h,...y},ownerState:j,additionalProps:{square:!0,elevation:0}}),[C,z]=G("dots",{className:m.dots,elementType:vt,externalForwardedProps:h,ownerState:j}),[I,T]=G("dot",{elementType:yt,externalForwardedProps:h,ownerState:j}),[_,U]=G("progress",{className:m.progress,elementType:ft,shouldForwardComponentProp:!0,externalForwardedProps:h,ownerState:j,additionalProps:{value:c,variant:"determinate"}});return e.jsxs(w,{...D,children:[a,i==="text"&&e.jsxs(v.Fragment,{children:[l+1," / ",b]}),i==="dots"&&e.jsx(C,{...z,children:[...new Array(b)].map((M,W)=>e.jsx(I,{...T,className:F(m.dot,T.className,W===l&&m.dotActive),dotActive:W===l},W))}),i==="progress"&&e.jsx(_,{...U}),g]})}),le=v.createContext({}),fe=v.createContext({});function bt(t){return q("MuiStep",t)}ee("MuiStep",["root","horizontal","vertical","alternativeLabel","completed"]);const jt=t=>{const{classes:o,orientation:n,alternativeLabel:s,completed:l}=t;return ne({root:["root",n,s&&"alternativeLabel",l&&"completed"]},bt,o)},St=k("div",{name:"MuiStep",slot:"Root",overridesResolver:(t,o)=>{const{ownerState:n}=t;return[o.root,o[n.orientation],n.alternativeLabel&&o.alternativeLabel,n.completed&&o.completed]}})({variants:[{props:{orientation:"horizontal"},style:{paddingLeft:8,paddingRight:8}},{props:{alternativeLabel:!0},style:{flex:1,position:"relative"}}]}),wt=v.forwardRef(function(o,n){const s=te({props:o,name:"MuiStep"}),{active:l,children:a,className:f,component:r="div",completed:g,disabled:u,expanded:b=!1,index:i,last:p,...x}=s,{activeStep:y,connector:j,alternativeLabel:c,orientation:m,nonLinear:h}=v.useContext(le);let[w=!1,D=!1,C=!1]=[l,g,u];y===i?w=l!==void 0?l:!0:!h&&y>i?D=g!==void 0?g:!0:!h&&y<i&&(C=u!==void 0?u:!0);const z=v.useMemo(()=>({index:i,last:p,expanded:b,icon:i+1,active:w,completed:D,disabled:C}),[i,p,b,w,D,C]),I={...s,active:w,orientation:m,alternativeLabel:c,completed:D,disabled:C,expanded:b,component:r},T=jt(I),_=e.jsxs(St,{as:r,className:F(T.root,f),ref:n,ownerState:I,...x,children:[j&&c&&i!==0?j:null,a]});return e.jsx(fe.Provider,{value:z,children:j&&!c&&i!==0?e.jsxs(v.Fragment,{children:[j,_]}):_})}),Ct=oe(e.jsx("path",{d:"M12 0a12 12 0 1 0 0 24 12 12 0 0 0 0-24zm-2 17l-5-5 1.4-1.4 3.6 3.6 7.6-7.6L19 8l-9 9z"})),It=oe(e.jsx("path",{d:"M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"}));function Lt(t){return q("MuiStepIcon",t)}const me=ee("MuiStepIcon",["root","active","completed","error","text"]);var Le;const zt=t=>{const{classes:o,active:n,completed:s,error:l}=t;return ne({root:["root",n&&"active",s&&"completed",l&&"error"],text:["text"]},Lt,o)},he=k($e,{name:"MuiStepIcon",slot:"Root"})(Y(({theme:t})=>({display:"block",transition:t.transitions.create("color",{duration:t.transitions.duration.shortest}),color:(t.vars||t).palette.text.disabled,[`&.${me.completed}`]:{color:(t.vars||t).palette.primary.main},[`&.${me.active}`]:{color:(t.vars||t).palette.primary.main},[`&.${me.error}`]:{color:(t.vars||t).palette.error.main}}))),Tt=k("text",{name:"MuiStepIcon",slot:"Text"})(Y(({theme:t})=>({fill:(t.vars||t).palette.primary.contrastText,fontSize:t.typography.caption.fontSize,fontFamily:t.typography.fontFamily}))),_t=v.forwardRef(function(o,n){const s=te({props:o,name:"MuiStepIcon"}),{active:l=!1,className:a,completed:f=!1,error:r=!1,icon:g,...u}=s,b={...s,active:l,completed:f,error:r},i=zt(b);if(typeof g=="number"||typeof g=="string"){const p=F(a,i.root);return r?e.jsx(he,{as:It,className:p,ref:n,ownerState:b,...u}):f?e.jsx(he,{as:Ct,className:p,ref:n,ownerState:b,...u}):e.jsxs(he,{className:p,ref:n,ownerState:b,...u,children:[Le||(Le=e.jsx("circle",{cx:"12",cy:"12",r:"12"})),e.jsx(Tt,{className:i.text,x:"12",y:"12",textAnchor:"middle",dominantBaseline:"central",ownerState:b,children:g})]})}return g});function Dt(t){return q("MuiStepLabel",t)}const N=ee("MuiStepLabel",["root","horizontal","vertical","label","active","completed","error","disabled","iconContainer","alternativeLabel","labelContainer"]),Rt=t=>{const{classes:o,orientation:n,active:s,completed:l,error:a,disabled:f,alternativeLabel:r}=t;return ne({root:["root",n,a&&"error",f&&"disabled",r&&"alternativeLabel"],label:["label",s&&"active",l&&"completed",a&&"error",f&&"disabled",r&&"alternativeLabel"],iconContainer:["iconContainer",s&&"active",l&&"completed",a&&"error",f&&"disabled",r&&"alternativeLabel"],labelContainer:["labelContainer",r&&"alternativeLabel"]},Dt,o)},kt=k("span",{name:"MuiStepLabel",slot:"Root",overridesResolver:(t,o)=>{const{ownerState:n}=t;return[o.root,o[n.orientation]]}})({display:"flex",alignItems:"center",[`&.${N.alternativeLabel}`]:{flexDirection:"column"},[`&.${N.disabled}`]:{cursor:"default"},variants:[{props:{orientation:"vertical"},style:{textAlign:"left",padding:"8px 0"}}]}),Mt=k("span",{name:"MuiStepLabel",slot:"Label"})(Y(({theme:t})=>({...t.typography.body2,display:"block",transition:t.transitions.create("color",{duration:t.transitions.duration.shortest}),[`&.${N.active}`]:{color:(t.vars||t).palette.text.primary,fontWeight:500},[`&.${N.completed}`]:{color:(t.vars||t).palette.text.primary,fontWeight:500},[`&.${N.alternativeLabel}`]:{marginTop:16},[`&.${N.error}`]:{color:(t.vars||t).palette.error.main}}))),At=k("span",{name:"MuiStepLabel",slot:"IconContainer"})({flexShrink:0,display:"flex",paddingRight:8,[`&.${N.alternativeLabel}`]:{paddingRight:0}}),Ut=k("span",{name:"MuiStepLabel",slot:"LabelContainer"})(Y(({theme:t})=>({width:"100%",color:(t.vars||t).palette.text.secondary,[`&.${N.alternativeLabel}`]:{textAlign:"center"}}))),Re=v.forwardRef(function(o,n){const s=te({props:o,name:"MuiStepLabel"}),{children:l,className:a,componentsProps:f={},error:r=!1,icon:g,optional:u,slots:b={},slotProps:i={},StepIconComponent:p,StepIconProps:x,...y}=s,{alternativeLabel:j,orientation:c}=v.useContext(le),{active:m,disabled:h,completed:w,icon:D}=v.useContext(fe),C=g||D;let z=p;C&&!z&&(z=_t);const I={...s,active:m,alternativeLabel:j,completed:w,disabled:h,error:r,orientation:c},T=Rt(I),_={slots:b,slotProps:{stepIcon:x,...f,...i}},[U,M]=G("root",{elementType:kt,externalForwardedProps:{..._,...y},ownerState:I,ref:n,className:F(T.root,a)}),[W,Q]=G("label",{elementType:Mt,externalForwardedProps:_,ownerState:I}),[P,ce]=G("stepIcon",{elementType:z,externalForwardedProps:_,ownerState:I});return e.jsxs(U,{...M,children:[C||P?e.jsx(At,{className:T.iconContainer,ownerState:I,children:e.jsx(P,{completed:w,active:m,error:r,icon:C,...ce})}):null,e.jsxs(Ut,{className:T.labelContainer,ownerState:I,children:[l?e.jsx(W,{...Q,className:F(T.label,Q?.className),children:l}):null,u]})]})});Re.muiName="StepLabel";function Wt(t){return q("MuiStepConnector",t)}ee("MuiStepConnector",["root","horizontal","vertical","alternativeLabel","active","completed","disabled","line","lineHorizontal","lineVertical"]);const Pt=t=>{const{classes:o,orientation:n,alternativeLabel:s,active:l,completed:a,disabled:f}=t,r={root:["root",n,s&&"alternativeLabel",l&&"active",a&&"completed",f&&"disabled"],line:["line",`line${ie(n)}`]};return ne(r,Wt,o)},Bt=k("div",{name:"MuiStepConnector",slot:"Root",overridesResolver:(t,o)=>{const{ownerState:n}=t;return[o.root,o[n.orientation],n.alternativeLabel&&o.alternativeLabel,n.completed&&o.completed]}})({flex:"1 1 auto",variants:[{props:{orientation:"vertical"},style:{marginLeft:12}},{props:{alternativeLabel:!0},style:{position:"absolute",top:12,left:"calc(-50% + 20px)",right:"calc(50% + 20px)"}}]}),Vt=k("span",{name:"MuiStepConnector",slot:"Line",overridesResolver:(t,o)=>{const{ownerState:n}=t;return[o.line,o[`line${ie(n.orientation)}`]]}})(Y(({theme:t})=>{const o=t.palette.mode==="light"?t.palette.grey[400]:t.palette.grey[600];return{display:"block",borderColor:t.vars?t.vars.palette.StepConnector.border:o,variants:[{props:{orientation:"horizontal"},style:{borderTopStyle:"solid",borderTopWidth:1}},{props:{orientation:"vertical"},style:{borderLeftStyle:"solid",borderLeftWidth:1,minHeight:24}}]}})),Et=v.forwardRef(function(o,n){const s=te({props:o,name:"MuiStepConnector"}),{className:l,...a}=s,{alternativeLabel:f,orientation:r="horizontal"}=v.useContext(le),{active:g,disabled:u,completed:b}=v.useContext(fe),i={...s,alternativeLabel:f,orientation:r,active:g,completed:b,disabled:u},p=Pt(i);return e.jsx(Bt,{className:F(p.root,l),ref:n,ownerState:i,...a,children:e.jsx(Vt,{className:p.line,ownerState:i})})});function $t(t){return q("MuiStepper",t)}ee("MuiStepper",["root","horizontal","vertical","nonLinear","alternativeLabel"]);const Nt=t=>{const{orientation:o,nonLinear:n,alternativeLabel:s,classes:l}=t;return ne({root:["root",o,n&&"nonLinear",s&&"alternativeLabel"]},$t,l)},Ft=k("div",{name:"MuiStepper",slot:"Root",overridesResolver:(t,o)=>{const{ownerState:n}=t;return[o.root,o[n.orientation],n.alternativeLabel&&o.alternativeLabel,n.nonLinear&&o.nonLinear]}})({display:"flex",variants:[{props:{orientation:"horizontal"},style:{flexDirection:"row",alignItems:"center"}},{props:{orientation:"vertical"},style:{flexDirection:"column"}},{props:{alternativeLabel:!0},style:{alignItems:"flex-start"}}]}),Ht=e.jsx(Et,{}),Ot=v.forwardRef(function(o,n){const s=te({props:o,name:"MuiStepper"}),{activeStep:l=0,alternativeLabel:a=!1,children:f,className:r,component:g="div",connector:u=Ht,nonLinear:b=!1,orientation:i="horizontal",...p}=s,x={...s,nonLinear:b,alternativeLabel:a,orientation:i,component:g},y=Nt(x),j=v.Children.toArray(f).filter(Boolean),c=j.map((h,w)=>v.cloneElement(h,{index:w,last:w+1===j.length,...h.props})),m=v.useMemo(()=>({activeStep:l,alternativeLabel:a,connector:u,nonLinear:b,orientation:i}),[l,a,u,b,i]);return e.jsx(le.Provider,{value:m,children:e.jsx(Ft,{as:g,ownerState:x,className:F(y.root,r),ref:n,...p,children:c})})}),Gt=oe(e.jsx("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m-2 15-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8z"})),Yt=oe(e.jsx("path",{d:"m12 8-6 6 1.41 1.41L12 10.83l4.59 4.58L18 14z"})),Qt=oe(e.jsx("path",{d:"M21 6h-2v9H6v2c0 .55.45 1 1 1h11l4 4V7c0-.55-.45-1-1-1m-4 6V3c0-.55-.45-1-1-1H3c-.55 0-1 .45-1 1v14l4-4h10c.55 0 1-.45 1-1"})),Kt=oe(e.jsx("path",{d:"M19.8 18.4 14 10.67V6.5l1.35-1.69c.26-.33.03-.81-.39-.81H9.04c-.42 0-.65.48-.39.81L10 6.5v4.17L4.2 18.4c-.49.66-.02 1.6.8 1.6h14c.82 0 1.29-.94.8-1.6"})),Zt=()=>{const t=v.useContext(Ne);if(t===void 0)throw new Error("useSession must be used within a SessionProvider");return t},Jt=t=>{const{readCharacteristic:o}=ve(),[n,s]=v.useState(!1),[l,a]=v.useState(t?.batteryData||null),[f,r]=v.useState(t?.analysis||null),g=v.useCallback(async(u,b)=>{if(!u||!u.gatt||!u.gatt.connected)throw new Error("Device not connected");console.log("[BatteryDiag] Starting diagnostics using context read..."),s(!0);const i={standardLevel:null,standardError:null,rawHex:null,serviceUuid:null,parsed:null,error:null};try{try{console.log("[BatteryDiag] Reading Standard Battery Service...");const p=await o(Fe,He);i.standardLevel=p.getUint8(0),console.log("[BatteryDiag] Standard Level:",i.standardLevel)}catch(p){const x=p instanceof Error?p.message:String(p);console.warn("[BatteryDiag] Standard Battery Read Failed:",x),i.standardError=x}try{console.log("[BatteryDiag] Reading Proprietary Battery Characteristic...");const p=await o(Ce,Oe),x=new Uint8Array(p.buffer);i.rawHex=Array.from(x).map(m=>m.toString(16).padStart(2,"0").toUpperCase()).join(" "),i.serviceUuid=Ce,console.log("[BatteryDiag] Proprietary Data (HEX):",i.rawHex);const y=p.byteLength;let j="Unknown";y===1?j="Single Measure":y===4?j="T1/T5/T10":y===6&&(j="Min/Mean/Max");const c={format:j};if(y===1)c.level=p.getUint8(0);else if(y===4)c.level=p.getUint8(0),c.t1=p.getUint8(1),c.t5=p.getUint8(2),c.temp_C=p.getUint8(3)-25;else if(y===6){const m=new Uint8Array(p.buffer),h=w=>w===O;h(m[0])&&h(m[1])&&h(m[2])&&h(m[3])&&h(m[4])?i.error="Données invalides (255)":(c.first_mV=m[0]===O?void 0:m[0]*100,c.min_mV=m[1]===O?void 0:m[1]*100,c.mean_mV=m[2]===O?void 0:m[2]*100,c.max_mV=m[3]===O?void 0:m[3]*100,c.last_mV=m[4]===O?void 0:m[4]*100,c.temp_C=m[5]===O?void 0:m[5]-25)}else c.rawLength=y;i.parsed=c}catch(p){const x=p instanceof Error?p.message:String(p);console.error("[BatteryDiag] Proprietary Read Error:",x),i.error=x}if(a(i),i.parsed)try{const p=Xt(i,b);r(p)}catch(p){console.error("Error analyzing battery data:",p);const x=p instanceof Error?p.message:String(p);i.error=(i.error||"")+` | Analysis failed: ${x}`}}catch(p){console.error("[BatteryDiag] Global Error:",p)}finally{s(!1)}},[o]);return{isReading:n,batteryData:l,analysis:f,readBatteryDiagnostics:g}};function Xt(t,o){const n={userClaimType:null,userClaimText:"Inconnue",detectedType:"Unknown",detectedText:"Incertain",finalType:"aaa",consistencyStatus:"neutral",consistencyText:""};if(!t.parsed)return n.consistencyStatus="error",n.consistencyText="Données propriétaires non disponibles",n;const s=t.parsed.last_mV;return o&&(o.answer==="Oui"&&o.inference?(n.userClaimType=o.inference.battery,n.userClaimText=o.inference.label+" (Confirmé)"):o.answer==="Non"?(n.userClaimText="Infirmé par l'utilisateur",n.userClaimType="rejected"):o.answer==="Inconnu"&&(n.userClaimText="Inconnu (Utilisateur)",n.userClaimType="unknown")),s&&(s>5e3?(n.detectedType="aaa",n.detectedText="8x AAA ( > 5V )"):s<4500?(n.detectedType="lsh14",n.detectedText="LSH14 ( < 4.5V )"):n.detectedText=`Ambigu (${(s/1e3).toFixed(2)}V)`),n.userClaimType==="aaa"||n.userClaimType==="lsh14"?n.detectedType!=="Unknown"?n.userClaimType===n.detectedType?(n.finalType=n.detectedType||"aaa",n.consistencyStatus="success",n.consistencyText="✅ Cohérent : Le voltage confirme le matériel."):(n.finalType=n.detectedType||"aaa",n.consistencyStatus="error",n.consistencyText="❌ Incohérence : Le voltage contredit le matériel déclaré !"):(n.finalType=n.userClaimType,n.consistencyStatus="warning",n.consistencyText="⚠️ Voltage ambigu, utilisation du type déclaré."):n.detectedType!=="Unknown"?(n.finalType=n.detectedType||"aaa",n.consistencyStatus="success",n.consistencyText="ℹ️ Type déduit automatiquement du voltage."):(n.finalType="aaa",n.consistencyStatus="warning",n.consistencyText="⚠️ Impossible de déterminer le type (Voltage ambigu). Par défaut : AAA."),n}const qt=({isConnected:t,isConnecting:o,connect:n,error:s,device:l,firmwareVersion:a,isLoadingInfo:f,onRetryFetch:r})=>{const{t:g}=re(["wizard","common"]),u=g;return e.jsxs(S,{sx:{mt:2},children:[e.jsx(d,{variant:"h6",gutterBottom:!0,children:u("connect.title")}),e.jsx(d,{variant:"body2",color:"text.secondary",sx:{mb:2},children:u("connect.desc")}),t?e.jsx(J,{variant:"outlined",sx:{mt:2,borderColor:"success.main"},children:e.jsxs(X,{children:[e.jsxs(A,{direction:"row",alignItems:"center",spacing:2,sx:{mb:2},children:[e.jsx(Gt,{color:"success",fontSize:"large"}),e.jsxs(S,{children:[e.jsx(d,{variant:"h6",color:"success.main",children:u("connect.success")}),e.jsx(d,{variant:"body2",color:"text.secondary",children:u("connect.ready")})]})]}),e.jsx(_e,{sx:{my:2}}),e.jsx(d,{variant:"subtitle2",gutterBottom:!0,children:"Informations de l'appareil :"}),e.jsxs(A,{spacing:1,children:[e.jsxs(S,{display:"flex",justifyContent:"space-between",children:[e.jsx(d,{variant:"body2",color:"text.secondary",children:"Nom :"}),e.jsx(d,{variant:"body2",fontWeight:"medium",children:l?.name||"Inconnu"})]}),e.jsxs(S,{display:"flex",justifyContent:"space-between",children:[e.jsx(d,{variant:"body2",color:"text.secondary",children:"ID :"}),e.jsx(d,{variant:"body2",fontWeight:"medium",children:l?.id||"Inconnu"})]}),e.jsxs(S,{display:"flex",justifyContent:"space-between",alignItems:"center",children:[e.jsx(d,{variant:"body2",color:"text.secondary",children:"Firmware :"}),e.jsxs(S,{display:"flex",alignItems:"center",gap:1,children:[e.jsx(d,{variant:"body2",fontWeight:"medium",children:f?e.jsx(Z,{size:12}):a||"Inconnu"}),!f&&e.jsx(R,{size:"small",onClick:r,sx:{minWidth:0,p:.5},children:e.jsx(Ge,{sx:{fontSize:16}})})]})]})]})]})}):e.jsxs(S,{sx:{display:"flex",flexDirection:"column",alignItems:"center",gap:2,py:4},children:[s&&e.jsx(B,{severity:"error",sx:{width:"100%",mb:2},children:s.startsWith("errors.")?u(`common:${s}`):s}),e.jsx(R,{variant:"contained",size:"large",startIcon:o?e.jsx(Z,{size:20,color:"inherit"}):e.jsx(Te,{}),onClick:()=>n(),disabled:o,children:u(o?"common:connecting":"connect.button")})]})]})},en=({pinCode:t,updateDebugWizardState:o,onOpenDoor:n,isOpening:s,isConnected:l,openDoorSuccess:a,openDoorError:f,batteryData:r,waitingForClose:g,isReadingBattery:u,isPreparing:b,analysis:i})=>{const{t:p}=re(),x=p;return e.jsxs(S,{sx:{mt:2},children:[e.jsx(d,{variant:"h6",gutterBottom:!0,children:x("wizard:door.title")}),e.jsx(d,{variant:"body2",color:"text.secondary",sx:{mb:2},children:x("wizard:door.desc")}),e.jsxs(A,{spacing:3,children:[e.jsx(J,{variant:"outlined",children:e.jsxs(X,{children:[e.jsxs(A,{direction:"row",alignItems:"center",spacing:1,sx:{mb:2},children:[e.jsx(Ie,{color:"primary"}),e.jsx(d,{variant:"h6",children:x("wizard:door.open")})]}),e.jsxs(S,{sx:{display:"flex",flexDirection:"column",gap:2},children:[e.jsx(ye,{label:x("codes:pin_label"),variant:"outlined",size:"small",value:t||"",onChange:y=>{const j=y.currentTarget.value.toUpperCase();/^[0-9AB]*$/.test(j)&&j.length<=6&&o({pinCode:j})},placeholder:x("wizard:door.pin_placeholder"),type:"text",fullWidth:!0,inputProps:{maxLength:6}}),e.jsx(R,{variant:"contained",onClick:n,disabled:s||!l,startIcon:s?e.jsx(Z,{size:20,color:"inherit"}):e.jsx(Ie,{}),children:x(s?"wizard:door.opening":"wizard:door.open")}),a&&!f&&e.jsx(B,{severity:"success",children:x("wizard:door.success")}),f&&e.jsx(B,{severity:"error",children:f})]})]})}),e.jsx(J,{variant:"outlined",children:e.jsxs(X,{children:[e.jsxs(A,{direction:"row",alignItems:"center",spacing:1,sx:{mb:2},children:[e.jsx(Ye,{color:"primary"}),e.jsx(d,{variant:"h6",children:x("battery_level")})]}),e.jsxs(S,{sx:{display:"flex",flexDirection:"column",gap:2},children:[!r&&!g&&!u&&!b&&e.jsx(B,{severity:"info",children:x("wizard:battery.wait")}),g&&e.jsx(B,{severity:"info",icon:e.jsx(Z,{size:20}),children:x("wizard:battery.waiting_close")}),(u||b)&&e.jsx(B,{severity:"info",icon:e.jsx(Z,{size:20}),children:x("wizard:battery.analyzing")}),r&&e.jsxs(S,{sx:{mt:2,p:2,bgcolor:"background.paper",borderRadius:1,border:1,borderColor:"divider"},children:[e.jsxs(S,{display:"flex",justifyContent:"space-between",mb:1,children:[e.jsxs(d,{variant:"body2",color:"text.primary",children:[x("wizard:battery.standard_level"),":"]}),e.jsx(d,{variant:"body2",fontWeight:"bold",color:"text.primary",children:r.standardLevel!==null?`${r.standardLevel}%`:"N/A"})]}),r.parsed&&e.jsxs(e.Fragment,{children:[e.jsx(_e,{sx:{my:1}}),e.jsxs(d,{variant:"subtitle2",gutterBottom:!0,color:"text.primary",children:[x("wizard:battery.proprietary_data")," (",r.parsed.format,")"]}),r.parsed.level!==void 0&&e.jsxs(S,{display:"flex",justifyContent:"space-between",children:[e.jsxs(d,{variant:"body2",color:"text.primary",children:[x("battery_level")," (Proprietary):"]}),e.jsxs(d,{variant:"body2",fontWeight:"bold",color:"text.primary",children:[r.parsed.level,"%"]})]}),r.parsed.first_mV!==void 0&&e.jsxs(S,{display:"flex",justifyContent:"space-between",children:[e.jsx(d,{variant:"body2",color:"text.primary",children:"Voltage (First):"}),e.jsx(d,{variant:"body2",fontWeight:"bold",color:"text.primary",children:r.parsed.first_mV!==null?`${(r.parsed.first_mV/1e3).toFixed(2)} V`:"N/A"})]}),r.parsed.min_mV!==void 0&&e.jsxs(S,{display:"flex",justifyContent:"space-between",children:[e.jsx(d,{variant:"body2",color:"text.primary",children:"Voltage (Min):"}),e.jsx(d,{variant:"body2",fontWeight:"bold",color:"text.primary",children:r.parsed.min_mV!==null?`${(r.parsed.min_mV/1e3).toFixed(2)} V`:"N/A"})]}),r.parsed.mean_mV!==void 0&&e.jsxs(S,{display:"flex",justifyContent:"space-between",children:[e.jsx(d,{variant:"body2",color:"text.primary",children:"Voltage (Mean):"}),e.jsx(d,{variant:"body2",fontWeight:"bold",color:"text.primary",children:r.parsed.mean_mV!==null?`${(r.parsed.mean_mV/1e3).toFixed(2)} V`:"N/A"})]}),r.parsed.max_mV!==void 0&&e.jsxs(S,{display:"flex",justifyContent:"space-between",children:[e.jsx(d,{variant:"body2",color:"text.primary",children:"Voltage (Max):"}),e.jsx(d,{variant:"body2",fontWeight:"bold",color:"text.primary",children:r.parsed.max_mV!==null?`${(r.parsed.max_mV/1e3).toFixed(2)} V`:"N/A"})]}),r.parsed.last_mV!==void 0&&e.jsxs(S,{display:"flex",justifyContent:"space-between",children:[e.jsxs(d,{variant:"body2",color:"text.primary",children:[x("wizard:battery.voltage_last"),":"]}),e.jsx(d,{variant:"body2",fontWeight:"bold",color:"text.primary",children:r.parsed.last_mV!==null?`${(r.parsed.last_mV/1e3).toFixed(2)} V`:"N/A"})]}),r.parsed.t1!==void 0&&e.jsxs(S,{display:"flex",justifyContent:"space-between",children:[e.jsx(d,{variant:"body2",color:"text.primary",children:"T1:"}),e.jsx(d,{variant:"body2",fontWeight:"bold",color:"text.primary",children:r.parsed.t1})]}),r.parsed.t5!==void 0&&e.jsxs(S,{display:"flex",justifyContent:"space-between",children:[e.jsx(d,{variant:"body2",color:"text.primary",children:"T5:"}),e.jsx(d,{variant:"body2",fontWeight:"bold",color:"text.primary",children:r.parsed.t5})]}),r.parsed.temp_C!==void 0&&e.jsxs(S,{display:"flex",justifyContent:"space-between",children:[e.jsxs(d,{variant:"body2",color:"text.primary",children:[x("wizard:battery.temperature"),":"]}),e.jsx(d,{variant:"body2",fontWeight:"bold",color:"text.primary",children:r.parsed.temp_C!==null?`${r.parsed.temp_C}°C`:"N/A"})]}),i&&e.jsxs(S,{sx:{mt:2,p:1,border:"1px solid",borderColor:"divider",borderRadius:1,bgcolor:"background.paper"},children:[e.jsxs(d,{variant:"caption",display:"block",color:"text.secondary",children:[x("wizard:battery.analysis"),":"]}),e.jsxs(d,{variant:"body2",gutterBottom:!0,color:"text.primary",children:[x("wizard:battery.detected_type"),":"," ",e.jsx("strong",{children:i.detectedText})]}),e.jsx(d,{variant:"body2",color:i.consistencyStatus==="success"?"success.main":i.consistencyStatus==="error"?"error.main":"warning.main",fontWeight:"medium",children:i.consistencyText})]})]}),r.error&&e.jsx(B,{severity:"warning",sx:{mt:1},children:r.error})]})]})]})})]})]})},tn=({questionAnswers:t,onAnswerQuestion:o})=>{const{t:n}=re(["wizard","common"]),s=[{id:"has_scale",text:n("questions.has_scale"),expected:"Non"},{id:"anything_special",text:n("questions.anything_special"),expected:"Non"}];return e.jsxs(S,{sx:{mt:2},children:[e.jsx(d,{variant:"h6",gutterBottom:!0,children:n("questions.title")}),e.jsx(d,{variant:"body2",color:"text.secondary",sx:{mb:2},children:n("questions.desc")}),e.jsx(A,{spacing:2,children:s.map(l=>{const a=t.find(f=>f.id===l.id);return e.jsx(J,{variant:"outlined",children:e.jsxs(X,{children:[e.jsxs(A,{direction:"row",spacing:1,alignItems:"flex-start",mb:2,children:[e.jsx(Qt,{color:"action"}),e.jsx(d,{variant:"subtitle1",fontWeight:"medium",children:l.text})]}),e.jsxs(A,{direction:"row",spacing:1,children:[e.jsx(R,{variant:a?.answer==="Oui"?"contained":"outlined",onClick:()=>o(l.id,"Oui",l.expected),color:a?.answer==="Oui"?"primary":"inherit",children:n("common:yes")}),e.jsx(R,{variant:a?.answer==="Non"?"contained":"outlined",onClick:()=>o(l.id,"Non",l.expected),color:a?.answer==="Non"?"primary":"inherit",children:n("common:no")}),e.jsx(R,{variant:a?.answer==="Inconnu"?"contained":"outlined",onClick:()=>o(l.id,"Inconnu",l.expected),color:a?.answer==="Inconnu"?"secondary":"inherit",children:n("common:unknown")})]})]})},l.id)})})]})},nn=({customUuids:t,customResults:o,updateDebugWizardState:n})=>{const{t:s}=re(["wizard","common","codes"]),{connect:l,disconnect:a,device:f}=ve(),[r,g]=v.useState(!1),[u,b]=v.useState(""),[i,p]=v.useState(!1),x=()=>{if(!u)return;const c=u.trim().toLowerCase();t.includes(c)||(n({customUuids:[...t,c]}),b(""))},y=c=>{n({customUuids:t.filter(m=>m!==c)})},j=async()=>{if(t.length!==0){p(!0);try{console.log("DebugWizard: Disconnecting for custom discovery..."),a(),await new Promise(h=>setTimeout(h,qe)),console.log("DebugWizard: Reconnecting with custom services:",t),await l(t),await new Promise(h=>setTimeout(h,et));const c=[],m=f;m?.gatt?.connected||console.warn("Device not marked as connected yet, checking GATT directly...");for(const h of t)try{console.log(`DebugWizard: Accessing service ${h}`);const w=m?.gatt;if(!w)continue;const C=await(await w.getPrimaryService(h)).getCharacteristics();for(const z of C)try{console.log(`DebugWizard: Reading characteristic ${z.uuid}`);const I=await z.readValue(),T=new Uint8Array(I.buffer),_=Array.from(T).map(U=>U.toString(16).padStart(2,"0").toUpperCase()).join(" ");c.push({serviceUuid:h,charUuid:z.uuid,value:_,timestamp:new Date().toISOString()})}catch(I){console.warn(`Failed to read char ${z.uuid} in service ${h}`,I)}}catch(w){console.warn(`Failed to access service ${h}`,w)}n({customResults:c})}catch(c){console.error("Custom discovery failed:",c)}finally{p(!1)}}};return e.jsxs(S,{sx:{mt:2},children:[e.jsx(d,{variant:"h6",gutterBottom:!0,children:s("advanced.title")}),e.jsx(B,{severity:"info",sx:{mb:3},children:s("advanced.warning")}),e.jsxs(A,{spacing:3,children:[e.jsx(J,{variant:"outlined",children:e.jsxs(X,{children:[e.jsxs(S,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",cursor:"pointer"},onClick:()=>g(!r),children:[e.jsxs(A,{direction:"row",alignItems:"center",spacing:1,children:[e.jsx(Kt,{color:"primary"}),e.jsx(d,{variant:"h6",children:s("advanced.tutorial_title")})]}),e.jsx(De,{children:r?e.jsx(Yt,{}):e.jsx(Qe,{})})]}),e.jsx(Ke,{in:r,children:e.jsxs(S,{sx:{mt:3},children:[e.jsx(d,{variant:"body2",sx:{mb:2},children:s("advanced.tutorial_desc")}),e.jsxs(A,{direction:"row",spacing:2,sx:{mt:2,justifyContent:"center"},children:[e.jsx(R,{variant:"outlined",href:"https://play.google.com/store/apps/details?id=no.nordicsemi.android.mcp",target:"_blank",rel:"noopener noreferrer",children:"Android (Play Store)"}),e.jsx(R,{variant:"outlined",href:"https://apps.apple.com/us/app/nrf-connect-for-mobile/id1054362403",target:"_blank",rel:"noopener noreferrer",children:"iOS (App Store)"})]})]})})]})}),e.jsx(J,{variant:"outlined",children:e.jsxs(X,{children:[e.jsx(d,{variant:"subtitle1",gutterBottom:!0,fontWeight:"bold",children:s("advanced.explorer_title")}),e.jsx(d,{variant:"body2",color:"text.secondary",sx:{mb:2},children:s("advanced.explorer_desc")}),e.jsxs(S,{sx:{display:"flex",gap:1,mb:2},children:[e.jsx(ye,{size:"small",fullWidth:!0,placeholder:"ex: 0000180f-0000-1000-8000-00805f9b34fb",value:u,onChange:c=>b(c.currentTarget.value),onKeyPress:c=>c.key==="Enter"&&x()}),e.jsx(R,{variant:"outlined",onClick:x,children:s("codes:add_new")})]}),e.jsx(S,{sx:{display:"flex",flexWrap:"wrap",gap:1,mb:3},children:t.map(c=>e.jsx(dt,{label:c,onDelete:()=>y(c),size:"small",color:"primary",variant:"outlined"},c))}),e.jsx(R,{variant:"contained",fullWidth:!0,disabled:t.length===0||i,onClick:j,startIcon:i?e.jsx(Z,{size:20,color:"inherit"}):e.jsx(Te,{}),children:s(i?"advanced.exploring":"advanced.explore_button")}),o.length>0&&e.jsxs(S,{sx:{mt:3},children:[e.jsxs(d,{variant:"subtitle2",gutterBottom:!0,children:["Résultats trouvés : ",o.length]}),e.jsx(Ze,{dense:!0,children:o.map((c,m)=>e.jsx(Je,{divider:!0,children:e.jsx(Xe,{primary:`Char: ${c.charUuid.substring(0,8)}...`,secondary:`Service: ${c.serviceUuid.substring(0,8)}... | Val: ${c.value}`,secondaryTypographyProps:{sx:{fontFamily:"monospace",fontSize:"0.75rem"}}})},m))})]})]})})]})]})},on=({device:t,firmwareVersion:o,hardwareInference:n,deviceInfo:s,batteryData:l,analysis:a,pinCode:f,openDoorSuccess:r,openDoorError:g,questionAnswers:u,customUuids:b,customResults:i,serviceUuid:p,serviceResults:x})=>{const{t:y}=re(["wizard","common","codes"]),[j,c]=v.useState(!1),m={device:{name:t?.name,id:t?.id,firmwareVersion:o,hardwareInference:n,deviceInfo:s},status:{battery:l,analysis:a,doorTest:{attempted:!!f,success:r,error:g}},questionAnswers:u,customDiscovery:{uuids:b,results:i},advanced:{serviceUuid:p,results:x},timestamp:new Date().toISOString()},h=JSON.stringify(m,null,2),w=()=>{navigator.clipboard.writeText(h),c(!0)},D=!n||n.version==="Unknown",C=i.length>0,z=a?.consistencyStatus==="error"||a?.consistencyStatus==="warning",I=u.find(M=>M.id==="has_scale"&&M.answer==="Oui"),T=u.find(M=>M.id==="anything_special"&&M.answer==="Oui"),_=D||C||z||I||T,U=()=>{const M=`Debug Data: ${t?.name||"Unknown Boks"} - ${o||"Unknown FW"}`,W="```",Q=`Please find below the debug data captured via the Boks Web BLE tool.

${W}json
${h}
${W}`,P=new URLSearchParams;return P.set("title",M),P.set("body",Q),`${rt}?${P.toString()}`};return e.jsxs(S,{sx:{mt:2},children:[e.jsx(d,{variant:"h6",gutterBottom:!0,children:y("recap.title")}),e.jsx(d,{variant:"body2",color:"text.secondary",sx:{mb:2},children:y("recap.desc")}),_&&e.jsx(B,{severity:"info",icon:e.jsx(tt,{}),sx:{mb:3},action:e.jsxs(R,{color:"inherit",size:"small",href:U(),target:"_blank",onClick:()=>{},children:[" ",y("recap.open_issue")]}),children:y("recap.interesting_found")}),e.jsxs(S,{sx:{position:"relative"},children:[e.jsx(ye,{multiline:!0,fullWidth:!0,minRows:10,maxRows:20,value:h,variant:"outlined",InputProps:{readOnly:!0,style:{fontFamily:"monospace",fontSize:"0.875rem"}}}),e.jsx(De,{onClick:w,sx:{position:"absolute",top:8,right:8,bgcolor:"background.paper"},title:y("codes:copy_to_clipboard"),children:e.jsx(nt,{})})]}),e.jsx(ot,{open:j,autoHideDuration:3e3,onClose:()=>c(!1),message:"Données de débogage copiées dans le presse-papier"})]})},dn=()=>{const{t}=re(),o=[t("wizard:steps.step1"),t("wizard:steps.step2"),t("wizard:steps.step3"),t("wizard:steps.step4"),t("wizard:steps.step5")],n=st(),s=at(n.breakpoints.down("sm")),{debugWizardState:l,updateDebugWizardState:a,resetDebugWizardState:f}=Zt(),{activeDevice:r}=it(),{device:g,isConnected:u,connect:b,disconnect:i,getDeviceInfo:p,error:x}=ve(),{activeStep:y,firmwareVersion:j,hardwareInference:c,deviceInfo:m,pinCode:h,openDoorSuccess:w,openDoorError:D,questionAnswers:C=[],serviceUuid:z,serviceResults:I=[],batteryData:T,batteryAnalysis:_,customUuids:U=[],customResults:M=[]}=l,{openDoor:W,isOpening:Q,doorStatus:P}=lt(),{isReading:ce,batteryData:de,analysis:ge,readBatteryDiagnostics:be}=Jt({batteryData:l.batteryData,analysis:l.batteryAnalysis}),[ae,je]=v.useState(!1),se=v.useRef(!1),[pe,ue]=v.useState(!1),[xe,Se]=v.useState(!1);v.useEffect(()=>(console.log("DebugWizard: Component Mounted"),()=>console.log("DebugWizard: Component Unmounted")),[]),v.useEffect(()=>{console.log(`DebugWizard: isConnected=${u}, activeDevice=${r?.id||"none"}`)},[u,r?.id]),v.useEffect(()=>{r?.door_pin_code&&!h&&a({pinCode:r.door_pin_code})},[r,h,a]),v.useEffect(()=>{console.log("DebugWizard: Check conditions - isConnected:",u,"firmwareVersion:",j,"isLoadingInfo:",ae,"isFetchingRef:",se.current);const L=!0;u&&!j&&!ae&&!se.current&&(async()=>{if(se.current){console.log("DebugWizard: already fetching, skipping");return}console.log("DebugWizard: condition met, starting fetchInfo"),se.current=!0,je(!0);try{console.log("DebugWizard: Starting device info fetch sequence...");const V=await p(),E=V["Firmware Revision"];console.log("DebugWizard: Raw firmware revision:",E);const $=ct(E);console.log("DebugWizard: Hardware Inference result:",$);let H=E||"Inconnu";$.version!=="Unknown"&&(H+=` (v${$.version} - ${$.label})`),console.log("DebugWizard: Final display version string:",H),a({firmwareVersion:H,hardwareInference:$,deviceInfo:V}),console.log("DebugWizard: Called updateDebugWizardState with:",H)}catch(V){console.error("DebugWizard: Error in fetchInfo:",V)}finally{setTimeout(()=>{je(!1),se.current=!1,console.log("DebugWizard: Fetch sequence finished and lock cleared.")},500)}})()},[u,j,ae,a,p]);const ke=()=>{a({firmwareVersion:null})},Me=()=>{a({activeStep:y+1})},Ae=()=>{a({activeStep:y-1})},Ue=()=>{f(),i()},We=async()=>{if(a({openDoorError:null,openDoorSuccess:!1}),!h||h.length<4){a({openDoorError:"Veuillez entrer un code PIN valide (au moins 4 chiffres)"});return}try{await W(h),ue(!0),a({openDoorSuccess:!0})}catch(L){ue(!1);const K=L instanceof Error?L.message:String(L);a({openDoorError:K||"Échec de l'ouverture de la porte"})}},we=v.useCallback(async()=>{if(!g){console.warn("DebugWizard: No device for battery check");return}console.log("DebugWizard: Executing battery diagnostics...");const L=C.find(V=>V.id==="hardware_check"),K=L?{answer:L.answer,inference:c||{battery:"Unknown",label:"Unknown"}}:void 0;await be(g,K)},[g,C,c,be]);v.useEffect(()=>{pe&&P==="closed"&&(console.log("DebugWizard: Door closed, initiating battery check sequence"),ue(!1),Se(!0))},[P,pe]),v.useEffect(()=>{if(xe){const L=setTimeout(()=>{console.log("DebugWizard: Preparation delay finished, checking battery..."),Se(!1),we()},2e3);return()=>clearTimeout(L)}},[xe,we]),v.useEffect(()=>{de&&a({batteryData:de,batteryAnalysis:ge})},[de,ge,a]);const Pe=(L,K,V)=>{const E=[...C||[]],$=E.findIndex(Ve=>Ve.id===L),H={id:L,answer:K,expected:V,timestamp:new Date().toISOString()};$>=0?E[$]=H:E.push(H),a({questionAnswers:E})},Be=L=>{switch(L){case 0:return e.jsx(qt,{isConnected:u,isConnecting:!1,connect:b,error:x,device:g,firmwareVersion:j,isLoadingInfo:ae,onRetryFetch:ke});case 1:return e.jsx(en,{pinCode:h,updateDebugWizardState:a,onOpenDoor:We,isOpening:Q,isConnected:u,openDoorSuccess:w,openDoorError:D,batteryData:T,waitingForClose:pe,isReadingBattery:ce,isPreparing:xe,analysis:_});case 2:return e.jsx(tn,{questionAnswers:C,onAnswerQuestion:Pe});case 3:return e.jsx(nn,{customUuids:U,customResults:M,updateDebugWizardState:a});case 4:return e.jsx(on,{device:g,firmwareVersion:j,hardwareInference:c,deviceInfo:m,batteryData:T,analysis:_,pinCode:h,openDoorSuccess:w,openDoorError:D,questionAnswers:C,customUuids:U,customResults:M,serviceUuid:z,serviceResults:I});default:return"Unknown step"}};return e.jsx(pt,{maxWidth:"md",sx:{mt:4,mb:4,px:s?1:3},children:e.jsxs(ze,{sx:{p:s?2:4},children:[e.jsx(d,{variant:s?"h5":"h4",component:"h1",gutterBottom:!0,align:"center",children:t("wizard:title")}),s?e.jsxs(S,{sx:{mb:2},children:[e.jsx(gt,{variant:"text",steps:o.length,position:"static",activeStep:y,nextButton:null,backButton:null,sx:{bgcolor:"transparent",justifyContent:"center","& .MuiMobileStepper-dot":{mx:.5}}}),e.jsx(d,{variant:"subtitle2",align:"center",color:"primary",sx:{mt:1},children:y<o.length?o[y]:t("common:finish")})]}):e.jsx(Ot,{activeStep:y,sx:{pt:3,pb:5},alternativeLabel:!0,children:o.map(L=>e.jsx(wt,{children:e.jsx(Re,{children:L})},L))}),e.jsx(e.Fragment,{children:y===o.length?e.jsxs(e.Fragment,{children:[e.jsx(d,{variant:"h5",gutterBottom:!0,children:t("wizard:finished.title")}),e.jsx(d,{variant:"subtitle1",children:t("wizard:finished.desc")}),e.jsx(S,{sx:{display:"flex",justifyContent:"flex-end",mt:3},children:e.jsx(R,{onClick:Ue,children:t("common:reset")})})]}):e.jsxs(e.Fragment,{children:[Be(y),e.jsxs(S,{sx:{display:"flex",justifyContent:"flex-end",mt:3},children:[y!==0&&e.jsx(R,{onClick:Ae,sx:{mr:1},children:t("common:back")}),e.jsx(R,{variant:"contained",onClick:Me,disabled:y===0&&!u,children:y===o.length-1?t("common:finish"):t("common:next")})]})]})})]})})};export{dn as DebugWizardPage};
